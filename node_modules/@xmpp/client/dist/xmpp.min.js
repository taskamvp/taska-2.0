var XMPP=function(t){"use strict";var e;function n(){}function r(){r.init.call(this)}function s(t){return void 0===t._maxListeners?r.defaultMaxListeners:t._maxListeners}function i(t,e,r,i){var o,a,c,l;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((a=t._events)?(a.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),a=t._events),c=a[e]):(a=t._events=new n,t._eventsCount=0),c){if("function"==typeof c?c=a[e]=i?[r,c]:[c,r]:i?c.unshift(r):c.push(r),!c.warned&&(o=s(t))&&o>0&&c.length>o){c.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+e+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=c.length,l=u,"function"==typeof console.warn?console.warn(l):console.log(l)}}else c=a[e]=r,++t._eventsCount;return t}function o(t,e,n){var r=!1;function s(){t.removeListener(e,s),r||(r=!0,n.apply(t,arguments))}return s.listener=n,s}function a(t){var e=this._events;if(e){var n=e[t];if("function"==typeof n)return 1;if(n)return n.length}return 0}function c(t,e){for(var n=new Array(e);e--;)n[e]=t[e];return n}n.prototype=Object.create(null),r.EventEmitter=r,r.usingDomains=!1,r.prototype.domain=void 0,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.init=function(){this.domain=null,r.usingDomains&&(!e.active||this instanceof e.Domain||(this.domain=e.active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new n,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},r.prototype.getMaxListeners=function(){return s(this)},r.prototype.emit=function(t){var e,n,r,s,i,o,a,l="error"===t;if(o=this._events)l=l&&null==o.error;else if(!l)return!1;if(a=this.domain,l){if(e=arguments[1],!a){if(e instanceof Error)throw e;var u=new Error('Uncaught, unspecified "error" event. ('+e+")");throw u.context=e,u}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=a,e.domainThrown=!1,a.emit("error",e),!1}if(!(n=o[t]))return!1;var h="function"==typeof n;switch(r=arguments.length){case 1:!function(t,e,n){if(e)t.call(n);else for(var r=t.length,s=c(t,r),i=0;i<r;++i)s[i].call(n)}(n,h,this);break;case 2:!function(t,e,n,r){if(e)t.call(n,r);else for(var s=t.length,i=c(t,s),o=0;o<s;++o)i[o].call(n,r)}(n,h,this,arguments[1]);break;case 3:!function(t,e,n,r,s){if(e)t.call(n,r,s);else for(var i=t.length,o=c(t,i),a=0;a<i;++a)o[a].call(n,r,s)}(n,h,this,arguments[1],arguments[2]);break;case 4:!function(t,e,n,r,s,i){if(e)t.call(n,r,s,i);else for(var o=t.length,a=c(t,o),l=0;l<o;++l)a[l].call(n,r,s,i)}(n,h,this,arguments[1],arguments[2],arguments[3]);break;default:for(s=new Array(r-1),i=1;i<r;i++)s[i-1]=arguments[i];!function(t,e,n,r){if(e)t.apply(n,r);else for(var s=t.length,i=c(t,s),o=0;o<s;++o)i[o].apply(n,r)}(n,h,this,s)}return!0},r.prototype.addListener=function(t,e){return i(this,t,e,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(t,e){return i(this,t,e,!0)},r.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,o(this,t,e)),this},r.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,o(this,t,e)),this},r.prototype.removeListener=function(t,e){var r,s,i,o,a;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(s=this._events))return this;if(!(r=s[t]))return this;if(r===e||r.listener&&r.listener===e)0===--this._eventsCount?this._events=new n:(delete s[t],s.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(i=-1,o=r.length;o-- >0;)if(r[o]===e||r[o].listener&&r[o].listener===e){a=r[o].listener,i=o;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0===--this._eventsCount)return this._events=new n,this;delete s[t]}else!function(t,e){for(var n=e,r=n+1,s=t.length;r<s;n+=1,r+=1)t[n]=t[r];t.pop()}(r,i);s.removeListener&&this.emit("removeListener",t,a||e)}return this},r.prototype.removeAllListeners=function(t){var e,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new n,this._eventsCount=0):r[t]&&(0===--this._eventsCount?this._events=new n:delete r[t]),this;if(0===arguments.length){for(var s,i=Object.keys(r),o=0;o<i.length;++o)"removeListener"!==(s=i[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=new n,this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(e)do{this.removeListener(t,e[e.length-1])}while(e[0]);return this},r.prototype.listeners=function(t){var e,n=this._events;return n&&(e=n[t])?"function"==typeof e?[e.listener||e]:function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(e):[]},r.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):a.call(t,e)},r.prototype.listenerCount=a,r.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var l=Object.freeze({__proto__:null,EventEmitter:r,default:r});class u extends Error{constructor(t){super(t),this.name="TimeoutError"}}function h(t,e){const n=function(t){let e;const n=new Promise((n=>{e=setTimeout(n,t)}));return n.timeout=e,n}(e);const r=new u;return Promise.race([t.finally((function(){clearTimeout(n.timeout)})),n.then((()=>{throw r}))])}const m=new WeakMap;function p(t){let e=m.get(t);if(!e){e={on:(t.addEventListener??t.addListener).bind(t),off:(t.removeEventListener??t.removeListener).bind(t),once:(t.once??((e,n)=>t.addEventListener(e,n,{once:!0}))).bind(t)},m.set(t,e)}return e}function f(t,e,n="error",r){return new Promise(((s,i)=>{let o;const{off:a,once:c}=p(t),l=()=>{clearTimeout(o),a(e,m),a(n,h)};function h(t){i(t),l()}function m(t){s(t),l()}if(c(e,m),n&&c(n,h),r){const t=new u;o=setTimeout((()=>{l(),i(t)}),r)}}))}function d(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}function y(t,e=null,n){return new Promise(((r,s)=>{function i(e){t.removeListener("nonza",a),s(e)}function o(...e){t.removeListener("nonza",a),r(...e)}async function a(t){try{await n(t,o)}catch(t){i(t)}}e&&t.send(e).catch(i),t.on("nonza",a)}))}function w(t){return{subscribe(e){const{on:n}=p(e);for(const[e,r]of Object.entries(t))n(e,r)},unsubscribe(e){const{off:n}=p(e);for(const[e,r]of Object.entries(t))n(e,r)}}}function g(t){if(!t)return!1;return-1!==t.replaceAll(String.raw`\20`,"").replaceAll(String.raw`\22`,"").replaceAll(String.raw`\26`,"").replaceAll(String.raw`\27`,"").replaceAll(String.raw`\2f`,"").replaceAll(String.raw`\3a`,"").replaceAll(String.raw`\3c`,"").replaceAll(String.raw`\3e`,"").replaceAll(String.raw`\40`,"").replaceAll(String.raw`\5c`,"").search(/[ "&'/:<>@\\]/g)}function b(t){return null===t?null:t.replaceAll(/^\s+|\s+$/g,"").replaceAll("\\",String.raw`\5c`).replaceAll(" ",String.raw`\20`).replaceAll('"',String.raw`\22`).replaceAll("&",String.raw`\26`).replaceAll("'",String.raw`\27`).replaceAll("/",String.raw`\2f`).replaceAll(":",String.raw`\3a`).replaceAll("<",String.raw`\3c`).replaceAll(">",String.raw`\3e`).replaceAll("@",String.raw`\40`)}function v(t){return null===t?null:t.replaceAll(String.raw`\20`," ").replaceAll(String.raw`\22`,'"').replaceAll(String.raw`\26`,"&").replaceAll(String.raw`\27`,"'").replaceAll(String.raw`\2f`,"/").replaceAll(String.raw`\3a`,":").replaceAll(String.raw`\3c`,"<").replaceAll(String.raw`\3e`,">").replaceAll(String.raw`\40`,"@").replaceAll(String.raw`\5c`,"\\")}class x{constructor(t,e,n){if("string"!=typeof e||!e)throw new TypeError("Invalid domain.");this.setDomain(e),this.setLocal("string"==typeof t?t:""),this.setResource("string"==typeof n?n:"")}[Symbol.toPrimitive](t){return"number"===t?Number.NaN:this.toString()}toString(t){let e=this._domain;return this._local&&(e=this.getLocal(t)+"@"+e),this._resource&&(e=e+"/"+this._resource),e}bare(){return this._resource?new x(this._local,this._domain,null):this}equals(t){return this._local===t._local&&this._domain===t._domain&&this._resource===t._resource}setLocal(t,e){return(e=e||g(t))&&(t=b(t)),this._local=t&&t.toLowerCase(),this}getLocal(t=!1){let e=null;return e=t?v(this._local):this._local,e}setDomain(t){return this._domain=t.toLowerCase(),this}getDomain(){return this._domain}setResource(t){return this._resource=t,this}getResource(){return this._resource}}function _(t){let e,n;const r=t.indexOf("/");-1!==r&&(n=t.slice(r+1),t=t.slice(0,r));const s=t.indexOf("@");return-1!==s&&(e=t.slice(0,s),t=t.slice(s+1)),new x(e,t,n)}function S(...t){return t[1]||t[2]?new x(...t):_(...t)}Object.defineProperty(x.prototype,"local",{get:x.prototype.getLocal,set:x.prototype.setLocal}),Object.defineProperty(x.prototype,"domain",{get:x.prototype.getDomain,set:x.prototype.setDomain}),Object.defineProperty(x.prototype,"resource",{get:x.prototype.getResource,set:x.prototype.setResource});const k=S.bind();function E(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function L(t){if(Object.prototype.hasOwnProperty.call(t,"__esModule"))return t;var e=t.default;if("function"==typeof e){var n=function t(){var n=!1;try{n=this instanceof t}catch{}return n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};n.prototype=e.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(t).forEach((function(e){var r=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(n,e,r.get?r:{enumerable:!0,get:function(){return t[e]}})})),n}k.jid=S,k.JID=x,k.parse=_,k.equal=function(t,e){return t.equals(e)},k.detectEscape=g,k.escapeLocal=b,k.unescapeLocal=v;var A,T,C,P={};function M(){if(A)return P;A=1;const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function e(e){return t[e]}const n={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function r(t){if("#"===t[1]){const e="x"===t[2]?parseInt(t.slice(3),16):parseInt(t.slice(2),10);if(9===e||10===e||13===e||e>=32&&e<=55295||e>=57344&&e<=65533||e>=65536&&e<=1114111)return String.fromCodePoint(e);throw new Error("Illegal XML character 0x"+e.toString(16))}if(n[t])return n[t]||t;throw new Error("Illegal XML entity "+t)}return P.escapeXML=function(t){return t.replace(/["&'<>]/g,e)},P.escapeXMLText=function(t){return t.replace(/[&<>]/g,e)},P.unescapeXML=function(t){let e="",n=-1,s=-1,i=0;for(;-1!==(n=t.indexOf("&",i))&&-1!==(s=t.indexOf(";",n+1));)e=e+t.slice(i,n)+r(t.slice(n,s+1)),i=s+1;return 0===i?t:(e+=t.substring(i),e)},P.unescapeXMLText=function(t){return t.replace(/&(amp|#38|lt|#60|gt|#62);/g,r)},P}function N(){if(C)return T;C=1;var t=M();class e{constructor(t,e){this.name=t,this.parent=null,this.children=[],this.attrs={},this.setAttrs(e)}is(t,e){return this.getName()===t&&(!e||this.getNS()===e)}getName(){const t=this.name.indexOf(":");return t>=0?this.name.slice(t+1):this.name}getNS(){const t=this.name.indexOf(":");if(t>=0){const e=this.name.slice(0,t);return this.findNS(e)}return this.findNS()}findNS(t){if(t){const e="xmlns:"+t;if(this.attrs[e])return this.attrs[e];if(this.parent)return this.parent.findNS(t)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}}getXmlns(){let t={};this.parent&&(t=this.parent.getXmlns());for(const e in this.attrs){const n=e.match("xmlns:?(.*)");this.attrs.hasOwnProperty(e)&&n&&(t[this.attrs[e]]=n[1])}return t}setAttrs(t){"string"==typeof t?this.attrs.xmlns=t:t&&Object.assign(this.attrs,t)}getAttr(t,e){if(!e)return this.attrs[t];const n=this.getXmlns();return n[e]?this.attrs[[n[e],t].join(":")]:null}getChild(t,e){return this.getChildren(t,e)[0]}getChildren(t,e){const n=[];for(const r of this.children)!r.getName||r.getName()!==t||e&&r.getNS()!==e||n.push(r);return n}getChildByAttr(t,e,n,r){return this.getChildrenByAttr(t,e,n,r)[0]}getChildrenByAttr(t,e,n,r){let s=[];for(const i of this.children)!i.attrs||i.attrs[t]!==e||n&&i.getNS()!==n||s.push(i),r&&i.getChildrenByAttr&&s.push(i.getChildrenByAttr(t,e,n,!0));return r&&(s=s.flat()),s}getChildrenByFilter(t,e){let n=[];for(const r of this.children)t(r)&&n.push(r),e&&r.getChildrenByFilter&&n.push(r.getChildrenByFilter(t,!0));return e&&(n=n.flat()),n}getText(){let t="";for(const e of this.children)"string"!=typeof e&&"number"!=typeof e||(t+=e);return t}getChildText(t,e){const n=this.getChild(t,e);return n?n.getText():null}getChildElements(){return this.getChildrenByFilter((t=>t instanceof e))}root(){return this.parent?this.parent.root():this}up(){return this.parent?this.parent:this}c(t,n){return this.cnode(new e(t,n))}cnode(t){return this.children.push(t),"object"==typeof t&&(t.parent=this),t}append(...t){for(const e of t)this.children.push(e),"object"==typeof e&&(e.parent=this)}prepend(...t){for(const e of t)this.children.unshift(e),"object"==typeof e&&(e.parent=this)}t(t){return this.children.push(t),this}remove(t,e){const n="string"==typeof t?n=>!(n.is&&n.is(t,e)):e=>e!==t;return this.children=this.children.filter(n),this}text(t){return t&&1===this.children.length?(this.children[0]=t,this):this.getText()}attr(t,e){return void 0!==e||null===e?(this.attrs||(this.attrs={}),this.attrs[t]=e,this):this.attrs[t]}toString(){let t="";return this.write((e=>{t+=e})),t}_addChildren(e){e(">");for(const n of this.children)null!=n&&(n.write?n.write(e):"string"==typeof n?e(t.escapeXMLText(n)):n.toString&&e(t.escapeXMLText(n.toString(10))));e("</"),e(this.name),e(">")}write(e){e("<"),e(this.name);for(const n in this.attrs){const r=this.attrs[n];null!=r&&(e(" "),e(n),e('="'),e(t.escapeXML("string"==typeof r?r:r.toString(10))),e('"'))}0===this.children.length?e("/>"):this._addChildren(e)}}return e.prototype.tree=e.prototype.root,T=e}var j,O,F=E(N());var q,X,z=function(){if(O)return j;O=1;var t=N();function e(t,n){if(Array.isArray(n))for(const r of n)e(t,r);else""!==n&&null!=n&&!0!==n&&!1!==n&&t.cnode(n)}return j=function(n,r,...s){if("object"==typeof r&&null!==r){delete r.__source,delete r.__self;for(const[t,e]of Object.entries(r))null==e?delete r[t]:r[t]=e.toString(10)}const i=new t(n,r);for(const t of s)e(i,t);return i}}(),D=E(z),R=L(l);var $=function(){if(X)return q;X=1;var t=R,e=M();class n extends t.EventEmitter{constructor(){super();let t,n,r,s,i,o,a,c,l,u=0,h=0;this._handleTagOpening=function(t,e,n){t?this.emit("endElement",e,!1):(this.emit("startElement",e,n),o&&this.emit("endElement",e,!0))},this.write=function(m){"string"!=typeof m&&(m=m.toString());let p=0;function f(){if("number"==typeof h){const t=m.slice(h,p);return h=void 0,t}}for(t&&(m=t+m,p+=n?0:t.length,n=!1,t=null);p<m.length;p++){switch(u){case 0:{const t=m.indexOf("<",p);-1!==t&&p!==t&&(p=t);break}case 8:{const t=m.indexOf(c,p);-1!==t&&(p=t);break}case 1:{const t=m.indexOf("--\x3e",p);-1!==t&&(p=t+2);break}case 10:{const t=m.indexOf("]]>",p);-1!==t&&(p=t+2);break}}const t=m.charCodeAt(p);switch(u){case 0:if(60===t){const t=f();t&&this.emit("text",e.unescapeXML(t)),u=3,h=p+1,s={}}break;case 9:if(93===t)if("]>"===m.substr(p+1,2)){const t=f();t&&this.emit("text",t),u=0}else m.length<p+2&&(n=!0,p=m.length);break;case 3:47===t&&h===p?(h=p+1,i=!0):33===t?"[CDATA["===m.substr(p+1,7)?(h=p+8,u=9):m.length<p+8&&"[CDATA[".startsWith(m.slice(p+1))?(n=!0,p=m.length):(h=void 0,u=1):63===t?(h=void 0,u=2):(t<=32||47===t||62===t)&&(r=f(),p--,u=4);break;case 1:if(62===t){const t=m.charCodeAt(p-1),e=m.charCodeAt(p-2);(45===t&&45===e||93===t&&93===e)&&(u=0)}break;case 2:if(62===t){63===m.charCodeAt(p-1)&&(u=0)}break;case 4:62===t?(this._handleTagOpening(i,r,s),r=void 0,s=void 0,i=void 0,o=void 0,u=0,h=p+1):47===t?o=!0:t>32&&(h=p,u=5);break;case 5:(t<=32||61===t)&&(l=f(),p--,u=6);break;case 6:61===t&&(u=7);break;case 7:34!==t&&39!==t||(a=t,c=34===t?'"':"'",u=8,h=p+1);break;case 8:if(t===a){const t=e.unescapeXML(f());s[l]=t,l=void 0,u=4}}}"number"==typeof h&&h<=m.length&&(t=m.slice(h),h=0)}}end(t){t&&this.write(t),this.write=function(){}}}return q=n}(),H=E($);class I extends Error{constructor(...t){super(...t),this.name="XMLError"}}class B extends r{constructor(){super();const t=new H;this.root=null,this.cursor=null,t.on("startElement",this.onStartElement.bind(this)),t.on("endElement",this.onEndElement.bind(this)),t.on("text",this.onText.bind(this)),this.parser=t}onStartElement(t,e){const n=new F(t,e),{root:r,cursor:s}=this;r?s!==r&&s.append(n):(this.root=n,this.emit("start",n)),this.cursor=n}onEndElement(t){const{root:e,cursor:n}=this;if(t===n.name){if(n!==e)return n.parent?void(this.cursor=n.parent):(n.parent=e,this.emit("element",n),void(this.cursor=e));this.emit("end",e)}else this.emit("error",new I(`${n.name} must be closed.`))}onText(t){const{cursor:e}=this;e?e.t(t):this.emit("error",new I(`${t} must be a child.`))}write(t){this.parser.write(t)}end(t){t&&this.parser.write(t)}}B.XMLError=I;var U=M();function W(...t){return D(...t)}Object.assign(W,{Element:F,createElement:D,Parser:B,escapeXML:U.escapeXML,unescapeXML:U.unescapeXML,escapeXMLText:U.escapeXMLText,unescapeXMLText:U.unescapeXMLText,XMLError:I,xml:W});class K extends Error{constructor(t,e,n){super(t+(e?` - ${e}`:"")),this.name="XMPPError",this.condition=t,this.text=e,this.application=n}static fromElement(t){const[e,n,r]=t.getChildElements();let s,i;n&&(n.is("text")?s=n:n&&(i=n),r&&(i=r));const o=new this(e.name,s?s.text():"",i);return o.element=t,o}}class Y extends K{constructor(...t){super(...t),this.name="StreamError"}}function J(t){let{port:e,hostname:n,protocol:r}=new URL(t);return"[::1]"===n&&(n="::1"),{port:e,hostname:n,protocol:r}}function Z(t){const{port:e,hostname:n}=J(`http://${t}`);return{port:e,hostname:n}}class G extends r{#t=null;#e=null;constructor(t={}){super(),"string"==typeof t&&(t={domain:t}),this.jid=null,this.timeout=t.timeout||2e3,this.options=t,this.status="offline",this.socket=null,this.parser=null,this.root=null}isSecure(){return!0===this.socket?.secure}async _streamError(t,e){try{await this.send(W("stream:error",{},[W(t,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},e)]))}catch{}return this.disconnect()}_onData(t){const e=t.toString("utf8");this.parser.write(e)}#n(t){this._streamError("bad-format"),this._detachParser(),this.emit("error",t)}#r(t,e){this._detachSocket(),this._status("disconnect",{clean:!t,reason:e})}#s(t,e){this._detachParser(),this._status("close",{clean:!t,reason:e})}_attachSocket(t){this.socket=t,this.#t??=w({data:this._onData.bind(this),close:this.#r.bind(this),connect:()=>this._status("connect"),error:t=>this.emit("error",t)}),this.#t.subscribe(this.socket)}_detachSocket(){this.socket&&this.#t?.unsubscribe(this.socket),this.socket=null}_onElement(t){const e=t.is("error","http://etherx.jabber.org/streams");e&&this._onStreamError(t),this.emit("element",t),this.emit(this.isStanza(t)?"stanza":"nonza",t),e&&this.disconnect()}_onStreamError(t){const e=Y.fromElement(t);if("see-other-host"===e.condition)return this._onSeeOtherHost(e);this.emit("error",e)}async _onSeeOtherHost(t){const{protocol:e}=function(t){return t.includes("://")?J(t):Z(t)}(this.options.service),n=t.element.getChildText("see-other-host"),{port:r}=Z(n);let s;s=r?`${e||"xmpp:"}//${n}`:(e?`${e}//`:"")+n;try{await f(this,"disconnect");const{domain:t,lang:e}=this.options;await this.connect(s),await this.open({domain:t,lang:e})}catch(t){this.emit("error",t)}}_attachParser(t){this.parser=t,this.#e??=w({element:this._onElement.bind(this),error:this.#n.bind(this),end:this.#s.bind(this),start:t=>this._status("open",t)}),this.#e.subscribe(this.parser)}_detachParser(){this.parser&&this.#e?.unsubscribe(this.parser),this.parser=null,this.root=null}_jid(t){return this.jid=k(t),this.jid}_status(t,...e){this.status!==t&&(this.status=t,this.emit("status",t,...e),this.emit(t,...e))}_ready(t=!1){t?this.status="online":this._status("online",this.jid)}async disconnect(){let t;try{t=await this._closeStream()}catch(t){this.#s(t)}try{await this._closeSocket()}catch(t){this.#r(!0,t)}return t}async start(){if("offline"!==this.status)throw new Error("Connection is not offline");const{service:t,domain:e,lang:n}=this.options;await this.connect(t);const r=f(this,"online");return await this.open({domain:e,lang:n}),r}async connect(t){this._status("connecting",t);const e=new this.Socket;return this._attachSocket(e),e.connect(this.socketParameters(t)),f(e,"connect")}async _closeSocket(t=this.timeout){this._status("disconnecting"),this.socket.end(),await f(this.socket,"close","error",t)}async open(t){this._status("opening");const{domain:e,lang:n}=t,r=this.headerElement();return r.attrs.to=e,r.attrs["xml:lang"]=n,this.root=r,this._attachParser(new this.Parser),await this.write(this.header(r)),f(this,"open","error",this.timeout)}async stop(){const t=await this.disconnect();return this._status("offline",t),t}async _closeStream(t=this.timeout){await this.#i("close");const e=this.footer(this.footerElement());return await this.write(e),this._status("closing"),f(this.parser,"end","error",t)}async restart(){this._detachParser();const{domain:t,lang:e}=this.options;return this.open({domain:t,lang:e})}async send(t){t.parent=this.root,await this.write(t.toString()),this.emit("send",t)}sendReceive(t,e=this.timeout){return Promise.all([this.send(t),f(this,"element","error",e)]).then((([,t])=>t))}async write(t){if("closing"===this.status)throw new Error("Connection is closing");return new Promise(((e,n)=>{this.socket.write(t,(t=>t?n(t):e()))}))}isStanza(t){const{name:e}=t;return"iq"===e||"message"===e||"presence"===e}isNonza(t){return!this.isStanza(t)}header(t){return t.toString()}headerElement(){return new W.Element("",{version:"1.0",xmlns:this.NS})}footer(t){return t.toString()}footerElement(){}socketParameters(){}#o=new Map;#a=new Set(["close"]);hook(t,e){this.#c(t),this.#o.has(t)||this.#o.set(t,new Set),this.#o.get(t).add([e])}#c(t){if(!this.#a.has(t))throw new Error(`Hook event name "${t}" is unknown.`)}unhook(t,e){this.#c(t);const n=this.#o.get("event"),r=[...n].find((t=>t.handler===e));n.remove(r)}async#i(t,...e){this.#c(t);const n=this.#o.get(t);n&&await Promise.all([...n].map((async([t])=>{try{await t(...e)}catch(t){this.emit("error",t)}})))}}G.prototype.NS="",G.prototype.Socket=null,G.prototype.Parser=null;class Q extends G{constructor(t){super(t),this.transports=[]}send(t,...e){return this.Transport.prototype.send.call(this,t,...e)}sendMany(...t){return this.Transport.prototype.sendMany.call(this,...t)}_findTransport(t){return this.transports.find((e=>{try{return void 0!==e.prototype.socketParameters(t)}catch{return!1}}))}connect(t){const e=this._findTransport(t);if(!e)throw new Error("No compatible connection method found.");return this.Transport=e,this.Socket=e.prototype.Socket,this.Parser=e.prototype.Parser,super.connect(t)}socketParameters(...t){return this.Transport.prototype.socketParameters(...t)}header(t,...e){const n=this.isSecure()&&this.jid?.bare().toString();return n&&(t.attrs.from=n),this.Transport.prototype.header(t,...e)}headerElement(...t){return this.Transport.prototype.headerElement(...t)}footer(...t){return this.Transport.prototype.footer(...t)}footerElement(...t){return this.Transport.prototype.footerElement(...t)}}Q.prototype.NS="jabber:client";const V="ANONYMOUS",tt="PLAIN";function et(t,e){return async function(...n){if("function"==typeof t)return void await t(...n);const[r,s,i,o]=n;t.token??=await(i?.fetch());const a=function({mechanisms:t,entity:e,credentials:n}){if(!n?.username&&!n?.password&&!n?.token&&t.includes(V))return V;return e.isSecure()?t[0]:t.find((t=>t!==tt))}({mechanisms:s,entity:o,credentials:t});await r(t,a,e)}}class nt extends r{constructor(t){super(),this.delay=1e3,this.entity=t,this._timeout=null}#l=()=>{this.scheduleReconnect()};scheduleReconnect(){const{entity:t,delay:e,_timeout:n}=this;clearTimeout(n),this._timeout=setTimeout((async()=>{if("disconnect"===t.status)try{await this.reconnect()}catch{}}),e)}async reconnect(){const{entity:t}=this;this.emit("reconnecting");const{service:e,domain:n,lang:r}=t.options;await t.connect(e),await t.open({domain:n,lang:r}),this.emit("reconnected")}start(){const{entity:t}=this;t.on("disconnect",this.#l)}stop(){const{entity:t,_timeout:e}=this;t.removeListener("disconnect",this.#l),clearTimeout(e)}}const rt="ECONNERROR";const st="urn:ietf:params:xml:ns:xmpp-framing";class it extends G{send(t,...e){return t.attrs.xmlns??=this.NS,super.send(t,...e)}async sendMany(t){for(const e of t)e.attrs.xmlns??=this.NS,e.parent=this.root,this.socket.write(e.toString()),this.emit("send",e)}footerElement(){return new W.Element("close",{xmlns:st})}headerElement(){const t=super.headerElement();return t.name="open",t.attrs.xmlns=st,t}socketParameters(t){return/^wss?:\/\//.test(t)?t:void 0}}it.prototype.Socket=class extends r{#u=null;socket=null;url=null;secure=!1;connect(t){this.url=t,this.secure=function(t){const e=J(t);return"wss:"===e.protocol||!!["localhost","127.0.0.1","::1"].includes(e.hostname)}(t),this._attachSocket(new WebSocket(t,["xmpp"]))}_attachSocket(t){this.socket=t,this.#u??=w({open:()=>this.emit("connect"),message:({data:t})=>this.emit("data",t),error:t=>{const{url:e}=this;let{error:n}=t;n||(n=new Error(t.message||`WebSocket ${rt} ${e}`),n.errno=rt,n.code=rt),n.event=t,n.url=e,this.emit("error",n)},close:t=>{this._detachSocket(),this.emit("close",!t.wasClean,t)}}),this.#u.subscribe(this.socket)}_detachSocket(){this.url=null,this.secure=!1,this.socket&&this.#u?.unsubscribe(this.socket),this.socket=null}end(){this.socket.close()}write(t,e){function n(t){e&&Promise.resolve().then((()=>e(t)))}try{this.socket.send(t)}catch(t){return void n(t)}n()}},it.prototype.NS="jabber:client",it.prototype.Parser=class extends B{onStartElement(t,e){const n=new F(t,e),{cursor:r}=this;r&&r.append(n),this.cursor=n}onEndElement(t){const{cursor:e}=this;t===e.name?e.parent?this.cursor=e.parent:(e.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",e):e.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",e):this.emit("element",e),this.cursor=null):this.emit("error",new I(`${e.name} must be closed.`))}};var ot,at,ct={};var lt=(at||(at=1,ot=function(t){if(!Array.isArray(t))throw new TypeError("Middleware stack must be an array!");for(const e of t)if("function"!=typeof e)throw new TypeError("Middleware must be composed of functions!");return function(e,n){let r=-1;return function s(i){if(i<=r)return Promise.reject(new Error("next() called multiple times"));r=i;let o=t[i];if(i===t.length&&(o=n),!o)return Promise.resolve();try{return Promise.resolve(o(e,s.bind(null,i+1)))}catch(t){return Promise.reject(t)}}(0)}}),ot),ut=E(lt);class ht{constructor(t,e){this.stanza=e,this.entity=t;const{name:n,attrs:r}=e,{type:s,id:i}=r;this.name=n,this.id=i||"",this.type="message"===n?s||"normal":"presence"===n?s||"available":s||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}}class mt extends ht{constructor(t,e){super(t,e);const{jid:n}=t,{domain:r}=t.options??{},s=e.attrs.to||n?.toString(),i=e.attrs.from||r;s&&(this.to=new k(s)),i&&(this.from=new k(i),this.local=this.from.local,this.domain=this.from.domain,this.resource=this.from.resource)}}class pt extends ht{constructor(t,e){super(t,e);const{jid:n}=t,{domain:r}=t.options??{},s=e.attrs.from||n?.toString(),i=e.attrs.to||r;s&&(this.from=new k(s)),i&&(this.to=new k(i),this.local=this.to.local,this.domain=this.to.domain,this.resource=this.to.resource)}}function ft(t,e,n){return r=>{const s=new n(t,r);return ut(e)(s)}}function dt(t){return(e,n)=>{n().then((e=>e&&t.send(e))).catch((e=>t.emit("error",e)))}}class yt extends K{constructor(t,e,n,r){super(t,e,n),this.type=r,this.name="StanzaError"}static fromElement(t){const e=super.fromElement(t);return e.type=t.attrs.type,e}}class wt{constructor({entity:t,middleware:e}){this.handlers=new Map,this.entity=t,this.middleware=e}start(){this.middleware.use(this._route.bind(this))}_route({type:t,name:e,id:n,stanza:r},s){if(!function({name:t,type:e}){return"iq"===t&&("error"===e||"result"===e)}({name:e,type:t}))return s();const i=this.handlers.get(n);if(!i)return s();"error"===t?i.reject(yt.fromElement(r.getChild("error"))):i.resolve(r),this.handlers.delete(n)}async request(t,e=3e4){t.attrs.id||(t.attrs.id=function(){let t;for(;!t;)t=Math.random().toString(36).slice(2,12);return t}());const n=new d;this.handlers.set(t.attrs.id,n);try{await this.entity.send(t),await h(n.promise,e)}catch(e){throw this.handlers.delete(t.attrs.id),e}return n.promise}_childRequest(t,e,n,...r){const{name:s,attrs:{xmlns:i}}=e;return this.request(W("iq",{type:t,to:n},e),...r).then((t=>t.getChild(s,i)))}async get(...t){return this._childRequest("get",...t)}async set(...t){return this._childRequest("set",...t)}}function gt({stanza:t}){return W("iq",{to:t.attrs.from,from:t.attrs.to,id:t.attrs.id})}function bt(t,e,n){const r=gt(t);return r.attrs.type="error",n&&r.append(n),r.append(e),r}function vt(t,e){return W("error",{type:t},W(e,"urn:ietf:params:xml:ns:xmpp-stanzas"))}function xt(t){return async function(e,n){if(!function({name:t,type:e}){return"iq"===t&&"error"!==e&&"result"!==e}(e))return n();const{stanza:r}=e,s=r.getChildElements(),[i]=s;if(!function({type:t},e,n){return("get"===t||"set"===t)&&1===e.length&&!!n}(e,s,i))return bt(e,vt("modify","bad-request"),i);let o;e.element=i;try{o=await n()}catch(e){t.emit("error",e),o=vt("cancel","internal-server-error")}return o||(o=vt("cancel","service-unavailable")),o instanceof W.Element&&o.is("error")?bt(e,o,i):function(t,e){const n=gt(t);return n.attrs.type="result",e&&n.append(e),n}(e,o instanceof W.Element?o:void 0)}}function _t(t,e,n,r){return(s,i)=>s.type!==t|!s.element||!s.element.is(n,e)?i():r(s,i)}function St(t){return t.startsWith("https")||t.startsWith("wss")}function kt(t,e){let n,r;return n=St(t.uri)&&!St(e.uri)?-1:!St(t.uri)&&St(e.uri)?1:0,0!==n?n:(r=t.method===e.method?0:"websocket"===t.method?-1:"websocket"===e.method?1:"xbosh"===t.method?-1:"xbosh"===e.method?1:"httppoll"===t.method?-1:"httppoll"===e.method?1:0,0!==r?r:0)}function Et(t){return fetch(`https://${t}/.well-known/host-meta`).then((t=>t.text())).then((t=>function(t){const e=new B;let n=null,r=null;if(e.on("start",(t=>{n=t})),e.on("element",(t=>{n.append(t)})),e.on("error",(t=>{r=t})),e.write(t),e.end(),r)throw r;return n}(t).getChildren("Link").filter((t=>["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(t.attrs.rel))).map((({attrs:t})=>({rel:t.rel,href:t.href,method:t.rel.split(":").pop(),uri:t.href}))).sort(kt))).catch((()=>[]))}async function Lt(t){const e=await function(...t){return Promise.all([Promise.resolve([]),Et(...t)]).then((([t,e])=>[...t,...e]))}(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]});return[...new Set(e.map((t=>t.uri)))]}async function At(t,e){if(0===e.length)throw new Error("Couldn't connect");const n=e.shift(),r=t._findTransport(n);if(!r)return At(t,e);t._status("connecting",n);const s=r.prototype.socketParameters(n),i=new r.prototype.Socket;try{i.connect(s),await f(i,"connect")}catch{return At(t,e)}t._attachSocket(i),i.emit("connect"),t.Transport=r,t.Socket=r.prototype.Socket,t.Parser=r.prototype.Parser}function Tt({entity:t}){const e=t.connect;t.connect=async function(n){if(!n||/:\/\//.test(n))return e.call(this,n);const r=function(t,e){return e.filter((e=>t._findTransport(e)))}(t,await Lt(n));if(0===r.length)throw new Error("No compatible transport found.");try{await At(t,r)}catch(e){throw await t.disconnect(),t._status("disconnect"),e}}}function Ct(t){return globalThis.btoa(t)}function Pt(t){return globalThis.atob(t)}class Mt extends K{constructor(...t){super(...t),this.name="SASLError"}}const Nt="urn:ietf:params:xml:ns:xmpp-sasl";function jt(t,e,n){const r=new Set(t.getChildren("mechanism",e).map((t=>t.text())));return n._mechs.map((({name:t})=>t)).filter((t=>r.has(t)))}function Ot({streamFeatures:t,saslFactory:e},n){t.use("mechanisms",Nt,(async({entity:t},r,s)=>{const i=jt(s,Nt,e);if(0===i.length)throw new Mt("SASL: No compatible mechanism available.");await n((async function(n,r){await async function({saslFactory:t,entity:e,mechanism:n,credentials:r}){const s=t.create([n]);if(!s)throw new Error(`SASL: Mechanism ${n} not found.`);const{domain:i}=e.options,o={username:null,password:null,server:i,host:i,realm:i,serviceType:"xmpp",serviceName:i,...r};await y(e,s.clientFirst&&W("auth",{xmlns:Nt,mechanism:s.name},Ct(await s.response(o))),(async(t,n)=>{if(t.getNS()===Nt){if("challenge"!==t.name){if("failure"===t.name)throw Mt.fromElement(t);return"success"===t.name?n():void 0}{await s.challenge(Pt(t.text()));const n=await s.response(o);await e.send(W("response",{xmlns:Nt,mechanism:s.name},"string"==typeof n?Ct(n):""))}}}))}({saslFactory:e,entity:t,mechanism:r,credentials:n})}),i,null,t),await t.restart()}))}const Ft="urn:xmpp:sasl:2";async function qt({saslFactory:t,entity:e,mechanism:n,credentials:r,userAgent:s,streamFeatures:i,features:o}){const a=t.create([n]);if(!a)throw new Error(`SASL: Mechanism ${n} not found.`);const{domain:c}=e.options,l={username:null,password:null,server:c,host:c,realm:c,serviceType:"xmpp",serviceName:c,...r};await y(e,W("authenticate",{xmlns:Ft,mechanism:a.name},[a.clientFirst&&W("initial-response",{},Ct(await a.response(l))),s,...i]),(async(t,n)=>{if(t.getNS()===Ft)if("challenge"!==t.name){if("failure"===t.name)throw Mt.fromElement(t);if("continue"===t.name)throw new Error("SASL continue is not supported yet");if("success"===t.name){const r=t.getChild("additional-data")?.text();r&&a.final&&await a.final(Pt(r));const s=t.getChildText("authorization-identifier");s&&e._jid(s);for(const e of t.getChildElements()){const t=o.get(e.getNS());t?.[1]?.(e)}return n()}}else{await a.challenge(Pt(t.text()));const n=await a.response(l);await e.send(W("response",{xmlns:Ft,mechanism:a.name},"string"==typeof n?Ct(n):""))}}))}function Xt({streamFeatures:t,saslFactory:e},n){const r=new Map;let s;return t.use("authentication",Ft,(async({entity:t},i,o)=>{const a=jt(o,Ft,e),c=await async function({element:t,features:e}){const n=[],r=t.getChild("inline");if(!r)return n;for(const t of r.getChildElements()){const r=t.getNS(),s=e.get(r);s&&n.push(s[0](t))}return Promise.all(n)}({element:o,features:r}),l=!!s?.mechanism;if(0===a.length&&!l)throw new Mt("SASL: No compatible mechanism available.");await n((async function(n,i,o){if(await s.auth({authenticate:qt,entity:t,userAgent:o,streamFeatures:c,features:r,credentials:n}))return;await qt({entity:t,userAgent:o,streamFeatures:c,features:r,saslFactory:e,mechanism:i,credentials:n})}),a,l?s:null,t)})),{use(t,e,n){r.set(t,[e,n])},setup({fast:t}){s=t}}}const zt="urn:ietf:params:xml:ns:xmpp-bind";async function Dt(t,e,n){const r=await e.set(function(t){return W("bind",{xmlns:zt},t&&W("resource",{},t))}(n)),s=r.getChildText("jid");return t._jid(s),t._ready(!1),s}function Rt({streamFeatures:t,iqCaller:e},n){t.use("bind",zt,function({iqCaller:t},e){return async({entity:n},r)=>{e="function"==typeof e?await e():e,await Dt(n,t,e),r()}}({iqCaller:e},n))}function $t(t=new Date){return"string"==typeof t&&(t=new Date(t)),new Date(t).toISOString().split(".")[0]+"Z"}function Ht({streamFeatures:t,sm:e,entity:n,resumed:r,failed:s,enabled:i}){t.use("sm",It,(async(t,o)=>{if(e.id)try{const t=await async function(t,e){return y(t,Ut({sm:e}),((t,e)=>{if(t.is("resumed",It))return e(t);if(t.is("failed",It))throw K.fromElement(t)}))}(n,e);return void await r(t)}catch{s()}await o();const a=function(t,e){return y(t,Bt({sm:e}),((t,e)=>{if(t.is("enabled",It))return e(t);if(t.is("failed",It))throw K.fromElement(t)}))}(n,e);if(e.outbound_q.length>0)throw new Error("Stream Management assertion failure, queue should be empty after enable");e.outbound=0;try{const t=await a;i(t.attrs)}catch{e.enabled=!1,e.enableSent=!1}}))}const It="urn:xmpp:sm:3";function Bt({sm:t}){return W("enable",{xmlns:It,max:t.preferredMaximum,resume:"true"})}function Ut({sm:t}){return W("resume",{xmlns:It,h:t.inbound,previd:t.id})}function Wt({streamFeatures:t,entity:e,middleware:n,bind2:s,sasl2:i}){let o=null,a=null,c=null;const l=new r;async function u(){try{await e.send(W("a",{xmlns:It,h:l.inbound}))}catch{}}async function h(t){l.enabled=!0,p(+t.attrs.h);let n=l.outbound_q;l.outbound_q=[],await e.sendMany(n.map((t=>function({entity:t,item:e}){const{stanza:n,stamp:r}=e;"message"!==n.name||n.getChild("delay","urn:xmpp:delay")||n.append(W("delay",{xmlns:"urn:xmpp:delay",from:t.jid.toString(),stamp:r}));return n}({entity:e,item:t})))),l.emit("resumed"),e._ready(!0),y()}function m(){l.enabled=!1,l.enableSent=!1,l.id="",f()}function p(t){const e=l.outbound;for(let n=0;n<+t-e;n++){const t=l.outbound_q.shift();l.outbound++,l.emit("ack",t.stanza)}}function f(){let t;for(;t=l.outbound_q.shift();)l.emit("fail",t.stanza);l.outbound=0}function d({id:t,max:e}){l.enabled=!0,l.id=t,l.max=e,l.inbound=0,y()}function y(t=l.requestAckInterval){clearTimeout(a),l.enabled&&t&&(a=setTimeout(w,t))}function w(){clearTimeout(o),clearTimeout(a),clearTimeout(c),l.enabled&&(l.timeout&&(o=setTimeout((()=>e.disconnect().catch((()=>{}))),l.timeout)),e.send(W("r",{xmlns:It})).catch((()=>{})),y())}return Object.assign(l,{preferredMaximum:null,enabled:!1,enableSent:!1,id:"",outbound_q:[],outbound:0,inbound:0,max:null,timeout:6e4,requestAckInterval:3e4,requestAckDebounce:250}),e.on("disconnect",(()=>{clearTimeout(o),clearTimeout(a),clearTimeout(c),l.enabled=!1,l.enableSent=!1})),e.hook("close",(async()=>{l.enabled&&await u()})),e.on("offline",(()=>{f(),l.inbound=0,l.enabled=!1,l.enableSent=!1,l.id=""})),n.use((async(t,e)=>{const{stanza:n}=t;return clearTimeout(o),["presence","message","iq"].includes(n.name)?l.inbound+=1:n.is("r",It)?await u():n.is("a",It)&&p(+n.attrs.h),y(),e()})),s&&function({bind2:t,sm:e,failed:n,enabled:r}){t.use(It,(t=>Bt({sm:e})),(async t=>{t.is("enabled")?r(t.attrs):t.is("failed")&&n()}))}({bind2:s,sm:l,failed:m,enabled:d}),i&&function({sasl2:t,sm:e,failed:n,resumed:r}){t.use(It,(t=>{if(t.is("sm"))return e.id?Ut({sm:e}):void 0}),(t=>{t.is("resumed")?r(t):t.is("failed")&&n()}))}({sasl2:i,sm:l,failed:m,resumed:h}),n.filter(((t,e)=>{const{stanza:n}=t;return n.is("enable",It)&&(l.enableSent=!0),(l.enabled||l.enableSent)&&["presence","message","iq"].includes(n.name)?(l.outbound_q.push({stanza:n,stamp:$t()}),clearTimeout(a),clearTimeout(c),c=setTimeout(w,l.requestAckDebounce),e()):e()})),t&&Ht({streamFeatures:t,sm:l,entity:e,resumed:h,failed:m,enabled:d}),l}const Kt="urn:xmpp:bind:0";function Yt({sasl2:t,entity:e},n){const r=new Map;return t.use(Kt,(async t=>{if(!t.is("bind",Kt))return;n="function"==typeof n?await n():n;const e=await function({element:t,features:e}){const n=[],r=t.getChild("inline");if(!r)return n;for(const t of r.getChildElements()){const r=t.attrs.var,s=e.get(r);s&&n.push(s[0](t))}return Promise.all(n)}({element:t,features:r});return W("bind",{xmlns:"urn:xmpp:bind:0"},n&&W("tag",null,n),...e)}),(t=>{if(t.is("bound")){e._ready(!1);for(const e of t.getChildElements()){const t=r.get(e.getNS());t?.[1]?.(e)}}})),{use(t,e,n){r.set(t,[e,n])}}}var Jt,Zt={exports:{}},Gt={exports:{}};var Qt;var Vt,te,ee=(Qt||(Qt=1,Vt=Zt,Jt||(Jt=1,function(t,e){function n(){this._mechs=[]}n.prototype.use=function(t,e){return e||(t=(e=t).prototype.name),this._mechs.push({name:t,mech:e}),this},n.prototype.create=function(t){for(var e=0,n=this._mechs.length;e<n;e++)for(var r=0,s=t.length;r<s;r++){var i=this._mechs[e];if(i.name==t[r])return new i.mech}return null},e.exports=n}(0,Gt)),te=Gt.exports,void((Vt.exports=te).Factory=te)),Zt.exports),ne=E(ee);const re="urn:xmpp:fast:0";function se({sasl2:t,entity:e}){const n=new ne;let s;const i=new r;function o(){i.mechanism=null,i.mechanisms=[]}return Object.assign(i,{mechanism:null,mechanisms:[],async saveToken(t){s=t},fetchToken:async()=>s,async deleteToken(){s=null},async save(t){try{await this.saveToken(t)}catch(t){e.emit("error",t)}},async fetch(){try{return this.fetchToken()}catch(t){e.emit("error",t)}},async delete(){try{await this.deleteToken()}catch(t){e.emit("error",t)}},saslFactory:n,async auth({authenticate:t,entity:e,userAgent:n,credentials:r,streamFeatures:s,features:o}){if(!i.mechanism)return!1;const{token:a}=r;if(!function(t,e){if(!t)return!1;if(!e.includes(t.mechanism))return!1;if(new Date(t.expiry)<=new Date)return!1;return!0}(a,i.mechanisms))return c();try{return await t({saslFactory:i.saslFactory,mechanism:a.mechanism,credentials:{...r,password:a.token},streamFeatures:[...s,W("fast",{xmlns:re})],entity:e,userAgent:n,features:o}),!0}catch(t){return t instanceof Mt&&["not-authorized","credentials-expired"].includes(t.condition)?c():(e.emit("error",t),!1)}async function c(){return await i.delete(),function(t){t.push(W("request-token",{xmlns:re,mechanism:i.mechanism}))}(s),!1}}}),o(),t.use(re,(async t=>{if(!t.is("fast",re))return o();i.available=!0;const e=jt(t,re,n),r=e[0];if(!r)return o();i.mechanisms=e,i.mechanism=r}),(async t=>{t.is("token",re)&&await i.save({mechanism:i.mechanism,token:t.attrs.token,expiry:t.attrs.expiry})})),i}var ie,oe={exports:{}},ae={exports:{}};var ce;var le=(ce||(ce=1,function(t){!function(t,e,n){(e.exports=n).Mechanism=n}(0,t,(ie||(ie=1,function(t){!function(t,e){function n(){}n.prototype.name="PLAIN",n.prototype.clientFirst=!0,n.prototype.response=function(t){var e="";return e+=t.authzid||"",e+="\0",e+=t.username,(e+="\0")+t.password},n.prototype.challenge=function(t){return this},e.exports=n}(0,t)}(ae)),ae.exports))}(oe)),oe.exports),ue=E(le);function he(t){t.use(ue)}var me,pe={exports:{}},fe={exports:{}};var de;var ye=(de||(de=1,function(t){!function(t,e,n){(e.exports=n).Mechanism=n}(0,t,(me||(me=1,function(t){!function(t,e){function n(){}n.prototype.name="ANONYMOUS",n.prototype.clientFirst=!0,n.prototype.response=function(t){return t.trace||""},n.prototype.challenge=function(t){},e.exports=n}(0,t)}(fe)),fe.exports))}(pe)),pe.exports),we=E(ye);function ge(t){t.use(we)}function be(){}function ve(t,...e){if("function"==typeof t)return t(...e)}return be.prototype.Mechanism=be,be.prototype.name="HT-SHA-256-NONE",be.prototype.clientFirst=!0,be.prototype.response=async function({username:t,password:e}){this.key=await crypto.subtle.importKey("raw",(new TextEncoder).encode(e),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"]);const n=await crypto.subtle.sign("HMAC",this.key,(new TextEncoder).encode("Initiator"));return`${t}\0${String.fromCodePoint(...new Uint8Array(n))}`},be.prototype.final=async function(t){const e=Uint8Array.from(t,(t=>t.codePointAt(0)));if(!0!==await crypto.subtle.verify("HMAC",this.key,e,(new TextEncoder).encode("Responder")))throw new Error("Responder message from server was wrong")},t.client=function(t={}){let{resource:e,credentials:n,username:r,password:s,userAgent:i,...o}=t;const{domain:a,service:c}=o;!a&&c&&(o.domain=function(t){return(t.split("://")[1]||t).split(":")[0].split("/")[0]}(c));const l=new Q(o);r&&o.domain&&(l.jid=k(r,o.domain));const u=function({entity:t}){const e=new nt(t);return e.start(),e}({entity:l}),h=function({entity:t}){t.transports.push(it)}({entity:l}),m=ve(ct,{entity:l}),p=ve(ct,{entity:l}),f=function({entity:t}){const e=[dt(t)],n=[],r=ft(t,e,mt),s=ft(t,n,pt);return t.on("element",r),t.on("send",s),{use:t=>(e.push(t),t),filter:t=>(n.push(t),t)}}({entity:l}),d=function({middleware:t}){return{use:function(e,n,r){return t.use(((t,s)=>{const{stanza:i}=t;if(!i.is("features","http://etherx.jabber.org/streams"))return s();const o=i.getChild(e,n);return o?r(t,s,o):s()}))}}}({middleware:f}),y=function(...t){const e=new wt(...t);return e.start(),e}({middleware:f,entity:l}),w=function({middleware:t,entity:e}){return t.use(xt(e)),{get(e,n,r){t.use(_t("get",e,n,r))},set(e,n,r){t.use(_t("set",e,n,r))}}}({middleware:f,entity:l}),g=Tt({entity:l}),b=new ne,v=Object.entries({plain:he,anonymous:ge}).map((([t,e])=>({[t]:e(b)})));i??=W("user-agent",{id:globalThis.crypto.randomUUID()});const x=ve(ct,{streamFeatures:d}),_=Xt({streamFeatures:d,saslFactory:b},et(n??{username:r,password:s},i)),S=se({sasl2:_,entity:l});_.setup({fast:S});const E=Yt({sasl2:_,entity:l},e);!function(t){t.use(be)}(S.saslFactory);const L=Ot({streamFeatures:d,saslFactory:b},et(n??{username:r,password:s},i)),A=Wt({streamFeatures:d,entity:l,middleware:f,bind2:E,sasl2:_}),T=Rt({iqCaller:y,streamFeatures:d},e);return w?.get("urn:xmpp:ping","ping",(()=>({}))),Object.assign(l,{entity:l,reconnect:u,tcp:m,websocket:h,tls:p,middleware:f,streamFeatures:d,iqCaller:y,iqCallee:w,resolve:g,starttls:x,saslFactory:b,sasl2:_,sasl:L,resourceBinding:T,streamManagement:A,mechanisms:v,bind2:E,fast:S})},t.jid=k,t.xml=W,t}({});//# sourceMappingURL=xmpp.min.js.map
