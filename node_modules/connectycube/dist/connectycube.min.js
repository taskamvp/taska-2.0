!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-fetch")):"function"==typeof define&&define.amd?define(["node-fetch"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ConnectyCube=t(e.nodeFetch)}(this,function(e){"use strict";const t=e=>n?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))):Buffer.from(e).toString("base64"),r="4.7.0",n="object"==typeof window&&"object"==typeof document,s="object"==typeof process&&"object"==typeof process.versions&&!!process.versions.node,i=!1,o=!1;let a,c;s?(import("node-fetch").then(e=>{a=e.default||e}),import("form-data").then(e=>{c=e.default||e})):(a=fetch,c=FormData);const l=n?window.navigator:void 0,d=n&&l?l.mediaDevices:void 0,u=n?window.MediaStream:void 0,h=n?window.MediaStreamTrack:void 0,p=n?window.RTCIceCandidate:void 0,m=n?window.RTCPeerConnection:void 0,f=n?window.RTCRtpReceiver:void 0,g=n?window.RTCRtpSender:void 0,y=n?window.RTCSessionDescription:void 0,b=!!n&&Boolean(d&&window?.RTCPeerConnection),C=n?window.adapter:void 0;var v,S,w=Object.freeze({__proto__:null,get FormDataImpl(){return c},MediaStream:u,MediaStreamTrack:h,RTCIceCandidate:p,RTCPeerConnection:m,RTCRtpReceiver:f,RTCRtpSender:g,RTCSessionDescription:y,adapter:C,base64Encode:t,get fetchImpl(){return a},isBrowser:n,isExpo:o,isNodeJS:s,isReactNative:i,isWebRTCAvailable:b,mediaDevices:d,navigator:l,sdkVersion:r});!function(e){e[e.COMPACT=1]="COMPACT",e[e.FULL=0]="FULL"}(v||(v={})),function(e){e.FACEBOOK="facebook",e.TWITTER="twitter",e.FIREBASE_PHONE="firebase_phone",e.FIREBASE_EMAIL="firebase_email"}(S||(S={}));var E,T,I,k,x,A,D,O,R,P,L,_,j,N,M,U,J,V,$,F,W,z,q,B,G,H,X,Q;!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(E||(E={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(T||(T={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.STOPPED=3]="STOPPED",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(I||(I={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(k||(k={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="stop",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(x||(x={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}(A||(A={})),function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(D||(D={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(O||(O={})),function(e){e.ALLOW="allow",e.DENY="deny"}(R||(R={})),function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(P||(P={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(L||(L={})),function(e){e.CREATE="create",e.READ="read",e.UPDATE="update",e.DELETE="delete"}(_||(_={})),function(e){e.OPEN="open",e.OWNER="owner",e.NOT_ALLOWED="not_allowed",e.OPEN_FOR_GROUPS="open_for_groups",e.OPEN_FOR_USERS_IDS="open_for_users_ids"}(j||(j={})),function(e){e[e.PUBLIC=1]="PUBLIC",e[e.GROUP=2]="GROUP",e[e.PRIVATE=3]="PRIVATE",e[e.BROADCAST=4]="BROADCAST",e[e.MEETING=5]="MEETING"}(N||(N={})),function(e){e.SENT="sent",e.DELIVERED="delivered",e.READ="read"}(M||(M={})),function(e){e.CREATED="created_at",e.UPDATED="updated_at",e.LAST_MESSAGE="last_message_date_sent"}(U||(U={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(J||(J={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(V||(V={})),function(e){e.VIDEO="video",e.AUDIO="audio"}($||($={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(F||(F={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(W||(W={})),function(e){e.AUDIO="audio",e.VIDEO="video",e.NONE="none"}(z||(z={})),function(e){e.MINUTES="minutes",e.HOURS="hours",e.DAYS="days",e.WEEK="weeks"}(q||(q={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(B||(B={})),function(e){e.JSON="json",e.TEXT="text"}(G||(G={})),function(e){e.APNS="apns",e.VOIP="apns_voip",e.GCM="gcm",e.WEB="web"}(H||(H={})),function(e){e.IOS="ios",e.ANDROID="android",e.WEB="web"}(X||(X={})),function(e){e.DEV="development",e.PROD="production"}(Q||(Q={}));class K{constructor(){this.version=r,this.creds={appId:"",authKey:""},this.endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},this.chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},this.chat={streamManagement:{enable:!1},reconnect:{enable:!0,timeInterval:5}},this.videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},this.conference={server:"wss://janus.connectycube.com:8989",debug:L.ALL},this.whiteboard={server:"https://whiteboard.connectycube.com"},this.linkpreview={server:"https://linkpreview.connectycube.com"},this.urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",unfurl:"unfurl",calls:"calls",type:".json"},this.on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0},this.timeout=null,this.debug={mode:1}}static getInstance(){return K.instance||(K.instance=new K),K.instance}set(e){e.endpoints&&e.endpoints.chat&&(this.endpoints.muc=`muc.${e.endpoints.chat}`,this.chatProtocol.bosh=`https://${e.endpoints.chat}:5281`,this.chatProtocol.websocket=`wss://${e.endpoints.chat}:5291`),Object.keys(e).forEach(t=>{if("set"!==t&&this.hasOwnProperty(t)){const r=e[t];"object"==typeof r&&null!==r?Object.keys(r).forEach(e=>{this[t]?.hasOwnProperty(e)&&(this[t][e]=r[e])}):this[t]=r}})}}var Y=K.getInstance();class Z{static safeCallbackCall(e=()=>{}){return(...t)=>{if("function"==typeof e)try{e(...t)}catch(t){console.error("Error in listener:",t,`Check the code:\n>>>\n${e.toString()}\n<<<`)}}}static getUrl(e,t,r){const n=t?`/${t}`:"",s=r?`/${r}`:"";return`https://${Y.endpoints.api}/${e}${n}${s}${Y.urls.type}`}static isArray(e){return Array.isArray(e)}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static getBsonObjectId(){const e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),r=(e.increment++).toString(16);return parseInt(r,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+r.padStart(6,"0")}static DLog(...e){if(Z.loggers.length>0)return void Z.loggers.forEach(t=>t(e));if("object"==typeof Y.debug){(Array.isArray(Y.debug.mode)?Y.debug.mode:[Y.debug.mode]).forEach(e=>{1===e&&Z.loggers.push(e=>{console.log(...e)})})}Z.loggers.forEach(t=>t(e))}static callTrafficUsageCallback(e,t){if("function"==typeof Y.on[e]){const r=e=>new Blob([e]).size,n=(e={})=>{const{body:t,headers:n}=e;let s=0;return t&&(s+=r("string"==typeof t?t:JSON.stringify(t))),n&&(s+=r(JSON.stringify(n))),s};Y.on[e](n(t))}}static cloneObject(e={},t=!1){try{const r=JSON.stringify(e),n=t?r.replace(/null/g,'""'):r;return JSON.parse(n)}catch{return e}}}Z.loggers=[],Z.env={isReactNative:i,isBrowser:n,isNodeJS:s,isExpo:o};class ee{constructor(e){this.route=Y.urls.addressbook,this.proxy=e}async uploadAddressBook(e=[],t={}){if(!Z.isArray(e))throw new Error("First parameter must be an Array.");const r={type:B.POST,url:Z.getUrl(this.route),data:{contacts:e,...t}};return this.proxy.ajax(r)}async get(e){const t={type:B.GET,url:Z.getUrl(this.route),data:e?{udid:e}:void 0};return this.proxy.ajax(t)}async getRegisteredUsers(e=!1){const t={type:B.GET,url:Z.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e};return this.proxy.ajax(t)}}class te{constructor(e){this.routes={session:Y.urls.session,login:Y.urls.login},this.setSession=e=>{this.proxy.setSession(e)},this.getSession=async()=>{try{const e={type:B.GET,url:Z.getUrl(this.routes.session)};return(await this.proxy.ajax(e)).session}catch(e){throw e}},this.createSession=async(e={})=>{if(""===Y.creds.appId||""===Y.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');try{const t={type:B.POST,url:Z.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},r=await this.proxy.ajax(t);return this.proxy.setSession(r.session),this.proxy.setCurrentUserId(r.session.user_id),r.session}catch(e){throw e}},this.destroySession=async()=>{try{const e={type:B.DELETE,url:Z.getUrl(this.routes.session),dataType:G.TEXT};await this.proxy.ajax(e),this.proxy.setSession(null),this.proxy.setCurrentUserId(null)}catch(e){throw e}},this.login=async e=>{try{const t={type:B.POST,url:Z.getUrl(this.routes.login),data:e},{user:r}=await this.proxy.ajax(t);return this.proxy.setCurrentUserId(r.id),r}catch(e){throw e}},this.logout=async()=>{const e={type:B.DELETE,url:Z.getUrl(this.routes.login),dataType:G.TEXT};return this.proxy.setCurrentUserId(null),this.proxy.ajax(e)},this.proxy=e}generateCreateSessionParams(e={}){const t={application_id:Y.creds.appId,auth_key:Y.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t}}function re(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function ne(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var r=function e(){var r=!1;try{r=this instanceof e}catch{}return r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),r}var se,ie,oe,ae,ce,le,de,ue,he={},pe={};function me(){return ie?se:(ie=1,se=class extends Error{constructor(e){super(e),this.name="TimeoutError"}})}function fe(){return ae||(ae=1,oe=function(e){let t;const r=new Promise(r=>{t=setTimeout(r,e)});return r.timeout=t,r}),oe}function ge(){if(le)return ce;le=1;const e=me(),t=fe();return ce=function(r,n){const s=t(n);return Promise.race([r.finally(function(){clearTimeout(s.timeout)}),s.then(()=>{throw new e})])},ce}function ye(){if(ue)return de;ue=1;const e=me();return de=function(t,r,n="error",s){return new Promise((i,o)=>{let a;const c=()=>{clearTimeout(a),t.removeListener(r,d),t.removeListener(n,l)};function l(e){o(e),c()}function d(e){i(e),c()}t.once(r,d),n&&t.once(n,l),s&&(a=setTimeout(()=>{c(),o(new e)},s))})},de}var be,Ce,ve,Se,we={exports:{}};function Ee(){return be||(be=1,function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}function s(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new s(n,i||e,o),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),a.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,o=new Array(i);s<i;s++)o[s]=n[s].fn;return o},a.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,s,i,o){var a=r?r+e:e;if(!this._events[a])return!1;var c,l,d=this._events[a],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,s),!0;case 5:return d.fn.call(d.context,t,n,s,i),!0;case 6:return d.fn.call(d.context,t,n,s,i,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,n);break;case 4:d[l].fn.call(d[l].context,t,n,s);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c)}}return!0},a.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,n,s){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||s&&!a.once||n&&a.context!==n||o(this,i);else{for(var c=0,l=[],d=a.length;c<d;c++)(a[c].fn!==t||s&&!a[c].once||n&&a[c].context!==n)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a}(we)),we.exports}function Te(){return ve||(ve=1,Ce=function(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}),Ce}function Ie(){if(Se)return pe;Se=1;const e=ge(),t=fe(),r=me(),n=ye(),s=Ee(),i=Te();return pe.EventEmitter=s,pe.timeout=e,pe.delay=t,pe.TimeoutError=r,pe.promise=n,pe.Deferred=i,pe}var ke,xe,Ae,De,Oe,Re,Pe={exports:{}},Le={};function _e(){return ke||(ke=1,Le.detect=function(e){if(!e)return!1;return-1!==e.replaceAll(String.raw`\20`,"").replaceAll(String.raw`\22`,"").replaceAll(String.raw`\26`,"").replaceAll(String.raw`\27`,"").replaceAll(String.raw`\2f`,"").replaceAll(String.raw`\3a`,"").replaceAll(String.raw`\3c`,"").replaceAll(String.raw`\3e`,"").replaceAll(String.raw`\40`,"").replaceAll(String.raw`\5c`,"").search(/[ "&'/:<>@\\]/g)},Le.escape=function(e){return null===e?null:e.replaceAll(/^\s+|\s+$/g,"").replaceAll("\\",String.raw`\5c`).replaceAll(" ",String.raw`\20`).replaceAll('"',String.raw`\22`).replaceAll("&",String.raw`\26`).replaceAll("'",String.raw`\27`).replaceAll("/",String.raw`\2f`).replaceAll(":",String.raw`\3a`).replaceAll("<",String.raw`\3c`).replaceAll(">",String.raw`\3e`).replaceAll("@",String.raw`\40`)},Le.unescape=function(e){return null===e?null:e.replaceAll(String.raw`\20`," ").replaceAll(String.raw`\22`,'"').replaceAll(String.raw`\26`,"&").replaceAll(String.raw`\27`,"'").replaceAll(String.raw`\2f`,"/").replaceAll(String.raw`\3a`,":").replaceAll(String.raw`\3c`,"<").replaceAll(String.raw`\3e`,">").replaceAll(String.raw`\40`,"@").replaceAll(String.raw`\5c`,"\\")}),Le}function je(){if(Ae)return xe;Ae=1;const e=_e();class t{constructor(e,t,r){if("string"!=typeof t||!t)throw new TypeError("Invalid domain.");this.setDomain(t),this.setLocal("string"==typeof e?e:""),this.setResource("string"==typeof r?r:"")}[Symbol.toPrimitive](e){return"number"===e?NaN:this.toString()}toString(e){let t=this._domain;return this._local&&(t=this.getLocal(e)+"@"+t),this._resource&&(t=t+"/"+this._resource),t}bare(){return this._resource?new t(this._local,this._domain,null):this}equals(e){return this._local===e._local&&this._domain===e._domain&&this._resource===e._resource}setLocal(t,r){return(r=r||e.detect(t))&&(t=e.escape(t)),this._local=t&&t.toLowerCase(),this}getLocal(t=!1){let r=null;return r=t?e.unescape(this._local):this._local,r}setDomain(e){return this._domain=e.toLowerCase(),this}getDomain(){return this._domain}setResource(e){return this._resource=e,this}getResource(){return this._resource}}return Object.defineProperty(t.prototype,"local",{get:t.prototype.getLocal,set:t.prototype.setLocal}),Object.defineProperty(t.prototype,"domain",{get:t.prototype.getDomain,set:t.prototype.setDomain}),Object.defineProperty(t.prototype,"resource",{get:t.prototype.getResource,set:t.prototype.setResource}),xe=t}function Ne(){if(Re)return Pe.exports;Re=1;const e=je(),t=_e(),r=function(){if(Oe)return De;Oe=1;const e=je();return De=function(t){let r,n;const s=t.indexOf("/");-1!==s&&(n=t.slice(s+1),t=t.slice(0,s));const i=t.indexOf("@");return-1!==i&&(r=t.slice(0,i),t=t.slice(i+1)),new e(r,t,n)}}();function n(...t){return t[1]||t[2]?new e(...t):r(...t)}return Pe.exports=n.bind(),Pe.exports.jid=n,Pe.exports.JID=e,Pe.exports.equal=function(e,t){return e.equals(t)},Pe.exports.detectEscape=t.detect,Pe.exports.escapeLocal=t.escape,Pe.exports.unescapeLocal=t.unescape,Pe.exports.parse=r,Pe.exports}var Me,Ue,Je,Ve,$e,Fe,We,ze,qe,Be,Ge,He,Xe,Qe,Ke,Ye,Ze={exports:{}},et={};function tt(){if(Me)return et;Me=1;const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function t(t){return e[t]}const r={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function n(e){if("#"===e[1]){const t="x"===e[2]?parseInt(e.slice(3),16):parseInt(e.slice(2),10);if(9===t||10===t||13===t||t>=32&&t<=55295||t>=57344&&t<=65533||t>=65536&&t<=1114111)return String.fromCodePoint(t);throw new Error("Illegal XML character 0x"+t.toString(16))}if(r[e])return r[e]||e;throw new Error("Illegal XML entity "+e)}return et.escapeXML=function(e){return e.replace(/["&'<>]/g,t)},et.escapeXMLText=function(e){return e.replace(/[&<>]/g,t)},et.unescapeXML=function(e){let t="",r=-1,s=-1,i=0;for(;-1!==(r=e.indexOf("&",i))&&-1!==(s=e.indexOf(";",r+1));)t=t+e.slice(i,r)+n(e.slice(r,s+1)),i=s+1;return 0===i?e:(t+=e.substring(i),t)},et.unescapeXMLText=function(e){return e.replace(/&(amp|#38|lt|#60|gt|#62);/g,n)},et}function rt(){if(Je)return Ue;Je=1;var e=tt();class t{constructor(e,t){this.name=e,this.parent=null,this.children=[],this.attrs={},this.setAttrs(t)}is(e,t){return this.getName()===e&&(!t||this.getNS()===t)}getName(){const e=this.name.indexOf(":");return e>=0?this.name.slice(e+1):this.name}getNS(){const e=this.name.indexOf(":");if(e>=0){const t=this.name.slice(0,e);return this.findNS(t)}return this.findNS()}findNS(e){if(e){const t="xmlns:"+e;if(this.attrs[t])return this.attrs[t];if(this.parent)return this.parent.findNS(e)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}}getXmlns(){let e={};this.parent&&(e=this.parent.getXmlns());for(const t in this.attrs){const r=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&r&&(e[this.attrs[t]]=r[1])}return e}setAttrs(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.assign(this.attrs,e)}getAttr(e,t){if(!t)return this.attrs[e];const r=this.getXmlns();return r[t]?this.attrs[[r[t],e].join(":")]:null}getChild(e,t){return this.getChildren(e,t)[0]}getChildren(e,t){const r=[];for(const n of this.children)!n.getName||n.getName()!==e||t&&n.getNS()!==t||r.push(n);return r}getChildByAttr(e,t,r,n){return this.getChildrenByAttr(e,t,r,n)[0]}getChildrenByAttr(e,t,r,n){let s=[];for(const i of this.children)!i.attrs||i.attrs[e]!==t||r&&i.getNS()!==r||s.push(i),n&&i.getChildrenByAttr&&s.push(i.getChildrenByAttr(e,t,r,!0));return n&&(s=s.flat()),s}getChildrenByFilter(e,t){let r=[];for(const n of this.children)e(n)&&r.push(n),t&&n.getChildrenByFilter&&r.push(n.getChildrenByFilter(e,!0));return t&&(r=r.flat()),r}getText(){let e="";for(const t of this.children)"string"!=typeof t&&"number"!=typeof t||(e+=t);return e}getChildText(e,t){const r=this.getChild(e,t);return r?r.getText():null}getChildElements(){return this.getChildrenByFilter(e=>e instanceof t)}root(){return this.parent?this.parent.root():this}up(){return this.parent?this.parent:this}c(e,r){return this.cnode(new t(e,r))}cnode(e){return this.children.push(e),"object"==typeof e&&(e.parent=this),e}append(...e){for(const t of e)this.children.push(t),"object"==typeof t&&(t.parent=this)}prepend(...e){for(const t of e)this.children.unshift(t),"object"==typeof t&&(t.parent=this)}t(e){return this.children.push(e),this}remove(e,t){const r="string"==typeof e?r=>!(r.is&&r.is(e,t)):t=>t!==e;return this.children=this.children.filter(r),this}text(e){return e&&1===this.children.length?(this.children[0]=e,this):this.getText()}attr(e,t){return void 0!==t||null===t?(this.attrs||(this.attrs={}),this.attrs[e]=t,this):this.attrs[e]}toString(){let e="";return this.write(t=>{e+=t}),e}_addChildren(t){t(">");for(const r of this.children)null!=r&&(r.write?r.write(t):"string"==typeof r?t(e.escapeXMLText(r)):r.toString&&t(e.escapeXMLText(r.toString(10))));t("</"),t(this.name),t(">")}write(t){t("<"),t(this.name);for(const r in this.attrs){const n=this.attrs[r];null!=n&&(t(" "),t(r),t('="'),t(e.escapeXML("string"==typeof n?n:n.toString(10))),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)}}return t.prototype.tree=t.prototype.root,Ue=t}function nt(){return qe?ze:(qe=1,ze=class extends Error{constructor(...e){super(...e),this.name="XMLError"}})}function st(){if(Ge)return Be;Ge=1;const e=function(){if(We)return Fe;We=1;var e=Ee(),t=tt();class r extends e.EventEmitter{constructor(){super();let e,r,n,s,i,o,a,c,l,d=0,u=0;this._handleTagOpening=function(e,t,r){e?this.emit("endElement",t,!1):(this.emit("startElement",t,r),o&&this.emit("endElement",t,!0))},this.write=function(h){"string"!=typeof h&&(h=h.toString());let p=0;function m(){if("number"==typeof u){const e=h.slice(u,p);return u=void 0,e}}for(e&&(h=e+h,p+=r?0:e.length,r=!1,e=null);p<h.length;p++){switch(d){case 0:{const e=h.indexOf("<",p);-1!==e&&p!==e&&(p=e);break}case 8:{const e=h.indexOf(c,p);-1!==e&&(p=e);break}case 1:{const e=h.indexOf("--\x3e",p);-1!==e&&(p=e+2);break}case 10:{const e=h.indexOf("]]>",p);-1!==e&&(p=e+2);break}}const e=h.charCodeAt(p);switch(d){case 0:if(60===e){const e=m();e&&this.emit("text",t.unescapeXML(e)),d=3,u=p+1,s={}}break;case 9:if(93===e)if("]>"===h.substr(p+1,2)){const e=m();e&&this.emit("text",e),d=0}else h.length<p+2&&(r=!0,p=h.length);break;case 3:47===e&&u===p?(u=p+1,i=!0):33===e?"[CDATA["===h.substr(p+1,7)?(u=p+8,d=9):h.length<p+8&&"[CDATA[".startsWith(h.slice(p+1))?(r=!0,p=h.length):(u=void 0,d=1):63===e?(u=void 0,d=2):(e<=32||47===e||62===e)&&(n=m(),p--,d=4);break;case 1:if(62===e){const e=h.charCodeAt(p-1),t=h.charCodeAt(p-2);(45===e&&45===t||93===e&&93===t)&&(d=0)}break;case 2:62===e&&63===h.charCodeAt(p-1)&&(d=0);break;case 4:62===e?(this._handleTagOpening(i,n,s),n=void 0,s=void 0,i=void 0,o=void 0,d=0,u=p+1):47===e?o=!0:e>32&&(u=p,d=5);break;case 5:(e<=32||61===e)&&(l=m(),p--,d=6);break;case 6:61===e&&(d=7);break;case 7:34!==e&&39!==e||(a=e,c=34===e?'"':"'",d=8,u=p+1);break;case 8:if(e===a){const e=t.unescapeXML(m());s[l]=e,l=void 0,d=4}}}"number"==typeof u&&u<=h.length&&(e=h.slice(u),u=0)}}end(e){e&&this.write(e),this.write=function(){}}}return Fe=r}(),t=rt(),r=Ee(),n=nt();class s extends r{constructor(){super();const t=new e;this.root=null,this.cursor=null,t.on("startElement",this.onStartElement.bind(this)),t.on("endElement",this.onEndElement.bind(this)),t.on("text",this.onText.bind(this)),this.parser=t}onStartElement(e,r){const n=new t(e,r),{root:s,cursor:i}=this;s?i!==s&&i.append(n):(this.root=n,this.emit("start",n)),this.cursor=n}onEndElement(e){const{root:t,cursor:r}=this;if(e===r.name){if(r!==t)return r.parent?void(this.cursor=r.parent):(r.parent=t,this.emit("element",r),void(this.cursor=t));this.emit("end",t)}else this.emit("error",new n(`${r.name} must be closed.`))}onText(e){const{cursor:t}=this;t?t.t(e):this.emit("error",new n(`${e} must be a child.`))}write(e){this.parser.write(e)}end(e){e&&this.parser.write(e)}}return s.XMLError=n,Be=s}function it(){return He||(He=1,function(e){const t=rt(),r=function(){if($e)return Ve;$e=1;var e=rt();function t(e,r){if(Array.isArray(r))for(const n of r)t(e,n);else""!==r&&null!=r&&!0!==r&&!1!==r&&e.cnode(r)}return Ve=function(r,n,...s){if("object"==typeof n&&null!==n){delete n.__source,delete n.__self;for(const[e,t]of Object.entries(n))null==t?delete n[e]:n[e]=t.toString(10)}const i=new e(r,n);for(const e of s)t(i,e);return i}}(),n=st(),{escapeXML:s,unescapeXML:i,escapeXMLText:o,unescapeXMLText:a}=tt(),c=nt();e.exports=function(...e){return r(...e)},Object.assign(e.exports,{Element:t,createElement:r,Parser:n,escapeXML:s,unescapeXML:i,escapeXMLText:o,unescapeXMLText:a,XMLError:c})}(Ze)),Ze.exports}function ot(){if(Qe)return Xe;Qe=1;class e extends Error{constructor(e,t,r){super(e+(t?` - ${t}`:"")),this.name="XMPPError",this.condition=e,this.text=t,this.application=r}static fromElement(e){const[t,r,n]=e.getChildElements();let s,i;r&&(r.is("text")?s=r:r&&(i=r),n&&(i=n));const o=new this(t.name,s?s.text():"",i);return o.element=e,o}}return Xe=e}var at,ct,lt,dt,ut,ht,pt={exports:{}};function mt(){if(lt)return ct;lt=1;const{EventEmitter:e,promise:t}=Ie(),r=Ne(),n=it(),s=function(){if(Ye)return Ke;Ye=1;const e=ot();return Ke=class extends e{constructor(...e){super(...e),this.name="StreamError"}}}(),{parseHost:i,parseService:o}=(at||(at=1,function(e){function t(e){let{port:t,hostname:r,protocol:n}=new URL(e);return"[::1]"===r&&(r="::1"),{port:t,hostname:r,protocol:n}}function r(e){const{port:r,hostname:n}=t(`http://${e}`);return{port:r,hostname:n}}Object.assign(e.exports,{parseURI:t,parseHost:r,parseService:function(e){return e.includes("://")?t(e):r(e)}})}(pt)),pt.exports);class a extends e{constructor(e={}){super(),this.jid=null,this.timeout=2e3,this.options=e,this.socketListeners=Object.create(null),this.parserListeners=Object.create(null),this.status="offline",this.socket=null,this.parser=null,this.root=null}_reset(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()}async _streamError(e,t){try{await this.send(n("stream:error",{},[n(e,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},t)]))}catch{}return this._end()}_onData(e){const t=e.toString("utf8");this.emit("input",t),this.parser.write(t)}_onParserError(e){this._streamError("bad-format"),this._detachParser(),this.emit("error",e)}_attachSocket(e){this.socket=e;const t=this.socketListeners;t.data=this._onData.bind(this),t.close=(e,t)=>{this._reset(),this._status("disconnect",{clean:!e,event:t})},t.connect=()=>{this._status("connect")},t.error=e=>{this.emit("error",e)},this.socket.on("close",t.close),this.socket.on("data",t.data),this.socket.on("error",t.error),this.socket.on("connect",t.connect)}_detachSocket(){const{socketListeners:e,socket:t}=this;for(const r of Object.getOwnPropertyNames(e))t.removeListener(r,e[r]),delete e[r];return this.socket=null,t}_onElement(e){const t=e.is("error","http://etherx.jabber.org/streams");t&&this._onStreamError(e),this.emit("element",e),this.emit(this.isStanza(e)?"stanza":"nonza",e),t&&this._end()}_onStreamError(e){const t=s.fromElement(e);if("see-other-host"===t.condition)return this._onSeeOtherHost(t);this.emit("error",t)}async _onSeeOtherHost(e){const{protocol:r}=o(this.options.service),n=e.element.getChildText("see-other-host"),{port:s}=i(n);let a;a=s?`${r||"xmpp:"}//${n}`:(r?`${r}//`:"")+n;try{await t(this,"disconnect");const{domain:e,lang:r}=this.options;await this.connect(a),await this.open({domain:e,lang:r})}catch(e){this.emit("error",e)}}_attachParser(e){this.parser=e;const t=this.parserListeners;t.element=this._onElement.bind(this),t.error=this._onParserError.bind(this),t.end=e=>{this._detachParser(),this._status("close",e)},t.start=e=>{this._status("open",e)},this.parser.on("error",t.error),this.parser.on("element",t.element),this.parser.on("end",t.end),this.parser.on("start",t.start)}_detachParser(){const e=this.parserListeners;for(const t of Object.getOwnPropertyNames(e))this.parser.removeListener(t,e[t]),delete e[t];this.parser=null}_jid(e){return this.jid=r(e),this.jid}_status(e,...t){this.status=e,this.emit("status",e,...t),this.emit(e,...t)}async _end(){let e;try{e=await this.close()}catch{}try{await this.disconnect()}catch{}return e}async start(){if("offline"!==this.status)throw new Error("Connection is not offline");const{service:e,domain:r,lang:n}=this.options;await this.connect(e);const s=t(this,"online");return await this.open({domain:r,lang:n}),s}async connect(e){this._status("connecting",e);const r=new this.Socket;return this._attachSocket(r),r.connect(this.socketParameters(e)),t(r,"connect")}async disconnect(e=this.timeout){this.socket&&this._status("disconnecting"),this.socket.end(),await t(this.socket,"close","error",e)}async open(e){this._status("opening"),"string"==typeof e&&(e={domain:e});const{domain:r,lang:n,timeout:s=this.timeout}=e,i=this.headerElement();return i.attrs.to=r,i.attrs["xml:lang"]=n,this.root=i,this._attachParser(new this.Parser),await this.write(this.header(i)),t(this,"open","error",s)}async stop(){const e=await this._end();return"offline"!==this.status&&this._status("offline",e),e}async close(e=this.timeout){const r=this.footer(this.footerElement()),n=Promise.all([t(this.parser,"end","error",e),this.write(r)]);this.parser&&this.socket&&this._status("closing");const[s]=await n;return this.root=null,s}async restart(){this._detachParser();const{domain:e,lang:t}=this.options;return this.open({domain:e,lang:t})}async send(e){e.parent=this.root,await this.write(e.toString()),this.emit("send",e)}sendReceive(e,r=this.timeout){return Promise.all([this.send(e),t(this,"element","error",r)]).then(([,e])=>e)}write(e){return new Promise((t,r)=>{"closing"!==this.status?this.socket.write(e,n=>{if(n)return r(n);this.emit("output",e),t()}):r(new Error("Connection is closing"))})}isStanza(e){const{name:t}=e;return"iq"===t||"message"===t||"presence"===t}isNonza(e){return!this.isStanza(e)}header(e){return e.toString()}headerElement(){return new n.Element("",{version:"1.0",xmlns:this.NS})}footer(e){return e.toString()}footerElement(){}socketParameters(){}}return a.prototype.NS="",a.prototype.Socket=null,a.prototype.Parser=null,ct=a}var ft,gt,yt=function(){if(ht)return he;ht=1;const e=function(){if(ut)return dt;ut=1;const e=mt();class t extends e{constructor(e){super(e),this.transports=[]}send(e,...t){return this.Transport.prototype.send.call(this,e,...t)}sendMany(...e){return this.Transport.prototype.sendMany.call(this,...e)}_findTransport(e){return this.transports.find(t=>{try{return void 0!==t.prototype.socketParameters(e)}catch{return!1}})}connect(e){const t=this._findTransport(e);if(!t)throw new Error("No compatible connection method found.");return this.Transport=t,this.Socket=t.prototype.Socket,this.Parser=t.prototype.Parser,super.connect(e)}socketParameters(...e){return this.Transport.prototype.socketParameters(...e)}header(...e){return this.Transport.prototype.header(...e)}headerElement(...e){return this.Transport.prototype.headerElement(...e)}footer(...e){return this.Transport.prototype.footer(...e)}footerElement(...e){return this.Transport.prototype.footerElement(...e)}}return t.prototype.NS="jabber:client",dt=t}(),t=it(),r=Ne();return he.Client=e,he.xml=t,he.jid=r,he}();var bt,Ct,vt,St,wt,Et,Tt,It,kt=function(){if(gt)return ft;gt=1;const{EventEmitter:e}=Ie();class t extends e{constructor(e){super(),this.delay=1e3,this.entity=e,this._timeout=null}scheduleReconnect(){const{entity:e,delay:t,_timeout:r}=this;clearTimeout(r),this._timeout=setTimeout(async()=>{if("disconnect"===e.status)try{await this.reconnect()}catch{}},t)}async reconnect(){const{entity:e}=this;this.emit("reconnecting");const{service:t,domain:r,lang:n}=e.options;await e.connect(t),await e.open({domain:r,lang:n}),this.emit("reconnected")}start(){const{entity:e}=this,t={};t.disconnect=()=>{this.scheduleReconnect()},this.listeners=t,e.on("disconnect",t.disconnect)}stop(){const{entity:e,listeners:t,_timeout:r}=this;e.removeListener("disconnect",t.disconnect),clearTimeout(r)}}return ft=function({entity:e}){const r=new t(e);return r.start(),r}}(),xt=re(kt),At=ne(Object.freeze({__proto__:null,default:{}}));function Dt(){if(Et)return wt;Et=1;const e=function(){if(Ct)return bt;Ct=1;const e=At,t=globalThis.WebSocket||e,r=Ee(),n="ECONNERROR";return bt=class extends r{constructor(){super(),this.listeners=Object.create(null)}connect(e){this.url=e,this._attachSocket(new t(e,["xmpp"]))}_attachSocket(e){this.socket=e;const{listeners:t}=this;t.open=()=>{this.emit("connect")},t.message=({data:e})=>this.emit("data",e),t.error=e=>{const{url:t}=this;let{error:r}=e;r||(r=new Error(`WebSocket ${n} ${t}`),r.errno=n,r.code=n),r.event=e,r.url=t,this.emit("error",r)},t.close=e=>{this._detachSocket(),this.emit("close",!e.wasClean,e)},this.socket.addEventListener("open",t.open),this.socket.addEventListener("message",t.message),this.socket.addEventListener("error",t.error),this.socket.addEventListener("close",t.close)}_detachSocket(){delete this.url;const{socket:e,listeners:t}=this;for(const r of Object.getOwnPropertyNames(t))e.removeEventListener(r,t[r]),delete t[r];delete this.socket}end(){this.socket.close()}write(r,n){t===e?this.socket.send(r,n):(this.socket.send(r),n())}},bt}(),t=mt(),r=it(),n=function(){if(St)return vt;St=1;const{Parser:e,Element:t,XMLError:r}=it();return vt=class extends e{onStartElement(e,r){const n=new t(e,r),{cursor:s}=this;s&&s.append(n),this.cursor=n}onEndElement(e){const{cursor:t}=this;e===t.name?t.parent?this.cursor=t.parent:(t.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",t):t.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",t):this.emit("element",t),this.cursor=null):this.emit("error",new r(`${t.name} must be closed.`))}}}(),s="urn:ietf:params:xml:ns:xmpp-framing";class i extends t{send(e,...t){return!e.attrs.xmlns&&super.isStanza(e)&&(e.attrs.xmlns="jabber:client"),super.send(e,...t)}async sendMany(e){for(const t of e)await this.send(t)}footerElement(){return new r.Element("close",{xmlns:s})}headerElement(){const e=super.headerElement();return e.name="open",e.attrs.xmlns=s,e}socketParameters(e){return/^wss?:\/\//.test(e)?e:void 0}}return i.prototype.Socket=e,i.prototype.NS="jabber:client",i.prototype.Parser=n,wt=i}var Ot,Rt,Pt,Lt,_t,jt,Nt,Mt,Ut,Jt,Vt=re(function(){if(It)return Tt;It=1;const e=Dt();return Tt=function({entity:t}){t.transports.push(e)}}());function $t(){return Lt||(Lt=1,Pt=class{constructor(e,t){this.stanza=t,this.entity=e;const{name:r,attrs:n}=t,{type:s,id:i}=n;this.name=r,this.id=i||"",this.type="message"===r?s||"normal":"presence"===r?s||"available":s||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}}),Pt}var Ft,Wt,zt,qt,Bt=function(){if(Jt)return Ut;Jt=1;const e=(Rt||(Rt=1,Ot=function(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return function(t,r){let n=-1;return function s(i){if(i<=n)return Promise.reject(new Error("next() called multiple times"));n=i;let o=e[i];if(i===e.length&&(o=r),!o)return Promise.resolve();try{return Promise.resolve(o(t,s.bind(null,i+1)))}catch(e){return Promise.reject(e)}}(0)}}),Ot),t=function(){if(jt)return _t;jt=1;const e=$t(),t=Ne();return _t=class extends e{constructor(e,r){super(e,r);const{jid:n,domain:s}=e,i=r.attrs.to||n&&n.toString(),o=r.attrs.from||s;i&&(this.to=new t(i)),o&&(this.from=new t(o),this.local=this.from.local,this.domain=this.from.domain,this.resource=this.from.resource)}},_t}(),r=function(){if(Mt)return Nt;Mt=1;const e=$t(),t=Ne();return Nt=class extends e{constructor(e,r){super(e,r);const{jid:n,domain:s}=e,i=r.attrs.from||n&&n.toString(),o=r.attrs.to||s;i&&(this.from=new t(i)),o&&(this.to=new t(o),this.local=this.to.local,this.domain=this.to.domain,this.resource=this.to.resource)}},Nt}();function n(t,r,n){return s=>{const i=new n(t,s);return e(r)(i)}}function s(e){return(t,r)=>{r().then(t=>t&&e.send(t)).catch(t=>e.emit("error",t))}}return Ut=function({entity:e}){const i=[s(e)],o=[],a=n(e,i,t),c=n(e,o,r);return e.on("element",a),e.hookOutgoing=c,{use:e=>(i.push(e),e),filter:e=>(o.push(e),e)}}}(),Gt=re(Bt);function Ht(){return Wt?Ft:(Wt=1,Ft=function(){return async({stanza:e,entity:t},r)=>{if(!e.is("features","http://etherx.jabber.org/streams"))return r();!await r()&&t.jid&&t._status("online",t.jid)}})}var Xt,Qt,Kt,Yt,Zt,er,tr=function(){if(qt)return zt;qt=1;const e=Ht();return zt=function({middleware:t}){return t.use(e()),{use:function(e,r,n){return t.use((t,s)=>{const{stanza:i}=t;if(!i.is("features","http://etherx.jabber.org/streams"))return s();const o=i.getChild(e,r);return o?n(t,s,o):s()})}}},zt}(),rr=re(tr);var nr,sr,ir=function(){if(er)return Zt;er=1;const e=Qt?Xt:(Qt=1,Xt=function(){let e;for(;!e;)e=Math.random().toString(36).slice(2,12);return e}),t=function(){if(Yt)return Kt;Yt=1;const e=ot();return Kt=class extends e{constructor(e,t,r,n){super(e,t,r),this.type=n,this.name="StanzaError"}static fromElement(e){const t=super.fromElement(e);return t.type=e.attrs.type,t}},Kt}(),{Deferred:r}=Ie(),n=Ie().timeout,s=it();class i{constructor({entity:e,middleware:t}){this.handlers=new Map,this.entity=e,this.middleware=t}start(){this.middleware.use(this._route.bind(this))}_route({type:e,name:r,id:n,stanza:s},i){if(!function({name:e,type:t}){return"iq"===e&&("error"===t||"result"===t)}({name:r,type:e}))return i();const o=this.handlers.get(n);if(!o)return i();"error"===e?o.reject(t.fromElement(s.getChild("error"))):o.resolve(s),this.handlers.delete(n)}async request(t,s=3e4){t.attrs.id||(t.attrs.id=e());const i=new r;this.handlers.set(t.attrs.id,i);try{await this.entity.send(t),await n(i.promise,s)}catch(e){throw this.handlers.delete(t.attrs.id),e}return i.promise}_childRequest(e,t,r,...n){const{name:i,attrs:{xmlns:o}}=t;return this.request(s("iq",{type:e,to:r},t),...n).then(e=>e.getChild(i,o))}async get(...e){return this._childRequest("get",...e)}async set(...e){return this._childRequest("set",...e)}}return Zt=function(...e){const t=new i(...e);return t.start(),t}}(),or=re(ir);var ar,cr,lr=function(){if(sr)return nr;sr=1;const e=it();function t({stanza:t}){return e("iq",{to:t.attrs.from,from:t.attrs.to,id:t.attrs.id})}function r(e,r,n){const s=t(e);return s.attrs.type="error",n&&s.append(n),s.append(r),s}function n(t,r){return e("error",{type:t},e(r,"urn:ietf:params:xml:ns:xmpp-stanzas"))}function s(s){return async function(i,o){if(!function({name:e,type:t}){return"iq"===e&&"error"!==t&&"result"!==t}(i))return o();const{stanza:a}=i,c=a.getChildElements(),[l]=c;if(!function({type:e},t,r){return("get"===e||"set"===e)&&1===t.length&&!!r}(i,c,l))return r(i,n("modify","bad-request"),l);let d;i.element=l;try{d=await o()}catch(e){s.emit("error",e),d=n("cancel","internal-server-error")}return d||(d=n("cancel","service-unavailable")),d instanceof e.Element&&d.is("error")?r(i,d,l):function(e,r){const n=t(e);return n.attrs.type="result",r&&n.append(r),n}(i,d instanceof e.Element?d:void 0)}}function i(e,t,r,n){return(s,i)=>s.type!==e|!s.element||!s.element.is(r,t)?i():n(s,i)}return nr=function({middleware:e,entity:t}){return e.use(s(t)),{get(t,r,n){e.use(i("get",t,r,n))},set(t,r,n){e.use(i("set",t,r,n))}}},nr}(),dr=re(lr),ur={exports:{}},hr={};function pr(){if(cr)return ar;cr=1;const e=st();return ar=function(t){const r=new e;let n=null,s=null;if(r.on("start",e=>{n=e}),r.on("element",e=>{n.append(e)}),r.on("error",e=>{s=e}),r.write(t),r.end(),s)throw s;return n},ar}var mr,fr,gr,yr,br,Cr={};function vr(){if(fr)return hr;fr=1;const t=globalThis.fetch||e,r=pr(),n=function(){if(mr)return Cr;function e(e){return e.startsWith("https")||e.startsWith("wss")}return mr=1,Cr.compare=function(t,r){let n,s;return n=e(t.uri)&&!e(r.uri)?-1:!e(t.uri)&&e(r.uri)?1:0,0!==n?n:(s=t.method===r.method?0:"websocket"===t.method?-1:"websocket"===r.method?1:"xbosh"===t.method?-1:"xbosh"===r.method?1:"httppoll"===t.method?-1:"httppoll"===r.method?1:0,0!==s?s:0)},Cr}().compare;return hr.resolve=function(e){return t(`https://${e}/.well-known/host-meta`).then(e=>e.text()).then(e=>r(e).getChildren("Link").filter(e=>["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(e.attrs.rel)).map(({attrs:e})=>({rel:e.rel,href:e.href,method:e.rel.split(":").pop(),uri:e.href})).sort(n)).catch(()=>[])},hr}function Sr(){if(gr)return ur.exports;gr=1;const e=At,t=vr();return ur.exports=function(...r){return Promise.all([e.resolve?e.resolve(...r):Promise.resolve([]),t.resolve(...r)]).then(([e,t])=>[...e,...t])},e.resolve&&(ur.exports.dns=e),ur.exports.http=t,ur.exports}var wr,Er,Tr,Ir=function(){if(br)return yr;br=1;const e=Sr(),{promise:t}=Ie();async function r(t){const r=await e(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]});return[...new Set(r.map(e=>e.uri))]}async function n(e,r){if(0===r.length)throw new Error("Couldn't connect");const s=r.shift(),i=e._findTransport(s);if(!i)return n(e,r);e._status("connecting",s);const o=i.prototype.socketParameters(s),a=new i.prototype.Socket;try{a.connect(o),await t(a,"connect")}catch{return n(e,r)}e._attachSocket(a),a.emit("connect"),e.Transport=i,e.Socket=i.prototype.Socket,e.Parser=i.prototype.Parser}return yr=function({entity:e}){const t=e.connect;e.connect=async function(s){if(!s||/:\/\//.test(s))return t.call(this,s);const i=function(e,t){return t.filter(t=>e._findTransport(t))}(e,await r(s));if(0===i.length)throw new Error("No compatible transport found.");try{await n(e,i)}catch(t){throw e._reset(),e._status("disconnect"),t}}}}(),kr=re(Ir),xr={};var Ar,Dr={exports:{}},Or={exports:{}};var Rr,Pr,Lr;function _r(){return Rr||(Rr=1,function(e){!function(e,t,r){(t.exports=r).Factory=r}(0,e,(Ar||(Ar=1,function(e){!function(e,t){function r(){this._mechs=[]}r.prototype.use=function(e,t){return t||(e=(t=e).prototype.name),this._mechs.push({name:e,mech:t}),this},r.prototype.create=function(e){for(var t=0,r=this._mechs.length;t<r;t++)for(var n=0,s=e.length;n<s;n++){var i=this._mechs[t];if(i.name==e[n])return new i.mech}return null},t.exports=r}(0,e)}(Or)),Or.exports))}(Dr)),Dr.exports}var jr,Nr,Mr=function(){if(Lr)return Pr;Lr=1;const{encode:e,decode:t}=(wr||(wr=1,xr.encode=function(e){return globalThis.btoa(e)},xr.decode=function(e){return globalThis.atob(e)}),xr),r=function(){if(Tr)return Er;Tr=1;const e=ot();return Er=class extends e{constructor(...e){super(...e),this.name="SASLError"}}}(),n=it(),s=_r(),i="urn:ietf:params:xml:ns:xmpp-sasl";async function o(s,o,a,c){const l=s.create([a]);if(!l)throw new Error("No compatible mechanism");const{domain:d}=o.options,u={username:null,password:null,server:d,host:d,realm:d,serviceType:"xmpp",serviceName:d,...c};return new Promise((s,a)=>{const c=d=>{if(d.attrs.xmlns===i){if("challenge"===d.name){console.log(d,typeof d),l.challenge(t(d.text()));const r=l.response(u);return void o.send(n("response",{xmlns:i,mechanism:l.name},"string"==typeof r?e(r):""))}"failure"===d.name?a(r.fromElement(d)):"success"===d.name&&s(),o.removeListener("nonza",c)}};o.on("nonza",c),l.clientFirst&&o.send(n("auth",{xmlns:i,mechanism:l.name},e(l.response(u))))})}return Pr=function({streamFeatures:e},t){const r=new s;return e.use("mechanisms",i,async({stanza:e,entity:n})=>{const s=e.getChild("mechanisms",i).getChildElements().map(e=>e.text());const a=r._mechs.map(({name:e})=>e).filter(e=>s.includes(e));let c=a[0];"function"==typeof t?await t(e=>o(r,n,c,e),c):(t.username||t.password||(c="ANONYMOUS"),await o(r,n,c,t)),await n.restart()}),{use:(...e)=>r.use(...e)}},Pr}(),Ur=re(Mr);var Jr,Vr,$r=function(){if(Nr)return jr;Nr=1;const e=it(),t="urn:ietf:params:xml:ns:xmpp-bind";async function r(r,n,s){const i=await n.set(function(r){return e("bind",{xmlns:t},r&&e("resource",{},r))}(s)),o=i.getChildText("jid");return r._jid(o),o}return jr=function({streamFeatures:e,iqCaller:n},s){e.use("bind",t,function({iqCaller:e},t){return async({entity:n},s)=>{await("function"==typeof t?t(t=>r(n,e,t)):r(n,e,t)),s()}}({iqCaller:n},s))},jr}(),Fr=re($r);var Wr,zr=function(){if(Vr)return Jr;Vr=1;const e=it(),t="urn:ietf:params:xml:ns:xmpp-session";return Jr=function({iqCaller:r,streamFeatures:n}){n.use("session",t,async(n,s,i)=>(i.getChild("optional")||await r.set(e("session",t)),s()))},Jr}(),qr=re(zr),Br={exports:{}},Gr={exports:{}};var Hr,Xr,Qr;function Kr(){return Hr||(Hr=1,function(e){!function(e,t,r){(t.exports=r).Mechanism=r}(0,e,(Wr||(Wr=1,function(e){!function(e,t){function r(){}r.prototype.name="ANONYMOUS",r.prototype.clientFirst=!0,r.prototype.response=function(e){return e.trace||""},r.prototype.challenge=function(e){},t.exports=r}(0,e)}(Gr)),Gr.exports))}(Br)),Br.exports}var Yr,Zr=function(){if(Qr)return Xr;Qr=1;const e=Kr();return Xr=function(t){t.use(e)},Xr}(),en=re(Zr),tn={exports:{}},rn={exports:{}};var nn,sn,on;function an(){return nn||(nn=1,function(e){!function(e,t,r){(t.exports=r).Mechanism=r}(0,e,(Yr||(Yr=1,function(e){!function(e,t){function r(){}r.prototype.name="PLAIN",r.prototype.clientFirst=!0,r.prototype.response=function(e){var t="";return t+=e.authzid||"",t+="\0",t+=e.username,(t+="\0")+e.password},r.prototype.challenge=function(e){return this},t.exports=r}(0,e)}(rn)),rn.exports))}(tn)),tn.exports}var cn=function(){if(on)return sn;on=1;const e=an();return sn=function(t){t.use(e)},sn}(),ln=re(cn);const dn=yt.xml;class un{constructor(e){this.route=`${Y.urls.chat}/Dialog`,this.subscribeToPublic=this.subscribe,this.unsubscribeFromPublic=this.unsubscribe,this.proxy=e}async list(e={}){const t={type:B.GET,url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t=Z.cloneObject(e);Z.isArray(t?.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),Z.isArray(t?.admins_ids)&&(t.admins_ids=t.admins_ids.join(", "));const r={type:B.POST,url:Z.getUrl(this.route),data:t};return this.proxy.ajax(r)}async update(e,t={}){const r={type:B.PUT,url:Z.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e,t={}){const r="string"==typeof e?e.split(",").map(e=>e.trim()):e,n={type:B.DELETE,url:Z.getUrl(this.route,r.toString()),dataType:1===r.length?G.TEXT:G.JSON,data:t};return this.proxy.ajax(n)}async addAdmins(e,t){const r={type:B.PUT,url:Z.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}};return this.proxy.ajax(r)}async removeAdmins(e,t){const r={type:B.PUT,url:Z.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}};return this.proxy.ajax(r)}async subscribe(e){const t={type:B.POST,url:Z.getUrl(this.route,e,"subscribe")};return this.proxy.ajax(t)}async unsubscribe(e){const t={type:B.DELETE,url:Z.getUrl(this.route,e,"subscribe"),dataType:G.TEXT};return this.proxy.ajax(t)}async updateNotificationsSettings(e,t){const r={type:B.PUT,url:Z.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}};return this.proxy.ajax(r)}async getNotificationsSettings(e){const t={type:B.GET,url:Z.getUrl(this.route,e,"notifications")};return this.proxy.ajax(t)}async getPublicOccupants(e,t={}){const r={type:B.GET,url:Z.getUrl(this.route,e,"occupants"),data:t};return this.proxy.ajax(r)}async clearHistory(e){const t={type:B.DELETE,url:Z.getUrl(this.route,"clearHistory",e),dataType:G.TEXT};return this.proxy.ajax(t)}}class hn{constructor(e){this.route=`${Y.urls.chat}/Message`,this.proxy=e}async list(e={}){const t={url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t={url:Z.getUrl(this.route),type:B.POST,data:e};return this.proxy.ajax(t)}async update(e,t={}){const r={type:B.PUT,dataType:G.TEXT,url:Z.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e,t){const r={url:Z.getUrl(this.route,e),type:B.DELETE,dataType:G.TEXT,data:t};return this.proxy.ajax(r)}async createSystem(e){const t={type:B.POST,url:Z.getUrl(this.route,"system"),data:e};return this.proxy.ajax(t)}async unreadCount(e={}){const t=Z.cloneObject(e);t&&t.chat_dialog_ids&&Z.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", "));const r={url:Z.getUrl(this.route,"unread"),data:t};return this.proxy.ajax(r)}async listReactions(e="_"){const t={type:B.GET,dataType:G.JSON,url:Z.getUrl(this.route,e,"reactions")};return this.proxy.ajax(t)}async addReaction(e,t){return this.updateReaction(e,t)}async removeReaction(e,t){return this.updateReaction(e,void 0,t)}async updateReaction(e,t,r){return this.putReaction(e,{add:t,remove:r})}async putReaction(e,t){const r={type:B.PUT,dataType:G.TEXT,url:Z.getUrl(this.route,e,"reactions"),data:t};return this.proxy.ajax(r)}}class pn{static buildUserJid(e={}){const{userId:t,resource:r,jid:n}=e,s=Y.creds.appId,i=Y.endpoints.chat;return t?`${t}-${s}@${i}${r?`/${r}`:""}`:n}static buildUserJidLocalPart(e){return`${e}-${Y.creds.appId}`}static createMessageStanza(e){return dn("message",e)}static createIqStanza(e){return dn("iq",e)}static createPresenceStanza(e){return dn("presence",e)}static createNonza(e,t){return dn(e,t)}static getAttr(e,t){return e?.getAttr(t)||e?.attrs[t]||null}static getElement(e,t){return e?.getChild(t)}static getName(e){return e?.getName()||null}static getText(e){return e?.getText()||null}static getChildElements(e){return e?.getChildElements()||[]}static isErrorStanza(e){return!!e?.getChild("error")}static getAllElements(e,t){return e?.getChildren(t)||[]}static getElementText(e,t){return e?.getChildText(t)||null}static getElementTreePath(e,t){return t.reduce((e,t)=>e?pn.getElement(e,t):void 0,e)}static assignObjectToXml(e,t,r){return e=e.c(r),Object.keys(t).forEach(r=>{"object"==typeof t[r]?pn.assignObjectToXml(e,t[r],r):e=e.c(r).t(t[r]).up()}),e=e.up()}static assignExtraParamsToXml(e,t){let r=pn.getElement(e,"extraParams");return Object.keys(t).forEach(e=>{"attachments"===e?t[e].forEach(e=>{r.c("attachment",e).up()}):"object"==typeof t[e]?pn.assignObjectToXml(r,t[e],e):r.c(e).t(t[e]).up()}),e.up(),e}static assignXmlToObject(e,t){const{children:r,name:n}=e,s={[n]:{}};return r.forEach(e=>{"string"==typeof e?s[n]=e:e.children.length>0?pn.assignXmlToObject(e,s[n]):s[n][e.name]=pn.getText(e)}),Object.assign(t,s)}static parseExtraParams(e){if(!e)return null;const t={attachments:[]};let r=null;return e.children.forEach(n=>{if("string"!=typeof n){if("attachment"===n.name){const e={};Object.keys(n.attrs).forEach(t=>{e[t]="size"===t?parseInt(n.attrs.size):n.attrs[t]}),t.attachments.push(e)}else"dialog_id"===n.name&&(r=pn.getElementText(e,"dialog_id"),t.dialog_id=r);n.children.length&&pn.assignXmlToObject(n,t)}}),0===t.attachments.length&&delete t.attachments,t.moduleIdentifier&&delete t.moduleIdentifier,{extension:t,dialogId:r}}static buildErrorFromXMPPErrorStanza(e){const t=pn.getElement(e,"error");return{code:t?parseInt(pn.getAttr(t,"code")):0,info:t?pn.getElementText(t,"text"):null}}static getUniqueId(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return"string"==typeof e||"number"==typeof e?`${t}:${e}`:t}static parseReactions(e){return pn.getChildElements(e).map(e=>({add:"true"===pn.getAttr(e,"add"),remove:"true"===pn.getAttr(e,"remove"),reaction:pn.getAttr(e,"type")})).reduce((e,{add:t,remove:r,reaction:n})=>(t?e.add=n:r&&(e.remove=n),e),{})}}class mn{constructor(){this.xmppJID="",this.getUniqueId=pn.getUniqueId,this.getBsonObjectId=Z.getBsonObjectId}get userCurrentJid(){return this.xmppJID}set userCurrentJid(e){this.xmppJID=e||""}isNumeric(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)}jidOrUserId(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)}typeChat(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}}getUserJid(e){return`${e}-${Y.creds.appId}@${Y.endpoints.chat}`}getUserNickWithMucDomain(e){return`${Y.endpoints.muc}/${e}`}getUserIdFromJID(e=this.userCurrentJid){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}getDialogIdFromJID(e){return e?.includes("@")?e.split("@")[0].split("_")[1]:null}getRoomJidFromDialogId(e){return`${Y.creds.appId}_${e}@${Y.endpoints.muc}`}getRoomJid(e){return`${e}/${this.getUserIdFromJID(this.userCurrentJid)}`}getIdFromResource(e){const t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null}getRoomJidFromRoomFullJid(e){const t=e.split("/");return t.length>1?t[0]:null}getUserIdFromRoomJid(e){const t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null}getDialogJid(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)}}var fn;!function(e){e.ENABLE="enable",e.ENABLED="enabled",e.REQUEST="r",e.ANSWER="a"}(fn||(fn={}));class gn{constructor(e){this.chat=e,this.xmlns="urn:xmpp:sm:3",this.enabled=!1,this.clientHandledCounter=0,this.serverHandledCounter=0,this.messagesQueue=new Set,this.elementHandler=e=>{const[t,r]=[e.name,pn.getAttr(e,"xmlns")];if(r===this.xmlns&&t===fn.ENABLED)return this.clientHandledCounter=0,this.serverHandledCounter=0,void(this.enabled=!0);if(r!==this.xmlns&&this.clientHandledCounter++,t!==fn.REQUEST){if(t===fn.ANSWER){const t=parseInt(pn.getAttr(e,"h"),10),r=Number.isNaN(t)?this.serverHandledCounter:t,n=r-this.serverHandledCounter;this.serverHandledCounter=r,this.markMessagesQueueAsSent(n),this.markMessagesQueueAsLostByTimeout()}}else this.sendNonza(fn.ANSWER)}}get supported(){return Y.chatProtocol.active===P.WS&&Y.chat.streamManagement?.enable}start(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.addElementHandler(),this.sendNonza(fn.ENABLE))}stop(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.markMessagesQueueAsLost())}async sendAndCount(e,t){const r=pn.getAttr(e,"type"),n=pn.getElementText(e,"body"),s=pn.getAllElements(e,"attachment"),i="message"===e.name,o=r===D.CHAT||r===D.GROUPCHAT,a=Boolean(n||s.length);try{await this.chat.xmppClient.sendOnline(e),this.enabled&&i&&o&&a&&(this.messagesQueue.add(t),this.sendNonza(fn.REQUEST))}catch{this.markMessageAsLost(t)}}markMessageAsSent(e){Z.safeCallbackCall(this.chat.onSentMessageCallback)(null,e),this.messagesQueue.delete(e)}markMessageAsLost(e,t=!0){Z.safeCallbackCall(this.chat.onSentMessageCallback)(e,null),t&&this.messagesQueue.delete(e)}markMessagesQueueAsSent(e=0){const t=this.messagesQueue.values();for(let r=0;r<e;r++){const{done:e,value:r}=t.next();if(e)break;this.markMessageAsSent(r)}}markMessagesQueueAsLost(){clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=void 0,this.messagesQueue.size>0&&(this.messagesQueue.forEach(e=>{this.markMessageAsLost(e,!1)}),this.messagesQueue.clear())}markMessagesQueueAsLostByTimeout(){const e=1e3*(Y.chat.streamManagement?.acknowledgementTimeout??30);clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=setTimeout(()=>{this.markMessagesQueueAsLost()},e)}sendNonza(e){const t={xmlns:this.xmlns,...e===fn.ANSWER&&{h:this.clientHandledCounter}},r=pn.createNonza(e,t);return this.chat.xmppClient.sendOnline(r)}removeElementHandler(){this.chat.xmppClient.removeListener("element",this.elementHandler)}addElementHandler(){this.chat.xmppClient.on("element",this.elementHandler)}}class yn{constructor(e){this.xmlns="jabber:iq:privacy",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async create(e){return new Promise((t,r)=>{const n=e.items.reduce((e,{user_id:t,action:r,mutualBlock:n})=>(e[t]={action:r,mutualBlock:n},e),{}),s=Object.keys(n),i={type:"set",from:this.helpers.userCurrentJid,id:pn.getUniqueId("edit")};let o=pn.createIqStanza(i);o.c("query",{xmlns:this.xmlns}).c("list",{name:e.name});for(let e=0,t=0,r=s.length;e<r;e++,t+=2){const r=s[e],{action:i,mutualBlock:a}=n[r],c=(a&&"deny"===i)??!1,l=this.helpers.jidOrUserId(parseInt(r,10)),d=this.helpers.getUserNickWithMucDomain(r);this.assignPrivacyItem(o,{order:t+1,value:l,action:i,isMutual:c}),this.assignPrivacyItem(o,{order:t+2,value:d,action:i,isMutual:c})}this.stanzasCallbacks[i.id]=e=>{pn.isErrorStanza(e)?r(pn.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(o)})}async getList(e){return new Promise((t,r)=>{const n=pn.getUniqueId("getlist"),s=pn.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:n});s.c("query",{xmlns:this.xmlns}).c("list",{name:e}),this.stanzasCallbacks[n]=e=>{const r=pn.getElement(e,"query"),s=pn.getElement(r,"list"),i={name:pn.getAttr(s,"name"),items:pn.getChildElements(s).map((e,t)=>{if(t%2==0){const{action:t,value:r}=e.attrs;return{user_id:this.helpers.getUserIdFromJID(r),action:t}}return null}).filter(e=>null!==e)};t(i),delete this.stanzasCallbacks[n]},this.xmppClient.sendOnline(s)})}async update(e){try{const t=await this.getList(e.name),r=new Map(t.items.map(e=>[e.user_id,e]));for(const t of e.items)if(t.action===R.ALLOW)r.delete(t.user_id);else{const e=Object.assign({},r.get(t.user_id),t);r.set(t.user_id,e)}const n=Array.from(r.values()),s={name:e.name,items:n};await this.create(s)}catch(e){throw e}}async getNames(){return new Promise((e,t)=>{const r=pn.getUniqueId("getNames"),n=pn.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:r});n.c("query",{xmlns:this.xmlns}),this.stanzasCallbacks[r]=r=>{if(pn.isErrorStanza(r))t(pn.buildErrorFromXMPPErrorStanza(r));else{const t=pn.getElement(r,"query"),n=pn.getElement(t,"default"),s=pn.getElement(t,"active"),i=pn.getAttr(n,"name"),o=pn.getAttr(s,"name"),a=pn.getChildElements(t).map(e=>pn.getAttr(e,"name"));e({default:i,active:o,names:a})}},this.xmppClient.sendOnline(n)})}async delete(e){return new Promise((t,r)=>{const n=pn.getUniqueId("remove"),s=pn.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:n});s.c("query",{xmlns:this.xmlns}).c("list",{name:e||""}),this.stanzasCallbacks[n]=e=>{pn.isErrorStanza(e)?r(pn.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(s)})}async setAsDefault(e){return new Promise((t,r)=>{const n=pn.getUniqueId("default"),s=pn.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:n});s.c("query",{xmlns:this.xmlns}).c("default",e?{name:e}:{}),this.stanzasCallbacks[n]=e=>{pn.isErrorStanza(e)?r(pn.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(s)})}assignPrivacyItem(e,t){const{value:r,action:n,order:s,isMutual:i}=t,o=pn.getElement(e,"query"),a=pn.getElement(o,"list").c("item",{type:"jid",value:r,action:n,order:s});i?(a.up(),s%2==0&&e.up().up()):a.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()}}class bn{constructor(e){this.xmlns="http://jabber.org/protocol/muc",this.joinedRooms={},this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async join(e){return new Promise((t,r)=>{const n=pn.getUniqueId("join"),s=this.helpers.getDialogJid(e),i=pn.createPresenceStanza({id:n,from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(s)});i.c("x",{xmlns:this.xmlns}).c("history",{maxstanzas:0}),this.stanzasCallbacks[n]=e=>{const i=pn.getElement(e,"x"),o=pn.getElement(i,"status"),a=pn.getAttr(o,"code");if(o&&"110"==a)this.joinedRooms[s]=!0,t();else{const t=pn.getAttr(i,"xmlns")===this.xmlns&&n.endsWith(":join"),s="error"===pn.getAttr(e,"type");if(t&&s){const t=pn.getElement(e,"error"),n={code:pn.getAttr(t,"code"),message:pn.getElementText(t,"text")||"Unknown issue"};r(n)}}},this.xmppClient.sendOnline(i)})}async leave(e){return new Promise((t,r)=>{const n=this.helpers.getDialogJid(e),s=pn.createPresenceStanza({type:"unavailable",from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(n)});delete this.joinedRooms[n],this.stanzasCallbacks["muc:leave"]=e=>{t()},this.xmppClient.sendOnline(s)})}async listOnlineUsers(e){return new Promise((t,r)=>{const n=pn.getUniqueId("muc_disco_items"),s=pn.createIqStanza({type:"get",to:this.helpers.getDialogJid(e),from:this.helpers.userCurrentJid,id:n});s.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),this.stanzasCallbacks[n]=e=>{const r=pn.getAttr(e,"id");if(this.stanzasCallbacks[r]){const r=pn.getAttr(e,"query"),n=pn.getChildElements(r).map(e=>{const t=pn.getAttr(e,"jid");return this.helpers.getUserIdFromRoomJid(t)}).filter(e=>null!==e);t(n)}},this.xmppClient.sendOnline(s)})}}class Cn{constructor(e){this.isConnected=!1,this.isConnecting=!1,this.isLogout=!1,this.isReconnect=!1,this.stanzasCallbacks={},this.xmppClientListeners=new Map,this.connectPromise=null,this.earlyIncomingMessagesQueue=[],this.proxy=e,this.dialog=new un(e),this.message=new hn(e),this.helpers=new mn,this.xmppClient=function(e){const{resource:t,credentials:r,username:n,password:s,...i}=e,{domain:o,service:a}=i;!o&&a&&(i.domain=(a.split("://")[1]||a).split(":")[0].split("/")[0]);const c=new yt.Client(i),l=xt({entity:c}),d=Vt({entity:c}),u=Gt({entity:c}),h=rr({middleware:u}),p=or({middleware:u,entity:c}),m=dr({middleware:u,entity:c}),f=Gt({entity:c}),g=kr({entity:c}),y=Ur({streamFeatures:h},r||{username:n,password:s}),b=Fr({iqCaller:p,streamFeatures:h},t),C=qr({iqCaller:p,streamFeatures:h}),v=Object.entries({plain:ln,anonymous:en}).map(([e,t])=>({[e]:t(y)}));return Object.assign(c,{entity:c,reconnect:l,websocket:d,middleware:u,streamFeatures:h,iqCaller:p,iqCallee:m,starttls:f,resolve:g,sasl:y,resourceBinding:b,sessionEstablishment:C,mechanisms:v,sendOnline:function(e,...t){if("online"===c.status)return c.send.call(c,e,...t);{const e="You are not connected to chat. Please call 'connect' function first";return Z.DLog("[Chat][Error]",e),Promise.reject(new Error(e))}}})}({service:Y.chatProtocol.websocket,credentials:(e,t)=>e({username:this.xmppClient.options.username||"",password:this.xmppClient.options.password||""})}),Y.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*Y.chat.reconnect.timeInterval);const t={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.muc=new bn(t),this.privacylist=new yn(t),this.streamManagement=new gn(this)}get connectionStatus(){return this.xmppClient.status}async connect(e){return this.connectPromise=new Promise((t,r)=>(Z.DLog("[Chat]","Connect with parameter:",e),this.isConnecting?(Z.DLog("[Chat]","Warning! Already in CONNECTING state"),void t(!1)):this.isConnected?(Z.DLog("[Chat]","Warning! Chat is already connected!"),void t(!1)):(this.isConnecting=!0,this.isLogout=!1,this.removeAllXMPPClientListeners(),this.addXMPPClientListener("connect",()=>{Z.DLog("[Chat]",this.isReconnect?"RECONNECTING":"CONNECTING")}),this.addXMPPClientListener("online",()=>{Z.DLog("[Chat]","ONLINE"),this.postConnectActions(),t(!0),this.connectPromise=null}),this.addXMPPClientListener("offline",()=>{Z.DLog("[Chat]","OFFLINE")}),this.addXMPPClientListener("disconnect",()=>{Z.DLog("[Chat]","DISCONNECTED"),Z.safeCallbackCall(this.onDisconnectedListener)(),Y.chat.reconnect.enable?(this.isConnected=!1,this.isConnecting=!1):this.disconnect()}),this.addXMPPClientListener("status",(e,t)=>{Z.DLog("[Chat]",`status - ${e}`,"object"==typeof t?JSON.stringify(t):""),Z.safeCallbackCall(this.onChatStatusListener)(e)}),this.addXMPPClientListener("stanza",e=>{if(e.is("message")&&!this.isConnected)return this.earlyIncomingMessagesQueue.push(e),void Z.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?this.onPresence(e):e.is("iq")?this.onIQ(e):e.is("message")&&("headline"===e.attrs.type?this.onSystemMessage(e):"error"===e.attrs.type?this.onMessageError(e):this.onMessage(e))}),this.addXMPPClientListener("error",e=>{Z.DLog("[Chat]","ERROR:",e,{isReconnect:this.isReconnect,connectPromise:!!this.connectPromise}),this.connectPromise?this.isReconnect||(r("SASLError"==e.name?e.condition:e),this.connectPromise=null):Z.safeCallbackCall(this.onConnectionErrorListener)(e)}),this.addXMPPClientListener("output",e=>{Z.callTrafficUsageCallback("xmppDataWrite",{body:e}),Z.DLog("[Chat]","SENT:",e)}),this.addXMPPClientListener("input",e=>{Z.callTrafficUsageCallback("xmppDataRead",{body:e}),Z.DLog("[Chat]","RECV:",e)}),this.xmppClient.options.username=pn.buildUserJidLocalPart(e.userId),this.xmppClient.options.password=e.password,void this.xmppClient.start().catch(e=>{console.error("[Chat] xmppClient.start error",e),this.connectPromise?(r(e),this.connectPromise=null):Z.safeCallbackCall(this.onConnectionErrorListener)(e)})))),this.connectPromise}async ping(){return new Promise((e,t)=>{const r=pn.getUniqueId("ping"),n=pn.createIqStanza({id:r,type:"get",to:Y.endpoints.chat});n.c("ping",{xmlns:"urn:xmpp:ping"}),this.stanzasCallbacks[r]=r=>{const n=pn.getElement(r,"error");n?t(pn.buildErrorFromXMPPErrorStanza(n)):e()},this.xmppClient.sendOnline(n)})}async pingWithTimeout(e=5e3){return Promise.race([this.ping(),new Promise((t,r)=>setTimeout(()=>{const e="Chat ping() timed out";Z.safeCallbackCall(this.onConnectionErrorListener)(e),r(e)},e))])}send(e,t={}){const r=t.id??Z.getBsonObjectId(),n=pn.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:t.type??this.helpers.typeChat(e),id:r});return t.id||(t.id=r),t.body&&n.c("body").t(t.body).up(),t.markable&&n.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(n.c("extraParams",{xmlns:"jabber:client"}),pn.assignExtraParamsToXml(n,t.extension)),this.streamManagement.supported?this.streamManagement.sendAndCount(n,t):this.xmppClient.sendOnline(n),r}sendSystemMessage(e,t){const r=t.id??Z.getBsonObjectId(),n=pn.createMessageStanza({type:"headline",id:r,to:this.helpers.jidOrUserId(e)});return t.body&&n.c("body").t(t.body).up(),t.extension&&(n.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),pn.assignExtraParamsToXml(n,t.extension)),this.xmppClient.sendOnline(n),r}sendIsTypingStatus(e){const t=pn.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendIsStopTypingStatus(e){const t=pn.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendDeliveredStatus(e){const t=pn.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:Z.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}sendReadStatus(e){const t=pn.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:Z.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}editMessage(e){const t=pn.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:Z.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&pn.assignExtraParamsToXml(t,e.extension),this.xmppClient.sendOnline(t)}deleteMessage(e){const t=pn.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:Z.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}getLastUserActivity(e){return new Promise((t,r)=>{const n=pn.getUniqueId("lastActivity"),s=pn.createIqStanza({type:"get",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),id:n});s.c("query",{xmlns:"jabber:iq:last"}),this.stanzasCallbacks[n]=e=>{pn.getElement(e,"error")?r(pn.buildErrorFromXMPPErrorStanza(e)):t(this.onLastActivityStanza(e))},this.xmppClient.sendOnline(s)})}onLastActivityStanza(e){const t=pn.getAttr(e,"from"),r=this.helpers.getUserIdFromJID(t),n=pn.getElement(e,"query"),s=n?parseInt(pn.getAttr(n,"seconds")):0;return Z.safeCallbackCall(this.onLastUserActivityListener)(r,s),{userId:r,seconds:s}}markActive(){const e=pn.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.sendOnline(e)}markInactive(){const e=pn.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.sendOnline(e)}async disconnect(){if(Z.DLog("[Chat]","disconnect"),this.isLogout)return Z.DLog("[Chat]","Warning! Chat is already disconnected!"),!0;this.isLogout=!0,this.isReconnect=!1,this.isConnected=!1,this.isConnecting=!1,this.muc.joinedRooms={},this.helpers.userCurrentJid="",this.streamManagement.stop();try{return await this.xmppClient.stop(),!0}catch{return!1}}terminate(){Z.DLog("[Chat]","terminated"),this.isConnected=!1,this.isConnecting=!1,this.streamManagement.stop(),this.xmppClient.socket.end()}async search(e){const t=Object.assign({},e);t.start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),Z.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(","));const r={type:B.GET,url:Z.getUrl(`${Y.urls.chat}/search`),data:t};return this.proxy.ajax(r)}onMessage(e){const t=pn.getElementTreePath(e,["sent","forwarded","message"]),r=t||e,n=pn.getAttr(r,"from"),s=pn.getAttr(r,"type"),i=pn.getElement(r,"invite"),o=this.xmppClient.jid?.getResource()||"",a="chat"===s;if(a&&n.includes(o)||i)return;const c=pn.getAttr(r,"id"),l=pn.getElement(r,"markable"),d=pn.getElement(r,"received"),u=pn.getElement(r,"displayed"),h=pn.getElement(r,"replace"),p=pn.getElement(r,"reactions"),m=pn.getElement(r,"remove"),f=Boolean(pn.getElement(r,"composing")),g=pn.getElement(r,"paused"),y=pn.getElement(r,"delay"),b=pn.getElement(r,"extraParams"),C=pn.getElementText(r,"body"),v=Boolean(t),S="groupchat"===s,w=a?pn.getAttr(r,"to"):null,E=w?this.helpers.getUserIdFromJID(w):null,T=b?pn.parseExtraParams(b):null,I=T?T.extension:null,k=S?this.helpers.getDialogIdFromJID(n):T?.dialogId??null,x=S?this.helpers.getIdFromResource(n):this.helpers.getUserIdFromJID(n),A=this.xmppClient.jid?.toString(),D=A?this.helpers.getUserIdFromJID(A):0;if(f||g)return void((a||S||!y)&&Z.safeCallbackCall(this.onMessageTypingListener)(f,x,k));if(h)return void Z.safeCallbackCall(this.onMessageUpdateListener)(pn.getAttr(h,"id"),"true"===pn.getAttr(h,"last"),C,k,x,I);if(p){if(v&&S)return;const e=pn.getAttr(p,"message_id"),t=parseInt(pn.getAttr(p,"user_id")),{add:r,remove:n}=pn.parseReactions(p);return void Z.safeCallbackCall(this.onMessageReactionsListener)(e,t,k,r,n)}if(m){const e=pn.getAttr(m,"id");return void Z.safeCallbackCall(this.onMessageDeleteListener)(e,k,x)}if(d||u){if(d&&a){const e=pn.getAttr(d,"id");Z.safeCallbackCall(this.onDeliveredStatusListener)(e,k,x)}if(u&&a){const e=pn.getAttr(u,"id");Z.safeCallbackCall(this.onReadStatusListener)(e,k,x)}return}l&&k&&x&&x!==D&&this.sendDeliveredStatus({messageId:c,dialogId:k,userId:x});const O={id:c,dialog_id:k,recipient_id:E,is_forwarded:v,type:s,body:C,extension:I,delay:y};l&&(O.markable=1),(a||S)&&Z.safeCallbackCall(this.onMessageListener)(x,O)}onPresence(e){const t=pn.getAttr(e,"from"),r=pn.getAttr(e,"id"),n=pn.getAttr(e,"type"),s=this.xmppClient.jid?.toString(),i=this.helpers.getUserIdFromJID(s),o=pn.getElement(e,"x"),a=o?pn.getAttr(o,"xmlns"):null,c=o?pn.getElement(o,"xmlns"):null,l=c?pn.getElementText(c,"code"):null;if(a&&a.startsWith("http://jabber.org/protocol/muc")){if("error"===n)return void(r.endsWith(":join")&&Z.safeCallbackCall(this.stanzasCallbacks[r])(e));const s=this.helpers.getDialogIdFromJID(t),o=this.helpers.getUserIdFromRoomJid(t);if(c){if("301"===l){const r=pn.getElement(e,"item"),n=r?pn.getElement(r,"actor"):null,i=n?pn.getAttr(n,"jid"):null,o=this.helpers.getUserIdFromJID(i),a=this.helpers.getRoomJidFromRoomFullJid(t);return Z.safeCallbackCall(this.onKickOccupant)(s,o),void(a&&delete this.muc.joinedRooms[a])}if("unavailable"===n)return void(c&&"110"===l&&Z.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(r.endsWith(":join")&&c&&"110"===l)return void this.stanzasCallbacks[r]?.(e)}else if(o!=i){const e="unavailable"===n?"onLeaveOccupant":"onJoinOccupant";return void Z.safeCallbackCall(this[e])(s,o)}}}onIQ(e){const t=pn.getAttr(e,"id");if(this.stanzasCallbacks[t])Z.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{const t=pn.getAttr(e,"from"),r=pn.getElement(e,"query");t&&r&&this.onLastActivityStanza(e)}}onSystemMessage(e){const t=pn.getElementTreePath(e,["sent","forwarded","message"])||e,r=pn.getAttr(t,"from"),n=pn.getAttr(t,"id"),s=pn.getElement(t,"extraParams"),i=this.helpers.getUserIdFromJID(r),o=pn.getElement(t,"delay"),a=s?pn.getElementText(s,"moduleIdentifier"):null,c=pn.getElementText(t,"body"),l=s?pn.parseExtraParams(s):null,d=l?l.extension:null;switch(a){case"SystemNotifications":Z.safeCallbackCall(this.onSystemMessageListener)({id:n,userId:i,body:c,extension:d});break;case"WebRTCVideoChat":this.webrtcSignalingProcessor&&!o&&Z.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(i,s)}}onMessageError(e){const t=pn.getAttr(e,"id"),r=pn.buildErrorFromXMPPErrorStanza(e);Z.safeCallbackCall(this.onMessageErrorListener)(t,r)}postConnectActions(){Z.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");const e=pn.createPresenceStanza();if(this.streamManagement.start(),this.helpers.userCurrentJid=this.xmppClient.jid?.toString()??null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.sendOnline(e),this.isReconnect?Z.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){Z.DLog("[Chat]",`Flush 'earlyIncomingMessagesQueue' (length=${this.earlyIncomingMessagesQueue.length})`);const e=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach(t=>{e?.(t)}),this.earlyIncomingMessagesQueue=[]}}enableCarbons(){const e=pn.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:pn.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.sendOnline(e)}setSubscriptionToUserLastActivity(e,t){const r=pn.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});r.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.sendOnline(r)}subscribeToUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!0)}unsubscribeFromUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!1)}addXMPPClientListener(e,t){this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)}removeXMPPClientListener(e){const t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)}removeAllXMPPClientListeners(){this.xmppClientListeners.forEach((e,t)=>this.removeXMPPClientListener(t))}getListenerByName(e){switch(e){case O.STATUS:return"onChatStatusListener";case O.ERROR:return"onConnectionErrorListener";case O.DISCONNECTED:return"onDisconnectedListener";case O.RECONNECTED:return"onReconnectListener";case O.MESSAGE:return"onMessageListener";case O.SYSTEM_MESSAGE:return"onSystemMessageListener";case O.ERROR_MESSAGE:return"onMessageErrorListener";case O.TYPING_MESSAGE:return"onMessageTypingListener";case O.UPDATE_MESSAGE:return"onMessageUpdateListener";case O.DELETE_MESSAGE:return"onMessageDeleteListener";case O.REACTIONS_MESSAGE:return"onMessageReactionsListener";case O.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case O.READ_MESSAGE:return"onReadStatusListener";case O.SENT_MESSAGE:return"onSentMessageCallback";case O.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case O.JOIN:return"onJoinOccupant";case O.LEAVE:return"onLeaveOccupant";case O.KICK:return"onKickOccupant";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}var vn,Sn,wn=re(Ee()),En=ne(w);var Tn=function(){if(Sn)return vn;Sn=1;const{adapter:e,navigator:t,MediaStream:r,MediaStreamTrack:n,RTCPeerConnection:s,RTCRtpReceiver:i,RTCRtpSender:o,isReactNative:a}=En;l.sessions={},l.mobile=a,l.isExtensionEnabled=function(){if(l.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||l.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!l.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(l.mobile)e();else{let t=window.setTimeout(function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,l.mobile||window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let r=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",r(e)}else r(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)})}};function l(e){if((e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:l.noop,!l.initDone)return e.error("Library not initialized"),{};if(!l.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(l.log("Library initialized: "+l.initDone),!e.server)return e.error("Invalid server url"),{};let a=!1,c=null,d={},u=null,h=null,p=0,m=e.server;l.isArray(m)?(l.log("Multiple servers provided ("+m.length+"), will use the first that works"),m=null,h=e.server,l.debug(h)):0===m.indexOf("ws")?(a=!0,l.log("Using WebSockets to contact Janus: "+m)):(a=!1,l.log("Using REST API to contact Janus: "+m));let f=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],g=e.iceTransportPolicy,y=e.bundlePolicy,b=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(b=!0===e.withCredentials);let C=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(C=e.max_poll_events),C<1&&(C=1);let v=null;void 0!==e.token&&null!==e.token&&(v=e.token);let S=null;void 0!==e.apisecret&&null!==e.apisecret&&(S=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let w=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(w=e.keepAlivePeriod),isNaN(w)&&(w=25e3);let E=6e4;function T(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(E=e.longPollTimeout),isNaN(E)&&(E=6e4);let I=!1,k=null,x={},A=this,D=0,O={};function R(){if(null==k)return;if(l.debug("Long poll..."),!I)return void l.warn("Is the server down? (connected=false)");let t=m+"/"+k+"?rid="+(new Date).getTime();C&&(t=t+"&maxev="+C),v&&(t=t+"&token="+encodeURIComponent(v)),S&&(t=t+"&apisecret="+encodeURIComponent(S)),l.httpAPICall(t,{verb:"GET",withCredentials:b,success:P,timeout:E,error:function(t,r){if(l.error(t+":",r),D++,D>3)return I=!1,void e.error("Lost connection to the server (is it down?)");R()}})}function P(e,t){if(D=0,a||null==k||!0===t||R(),a||!l.isArray(e))if("keepalive"!==e.janus){if("server_info"===e.janus){l.debug("Got info on the Janus instance"),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("ack"===e.janus){l.debug("Got an ack on session "+k),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("success"===e.janus){l.debug("Got a success on session "+k),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("trickle"===e.janus){const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];if(!r)return void l.debug("This handle is not attached to this session");let n=e.candidate;l.debug("Got a trickled candidate on session "+k),l.debug(n);let s=r.webrtcStuff;s.pc&&s.remoteSdp?(l.debug("Adding remote candidate:",n),n&&!0!==n.completed?s.pc.addIceCandidate(n):s.pc.addIceCandidate(l.endOfCandidates)):(l.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),s.candidates||(s.candidates=[]),s.candidates.push(n),l.debug(s.candidates))}else{if("webrtcup"===e.janus){l.debug("Got a webrtcup event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];return r?void r.webrtcState(!0):void l.debug("This handle is not attached to this session")}if("hangup"===e.janus){l.debug("Got a hangup event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];if(!r)return void l.debug("This handle is not attached to this session");r.webrtcState(!1,e.reason),r.hangup()}else if("detached"===e.janus){l.debug("Got a detached event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];if(!r)return;r.ondetached(),r.detach()}else if("media"===e.janus){l.debug("Got a media event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];if(!r)return void l.debug("This handle is not attached to this session");r.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){l.debug("Got a slowlink event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=x[t];if(!r)return void l.debug("This handle is not attached to this session");r.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){l.error("Ooops: "+e.error.code+" "+e.error.reason),l.debug(e);let t=e.transaction;if(t){let r=O[t];r&&r(e),delete O[t]}return}if("event"===e.janus){l.debug("Got a plugin event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");let r=e.plugindata;if(!r)return void l.warn("Missing plugindata...");l.debug("  -- Event is coming from "+t+" ("+r.plugin+")");let n=r.data;l.debug(n);const s=x[t];if(!s)return void l.warn("This handle is not attached to this session");let i=e.jsep;i&&(l.debug("Handling SDP as well..."),l.debug(i));let o=s.onmessage;o?(l.debug("Notifying application..."),o(n,i)):l.debug("No provided notification callback")}else{if("timeout"===e.janus)return l.error("Timeout on session "+k),l.debug(e),void(a&&c.close(3504,"Gateway timeout"));l.warn("Unknown message/event  '"+e.janus+"' on session "+k),l.debug(e)}}}}else l.vdebug("Got a keepalive on session "+k);else for(let t=0;t<e.length;t++)P(e[t],!0)}function L(){if(!m||!a||!I)return;u=setTimeout(L,w);let e={janus:"keepalive",session_id:k,transaction:l.randomString(12)};v&&(e.token=v),S&&(e.apisecret=S),c.send(JSON.stringify(e))}function _(t){let r=l.randomString(12),n={janus:"create",transaction:r};if(t.reconnect&&(I=!1,n.janus="claim",n.session_id=k,c&&(c.onopen=null,c.onerror=null,c.onclose=null,u&&(clearTimeout(u),u=null))),v&&(n.token=v),S&&(n.apisecret=S),!m&&l.isArray(h)&&(m=h[p],0===m.indexOf("ws")?(a=!0,l.log("Server #"+(p+1)+": trying WebSockets to contact Janus ("+m+")")):(a=!1,l.log("Server #"+(p+1)+": trying REST API to contact Janus ("+m+")"))),a){c=l.newWebSocket(m,"janus-protocol"),d={error:function(){if(l.error("Error connecting to the Janus WebSockets server... "+m),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){_(t)},200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){O[r]=function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);u=setTimeout(L,w),I=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+k):l.log("Created session: "+k),l.sessions[k]=A,t.success()},c.send(JSON.stringify(n))},message:function(e){P(JSON.parse(e.data))},close:function(){m&&I&&(I=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in d)c.addEventListener(e,d[e])}else l.httpAPICall(m,{verb:"POST",withCredentials:b,body:n,success:function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);I=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+k):l.log("Created session: "+k),l.sessions[k]=A,R(),t.success()},error:function(e,r){if(l.error(e+":",r),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){_(t)},200));""===r?t.error(e+": Is the server down?"):r&&r.error?t.error(e+": "+r.error.message):t.error(e+": "+r)}})}function j(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,!I)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=t.message,s=t.jsep,i=l.randomString(12),o={janus:"message",body:n,transaction:i};if(r.token&&(o.token=r.token),S&&(o.apisecret=S),s&&(o.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(o.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(o.jsep.rid_order=s.rid_order),s.force_relay&&(o.jsep.force_relay=!0)),l.debug("Sending message to plugin (handle="+e+"):"),l.debug(o),a)return o.session_id=k,o.handle_id=e,O[i]=function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let r=e.plugindata;if(!r)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+r.plugin+")");let n=r.data;return l.debug(n),void t.success(n)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(o));l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:o,success:function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let r=e.plugindata;if(!r)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+r.plugin+")");let n=r.data;return l.debug(n),void t.success(n)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},error:function(e,r){l.error(e+":",r),t.error(e+": "+r)}})}function N(e,t){if(!I)return void l.warn("Is the server down? (connected=false)");let r=x[e];if(!r||!r.webrtcStuff)return void l.warn("Invalid handle");let n={janus:"trickle",candidate:t,transaction:l.randomString(12)};if(r.token&&(n.token=r.token),S&&(n.apisecret=S),l.vdebug("Sending trickle candidate (handle="+e+"):"),l.vdebug(n),a)return n.session_id=k,n.handle_id=e,void c.send(JSON.stringify(n));l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:n,success:function(e){l.vdebug("Candidate sent!"),l.vdebug(e),"ack"===e.janus||l.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){l.error(e+":",t)}})}function M(e,t,r,n,s){let i=x[e];if(!i||!i.webrtcStuff)return void l.warn("Invalid handle");let o=i.webrtcStuff;if(!o.pc)return void l.warn("Invalid PeerConnection");let a=function(e){l.log("Received state change on data channel:",e);let t=e.target.label,r=e.target.protocol,n=o.dataChannel[t]?o.dataChannel[t].readyState:"null";if(l.log("State change on <"+t+"> data channel: "+n),"open"===n){if(o.dataChannel[t].pending&&o.dataChannel[t].pending.length>0){l.log("Sending pending messages on <"+t+">:",o.dataChannel[t].pending.length);for(let e of o.dataChannel[t].pending)l.log("Sending data on data channel <"+t+">"),l.debug(e),o.dataChannel[t].send(e);o.dataChannel[t].pending=[]}i.ondataopen(t,r)}};if(n)o.dataChannel[t]=n;else{let e=o.dataChannelOptions;r&&(e.protocol=r),o.dataChannel[t]=o.pc.createDataChannel(t,e)}o.dataChannel[t].onmessage=function(e){l.log("Received message on data channel:",e);let t=e.target.label;i.ondata(e.data,t)},o.dataChannel[t].onopen=a,o.dataChannel[t].onclose=a,o.dataChannel[t].onerror=function(e){l.error("Got error on data channel:",e)},o.dataChannel[t].pending=[],s&&o.dataChannel[t].pending.push(s)}function U(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=r.webrtcStuff,s=t.text||t.data;if(!s)return l.warn("Invalid data"),void t.error("Invalid data");let i=t.label?t.label:l.dataChanDefaultLabel;return n.dataChannel[i]?"open"!==n.dataChannel[i].readyState?(n.dataChannel[i].pending.push(s),void t.success()):(l.log("Sending data on data channel <"+i+">"),l.debug(s),n.dataChannel[i].send(s),void t.success()):(M(e,i,t.protocol,!1,s,t.protocol),void t.success())}function J(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=r.webrtcStuff;if(!n.dtmfSender){if(n.pc){let e=n.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!e)return l.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=e.dtmf,n.dtmfSender&&(l.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){l.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return l.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let s=t.dtmf;if(!s)return l.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let i=s.tones;if(!i)return l.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let o="number"==typeof s.duration?s.duration:500,a="number"==typeof s.gap?s.gap:50;l.debug("Sending DTMF string "+i+" (duration "+o+"ms, gap "+a+"ms)"),n.dtmfSender.insertDTMF(i,o,a),t.success()}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=!0===t.noRequest;l.log("Destroying handle "+e+" (only-locally="+r+")"),ee(e);let n=x[e];if(!n||n.detached)return delete x[e],void t.success();if(n.detached=!0,r)return delete x[e],void t.success();if(!I)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let s={janus:"detach",transaction:l.randomString(12)};if(n.token&&(s.token=n.token),S&&(s.apisecret=S),a)return s.session_id=k,s.handle_id=e,c.send(JSON.stringify(s)),delete x[e],void t.success();l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:s,success:function(r){l.log("Destroyed handle:"),l.debug(r),"success"!==r.janus&&l.error("Ooops: "+r.error.code+" "+r.error.reason),delete x[e],t.success()},error:function(r,n){l.error(r+":",n),delete x[e],t.success()}})}function $(e,t){let r=x[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=r.webrtcStuff;if(n.pc)return;let i={iceServers:f,iceTransportPolicy:g,bundlePolicy:y,sdpSemantics:"unified-plan"},a=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){a=!0;break}o&&(o.prototype.createEncodedStreams||o.prototype.createEncodedAudioStreams&&o.prototype.createEncodedVideoStreams)&&a&&(n.insertableStreams=!0,i.forceEncodedAudioInsertableStreams=!0,i.forceEncodedVideoInsertableStreams=!0,i.encodedInsertableStreams=!0),l.log("Creating PeerConnection"),n.pc=new s(i),l.debug(n.pc),n.pc.getStats&&(n.volume={},n.bitrate.value="0 kbits/sec"),l.log("Preparing local SDP and gathering candidates (trickle="+n.trickle+")"),n.pc.oniceconnectionstatechange=function(){n.pc&&r.iceState(n.pc.iceConnectionState)},n.pc.onicecandidate=function(r){if(!r.candidate||r.candidate.candidate&&r.candidate.candidate.indexOf("endOfCandidates")>0)l.log("End of candidates."),n.iceDone=!0,!0===n.trickle?N(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=x[e];if(!r||!r.webrtcStuff)return void l.warn("Invalid handle, not sending anything");let n=r.webrtcStuff;if(l.log("Sending offer/answer SDP..."),!n.mySdp)return void l.warn("Local SDP instance is invalid, not sending anything...");n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1);l.debug(t),n.sdpSent=!0,t.success(n.mySdp)}(e,t);else{let t={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===n.trickle&&N(e,t)}},n.pc.ontrack=function(e){if(l.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{r.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){l.error("Error calling onremotetrack",e)}if(e.track.onended)return;let s=null;l.log("Adding onended callback to track:",e.track),e.track.onended=function(e){l.log("Remote track removed:",e),clearTimeout(s);let t=n.pc?n.pc.getTransceivers():null,i=t?t.find(t=>{const r=t.receiver||t._receiver;return(r.track||r._track)===e.target}):null,o=i?i.mid||i._mid:e.target.id;try{r.onremotetrack(e.target,o,!1,{reason:"ended"})}catch(e){l.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(l.log("Remote track muted:",e),!s){const t=e.target;s=setTimeout(function(){l.log("Removing remote track");let e=n.pc?n.pc.getTransceivers():null,i=e?e.find(e=>{const r=e.receiver||e._receiver;return(r.track||r._track)===t}):null,o=i?i.mid||i._mid:t.id;try{r.onremotetrack(t,o,!1,{reason:"mute"})}catch(e){l.error("Error calling onremotetrack on mute",e)}s=null},2520)}},e.track.onunmute=function(e){if(l.log("Remote track flowing again:",e),null!=s)clearTimeout(s),s=null;else try{let t=n.pc?n.pc.getTransceivers():null,s=t?t.find(t=>{const r=t.receiver||t._receiver;return(r.track||r._track)===e.target}):null,i=s?s.mid||s._mid:e.target.id;r.onremotetrack(e.target,i,!0,{reason:"unmute"})}catch(e){l.error("Error calling onremotetrack on unmute",e)}}}}async function F(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:l.noop,r.error="function"==typeof r.error?r.error:Z;let n=r.jsep;if(t&&n)return l.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(t||n&&n.type&&n.sdp))return l.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");if(r.media&&!r.tracks){if(r.tracks=l.mediaToTracks(r.media),!0===r.simulcast||!0===r.simulcast2||r.svc)for(let e of r.tracks)if("video"===e.type){!0===r.simulcast||!0===r.simulcast2?e.simulcast=!0:r.svc&&(e.svc=r.svc);break}l.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",r.tracks)}if(r.tracks&&!Array.isArray(r.tracks))return l.error("Tracks must be an array"),void r.error("Tracks must be an array");let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void r.error("Invalid handle");let i=s.webrtcStuff;var o;i.trickle=(o=r.trickle,l.debug("isTrickleEnabled:",o),!1!==o);try{if($(e,r),t&&await q(e,r),n){if(await i.pc.setRemoteDescription(n),l.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(l.endOfCandidates)}i.candidates=[]}await q(e,r);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=x[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=r.webrtcStuff;l.log("Creating answer (iceDone="+n.iceDone+")");let s=await n.pc.createAnswer();l.debug(s);let i={type:"answer",sdp:s.sdp};if(t.customizeSdp(i),s.sdp=i.sdp,l.log("Setting local description"),n.mySdp={type:"answer",sdp:s.sdp},await n.pc.setLocalDescription(s),!n.iceDone&&!n.trickle)return l.log("Waiting for all candidates..."),null;n.insertableStreams&&(s.e2ee=!0);return s}(e,r);r.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=x[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=r.webrtcStuff;l.log("Creating offer (iceDone="+n.iceDone+")");let s={},i=!0===t.iceRestart;i&&(s.iceRestart=!0);l.debug(s);let o=await n.pc.createOffer(s);l.debug(o);let a={type:"offer",sdp:o.sdp};if(t.customizeSdp(a),o.sdp=a.sdp,l.log("Setting local description"),n.mySdp={type:"offer",sdp:o.sdp},await n.pc.setLocalDescription(o),n.mediaConstraints=s,!n.iceDone&&!n.trickle)return l.log("Waiting for all candidates..."),null;n.insertableStreams&&(o.e2ee=!0);return o}(e,r);r.success(t)}}catch(e){l.error(e),r.error(e)}}function W(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:Z,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=t.jsep,n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let s=n.webrtcStuff;if(r){if(!s.pc)return l.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(r),s.pc.setRemoteDescription(r).then(function(){if(l.log("Remote description accepted!"),s.remoteSdp=r.sdp,s.candidates&&s.candidates.length>0){for(let e=0;e<s.candidates.length;e++){let t=s.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?s.pc.addIceCandidate(t):s.pc.addIceCandidate(l.endOfCandidates)}s.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}async function z(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,t.tracks&&!Array.isArray(t.tracks))return l.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await q(e,t),t.success()}catch(e){l.error(e),t.error(e)}}async function q(e,s){let a=x[e];if(!a||!a.webrtcStuff)throw l.warn("Invalid handle, not sending anything"),"Invalid handle";let c=a.webrtcStuff;if(!c.pc)throw l.warn("Invalid PeerConnection"),"Invalid PeerConnection";let d=s.tracks;if(!d||!Array.isArray(d)||0===d.length)return;let u=!1,h={};for(let e of d){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof n)continue;let t=e.group?e.group:"default";h[t]||(h[t]={}),h[t][e.type]||(e.gumGroup=t,h[t][e.type]=e)}let p=Object.keys(h);for(let e of p){let t=h[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete h[e])}let m=!!s.jsep;for(let s of d){if(!s.type){l.warn("Missing track type:",s);continue}if("data"===s.type){if(c.pc.ondatachannel){l.warn("Data channel exists already, not creating another one");continue}l.log("Creating default data channel"),M(e,l.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){l.log("Data channel created by Janus:",t),M(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===s.add&&null===s.add&&void 0===s.remove&&null===s.remove&&void 0===s.replace&&null===s.replace&&(s.add=!0),s.add&&s.remove||s.add&&s.remove&&s.replace){l.warn("Conflicting actions for track, ignoring:",s);continue}s.add&&s.replace?(l.warn("Both add and replace provided, falling back to replace:",s),delete s.add):s.remove&&s.replace&&(l.warn("Both remove and replace provided, falling back to remove:",s),delete s.replace);let d=s.type;"screen"===s.type&&(d="video");let p=null,f=null;if(p=s.mid?c.pc.getTransceivers().find(e=>e.mid===s.mid&&e.receiver.track.kind===d):c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),s.replace||s.remove){if(!p){l.warn("Couldn't find a transceiver for track:",s);continue}if(!p.sender){l.warn("No sender in the transceiver for track:",s);continue}f=p.sender}if(m&&!p&&(p=c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),!p)){l.warn("Couldn't find a transceiver for track:",s);continue}let g=null,y=null;if(s.remove)l.log("Removing track from PeerConnection",s),y=f.track?f.track.id:null,await f.replaceTrack(null);else if(s.capture){if(s.gumGroup&&h[s.gumGroup]&&h[s.gumGroup].stream){let e=h[s.gumGroup].stream;g="audio"===s.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete h[s.gumGroup].stream,delete h[s.gumGroup],delete s.gumGroup}else if(s.capture instanceof n)g=s.capture;else{u||(u=!0,a.consentDialog(!0));let e=l.trackConstraints(s),r=null;if("audio"===s.type||"video"===s.type){if(s.gumGroup){let t="audio"===s.type?"video":"audio";if(h[s.gumGroup]&&h[s.gumGroup][t]){let r=h[s.gumGroup][t],n=l.trackConstraints(r);e[t]=n[t]}}r=await t.mediaDevices.getUserMedia(e),s.gumGroup&&e.audio&&e.video&&(h[s.gumGroup].stream=r,delete s.gumGroup)}else r=await t.mediaDevices.getDisplayMedia(e);g="audio"===s.type?r.getAudioTracks()[0]:r.getVideoTracks()[0]}if(s.replace){await f.replaceTrack(g);let e="sendrecv";!1!==s.recv&&"inactive"!==p.direction&&"sendonly"!==p.direction||(e="sendonly"),p.setDirection?p.setDirection(e):p.direction=e}else{if(c.myStream||(c.myStream=new r),"audio"===d||!s.simulcast&&!s.svc)f=c.pc.addTrack(g,c.myStream),p=c.pc.getTransceivers().find(e=>e.sender===f);else if(s.simulcast){if("firefox"!==l.webRTCAdapter.browserDetails.browser){l.log("Enabling rid-based simulcasting:",g);let e=T(s.simulcastMaxBitrates);p=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:s.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(l.log("Enabling Simulcasting for Firefox (RID)"),p=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream]}),f=p?p.sender:null,f){let e=f.getParameters();e||(e={});let t=T(s.simulcastMaxBitrates);e.encodings=s.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],f.setParameters(e)}}else l.log("Enabling SVC ("+s.svc+"):",g),p=c.pc.addTransceiver(g,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:s.svc}]});if(f||(f=p?p.sender:null),s.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",s);else if("string"!=typeof s.codec)l.warn("Invalid codec value, ignoring for track:",s);else{let e=d+"/"+s.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length){if(p)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}}else l.warn("Codec not supported in this browser for this track, ignoring:",s)}if(s.bitrate)if(s.simulcast||s.svc)l.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(s.bitrate)||s.bitrate<0)l.warn("Ignoring invalid bitrate for track:",s);else if(f){let e=f.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=s.bitrate,await f.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring bitrate for track:",s)}if("video"===d&&s.framerate)if(s.simulcast||s.svc)l.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(s.framerate)||s.framerate<0)l.warn("Ignoring invalid framerate for track:",s);else if(f){let e=f.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=s.framerate,await f.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring framerate for track:",s)}if(s.transforms){if(f&&s.transforms.sender){let e=null;o.prototype.createEncodedStreams?e=f.createEncodedStreams():(o.prototype.createAudioEncodedStreams||o.prototype.createEncodedVideoStreams)&&("audio"===d?e=f.createEncodedAudioStreams():"video"===d&&(e=f.createEncodedVideoStreams())),e&&(l.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(s.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(s.transforms.sender).pipeTo(e.writable))}if(p&&p.receiver&&s.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(s.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(s.transforms.receiver).pipeTo(e.writable))}}}g&&!0===s.dontStop&&(g.dontStop=!0)}else if(s.recv&&!p&&(p=c.pc.addTransceiver(d),p)){if(s.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",s);else if("string"!=typeof s.codec)l.warn("Invalid codec value, ignoring for track:",s);else{let e=d+"/"+s.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}else l.warn("Codec not supported in this browser for this track, ignoring:",s)}if(p.receiver&&s.transforms&&s.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(s.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(s.transforms.receiver).pipeTo(e.writable))}}if(y&&c.myStream){let e=null;if("audio"===d&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===y&&(e=t,l.log("Removing audio track:",e));else if("video"===d&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===y&&(e=t,l.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),a.onlocaltrack(e,!1)}catch(e){l.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(g){c.myStream.addTrack(g),g.onended=function(e){l.log("Local track removed:",e);try{a.onlocaltrack(e.target,!1)}catch(e){l.error("Error calling onlocaltrack following end",e)}};try{a.onlocaltrack(g,!0)}catch(e){l.error("Error calling onlocaltrack for track add",e)}}if(p){let e=p.direction,t=null,r=g&&p.sender.track,n=!1!==s.recv&&p.receiver.track;r&&n?t="sendrecv":r&&!n?t="sendonly":!r&&n?t="recvonly":r||n||(t="inactive"),t&&t!==e&&(l.warn("Changing direction of transceiver to "+t+" (was "+e+")",s),p.setDirection?p.setDirection(t):p.direction=t)}}u&&a.consentDialog(!1)}function B(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let r=t.webrtcStuff;if(!r.pc)return l.warn("Invalid PeerConnection"),null;let n=[],s=r.pc.getTransceivers();for(let e of s){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&n.push(t)}return n}function G(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let r=t.webrtcStuff;if(!r.pc)return l.warn("Invalid PeerConnection"),null;let n=[],s=r.pc.getTransceivers();for(let e of s){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&n.push(t)}return n}function H(e,t,r,n){n="function"==typeof n?n:l.noop;let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void n(0);let i=r?"remote":"local",o=s.webrtcStuff;if(o.volume[i]||(o.volume[i]={value:0}),o.pc&&o.pc.getStats&&("chrome"===l.webRTCAdapter.browserDetails.browser||"safari"===l.webRTCAdapter.browserDetails.browser)){let e=o.pc;if(t){let s=o.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!s)return l.warn("No audio transceiver with mid "+t),void n(0);if(r&&!s.receiver)return l.warn("Remote transceiver track unavailable"),void n(0);if(!r&&!s.sender)return l.warn("Local transceiver track unavailable"),void n(0);e=r?s.receiver:s.sender}return e.getStats().then(function(e){e.forEach(function(e){e&&"audio"===e.kind&&(r&&!e.remoteSource||!r&&"media-source"!==e.type||n(e.audioLevel?e.audioLevel:0))})}),o.volume[i].value}return l.warn("Getting the "+i+" volume unsupported by browser"),void n(0)}function X(e,t,r){let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),!0;let s=n.webrtcStuff;if(!s.pc)return l.warn("Invalid PeerConnection"),!0;if(!s.myStream)return l.warn("Invalid local MediaStream"),!0;if(r){if(!s.myStream.getVideoTracks()||0===s.myStream.getVideoTracks().length)return l.warn("No video track"),!0;if(t){let e=s.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No video sender with mid "+t),!0):(l.warn("No video transceiver with mid "+t),!0)}return!s.myStream.getVideoTracks()[0].enabled}if(!s.myStream.getAudioTracks()||0===s.myStream.getAudioTracks().length)return l.warn("No audio track"),!0;if(t){let e=s.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No audio sender with mid "+t),!0):(l.warn("No audio transceiver with mid "+t),!0)}return!s.myStream.getAudioTracks()[0].enabled}function Q(e,t,r,n){let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),!1;let i=s.webrtcStuff;if(!i.pc)return l.warn("Invalid PeerConnection"),!1;if(!i.myStream)return l.warn("Invalid local MediaStream"),!1;if(r){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return l.warn("No video track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!e)return l.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!n}else for(const e of i.myStream.getVideoTracks())e.enabled=!n}else{if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return l.warn("No audio track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!e)return l.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!n}else for(const e of i.myStream.getAudioTracks())e.enabled=!n}return!0}function K(e,t){let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),"Invalid handle";let n=r.webrtcStuff;if(!n.pc)return"Invalid PeerConnection";if(n.pc.getStats){let e=n.pc,r=t||"default";if(t){let r=n.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!r)return l.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!r.receiver)return l.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=r.receiver}return n.bitrate[r]||(n.bitrate[r]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),n.bitrate[r].timer?n.bitrate[r].value:(l.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),n.bitrate[r].timer=setInterval(function(){e.getStats().then(function(e){e.forEach(function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate[r].bsnow=e.bytesReceived,n.bitrate[r].tsnow=e.timestamp,null===n.bitrate[r].bsbefore||null===n.bitrate[r].tsbefore)n.bitrate[r].bsbefore=n.bitrate[r].bsnow,n.bitrate[r].tsbefore=n.bitrate[r].tsnow;else{let e=n.bitrate[r].tsnow-n.bitrate[r].tsbefore;"safari"===l.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(n.bitrate[r].bsnow-n.bitrate[r].bsbefore)/e);"safari"===l.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),n.bitrate[r].value=t+" kbits/sec",n.bitrate[r].bsbefore=n.bitrate[r].bsnow,n.bitrate[r].tsbefore=n.bitrate[r].tsnow}})})},1e3),"0 kbits/sec")}return l.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function Y(e,t,r){let n=x[e];if(!n||!n.webrtcStuff)return void l.warn("Invalid handle");let s=n.webrtcStuff;if(!s.pc)return void l.warn("Invalid PeerConnection");let i=s.pc.getTransceivers().find(e=>e.mid===t);if(!i)return void l.warn("No transceiver with mid",t);if(!i.sender)return void l.warn("No sender for transceiver with mid",t);let o=i.sender.getParameters();o&&o.encodings&&0!==o.encodings.length?o.encodings.length>1?l.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(r)||r<0?l.warn("Invalid bitrate (must be a positive integer)"):(o.encodings[0].maxBitrate=r,i.sender.setParameters(o)):l.warn("No parameters encodings")}function Z(e){l.error("WebRTC error:",e)}function ee(e,t){l.log("Cleaning WebRTC stuff");let r=x[e];if(!r)return;let n=r.webrtcStuff;if(n){if(!0===t){let t={janus:"hangup",transaction:l.randomString(12)};r.token&&(t.token=r.token),S&&(t.apisecret=S),l.debug("Sending hangup request (handle="+e+"):"),l.debug(t),a?(t.session_id=k,t.handle_id=e,c.send(JSON.stringify(t))):l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:t})}n.volume&&(n.volume.local&&n.volume.local.timer&&clearInterval(n.volume.local.timer),n.volume.remote&&n.volume.remote.timer&&clearInterval(n.volume.remote.timer));for(let e in n.bitrate)n.bitrate[e].timer&&clearInterval(n.bitrate[e].timer);n.bitrate={},!n.streamExternal&&n.myStream&&(l.log("Stopping local stream tracks"),l.stopAllTracks(n.myStream)),n.streamExternal=!1,n.myStream=null;try{n.pc.close()}catch(e){}n.pc=null,n.candidates=null,n.mySdp=null,n.remoteSdp=null,n.iceDone=!1,n.dataChannel={},n.dtmfSender=null,n.insertableStreams=!1}r.oncleanup()}_(e),this.getServer=function(){return m},this.isConnected=function(){return I},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.reconnect=!0,_(e)},this.getSessionId=function(){return k},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,l.log("Getting info on Janus instance"),!I)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=l.randomString(12),r={janus:"info",transaction:t};v&&(r.token=v);S&&(r.apisecret=S);if(a)return O[t]=function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(r));l.httpAPICall(m,{verb:"POST",withCredentials:b,body:r,success:function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,r){l.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)},this.destroy=function(r){!function(r){r=r||{},r.success="function"==typeof r.success?r.success:l.noop,r.error="function"==typeof r.error?r.error:l.noop;let n=!0===r.unload,s=!0;void 0!==r.notifyDestroyed&&null!==r.notifyDestroyed&&(s=!0===r.notifyDestroyed);let i=!0===r.cleanupHandles;if(l.log("Destroying session "+k+" (unload="+n+")"),!k)return l.warn("No session to destroy"),r.success(),void(s&&e.destroyed());if(i)for(let e in x)V(e,{noRequest:!0});if(!I)return l.warn("Is the server down? (connected=false)"),k=null,void r.success();let o={janus:"destroy",transaction:l.randomString(12)};v&&(o.token=v);S&&(o.apisecret=S);if(n)return a?(c.onclose=null,c.close(),c=null):t.sendBeacon(m+"/"+k,JSON.stringify(o)),l.log("Destroyed session:"),k=null,I=!1,r.success(),void(s&&e.destroyed());if(a){o.session_id=k;let t=function(){for(let e in d)c.removeEventListener(e,d[e]);c.removeEventListener("message",n),c.removeEventListener("error",i),u&&clearTimeout(u),c.close()},n=function(n){let i=JSON.parse(n.data);i.session_id==o.session_id&&i.transaction==o.transaction&&(t(),r.success(),s&&e.destroyed())},i=function(){t(),r.error("Failed to destroy the server: Is the server down?"),s&&e.destroyed()};return c.addEventListener("message",n),c.addEventListener("error",i),void(1===c.readyState?c.send(JSON.stringify(o)):i())}l.httpAPICall(m+"/"+k,{verb:"POST",withCredentials:b,body:o,success:function(t){l.log("Destroyed session:"),l.debug(t),k=null,I=!1,"success"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),r.success(),s&&e.destroyed()},error:function(t,n){l.error(t+":",n),k=null,I=!1,r.success(),s&&e.destroyed()}})}(r)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:l.noop,e.iceState="function"==typeof e.iceState?e.iceState:l.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:l.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:l.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:l.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:l.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:l.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:l.noop,e.ondata="function"==typeof e.ondata?e.ondata:l.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:l.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:l.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:l.noop,!I)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return l.error("Invalid plugin"),void e.error("Invalid plugin");let r=e.opaqueId,n=e.loopIndex,s=e.token?e.token:v,i=l.randomString(12),o={janus:"attach",plugin:t,opaque_id:r,loop_index:n,transaction:i};s&&(o.token=s);S&&(o.apisecret=S);if(a)return O[i]=function(r){if(l.debug(r),"success"!==r.janus)return l.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);let n=r.data.id;l.log("Created handle: "+n);let i={session:A,plugin:t,id:n,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return t},getVolume:function(e,t){return H(n,e,!0,t)},getRemoteVolume:function(e,t){return H(n,e,!0,t)},getLocalVolume:function(e,t){return H(n,e,!1,t)},isAudioMuted:function(e){return X(n,e,!1)},muteAudio:function(e){return Q(n,e,!1,!0)},unmuteAudio:function(e){return Q(n,e,!1,!1)},isVideoMuted:function(e){return X(n,e,!0)},muteVideo:function(e){return Q(n,e,!0,!0)},unmuteVideo:function(e){return Q(n,e,!0,!1)},getBitrate:function(e){return K(n,e)},setMaxBitrate:function(e,t){return Y(n,e,t)},send:function(e){j(n,e)},data:function(e){U(n,e)},dtmf:function(e){J(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(n,!0,e)},createAnswer:function(e){F(n,!1,e)},handleRemoteJsep:function(e){W(n,e)},replaceTracks:function(e){z(n,e)},getLocalTracks:function(){return B(n)},getRemoteTracks:function(){return G(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(n,!0===e)},detach:function(e){V(n,e)}};x[n]=i,e.success(i)},o.session_id=k,void c.send(JSON.stringify(o));l.httpAPICall(m+"/"+k,{verb:"POST",withCredentials:b,body:o,success:function(r){if(l.debug(r),"success"!==r.janus)return l.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);let n=r.data.id;l.log("Created handle: "+n);let i={session:A,plugin:t,id:n,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return t},getVolume:function(e,t){return H(n,e,!0,t)},getRemoteVolume:function(e,t){return H(n,e,!0,t)},getLocalVolume:function(e,t){return H(n,e,!1,t)},isAudioMuted:function(e){return X(n,e,!1)},muteAudio:function(e){return Q(n,e,!1,!0)},unmuteAudio:function(e){return Q(n,e,!1,!1)},isVideoMuted:function(e){return X(n,e,!0)},muteVideo:function(e){return Q(n,e,!0,!0)},unmuteVideo:function(e){return Q(n,e,!0,!1)},getBitrate:function(e){return K(n,e)},setMaxBitrate:function(e,t){return Y(n,e,t)},send:function(e){j(n,e)},data:function(e){U(n,e)},dtmf:function(e){J(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(n,!0,e)},createAnswer:function(e){F(n,!1,e)},handleRemoteJsep:function(e){W(n,e)},replaceTracks:function(e){z(n,e)},getLocalTracks:function(){return B(n)},getRemoteTracks:function(){return G(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(n,!0===e)},detach:function(e){V(n,e)}};x[n]=i,e.success(i)},error:function(t,r){l.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)}}return l.useDefaultDependencies=function(t){let r=t&&t.fetch||fetch,n=t&&t.Promise||Promise,s=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new s(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let s={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(s.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(s.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(s.body=JSON.stringify(t.body));let i=r(e,s).catch(function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})});if(t.timeout){let e=new n(function(e,r){let n=setTimeout(function(){return clearTimeout(n),r({message:"Request timed out",timeout:t.timeout})},t.timeout)});i=n.race([i,e])}return i.then(function(e){return e.ok?typeof t.success==typeof l.noop?e.json().then(function(e){try{t.success(e)}catch(e){l.error("Unhandled httpAPICall success callback error",e)}},function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:n.reject({message:"API call failed",response:e})}).catch(function(e){typeof t.error==typeof l.noop&&t.error(e.message||"<< internal error >>",e)}),i}}},l.useOldDependencies=function(t){let r=t&&t.jQuery||jQuery,n=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},isArray:function(e){return r.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let n=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},s=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return r.ajax(r.extend(n,s,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof l.noop&&t.success(e)},error:function(e,r,n){typeof t.error==typeof l.noop&&t.error(r,n)}}))}}},l.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let r={type:"audio"};e.removeAudio?r.remove=!0:(e.addAudio?r.add=!0:e.replaceAudio&&(r.replace=!0),!1!==e.audioSend&&(r.capture=e.audio||!0),!1!==e.audioRecv&&(r.recv=!0)),(r.remove||r.capture||r.recv)&&t.push(r)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let r={type:"video"};e.removeVideo?r.remove=!0:(e.addVideo?r.add=!0:e.replaceVideo&&(r.replace=!0),!1!==e.videoSend&&(r.capture=e.video||!0,["screen","window","desktop"].includes(r.capture)&&(r.type="screen",r.capture={video:{}},e.screenshareFrameRate&&(r.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(r.capture.height=e.screenshareHeight),e.screenshareWidth&&(r.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(r.recv=!0)),(r.remove||r.capture||r.recv)&&t.push(r)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},l.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let r=0,n=0;"lowres"===e.capture?(r=320,n=240):"lowres-16:9"===e.capture?(r=320,n=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(r=1280,n=720):"fhdres"===e.capture?(r=1920,n=1080):"4kres"===e.capture?(r=3840,n=2160):"stdres"===e.capture?(r=640,n=480):"stdres-16:9"===e.capture?(r=640,n=360):(l.log("Default video setting is stdres 4:3"),r=640,n=480),t.video={width:{ideal:r},height:{ideal:n}}}else"screen"===e.type&&(t.video=e.capture);return t},l.noop=function(){},l.dataChanDefaultLabel="JanusDataChannel",l.endOfCandidates=null,l.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)l.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},l.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:l.noop,l.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),l.trace=l.noop,l.debug=l.noop,l.vdebug=l.noop,l.log=l.noop,l.warn=l.noop,l.error=l.noop,!0===e.debug||"all"===e.debug)l.trace=console.trace.bind(console),l.debug=console.debug.bind(console),l.vdebug=console.debug.bind(console),l.log=console.log.bind(console),l.warn=console.warn.bind(console),l.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":l.trace=console.trace.bind(console);break;case"debug":l.debug=console.debug.bind(console);break;case"vdebug":l.vdebug=console.debug.bind(console);break;case"log":l.log=console.log.bind(console);break;case"warn":l.warn=console.warn.bind(console);break;case"error":l.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}l.log("Initializing library");let r=e.dependencies||l.useDefaultDependencies();if(l.isArray=r.isArray,l.webRTCAdapter=r.webRTCAdapter,l.httpAPICall=r.httpAPICall,l.newWebSocket=r.newWebSocket,l.extension=r.extension,l.extension.init(),l.listDevices=function(e,r){e="function"==typeof e?e:l.noop,r||(r={audio:!0,video:!0}),l.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(r).then(function(r){t.mediaDevices.enumerateDevices().then(function(t){l.debug(t),e(t),l.stopAllTracks(r)})}).catch(function(t){l.error(t),e([])}):(l.warn("navigator.mediaDevices unavailable"),e([]))},l.safariVp8=!1,"safari"===l.webRTCAdapter.browserDetails.browser&&l.webRTCAdapter.browserDetails.version>=605)if(o&&o.getCapabilities&&o.getCapabilities("video")&&o.getCapabilities("video").codecs&&o.getCapabilities("video").codecs.length){for(let e of o.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){l.safariVp8=!0;break}l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new s({});e.createOffer({offerToReceiveVideo:!0}).then(function(t){l.safariVp8=-1!==t.sdp.indexOf("VP8"),l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null})}l.initDone=!0,e.callback()}},l.isWebrtcSupported=function(){return!!s},l.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},l.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let n=0;n<e;n++){let e=Math.floor(62*Math.random());r+=t.charAt(e)}return r},vn=l}(),In=re(Tn);class kn{constructor(e){if(this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentRoomId=null,this.currentUserId=null,this.remoteFeeds={},this.remoteJseps={},this.remoteFeedsAttachingInProgress={},this.bitrateTimers={},this.emitter=new wn,!Z.env.isReactNative&&!C)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=Y.conference.server,this.debug=Y.conference.debug??L.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}createSession({success:e=()=>{},error:t=()=>{},destroyed:r=()=>{},timeoutSessionCallback:n=()=>{}}){In.init({debug:this.debug,callback:()=>{In.isWebrtcSupported()?this.engine=new In({server:this.server,iceServers:Y.videochat.iceServers,token:this.token,success:()=>Z.safeCallbackCall(e)(),error:e=>Z.safeCallbackCall(t)(e),destroyed:()=>Z.safeCallbackCall(r)(),timeoutSessionCallback:()=>Z.safeCallbackCall(n)()}):Z.safeCallbackCall(t)("Your browser does not support WebRTC, so you can't use this functionality.")}})}getSessionId(){return this.engine?.getSessionId()??null}destroySession({success:e=()=>{},error:t=()=>{}}){this.engine.destroy({success:()=>Z.safeCallbackCall(e)(),error:e=>Z.safeCallbackCall(t)(e)})}attachVideoConferencingPlugin(e,t,r,n){let s=null;const i=n.localStream;delete n.localStream;const o=n.displayName;delete n.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:r=>{if(e){s=r,s.userId=t,this.remoteFeedsAttachingInProgress[t]=s;const e={request:"join",room:this.currentRoomId,ptype:"listener",feed:t,display:o};s?.send({message:e})}else this.videoRoomPlugin=r;Z.safeCallbackCall(n.success)()},error:e=>{Z.safeCallbackCall(n.error)(e)},consentDialog:e=>{Z.safeCallbackCall(n.consentDialog)(e)},mediaState:(e,t)=>{Z.safeCallbackCall(n.mediaState)(e,t)},webrtcState:e=>{Z.safeCallbackCall(n.webrtcState)(e)},slowLink:(e,t)=>{Z.safeCallbackCall(n.slowLink)(e,t)},iceState:e=>{Z.safeCallbackCall(n.iceState)(e)},onmessage:(t,s)=>{const o=t.videoroom;if(e){if(o)if("attached"===o){const e=t.id;this.remoteFeeds[e]=this.remoteFeedsAttachingInProgress[e],this.remoteFeedsAttachingInProgress[e]=null}else t.error&&Z.safeCallbackCall(n.error)(t.error);if(s){const e=t.id;this.remoteJseps[e]=s,this.createAnswer({remoteFeed:this.remoteFeeds[e],jsep:s},i,{success:()=>{},error:e=>{Z.safeCallbackCall(n.error)(e)}})}}else{if(o)if("joined"===o){const e={media:r?{audio:!1,video:!1}:{audio:!0,video:!0},stream:r?void 0:i};this.createOffer(e,{success:()=>{if(t.publishers){const e=t.publishers;for(const t in e){const r=e[t].id,n=e[t].display;this.emitter.emit(V.PARTICIPANT_JOINED,r,n,!0)}}},error:e=>{Z.safeCallbackCall(n.error)(e)}})}else if("event"===o)if(t.publishers){const e=t.publishers;for(const t in e){const r=e[t].id,n=e[t].display;this.emitter.emit(V.PARTICIPANT_JOINED,r,n,!1)}}else if(t.leaving){const e=t.leaving;this.detachRemoteFeed(e)&&this.emitter.emit(V.PARTICIPANT_LEFT,e,null)}else if(t.unpublished){const e=t.unpublished;if("ok"!=e){this.detachRemoteFeed(e)&&this.emitter.emit(V.PARTICIPANT_LEFT,e,null)}}else t.error&&(Z.DLog("[janus error message]",t.error),this.emitter.emit(V.ERROR,t),Z.safeCallbackCall(n.error)(t.error));s&&this.videoRoomPlugin.handleRemoteJsep({jsep:s})}},onlocaltrack:(e,t)=>{Z.DLog("[onlocaltrack]",e,t),this.onLocalTrack(e,t)},onremotetrack:(e,t,r,n)=>{Z.DLog("[onremotetrack]",e,t,r,n),this.onRemoteTrack(s,e,t,r,n)},ondataopen:e=>{Z.DLog("[ondataopen]",e),this.emitter.emit(V.DATA_CHANNEL_OPEN,e)},ondata:(e,t)=>{Z.DLog("[ondata]",t,e),this.emitter.emit(V.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:()=>{Z.safeCallbackCall(n.oncleanup)()},detached:()=>{}})}onLocalTrack(e,t){}onRemoteTrack(e,t,r,n,s){const i=s&&s.reason;if(i===F.CREATED){const n=!e.stream||!e.tracks;n?(e.tracks={[r]:t},e.stream=new u([t])):(e.tracks[r]=t,e.stream.addTrack(t)),n&&this.emitter.emit(V.REMOTE_STREAM,e.userId,e.stream)}else if(i===F.ENDED){delete e.tracks[r];const n=e.stream.getTracks().find(e=>e.kind===t.kind);e.stream.removeTrack(n)}this.emitter.emit(V.REMOTE_TRACKS_UPDATED,e.userId,t,i)}getPluginId(){return this.videoRoomPlugin?.getId()??null}detachVideoConferencingPlugin(e){const t=()=>{this.videoRoomPlugin=null,Object.keys(this.remoteFeeds).forEach(e=>{this.detachRemoteFeed(Number(e))}),this.remoteFeeds={},this.remoteJseps={}};this.videoRoomPlugin.detach({success:()=>{t(),Z.safeCallbackCall(e.success)()},error:r=>{t(),Z.safeCallbackCall(e.error)(r)}})}join(e,t,r,n){const s=n.displayName;delete n.displayName,this.isOnlyAudio=r,Z.DLog("isOnlyAudio: "+this.isOnlyAudio);const i={request:"join",room:e,ptype:"publisher",id:t,display:s};this.videoRoomPlugin.send({message:i,success:r=>{this.currentRoomId=e,this.currentUserId=t,Z.safeCallbackCall(n.success)()},error:e=>{Z.safeCallbackCall(n.error)(e)}})}leave(e){if(Z.DLog("leave"),!this.engine.isConnected())return void Z.safeCallbackCall(e.success)();const t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,Z.safeCallbackCall(e.success)()}listOnlineParticipants(e,t){const r={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:r,success:e=>{const r=e?e.participants:[];Z.safeCallbackCall(t.success)(r)},error:e=>{Z.safeCallbackCall(t.error)(e)}})}toggleAudioMute(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()}isAudioMuted(){return this.videoRoomPlugin.isAudioMuted()}toggleRemoteAudioMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getAudioTracks();if(r&&r.length>0){for(let e=0;e<r.length;++e)r[e].enabled=!r[e].enabled;return!r[0].enabled}return!1}isRemoteAudioMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getAudioTracks();return!!(r&&r.length>0)&&!r[0].enabled}toggleVideoMute(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()}isVideoMuted(){return this.videoRoomPlugin.isVideoMuted()}toggleRemoteVideoMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getVideoTracks();if(r&&r.length>0){for(let e=0;e<r.length;++e)r[e].enabled=!r[e].enabled;return!r[0].enabled}return!1}isRemoteVideoMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getVideoTracks();return!!(r&&r.length>0)&&!r[0].enabled}sendKeyframeRequest(e,t){const r={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:r,success:e=>{Z.safeCallbackCall(t.success)(e)},error:e=>{Z.safeCallbackCall(t.error)(e)}})}getTracksFromStream(e){const t=[],r=e.getAudioTracks();if(r.length){const e=r[0];t.push({type:"audio",capture:e,recv:!1})}const n=e.getVideoTracks();if(n.length){const e=n[0];t.push({type:"video",capture:e,recv:!1})}return t}createOffer(e,t){Z.DLog("[JanusWrapper][createOffer]",e);const{stream:r,media:n,replace:s}=e,i={tracks:[{type:"data"}]};if(r){const e=this.getTracksFromStream(r);i.tracks=i.tracks.concat(e)}else if(n){const e=[];n.audio&&e.push({type:"audio",capture:n.audio,recv:!1,replace:!!s}),n.video&&e.push({type:"video",capture:n.video,recv:!1,replace:!!s}),i.tracks=i.tracks.concat(e)}else i.tracks=i.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!s},{type:"video",capture:!0,recv:!1,replace:!!s}]);Z.DLog("[JanusWrapper][createOffer][params]",i),i.customizeSdp=e=>{},i.success=e=>{const r={request:"configure",audio:!!n.audio,video:!!n.video};Z.DLog("[JanusWrapper][createOffer][success]",r),this.videoRoomPlugin.send({message:r,jsep:e}),Z.safeCallbackCall(t.success)()},i.error=e=>{Z.DLog("[JanusWrapper][createOffer][error]",e),n.audio?this.createOffer({media:{video:!1,audio:!1}},t):Z.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(i)}getTracksMidsFromStream(e){const t=[],r=e.getAudioTracks();if(r.length){const e=r[0];t.push({type:"audio",mid:e.id,recv:!0})}const n=e.getVideoTracks();if(n.length){const e=n[0];t.push({type:"video",mid:e.id,recv:!0})}return t}createAnswer({remoteFeed:e,jsep:t},r,n){Z.DLog("[JanusWrapper][createAnswer]",t,r);let s=[{type:"data"}];if(r){const e=this.getTracksMidsFromStream(r);s=s.concat(e)}Z.DLog("[JanusWrapper][createAnswer][tracks]",s),e.createAnswer({jsep:t,tracks:s,success:t=>{const r={request:"start",room:this.currentRoomId};Z.DLog("[JanusWrapper][createAnswer][success]",r),e.send({message:r,jsep:t}),Z.safeCallbackCall(n.success)()},error:e=>{Z.DLog("[JanusWrapper][createAnswer][error]",e),Z.safeCallbackCall(n.error)(e)}})}detachRemoteFeed(e){const t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)}getUserBitrate(e){return this.remoteFeeds[e].getBitrate()}getVolume(e){return this.videoRoomPlugin.getLocalVolume(null,e)}getUserVolume(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)}showBitrate(e,t){const r=this.remoteFeeds[e];Z.env.isReactNative||"chrome"!==C.browserDetails.browser&&"firefox"!==C.browserDetails.browser||(this.bitrateTimers[e]=setInterval(()=>{const e=r.getBitrate();t.text(e)},1e3))}hideBitrate(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null}on(e,t){return this.emitter.addListener(e,t)}removeAllListeners(e){return this.emitter.removeAllListeners(e)}}class xn{constructor(e){this.id=`${Math.random()}`,this.mediaParams={},this.onParticipantJoined=(e,t,r)=>{Z.DLog("[onParticipantJoined]",e,t,r),this.createHandler(e,!0,!1),Z.safeCallbackCall(this.onParticipantJoinedListener)(this,e,t,r)},this.onParticipantLeft=(e,t)=>{Z.DLog("[onParticipantLeft]",e,t),Z.safeCallbackCall(this.onParticipantLeftListener)(this,e,t)},this.onError=e=>{Z.DLog("[onError]",JSON.stringify(e)),Z.safeCallbackCall(this.onErrorListener)(this,e)},this.onDataChannelOpen=e=>{Z.DLog("[onDataChannelOpen]",e),Z.safeCallbackCall(this.onDataChannelOpenedListener)(this,e)},this.onDataChannelMessage=(e,t)=>{Z.DLog("[onDataChannelMessage]",e,t),Z.safeCallbackCall(this.onDataChannelMessageListener)(this,e,t)},this.onLocalIceStateChanged=e=>{Z.DLog("[onLocalIceStateChanged]",e),Z.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e)},this.onRemoteIceStateChanged=(e,t)=>{Z.DLog("[onRemoteIceStateChanged]",e,t),Z.safeCallbackCall(this.onRemoteConnectionStateChangedListener)(this,e,t)},this.onRemoteStream=(e,t)=>{Z.DLog("[onRemoteStream]",e,t),Z.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)},this.onRemoteTracksUpdated=(e,t,r)=>{Z.DLog("[onRemoteTracksUpdated]",e,t,r),Z.safeCallbackCall(this.onRemoteTracksUpdatedListener)(this,e,t,r)},this.onSlowLink=(e,t,r)=>{Z.DLog("[onSlowLink]",e,t,r),Z.safeCallbackCall(this.onSlowLinkListener)(this,e,t,r)},this.client=new kn(e),this.client.on(V.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(V.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(V.REMOTE_STREAM,this.onRemoteStream),this.client.on(V.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(V.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(V.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(V.ERROR,this.onError)}get currentRoomId(){return this.client.currentRoomId}set currentRoomId(e){this.client.currentRoomId=e}get currentPublisherPC(){return this.client.videoRoomPlugin.webrtcStuff.pc}async createSession(){let e=!1;return new Promise((t,r)=>{this.client.createSession({success:()=>{e=!0,t(void 0)},error:t=>{e?this.onError(t):r(t)}})})}async join(e,t,r){this.currentUserDisplayName=r,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!1),await this.joinInternal(this.currentRoomId,t)}async joinAsListener(e,t,r){this.currentUserDisplayName=r,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!0),await this.joinInternal(this.currentRoomId,t)}async sendKeyframeRequest(e){return new Promise((t,r)=>{this.client.sendKeyframeRequest(e,{success:t,error:r})})}async createHandler(e,t,r=!1){return new Promise((n,s)=>{this.client.attachVideoConferencingPlugin(t,e,r,{success:n,error:s,iceState:t?t=>this.onRemoteIceStateChanged(e,t):e=>this.onLocalIceStateChanged(e),slowLink:t?(t,r)=>this.onSlowLink(e,t,r):(e,t)=>this.onSlowLink(null,e,t),localStream:this.localStream,displayName:this.currentUserDisplayName})})}async joinInternal(e,t){return new Promise((r,n)=>{this.client.join(e,t,!1,{success:r,error:n,displayName:this.currentUserDisplayName})})}async listOfOnlineParticipants(){return new Promise((e,t)=>{this.currentRoomId?this.client.listOnlineParticipants(this.currentRoomId,{success:e,error:t}):t("Room ID is not set")})}async leave(){this.currentRoomId=null,this.currentUserDisplayName=void 0,await this.leaveGroup(),await this.detachVideoConferencingPlugin(),await this.destroy(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}async leaveGroup(){return new Promise((e,t)=>{this.client.leave({success:e,error:t})})}async destroy(){return new Promise((e,t)=>{this.client.destroySession({success:e,error:t})})}async detachVideoConferencingPlugin(){return new Promise((e,t)=>{this.client.detachVideoConferencingPlugin({success:e,error:t})})}async getDisplayMedia(e){if(!d.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,r=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await d.getDisplayMedia(n);return this.upsertStream(e,t,r)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,r=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await d.getUserMedia(n);return this.upsertStream(e,t,r)}catch(e){throw e}}upsertStream(e,t=null,r={}){const n=!!this.localStream;if(n?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(n&&this.detachMediaStream(t,r),this.attachMediaStream(t,this.localStream,r)),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===$.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{const t=this.currentPublisherPC.getSenders().find(({track:t})=>e.kind===t.kind);e.kind===$.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,t?(t.replaceTrack(e),this.localStream?.addTrack(e)):console.warn(`No sender found for track kind: ${e.kind}`)}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async switchMediaTracks(e){[$.AUDIO,$.VIDEO].forEach(t=>{const r=t===$.AUDIO?e.audio:t===$.VIDEO?e.video:{},n="string"==typeof r?r:r?.deviceId??null;n&&("object"==typeof this.mediaParams[t]?this.mediaParams[t].deviceId=n:this.mediaParams[t]={deviceId:n})});try{const e={audio:this.mediaParams?.audio??!1,video:this.mediaParams?.video??!1},t=await d.getDisplayMedia(e);return this.replaceTracks(t)}catch(e){throw e}}muteVideo(){this.isVideoMuted()||this.client.toggleVideoMute()}unmuteVideo(){this.isVideoMuted()&&this.client.toggleVideoMute()}muteAudio(){this.isAudioMuted()||this.client.toggleAudioMute()}unmuteAudio(){this.isAudioMuted()&&this.client.toggleAudioMute()}isVideoMuted(){return this.client.isVideoMuted()}isAudioMuted(){return this.client.isAudioMuted()}async getUserVolume(){return new Promise((e,t)=>this.client.getVolume(e))}getRemoteUserBitrate(e){return this.client.getUserBitrate(e)}async getRemoteUserVolume(e){return new Promise((t,r)=>this.client.getUserVolume(e,t))}attachMediaStream(e,t,r){const n=document.getElementById(e);if(!("srcObject"in n))throw new Error(`Unable to attach media stream, element #${e} is undefined`);n.srcObject=t,n.style.transform=r?.mirror?"scaleX(-1)":"none","boolean"==typeof r?.muted&&(n.muted=r?.muted),n.onloadedmetadata=e=>{n.play()}}detachMediaStream(e,t){const r=document.getElementById(e);if(!("srcObject"in r))throw new Error(`Unable to attach media stream, element #${e} is undefined`);r.pause(),r.srcObject=null,r.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(r.muted=t?.muted)}async sendData(e,t){return new Promise((r,n)=>{this.client.videoRoomPlugin.data({data:e,label:t,success:r,error:n})})}}class An{constructor(e){this.DeviceInputType=J,this.JanusCallType=$,this.sessionsStore={},this.proxy=e}createNewSession(){const e=new xn(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e}async getMediaDevices(e){if(d?.enumerateDevices){const t=await d.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}clearSession(e){delete this.sessionsStore[e]}getCurrentSessionToken(){const e=this.proxy.getSession();if(e?.token)return e.token;throw new Error("Session does not exist")}getListenerByName(e){switch(e){case W.JOIN:return"onParticipantJoinedListener";case W.LEFT:return"onParticipantLeftListener";case W.SLOW_LINK:return"onSlowLinkListener";case W.REMOTE_STREAM:return"onRemoteStreamListener";case W.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case W.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case W.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case W.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case W.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case W.ERROR:return"onErrorListener";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}class Dn{constructor(e){this.route=Y.urls.data,this.proxy=e}async create(e,t={}){const r=Z.isArray(t),n=r?"multi":void 0,s={type:B.POST,url:Z.getUrl(this.route,e,n),data:r?{record:this.createRecord(t)}:t};return this.proxy.ajax(s)}async list(e,t={}){const r="string"==typeof t?t:Z.isArray(t)?t.toString():void 0,n={url:Z.getUrl(this.route,e,r),data:r?void 0:t};return this.proxy.ajax(n)}async readPermissions(e,t){const r={url:Z.getUrl(this.route,e,t),data:{permissions:1}};return this.proxy.ajax(r)}async update(e,t={}){const r=Z.isArray(t),n=!r&&t.search_criteria,s=r?"multi":n?"by_criteria":t.id||t._id,i={type:B.PUT,url:Z.getUrl(this.route,e,s),data:r?{record:this.createRecord(t)}:t};return this.proxy.ajax(i)}async delete(e,t){const r=Z.isObject(t),n="string"==typeof t||Z.isArray(t)&&1===t.length,s=r?"by_criteria":t.toString(),i={type:B.DELETE,url:Z.getUrl(this.route,e,s),data:r?t:void 0,dataType:n?G.TEXT:void 0};return this.proxy.ajax(i)}createRecord(e=[]){return e.reduce((e,t,r)=>{const n=r+1,s=t.id||t._id,i=s?{...t,id:s}:t;return{...e,[n]:i}},{})}}class On{constructor(e){this.route=Y.urls.meetings,this.proxy=e}async get(e={}){const t={type:B.GET,url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t=Math.ceil(Date.now()/1e3),r=t+3600,n={name:new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),start_date:t,end_date:r,attendees:[],record:!1,chat:!1},s={type:B.POST,url:Z.getUrl(this.route),data:{...n,...e}};return this.proxy.ajax(s)}async update(e,t){const r={type:B.PUT,url:Z.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e){const t={type:B.DELETE,url:Z.getUrl(this.route,e),dataType:G.TEXT};return this.proxy.ajax(t)}async getRecordings(e){const t={type:B.GET,url:Z.getUrl(this.route,"recordings",e)};return this.proxy.ajax(t)}}class Rn{constructor(){this.sdkInstance={config:Y,session:null},this.requestsNumber=0,this.fetchImpl=a,this.abortControllersMap={},this.requestMethod=B,this.responseType=G}setSession(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)}getSession(){return this.sdkInstance.session}setCurrentUserId(e){this.currentUserId=e||void 0}getCurrentUserId(){return this.currentUserId}logRequest(e,t){Z.DLog(`[Request][${t}]`,`${e.type||"GET"} ${e.url}`,e)}logResponse(e,t){Z.DLog(`[Response][${t}]`,e)}buildRequestAndURL(e){const t=!e.type||"GET"===e.type||"HEAD"===e.type,r=!!e.type&&("POST"===e.type||"PUT"===e.type),n=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,s=-1===e.url.indexOf("s3.amazonaws.com"),i=!1===e.contentType,o=e.authKey;let a,c=e.url;const l={};return l.method=e.type||"GET",e.data&&(a=this.buildRequestBody(e,i,r),t?c+=`?${a}`:l.body=a),i||(l.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),s&&(l.headers||(l.headers={}),l.headers["CB-SDK"]=`JS ${Y.version} - Client`,n?l.headers["CB-Token"]=n:o&&(l.headers["CB-AuthKey"]=o)),Y.timeout&&(l.timeout=Y.timeout),[l,c]}buildRequestBody(e,t,r){const n=e.data,s=e.useArrayQuery;let i;return t?(i=new c,Object.keys(n).forEach(function(t){e.fileToCustomObject&&"file"===t?i.append(t,n[t].data,n[t].name):i.append(t,e.data[t])})):i=r?JSON.stringify(n):this.serializeQueryParams(n,"",s,0),i}serializeQueryParams(e,t,r,n=0){const s=[];for(let i in e){let o=this.encodeURIComponent(i);Z.isArray(e)&&(o="");const a=t?t+`[${o}]`:o;let c=e[i];const l=Z.isArray(c);l&&(r||0===n)||Z.isObject(c)?s.push(this.serializeQueryParams(c,a,r,++n)):(c=l?c.sort().join(","):c,s.push(`${a}=${this.encodeURIComponent(c)}`))}return s.sort().join("&")}encodeURIComponent(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,e=>`%${e.charCodeAt(0).toString(16)}`)}abortRequest(e){if(this.abortControllersMap[e]){(this.abortControllersMap[e].controllers||[]).forEach(e=>{e.abort()})}}processSuccessfulOrFailedRequest(e){if(!e||!this.abortControllersMap[e])return;const t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1;this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}async ajax(e){const t=++this.requestsNumber;return new Promise((r,n)=>{this.logRequest(e,t);const[s,i]=this.buildRequestAndURL(e),o=e.abort_id;if(o){let e=0;if(this.abortControllersMap[o]){const t=this.abortControllersMap[o].controllers||[];this.abortControllersMap[o].controllers.push(new AbortController),e=t.length-1}else this.abortControllersMap[o]={controllers:[new AbortController]};const t=this.abortControllersMap[o].controllers[e].signal;Object.assign(s,{signal:t})}let c;a(i,s).then(t=>{c=t;return(e.dataType||G.JSON)===G.TEXT?c.text():c.json()}).then(s=>{this.processSuccessfulOrFailedRequest(o),c.ok?this.processAjaxResponse(s,r,t):this.processAjaxError(c,s,null,n,r,e,t)}).catch(s=>{this.processSuccessfulOrFailedRequest(o),this.processAjaxError(c," ",s,n,r,e,t)})})}processAjaxResponse(e,t,r){const n=e&&" "!==e?e:"empty body";this.logResponse(n,r),t(e)}processAjaxError(e,t,r,n,s,i,o){if(!e&&r&&!r.code)return void n(r);const a=t||r||t.errors,c=e?.status,l={code:e&&c||r&&r.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||r&&r.errno};this.logResponse(a,o),-1===e?.url.indexOf(Y.urls.session)&&this.isExpiredSessionError(l)&&"function"==typeof Y.on.sessionExpired?this.handleExpiredSessionResponse(l,null,n,s,i):n(l)}handleExpiredSessionResponse(e,t,r,n,s){const i=()=>{e?r(e):n(t)},o=e=>{e&&(this.setSession(e),this.ajax(s).then(n).catch(r))};"function"==typeof Y.on.sessionExpired&&Y.on.sessionExpired(i,o)}isExpiredSessionError(e){try{return e&&401===e.code&&"Required session does not exist"===e.info?.errors?.base?.[0]}catch{return!1}}}class Pn{constructor(e){this.base64Encode=t,this.proxy=e,this.subscriptions=new Ln(e),this.events=new _n(e)}}class Ln{constructor(e){this.route=Y.urls.subscriptions,this.proxy=e}async create(e){const t={type:B.POST,url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async list(){const e={type:B.GET,url:Z.getUrl(this.route)};return this.proxy.ajax(e)}async delete(e){const t={type:B.DELETE,dataType:G.TEXT,url:Z.getUrl(this.route,e)};return this.proxy.ajax(t)}}class _n{constructor(e){this.route=Y.urls.events,this.proxy=e}async create(e){const t={type:B.POST,url:Z.getUrl(this.route),data:{event:e}};return this.proxy.ajax(t)}}class jn{constructor(e){this.route=Y.urls.blobs,this.proxy=e}async list(e={}){const t={type:B.GET,url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t={type:B.POST,url:Z.getUrl(this.route),data:{blob:e}};return this.proxy.ajax(t)}async delete(e){const t={type:B.DELETE,url:Z.getUrl(this.route,e),dataType:G.TEXT};return this.proxy.ajax(t)}async createAndUpload(e){const{name:t,file:r,size:n,abort_id:s,type:i,public:o=!0}=e,a={name:t,content_type:i,public:o};let c;return this.create(a).then(({blob:e})=>{c=e;const t=this.parseUri(c.blob_object_access?.params),n={url:`${t.protocol}://${t.authority}${t.path}`,data:{}};return s&&(n.abort_id=s),Object.keys(t.queryKey).forEach(e=>{n.data[e]=decodeURIComponent(t.queryKey[e])}),n.data.file=r,this.upload(n).then(()=>c)}).then(e=>this.markUploaded({id:e.id,size:n}).then(()=>e)).then(e=>({...e,size:n}))}async upload(e){const t={...e,type:B.POST,dataType:G.TEXT,contentType:!1};return this.proxy.ajax(t)}async markUploaded(e){const t={type:B.PUT,url:Z.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:G.TEXT};return this.proxy.ajax(t)}async getInfo(e){const t={url:Z.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFile(e){const t={url:Z.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFileObject(e,t){const r={type:B.GET,url:Z.getUrl(this.route,e,"object"),data:t};return this.proxy.ajax(r)}async update(e){const t={blob:{}};void 0!==e.name&&(t.blob.name=e.name);const r={url:Z.getUrl(this.route,e.id),data:t};return this.proxy.ajax(r)}privateUrl(e=""){return`https://${Y.endpoints.api}/blobs/${e}?token=${this.proxy.getSession()?.token}`}publicUrl(e=""){return`https://${Y.endpoints.api}/blobs/${e}`}parseUri(e=""){const t={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r=t.parser.loose.exec(e)??{},n={};let s=14;for(;s--;)n[t.key[s]]=r[s]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,(e,r,s)=>{r&&(n[t.q.name][r]=s)}),n}}class Nn{constructor(e){this.route=Y.urls.users,this.proxy=e}async getV2(e){const t={type:B.GET,url:Z.getUrl(this.route,"v2"),useArrayQuery:!0,data:e};return this.proxy.ajax(t)}async signup(e,t){const r={authKey:t??Y.creds.authKey,type:B.POST,url:Z.getUrl(this.route),data:{user:e}};return this.proxy.ajax(r)}async update(e={}){const t={type:B.PUT,url:Z.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}};return this.proxy.ajax(t)}async delete(){const e={type:B.DELETE,url:Z.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:G.TEXT};return this.proxy.ajax(e)}async resetPassword(e=""){const t={type:B.POST,url:Z.getUrl(this.route,"password","reset"),data:{email:e},dataType:G.TEXT};return this.proxy.ajax(t)}async listOnline(e={}){const t={type:B.GET,url:Z.getUrl(this.route,"online"),data:e};return this.proxy.ajax(t)}async getOnlineCount(){const e={type:B.GET,url:Z.getUrl(this.route,"online"),data:{count:!0}};return this.proxy.ajax(e)}async get(e){let t=Z.cloneObject(e),r="";const n=[],s=["created_at","updated_at","last_request_at"],i=["id","external_user_id"],o={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"};function a(e){const t=Z.cloneObject(e);let r=s.includes(t.field)?"date":typeof t.value;return Z.isArray(t.value)&&("object"===r&&(r=typeof t.value[0]),t.value=t.value.toString()),[r,t.field,t.param,t.value].join(" ")}if(t.order){const e=t.order.field in s?"date":t.order.field in i?"number":"string";t.order=[t.order.sort,e,t.order.field].join(" ")}if(t&&t.filter&&(Z.isArray(t.filter)?t.filter.forEach(e=>{n.push(a(e))}):n.push(a(t.filter)),t.filter=n),"number"==typeof t)r=t,t=void 0;else for(const e in o)if(t[e]){r=o[e],e===o.external&&(r+=`/${t[o.external]}`,t=void 0);break}const c={type:B.GET,url:Z.getUrl(this.route,r),data:t};return this.proxy.ajax(c)}}class Mn{static getUserJid(e){return`${e}-${Y.creds.appId}@${Y.endpoints.chat}`}static getUserIdFromJID(e){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}static trace(e){Y.debug&&console.log("[VideoChat]:",e)}static traceWarning(e){Y.debug&&console.warn("[VideoChat]:",e)}static traceError(e){Y.debug&&console.error("[VideoChat]:",e)}static get getVersionFirefox(){const e=l?.userAgent??null;let t=0;if(e){const r=e.match(/(?:firefox)[ \/](\d+)/i)||[];t=r[1]?+r[1]:0}return"string"==typeof t?parseInt(t):t}static get getVersionSafari(){const e=l?.userAgent??null;let t=0;if(e){if((e.match(/(?:safari)[ \/](\d+)/i)||[]).length){const r=e.match(/(?:version)[ \/](\d+)/i)||[];r&&(t=r[1]?+r[1]:0)}}return"string"==typeof t?parseInt(t):t}}class Un{constructor(e,t,r){this.remoteSDP=null,this.state=A.NEW,this.iceCandidates=[],this.remoteStream=new u,this.answerTimeInterval=0,this.onStatusClosedChecker=null,this.dialingTimer=null,this.statsReportTimer=null,this.waitingReconnectTimeoutCallback=null,this.released=!1,this.onMediaTrackHandler=e=>{this.remoteStream.addTrack(e.track),(this.session.callType==k.VIDEO&&this.remoteStream.getVideoTracks().length||this.session.callType==k.AUDIO&&this.remoteStream.getAudioTracks().length)&&this.session.onRemoteStream(this.userID,this.remoteStream),this.getWrappedStats()},this.onIceCandidateHandler=e=>{if(e.candidate){const{sdpMLineIndex:t,sdpMid:r,candidate:n}=e.candidate,s={sdpMLineIndex:t,sdpMid:r,candidate:n};"stable"===this.signalingState&&this.original.canTrickleIceCandidates?this.session.processIceCandidates(this.userID,[s]):this.iceCandidates.push(s)}},this.onSignalingStateHandler=async()=>{Mn.trace(`onSignalingStateHandler: ${this.signalingState}`),"stable"===this.signalingState&&this.iceCandidates.length>0&&(this.session.processIceCandidates(this.userID,this.iceCandidates),this.iceCandidates.length=0)},this.onIceConnectionStateHandler=()=>{switch(Mn.trace(`onIceConnectionStateHandler: ${this.iceConnectionState}`),this.onStatusClosedChecker&&Mn.getVersionSafari>=11&&clearTimeout(this.onStatusClosedChecker),this.iceConnectionState){case"checking":this.state=A.CHECKING,this.session.onSessionConnectionStateChanged(this.userID,T.CONNECTING);break;case"connected":this.state=A.CONNECTED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,T.CONNECTED);break;case"completed":this.state=A.COMPLETED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,T.COMPLETED);break;case"failed":this.state=A.FAILED,this.session.onSessionConnectionStateChanged(this.userID,T.FAILED);break;case"disconnected":this.state=A.DISCONNECTED,this.startWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,T.DISCONNECTED),Mn.getVersionSafari>=11&&(this.onStatusClosedChecker=setTimeout(()=>{this.onIceConnectionStateHandler()},500));break;case"closed":this.state=A.CLOSED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,T.CLOSED)}},this.create(),this.setup(e,t,r)}create(){const e={iceTransportPolicy:Y.videochat.alwaysRelayCalls?"relay":"all",iceServers:Y.videochat.iceServers.map(e=>({urls:e.urls??e.url,username:e.username,credential:e.credential}))};this.original=m?new m(e):{},Mn.trace(`new RTCPeerConnection(${JSON.stringify(e,null,2)})`)}setup(e,t,r){this.type=r,this.userID=t,this.session=e,this.session.startCallTime=Date.now(),this.original.addEventListener("track",this.onMediaTrackHandler),this.original.addEventListener("icecandidate",this.onIceCandidateHandler),this.original.addEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.addEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),Mn.trace(`RTCPeerConnection init. ${this.toString()}`)}clearWaitingReconnectTimer(){this.waitingReconnectTimeoutCallback&&(Mn.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)}startWaitingReconnectTimer(){const e=1e3*Y.videochat.disconnectTimeInterval;Mn.trace(`startWaitingReconnectTimer, timeout: ${e}`),this.waitingReconnectTimeoutCallback=setTimeout(()=>{Mn.trace("waitingReconnectTimeoutCallback"),this.waitingReconnectTimeoutCallback&&clearTimeout(this.waitingReconnectTimeoutCallback),this.release(),this.session.closeSessionIfAllConnectionsClosed()},e)}clearStatsReportTimer(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)}async addCandidates(e){for(const t of e)if(t?.candidate)try{await this.addIceCandidate(t),Mn.trace(`'addIceCandidate' success: ${this.signalingState}`)}catch(e){Mn.traceError(`'addIceCandidate' error: ${e}`)}}release(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),Mn.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.original.removeEventListener("track",this.onMediaTrackHandler),this.original.removeEventListener("icecandidate",this.onIceCandidateHandler),this.original.removeEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),this.released=!0,Mn.trace(`RTCPeerConnection closed. ${this.toString()}`)}clearDialingTimer(){this.dialingTimer&&(Mn.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)}async getAndSetLocalSessionDescription(e,t=!1){this.state=A.CONNECTING;try{const r=t?{iceRestart:t}:void 0,n="offer"===this.type?await this.createOffer(r):await this.createAnswer();return await this.setLocalDescription(n),this.setRTCRtpSenderMaxBandwidth(e),n}catch(e){throw e}}setRTCRtpSenderMaxBandwidth(e){const t=this.getSenders()||[],r=e?Math.round(1e3*e):0;t.forEach(t=>{if(t.track?.kind===z.VIDEO){const n=t.getParameters();n.encodings??(n.encodings=[{}]),n.encodings.forEach(e=>{r>0?e.maxBitrate=r:delete e.maxBitrate}),t.setParameters(n).then(()=>{Mn.trace(`Set 'maxBandwidth' for ${this.userID}: ${e>0?`${e} kbps`:"unlimited"}`)}).catch(e=>{Mn.traceWarning(`Set 'maxBandwidth' for ${this.userID}: ${e}`)})}})}startDialingTimer(e,t){const r=1e3*Y.videochat.dialingTimeInterval;Mn.trace(`startDialingTimer, dialingTimeInterval: ${JSON.stringify(r)}`);const n=(e,t,r)=>{r||(this.answerTimeInterval+=1e3*Y.videochat.dialingTimeInterval),Mn.trace(`dialingCallback, extension: ${JSON.stringify(e)}`),this.answerTimeInterval>=1e3*Y.videochat.answerTimeInterval?(this.clearDialingTimer(),t&&this.session.processOnNotAnswer(this)):this.session.processCall(this,e)};this.dialingTimer=setInterval(n,r,e,t,!1),n(e,t,!0)}async setRemoteSessionDescription(e,t){const r=new y({sdp:t,type:e});return this.setRemoteDescription(r)}getWrappedStats(){if(Y.videochat.statsReportTimeInterval){let e;Mn.trace("Stats tracker has been started"),this.statsReportTimer=setInterval(()=>{this.getStatsCustom(e,(t,r)=>{e=r,this.session.onCallStatsReport(this.userID,t)},e=>{Mn.traceError(`Get stats error. ${e.name}: ${e.message}`),this.session.onCallStatsReport(this.userID,null,e)})},1e3*Y.videochat.statsReportTimeInterval)}}set sdpRemote(e){e&&(this.remoteSDP=e)}get sdpRemote(){return this.remoteSDP}toString(){return`sessionID: ${this.session.ID}, userID: ${this.userID}, type: ${this.type}, state: ${this.state}`}getStatsCustom(e,t,r){const n={audio:{},video:{},candidate:{}},s={local:Object.assign({},n),remote:Object.assign({},n)};if(Mn.getVersionFirefox){const e=this.session.localStream,t=e?.getVideoTracks()[0].getSettings();t&&(s.local.video.frameHeight=t.height,s.local.video.frameWidth=t.width)}this.getStats().then(r=>{r.forEach(t=>{let r;t.bytesReceived&&"inbound-rtp"===t.type?(r=s.remote[t.mediaType],r.bitrate=this.getBitratePerSecond(t,e,!1),r.bytesReceived=t.bytesReceived,r.packetsReceived=t.packetsReceived,r.timestamp=t.timestamp,t.mediaType===z.VIDEO&&t.framerateMean&&(r.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?(r=s.local[t.mediaType],r.bitrate=this.getBitratePerSecond(t,e,!0),r.bytesSent=t.bytesSent,r.packetsSent=t.packetsSent,r.timestamp=t.timestamp,t.mediaType===z.VIDEO&&t.framerateMean&&(r.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(r=s.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(r.protocol=t.transport,r.ip=t.ipAddress,r.port=t.portNumber):Mn.getVersionFirefox||(r.protocol=t.protocol,r.ip=t.ip,r.port=t.port)):"remote-candidate"===t.type?(r=s.remote.candidate,r.protocol=t.protocol||t.transport,r.ip=t.ip||t.ipAddress,r.port=t.port||t.portNumber):"track"!==t.type||t.kind!==z.VIDEO||Mn.getVersionFirefox||(t.remoteSource?(r=s.remote.video,r.frameHeight=t.frameHeight,r.frameWidth=t.frameWidth,r.framesPerSecond=this.getFramesPerSecond(t,e,!1)):(r=s.local.video,r.frameHeight=t.frameHeight,r.frameWidth=t.frameWidth,r.framesPerSecond=this.getFramesPerSecond(t,e,!0)))}),t(s,r)},r)}getBitratePerSecond(e,t,r){const n=t.get(e.id),s=n?(e.timestamp-n.timestamp)/1e3:5,i=n?r?8*(e.bytesSent-n.bytesSent)/(1024*s):8*(e.bytesReceived-n.bytesReceived)/(1024*s):0;return Math.round(i)}getFramesPerSecond(e,t,r){const n=t&&t.get(e.id),s=n?(e.timestamp-n.timestamp)/1e3:5,i=n?r?(e.framesSent-n.framesSent)/s:(e.framesReceived-n.framesReceived)/s:0;return Math.round(10*i)/10}close(){this.original.close?.()}addTrack(e,t){return this.original.addTrack?.(e,t)??null}getSenders(){return this.original.getSenders?.()??null}async createOffer(e){return await(this.original.createOffer?.(e))??null}async createAnswer(e){return await(this.original.createAnswer?.(e))??null}async getStats(e){return await(this.original.getStats?.(e))??null}async addIceCandidate(e){await(this.original.addIceCandidate?.(e))}async setRemoteDescription(e){await(this.original.setRemoteDescription?.(e))}async setLocalDescription(e){await(this.original.setLocalDescription?.(e))}get localDescription(){return this.original.localDescription??null}get signalingState(){return this.original.signalingState??"closed"}get iceConnectionState(){return this.original.iceConnectionState??"closed"}}class Jn{constructor(e){this.ID=null,this.state=I.NEW,this.opponentsIDs=[],this.maxBandwidth=0,this.peerConnections={},this.mediaParams={},this.answerTimer=null,this.waitingOfferOrAnswerTimer=null,this.startCallTime=0,this.acceptCallTime=0,Object.assign(this,e,{ID:e.ID??Vn()})}async getDisplayMedia(e){if(!d.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,r=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await d.getDisplayMedia(n);return this.upsertStream(e,t,r)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,r=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await d.getUserMedia(n);return this.upsertStream(e,t,r)}catch(e){throw e}}upsertStream(e,t,r){const n=!!this.localStream;if(n?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(n&&this.detachMediaStream(t,r),this.attachMediaStream(t,this.localStream,r)),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===z.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{e.kind===z.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,e&&(Object.values(this.peerConnections).forEach(t=>{t.getSenders().find(({track:t})=>e.kind===t?.kind)?.replaceTrack(e)}),this.localStream?.addTrack(e))}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async setMaxBandwidth(e){const t=this.peerConnections,r=Object.keys(t);if(!(r.length<1))return Promise.all(r.map(r=>t[Number(r)].setRTCRtpSenderMaxBandwidth(e)));Mn.trace("No 'RTCPeerConnection' to set 'maxBandwidth'")}connectionStateForUser(e){const t=this.peerConnections[e];return t?t.state:null}attachMediaStream(e,t,r){const n=document.getElementById(e);if(!("srcObject"in n))throw new Error(`Unable to attach media stream, element #${e} is undefined`);n.srcObject=t,n.style.transform=r?.mirror?"scaleX(-1)":"none","boolean"==typeof r?.muted&&(n.muted=r?.muted),n.onloadedmetadata=e=>{n.play()}}detachMediaStream(e,t){const r=document.getElementById(e);if(!("srcObject"in r))throw new Error(`Unable to attach media stream, element #${e} is undefined`);r.pause(),r.srcObject=null,r.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(r.muted=t?.muted)}async switchMediaTracks(e={}){Z.DLog("switchMediaTracks:",e),[z.AUDIO,z.VIDEO].forEach(t=>{const r=t===z.AUDIO?e.audio:t===z.VIDEO?e.video:{},n="string"==typeof r?r:r?.deviceId;n&&("object"!=typeof this.mediaParams[t]?this.mediaParams[t].deviceId=n:this.mediaParams[t]={deviceId:n})});try{const e={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},t=await d.getUserMedia(e);return this.replaceTracks(t)}catch(e){throw e}}call(e={}){const t=$n(e);Mn.trace(`Call, extension: ${JSON.stringify(t)}`),this.state=I.ACTIVE,this.maxBandwidth=Number(t.userInfo?.maxBandwidth??0),this.opponentsIDs.forEach(e=>{this.callInternal(e,t,!0)})}async callInternal(e,t,r){const n=new Un(this,e,"offer");this.localStream?.getTracks().forEach(e=>{n.addTrack(e,this.localStream)}),this.peerConnections[e]=n;try{await n.getAndSetLocalSessionDescription(this.maxBandwidth),Mn.trace("getAndSetLocalSessionDescription success"),n.startDialingTimer(t,r)}catch(e){Mn.traceError(`getAndSetLocalSessionDescription error: ${e}`)}}accept(e={}){const t=$n(e);if(Mn.trace(`Accept, extension: ${JSON.stringify(t)}`),this.state===I.ACTIVE)return void Mn.traceError("Can't accept, the session is already active, return");if(this.state===I.CLOSED)return Mn.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=I.ACTIVE,this.acceptCallTime=Date.now(),this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,t);const r=this.opponentsIDs.filter(e=>e!==this.currentUserID);r.length>0&&(this.startWaitingOfferOrAnswerTimer(),r.forEach(e=>{this.currentUserID>e&&this.callInternal(e,t,!0)}))}async acceptInternal(e,t){const r=this.peerConnections[e];if(r&&r.sdpRemote){this.localStream?.getTracks().forEach(e=>{r.addTrack(e,this.localStream)});try{await r.setRemoteSessionDescription("offer",r.sdpRemote),Mn.trace("setRemoteSessionDescription - success"),await r.getAndSetLocalSessionDescription(this.maxBandwidth),Mn.trace("getAndSetLocalSessionDescription - success");const n=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:r.localDescription.sdp});this.signalingProvider.sendMessage(e,n,E.ACCEPT)}catch(e){Mn.traceError(`[acceptInternal] Error: ${e}`)}}else Mn.traceError("Can't accept the call, there is no information about peer connection by some reason")}reject(e={}){const t=$n(e);Mn.trace(`Reject, extension: ${JSON.stringify(t.userInfo)}`),this.state=I.REJECTED,this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,E.REJECT)}),this.close()}stop(e={}){const t=$n(e);Mn.trace(`Stop, extension: ${JSON.stringify(t.userInfo)}`),this.state=I.STOPPED,this.answerTimer&&this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,E.STOP)}),this.close()}canInitiateIceRestart(e){return"offer"===this.peerConnections[e]?.type}async iceRestart(e){const t=this.peerConnections[e];if(t)try{const{sdp:r}=await t.getAndSetLocalSessionDescription(this.maxBandwidth,!0),n={sessionID:this.ID??"",sdp:r};this.signalingProvider.sendMessage(e,n,E.RESTART),Mn.trace("[iceRestart] OK")}catch(e){Mn.traceError(`[iceRestart] Error: ${e}`)}else Mn.traceError("Can't restart ice, there is no information about peer connection by some reason")}processOnCall(e,t){[this.initiatorID,...this.opponentsIDs.filter(e=>e!==this.currentUserID)].forEach(r=>{const n=this.peerConnections[r];if(n)r===e&&(n.sdpRemote=t.sdp,e!==this.initiatorID&&this.state===I.ACTIVE&&this.acceptInternal(e,t));else{const n=r!==e&&this.currentUserID>r?"offer":"answer",s=new Un(this,r,n);this.peerConnections[r]=s,r===e&&(s.sdpRemote=t.sdp,this.startAnswerTimer())}})}async processOnAccept(e,t){const r=this.peerConnections[e];r||Mn.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason");try{r.clearDialingTimer(),await r.setRemoteSessionDescription("answer",t.sdp),Mn.trace("'setRemoteSessionDescription' success")}catch(e){Mn.traceError(`'setRemoteSessionDescription' error: ${e}`)}}processOnReject(e){const t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():Mn.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()}processOnStop(e){if(this.clearAnswerTimer(),e===this.initiatorID){const e=Object.keys(this.peerConnections);e.length>0?e.forEach(e=>{this.peerConnections[Number(e)].release()}):Mn.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{const t=this.peerConnections[e];t?t.release():Mn.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()}async processOnIceCandidates(e,t){const r=this.peerConnections[e];r||Mn.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates&&await r.addCandidates(t.iceCandidates)}async processOnIceRestart(e,t){const r=this.peerConnections[e];r||Mn.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason');try{await r.setRemoteSessionDescription("offer",t.sdp);const{sdp:n}=await r.getAndSetLocalSessionDescription(this.maxBandwidth),s={sessionID:this.ID??"",sdp:n};this.signalingProvider.sendMessage(e,s,E.RESTART_ACCEPT),Mn.trace("[processOnIceRestart] Success")}catch(e){Mn.traceError(`[processOnIceRestart] Error: ${e}`)}}async processOnIceRestartAccept(e,t){const r=this.peerConnections[e];r||Mn.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason');try{await r.setRemoteSessionDescription("answer",t.sdp),Mn.trace("[processOnIceRestartAccept] Success")}catch(e){Mn.traceError(`[processOnIceRestartAccept] Error: ${e}`)}}processCall(e,t={}){const r=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,r,E.CALL)}processIceCandidates(e,t){const r={sessionID:this.ID??"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,r)}processOnNotAnswer(e){Mn.trace(`Answer timeout callback for session ${this.ID} for user ${e.userID}`),this.clearWaitingOfferOrAnswerTimer(),e.release(),Z.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()}onRemoteStream(e,t){Z.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)}onCallStatsReport(e,t,r){Z.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,r)}onSessionConnectionStateChanged(e,t){Z.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)}close(){Object.values(this.peerConnections).forEach(e=>{try{e.release()}catch(e){Z.DLog(`Peer close error: ${e}`)}}),this.closeLocalMediaStream(),this.state=I.CLOSED,Z.safeCallbackCall(this.onSessionCloseListener)(this)}closeSessionIfAllConnectionsClosed(){let e=!0;Object.values(this.peerConnections).forEach(t=>{let r=!1;try{r="closed"===t.iceConnectionState||"closed"===t.signalingState||t.released}catch(e){Mn.traceError(e),r=!0}e=r}),Mn.trace(`All peer connections closed: ${e}`),e&&(this.closeLocalMediaStream(),Z.safeCallbackCall(this.onSessionCloseListener)(this),this.state=I.CLOSED)}closeLocalMediaStream(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}mute(e){this.muteStream(!1,e)}unmute(e){this.muteStream(!0,e)}muteStream(e,t=z.NONE){const r=t===z.AUDIO?this.localStream?.getAudioTracks():t===z.VIDEO?this.localStream?.getVideoTracks():[];r?.forEach(t=>{t.enabled=e})}clearAnswerTimer(){this.answerTimer&&(Mn.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)}startAnswerTimer(){Mn.trace("startAnswerTimer"),this.answerTimer=setTimeout(()=>{Mn.trace("answerTimeoutCallback"),this.close(),this.answerTimer=null},1e3*Y.videochat.answerTimeInterval)}clearWaitingOfferOrAnswerTimer(){this.waitingOfferOrAnswerTimer&&(Mn.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)}startWaitingOfferOrAnswerTimer(){const e=(this.acceptCallTime-this.startCallTime)/1e3,t=Math.min(e,Y.videochat.answerTimeInterval/2),r=Math.max(Y.videochat.answerTimeInterval-t,1);Mn.trace(`startWaitingOfferOrAnswerTimer, timeout: ${r}`),this.waitingOfferOrAnswerTimer=setTimeout(()=>{Mn.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(this.peerConnections).forEach(e=>{e.state!==A.CONNECTING&&e.state!==A.NEW||this.processOnNotAnswer(e)}),this.waitingOfferOrAnswerTimer=null},1e3*r)}toString(){return`ID: ${this.ID}, initiatorID: ${this.initiatorID}, opponentsIDs: ${this.opponentsIDs}, state: ${this.state}, callType: ${this.callType}`}}function Vn(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)})}function $n(e={}){const t={userInfo:e};try{Z.isObject(e)?t.userInfo=Z.cloneObject(e,!0):Mn.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){Mn.traceWarning(e.message)}return t}class Fn{constructor(e){this.onMessage=(e,t)=>{const r=this.getExtension(t),n=r?.sessionID??"",s=r?.signalType;switch(delete r?.moduleIdentifier,delete r?.sessionID,delete r?.signalType,s){case E.CALL:this.delegate.onCallHandler(e,n,r);break;case E.ACCEPT:this.delegate.onAcceptHandler(e,n,r);break;case E.REJECT:this.delegate.onRejectHandler(e,n,r);break;case E.STOP:this.delegate.onStopHandler(e,n,r);break;case E.CANDIDATE:this.delegate.onIceCandidatesHandler(e,n,r);break;case E.RESTART:this.delegate.onIceRestartHandler(e,n,r);break;case E.RESTART_ACCEPT:this.delegate.onIceRestartAcceptHandler(e,n,r)}},this.delegate=e}getExtension(e){if(!e)return{};const t={iceCandidates:[],opponentsIDs:[]};return pn.getChildElements(e).forEach(e=>{const r=pn.getChildElements(e),n=pn.getName(e)??"";switch(n){case"callerID":t[n]=parseInt(pn.getText(e)||"0");break;case"callType":const s=pn.getText(e);t[n]="1"===s?k.VIDEO:"2"===s?k.AUDIO:void 0;break;case"iceCandidates":r.forEach(e=>{const r={};pn.getChildElements(e).forEach(e=>{const t=pn.getName(e)||"",n=pn.getText(e);r[t]="sdpMLineIndex"===t?parseInt(n||"0"):n}),t.iceCandidates?.push(r)});break;case"opponentsIDs":r.forEach(e=>{t.opponentsIDs?.push(parseInt(pn.getText(e)||"0"))});break;default:r.length>1?(pn.getText(e)||"").length>4096?t[n]=r.reduce((e,t)=>e+pn.getText(t),""):pn.assignXmlToObject(e,t):"userInfo"===n?pn.assignXmlToObject(e,t):t[n]=pn.getText(e)}}),0===t.iceCandidates?.length&&delete t.iceCandidates,0===t.opponentsIDs?.length&&delete t.opponentsIDs,t}}class Wn{constructor(e){this.signalingConnection=e}sendCandidate(e,t,r={}){const n=Object.assign({},r,{iceCandidates:t});this.sendMessage(e,n,E.CANDIDATE)}sendMessage(e,t,r){const n=Object.assign({},t);n.moduleIdentifier="WebRTCVideoChat",n.signalType=r,n.platform=Z.env.isBrowser?"web":Z.env.isReactNative||Z.env.isExpo?"mobile":"node",n.userInfo&&(Object.keys(n.userInfo).length?0===n.userInfo.maxBandwidth&&delete n.userInfo.maxBandwidth:delete n.userInfo);let s=pn.createMessageStanza({to:Mn.getUserJid(e),type:"headline",id:Z.getBsonObjectId()}).c("extraParams",{xmlns:"jabber:client"});Object.keys(n).forEach(e=>{const t=n[e];"iceCandidates"===e?(s=s.c("iceCandidates"),t.forEach(e=>{s=s.c("iceCandidate"),Object.keys(e).forEach(t=>{s=s.c(t).t(e[t]).up()}),s=s.up()}),s=s.up()):"opponentsIDs"===e?(s=s.c("opponentsIDs"),t.forEach(e=>{s=s.c("opponentID").t(e).up()}),s=s.up()):"object"==typeof t?pn.assignObjectToXml(s,t,e):s=s.c(e).t(t).up()}),s=s.up(),this.signalingConnection.sendOnline(s)}}class zn{constructor(e,t){this.SessionConnectionState=T,this.PeerConnectionState=A,this.CallType=k,this.sessions={},this.onDevicesChangeListener=()=>{},this.connection=e,this.proxy=t,this.signalingProcessor=new Fn(this),this.signalingProvider=new Wn(e),d&&(d.ondevicechange=Z.safeCallbackCall(this.onDevicesChangeListener))}get currentUserID(){const e=this.connection.jid?.toString()??"";return Mn.getUserIdFromJID(e)??0}async getMediaDevices(e){if(d?.enumerateDevices){const t=await d.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}createNewSession(e,t,r){const n=(r?.maxBandwidth||r?.bandwidth)??0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,this.currentUserID,e,t,n)}createAndStoreSession(e,t,r,n,s=0){const i=new Jn({ID:e,initiatorID:t,opponentsIDs:r,callType:n,signalingProvider:this.signalingProvider,currentUserID:this.currentUserID,maxBandwidth:s});return i.onUserNotAnswerListener=this.onUserNotAnswerListener,i.onRemoteStreamListener=this.onRemoteStreamListener,i.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,i.onSessionCloseListener=this.onSessionCloseListener,i.onCallStatsReportListener=this.onCallStatsReport,i?.ID&&(this.sessions[i.ID]=i),i}clearSession(e){delete this.sessions[e]}callRejectRequest(e){const t={type:B.POST,url:Z.getUrl(Y.urls.calls,"reject"),data:e};return this.proxy.ajax(t)}onCallHandler(e,t,r){const n=r.userInfo||{},s=Number(n.maxBandwidth??0);let i=this.sessions[t];Mn.trace(`onCall. userID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),i||(i=this.createAndStoreSession(t,r.callerID||0,r.opponentsIDs||[],r.callType||k.VIDEO,s),Z.safeCallbackCall(this.onCallListener)(i,n)),i.processOnCall(e,r)}onAcceptHandler(e,t,r){const n=this.sessions[t],s=r.userInfo||{};Mn.trace(`onAccept. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),!n||n.state!==I.ACTIVE&&n.state!==I.NEW?Mn.traceWarning(`Ignore 'onAccept', there is no information about session ${t}`):(Z.safeCallbackCall(this.onAcceptCallListener)(n,e,s),n.processOnAccept(e,r))}onRejectHandler(e,t,r){const n=this.sessions[t];if(Mn.trace(`onReject. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),n){const t=r.userInfo||{};Z.safeCallbackCall(this.onRejectCallListener)(n,e,t),n.processOnReject(e)}else Mn.traceWarning(`Ignore 'onReject', there is no information about session ${t}`)}onStopHandler(e,t,r){Mn.trace(`onStop. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`);const n=this.sessions[t],s=r.userInfo||{};!n||n.state!==I.ACTIVE&&n.state!==I.NEW?(Z.safeCallbackCall(this.onInvalidEventsListener)(n,e,s),Mn.traceWarning(`Ignore 'onStop', there is no information about session ${t} by some reason`)):(n.processOnStop(e),Z.safeCallbackCall(this.onStopCallListener)(n,e,s))}onIceCandidatesHandler(e,t,r){const n=this.sessions[t];Mn.trace(`onIceCandidates. UserID: ${e}. SessionID: ${t}. ICE candidates count: ${r.iceCandidates?.length??0}`),n?n.state===I.ACTIVE?n.processOnIceCandidates(e,r):Mn.traceWarning(`Ignore 'OnIceCandidates', the session ( ${t} ) has invalid state`):Mn.traceWarning(`Ignore 'OnIceCandidates', there is no information about session ${t}`)}onIceRestartHandler(e,t,r){const n=this.sessions[t];Mn.trace(`onIceRestart. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(r)}`),n?n.state===I.ACTIVE?n.processOnIceRestart(e,r):Mn.traceWarning(`Ignore 'OnIceRestart', the session (${t}) has invalid state`):Mn.traceWarning(`Ignore 'OnIceRestart', there is no information about session ${t}`)}onIceRestartAcceptHandler(e,t,r){const n=this.sessions[t];Mn.trace(`onIceRestartAccept. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(r)}`),n?n.state===I.ACTIVE?n.processOnIceRestartAccept(e,r):Mn.traceWarning(`Ignore 'onIceRestartAccept', the session (${t}) has invalid state`):Mn.traceWarning(`Ignore 'onIceRestartAccept', there is no information about session ${t}`)}getListenerByName(e){switch(e){case x.CALL:return"onCallListener";case x.ACCEPT:return"onAcceptCallListener";case x.REJECT:return"onRejectCallListener";case x.STOP:return"onStopCallListener";case x.INVALID:return"onInvalidEventsListener";case x.NOT_ANSWER:return"onUserNotAnswerListener";case x.REMOTE_STREAM:return"onRemoteStreamListener";case x.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case x.CLOSE:return"onSessionCloseListener";case x.STATS_REPORT:return"onCallStatsReport";case x.DEVICES:return"onDevicesChangeListener";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=e===x.DEVICES?()=>{}:void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]="onDevicesChangeListener"===e?()=>{}:void 0)})}}class qn{constructor(e){this.route=Y.urls.whiteboards,this.server=Y.whiteboard.server,this.proxy=e}getURL({id:e,title:t,username:r}){return`${this.server}?whiteboardid=${e}&username=${r}&title=${t}`}async get(e){const t={type:B.GET,url:Z.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e};return this.proxy.ajax(t)}async create(e){const t={type:B.POST,url:Z.getUrl(this.route),data:e};return this.proxy.ajax(t)}async update(e,t){const r={type:B.PUT,url:Z.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e){const t={type:B.DELETE,url:Z.getUrl(this.route,e),dataType:G.TEXT};return this.proxy.ajax(t)}}class Bn{constructor(e){this.cache=new Map,this.route=Y.urls.unfurl,this.server=Y.linkpreview.server,this.proxy=e}async get(e){if(!this.cache.has(e)){let t;try{const r={type:B.POST,url:`${this.server}/${this.route}`,data:{url:e}};t=await this.proxy.ajax(r)}catch(r){t={url:e,title:this.getHostFromUrl(e),description:"",images:[]}}finally{this.cache.set(e,t)}}return this.cache.get(e)}getHostFromUrl(e){if("function"==typeof URL)return new URL(e).hostname;const t=e.match(/^(?:https?:\/\/)?([^\/]+)/);return t?t[1]:e}}class Gn{init(e,t={}){t&&"object"==typeof t&&Y.set(t),this.utils=Z,this.service=new Rn,this.auth=new te(this.service),this.users=new Nn(this.service),this.storage=new jn(this.service),this.pushnotifications=new Pn(this.service),this.data=new Dn(this.service),this.addressbook=new ee(this.service),this.chat=new Cn(this.service),this.meeting=new On(this.service),this.whiteboard=new qn(this.service),this.linkpreview=new Bn(this.service),b&&(this.videochat=new zn(this.chat.xmppClient,this.service),this.videochatconference=new An(this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor),e.token?(Y.creds.appId=e.appId,this.service.setSession({token:e.token})):(Y.creds.appId=e.appId,Y.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout}}const Hn=new Gn;return Hn.ConnectyCube=Gn,Hn});
//# sourceMappingURL=connectycube.min.js.map
