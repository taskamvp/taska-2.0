"use strict";var e=require("@xmpp/client-core"),t=require("@xmpp/reconnect"),r=require("@xmpp/websocket"),s=require("@xmpp/middleware"),n=require("@xmpp/stream-features"),i=require("@xmpp/iq/caller.js"),a=require("@xmpp/iq/callee.js"),o=require("@xmpp/resolve"),c=require("@xmpp/sasl"),l=require("@xmpp/resource-binding"),d=require("@xmpp/session-establishment"),u=require("@xmpp/sasl-anonymous"),h=require("@xmpp/sasl-plain"),p=require("eventemitter3");const m=e=>f?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))):Buffer.from(e).toString("base64"),g="4.7.0",f="object"==typeof window&&"object"==typeof document,y="object"==typeof process&&"object"==typeof process.versions&&!!process.versions.node,b=!1,C=!1;let S,v;y?(import("node-fetch").then(e=>{S=e.default||e}),import("form-data").then(e=>{v=e.default||e})):(S=fetch,v=FormData);const E=f?window.navigator:void 0,T=f&&E?E.mediaDevices:void 0,w=f?window.MediaStream:void 0,I=f?window.MediaStreamTrack:void 0,k=f?window.RTCIceCandidate:void 0,D=f?window.RTCPeerConnection:void 0,A=f?window.RTCRtpReceiver:void 0,x=f?window.RTCRtpSender:void 0,O=f?window.RTCSessionDescription:void 0,R=!!f&&Boolean(T&&window?.RTCPeerConnection),P=f?window.adapter:void 0;var L,N,j=Object.freeze({__proto__:null,get FormDataImpl(){return v},MediaStream:w,MediaStreamTrack:I,RTCIceCandidate:k,RTCPeerConnection:D,RTCRtpReceiver:A,RTCRtpSender:x,RTCSessionDescription:O,adapter:P,base64Encode:m,get fetchImpl(){return S},isBrowser:f,isExpo:C,isNodeJS:y,isReactNative:b,isWebRTCAvailable:R,mediaDevices:T,navigator:E,sdkVersion:g});!function(e){e[e.COMPACT=1]="COMPACT",e[e.FULL=0]="FULL"}(L||(L={})),function(e){e.FACEBOOK="facebook",e.TWITTER="twitter",e.FIREBASE_PHONE="firebase_phone",e.FIREBASE_EMAIL="firebase_email"}(N||(N={}));var M,U,_,J,V,$,F,W,q,G,B,z,H,X,Q,K,Y,Z,ee,te,re,se,ne,ie,ae,oe,ce,le;!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(M||(M={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(U||(U={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.STOPPED=3]="STOPPED",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(_||(_={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(J||(J={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="stop",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(V||(V={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}($||($={})),function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(F||(F={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(W||(W={})),function(e){e.ALLOW="allow",e.DENY="deny"}(q||(q={})),function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(G||(G={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(B||(B={})),function(e){e.CREATE="create",e.READ="read",e.UPDATE="update",e.DELETE="delete"}(z||(z={})),function(e){e.OPEN="open",e.OWNER="owner",e.NOT_ALLOWED="not_allowed",e.OPEN_FOR_GROUPS="open_for_groups",e.OPEN_FOR_USERS_IDS="open_for_users_ids"}(H||(H={})),function(e){e[e.PUBLIC=1]="PUBLIC",e[e.GROUP=2]="GROUP",e[e.PRIVATE=3]="PRIVATE",e[e.BROADCAST=4]="BROADCAST",e[e.MEETING=5]="MEETING"}(X||(X={})),function(e){e.SENT="sent",e.DELIVERED="delivered",e.READ="read"}(Q||(Q={})),function(e){e.CREATED="created_at",e.UPDATED="updated_at",e.LAST_MESSAGE="last_message_date_sent"}(K||(K={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(Y||(Y={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(Z||(Z={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(ee||(ee={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(te||(te={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(re||(re={})),function(e){e.AUDIO="audio",e.VIDEO="video",e.NONE="none"}(se||(se={})),function(e){e.MINUTES="minutes",e.HOURS="hours",e.DAYS="days",e.WEEK="weeks"}(ne||(ne={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(ie||(ie={})),function(e){e.JSON="json",e.TEXT="text"}(ae||(ae={})),function(e){e.APNS="apns",e.VOIP="apns_voip",e.GCM="gcm",e.WEB="web"}(oe||(oe={})),function(e){e.IOS="ios",e.ANDROID="android",e.WEB="web"}(ce||(ce={})),function(e){e.DEV="development",e.PROD="production"}(le||(le={}));class de{constructor(){this.version=g,this.creds={appId:"",authKey:""},this.endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},this.chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},this.chat={streamManagement:{enable:!1},reconnect:{enable:!0,timeInterval:5}},this.videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},this.conference={server:"wss://janus.connectycube.com:8989",debug:B.ALL},this.whiteboard={server:"https://whiteboard.connectycube.com"},this.linkpreview={server:"https://linkpreview.connectycube.com"},this.urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",unfurl:"unfurl",calls:"calls",type:".json"},this.on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0},this.timeout=null,this.debug={mode:1}}static getInstance(){return de.instance||(de.instance=new de),de.instance}set(e){e.endpoints&&e.endpoints.chat&&(this.endpoints.muc=`muc.${e.endpoints.chat}`,this.chatProtocol.bosh=`https://${e.endpoints.chat}:5281`,this.chatProtocol.websocket=`wss://${e.endpoints.chat}:5291`),Object.keys(e).forEach(t=>{if("set"!==t&&this.hasOwnProperty(t)){const r=e[t];"object"==typeof r&&null!==r?Object.keys(r).forEach(e=>{this[t]?.hasOwnProperty(e)&&(this[t][e]=r[e])}):this[t]=r}})}}var ue=de.getInstance();class he{static safeCallbackCall(e=()=>{}){return(...t)=>{if("function"==typeof e)try{e(...t)}catch(t){console.error("Error in listener:",t,`Check the code:\n>>>\n${e.toString()}\n<<<`)}}}static getUrl(e,t,r){const s=t?`/${t}`:"",n=r?`/${r}`:"";return`https://${ue.endpoints.api}/${e}${s}${n}${ue.urls.type}`}static isArray(e){return Array.isArray(e)}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static getBsonObjectId(){const e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),r=(e.increment++).toString(16);return parseInt(r,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+r.padStart(6,"0")}static DLog(...e){if(he.loggers.length>0)return void he.loggers.forEach(t=>t(e));if("object"==typeof ue.debug){(Array.isArray(ue.debug.mode)?ue.debug.mode:[ue.debug.mode]).forEach(e=>{1===e&&he.loggers.push(e=>{console.log(...e)})})}he.loggers.forEach(t=>t(e))}static callTrafficUsageCallback(e,t){if("function"==typeof ue.on[e]){const r=e=>new Blob([e]).size,s=(e={})=>{const{body:t,headers:s}=e;let n=0;return t&&(n+=r("string"==typeof t?t:JSON.stringify(t))),s&&(n+=r(JSON.stringify(s))),n};ue.on[e](s(t))}}static cloneObject(e={},t=!1){try{const r=JSON.stringify(e),s=t?r.replace(/null/g,'""'):r;return JSON.parse(s)}catch{return e}}}he.loggers=[],he.env={isReactNative:b,isBrowser:f,isNodeJS:y,isExpo:C};class pe{constructor(e){this.route=ue.urls.addressbook,this.proxy=e}async uploadAddressBook(e=[],t={}){if(!he.isArray(e))throw new Error("First parameter must be an Array.");const r={type:ie.POST,url:he.getUrl(this.route),data:{contacts:e,...t}};return this.proxy.ajax(r)}async get(e){const t={type:ie.GET,url:he.getUrl(this.route),data:e?{udid:e}:void 0};return this.proxy.ajax(t)}async getRegisteredUsers(e=!1){const t={type:ie.GET,url:he.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e};return this.proxy.ajax(t)}}class me{constructor(e){this.routes={session:ue.urls.session,login:ue.urls.login},this.setSession=e=>{this.proxy.setSession(e)},this.getSession=async()=>{try{const e={type:ie.GET,url:he.getUrl(this.routes.session)};return(await this.proxy.ajax(e)).session}catch(e){throw e}},this.createSession=async(e={})=>{if(""===ue.creds.appId||""===ue.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');try{const t={type:ie.POST,url:he.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},r=await this.proxy.ajax(t);return this.proxy.setSession(r.session),this.proxy.setCurrentUserId(r.session.user_id),r.session}catch(e){throw e}},this.destroySession=async()=>{try{const e={type:ie.DELETE,url:he.getUrl(this.routes.session),dataType:ae.TEXT};await this.proxy.ajax(e),this.proxy.setSession(null),this.proxy.setCurrentUserId(null)}catch(e){throw e}},this.login=async e=>{try{const t={type:ie.POST,url:he.getUrl(this.routes.login),data:e},{user:r}=await this.proxy.ajax(t);return this.proxy.setCurrentUserId(r.id),r}catch(e){throw e}},this.logout=async()=>{const e={type:ie.DELETE,url:he.getUrl(this.routes.login),dataType:ae.TEXT};return this.proxy.setCurrentUserId(null),this.proxy.ajax(e)},this.proxy=e}generateCreateSessionParams(e={}){const t={application_id:ue.creds.appId,auth_key:ue.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t}}const ge=e.xml;class fe{constructor(e){this.route=`${ue.urls.chat}/Dialog`,this.subscribeToPublic=this.subscribe,this.unsubscribeFromPublic=this.unsubscribe,this.proxy=e}async list(e={}){const t={type:ie.GET,url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t=he.cloneObject(e);he.isArray(t?.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),he.isArray(t?.admins_ids)&&(t.admins_ids=t.admins_ids.join(", "));const r={type:ie.POST,url:he.getUrl(this.route),data:t};return this.proxy.ajax(r)}async update(e,t={}){const r={type:ie.PUT,url:he.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e,t={}){const r="string"==typeof e?e.split(",").map(e=>e.trim()):e,s={type:ie.DELETE,url:he.getUrl(this.route,r.toString()),dataType:1===r.length?ae.TEXT:ae.JSON,data:t};return this.proxy.ajax(s)}async addAdmins(e,t){const r={type:ie.PUT,url:he.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}};return this.proxy.ajax(r)}async removeAdmins(e,t){const r={type:ie.PUT,url:he.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}};return this.proxy.ajax(r)}async subscribe(e){const t={type:ie.POST,url:he.getUrl(this.route,e,"subscribe")};return this.proxy.ajax(t)}async unsubscribe(e){const t={type:ie.DELETE,url:he.getUrl(this.route,e,"subscribe"),dataType:ae.TEXT};return this.proxy.ajax(t)}async updateNotificationsSettings(e,t){const r={type:ie.PUT,url:he.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}};return this.proxy.ajax(r)}async getNotificationsSettings(e){const t={type:ie.GET,url:he.getUrl(this.route,e,"notifications")};return this.proxy.ajax(t)}async getPublicOccupants(e,t={}){const r={type:ie.GET,url:he.getUrl(this.route,e,"occupants"),data:t};return this.proxy.ajax(r)}async clearHistory(e){const t={type:ie.DELETE,url:he.getUrl(this.route,"clearHistory",e),dataType:ae.TEXT};return this.proxy.ajax(t)}}class ye{constructor(e){this.route=`${ue.urls.chat}/Message`,this.proxy=e}async list(e={}){const t={url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t={url:he.getUrl(this.route),type:ie.POST,data:e};return this.proxy.ajax(t)}async update(e,t={}){const r={type:ie.PUT,dataType:ae.TEXT,url:he.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e,t){const r={url:he.getUrl(this.route,e),type:ie.DELETE,dataType:ae.TEXT,data:t};return this.proxy.ajax(r)}async createSystem(e){const t={type:ie.POST,url:he.getUrl(this.route,"system"),data:e};return this.proxy.ajax(t)}async unreadCount(e={}){const t=he.cloneObject(e);t&&t.chat_dialog_ids&&he.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", "));const r={url:he.getUrl(this.route,"unread"),data:t};return this.proxy.ajax(r)}async listReactions(e="_"){const t={type:ie.GET,dataType:ae.JSON,url:he.getUrl(this.route,e,"reactions")};return this.proxy.ajax(t)}async addReaction(e,t){return this.updateReaction(e,t)}async removeReaction(e,t){return this.updateReaction(e,void 0,t)}async updateReaction(e,t,r){return this.putReaction(e,{add:t,remove:r})}async putReaction(e,t){const r={type:ie.PUT,dataType:ae.TEXT,url:he.getUrl(this.route,e,"reactions"),data:t};return this.proxy.ajax(r)}}class be{static buildUserJid(e={}){const{userId:t,resource:r,jid:s}=e,n=ue.creds.appId,i=ue.endpoints.chat;return t?`${t}-${n}@${i}${r?`/${r}`:""}`:s}static buildUserJidLocalPart(e){return`${e}-${ue.creds.appId}`}static createMessageStanza(e){return ge("message",e)}static createIqStanza(e){return ge("iq",e)}static createPresenceStanza(e){return ge("presence",e)}static createNonza(e,t){return ge(e,t)}static getAttr(e,t){return e?.getAttr(t)||e?.attrs[t]||null}static getElement(e,t){return e?.getChild(t)}static getName(e){return e?.getName()||null}static getText(e){return e?.getText()||null}static getChildElements(e){return e?.getChildElements()||[]}static isErrorStanza(e){return!!e?.getChild("error")}static getAllElements(e,t){return e?.getChildren(t)||[]}static getElementText(e,t){return e?.getChildText(t)||null}static getElementTreePath(e,t){return t.reduce((e,t)=>e?be.getElement(e,t):void 0,e)}static assignObjectToXml(e,t,r){return e=e.c(r),Object.keys(t).forEach(r=>{"object"==typeof t[r]?be.assignObjectToXml(e,t[r],r):e=e.c(r).t(t[r]).up()}),e=e.up()}static assignExtraParamsToXml(e,t){let r=be.getElement(e,"extraParams");return Object.keys(t).forEach(e=>{"attachments"===e?t[e].forEach(e=>{r.c("attachment",e).up()}):"object"==typeof t[e]?be.assignObjectToXml(r,t[e],e):r.c(e).t(t[e]).up()}),e.up(),e}static assignXmlToObject(e,t){const{children:r,name:s}=e,n={[s]:{}};return r.forEach(e=>{"string"==typeof e?n[s]=e:e.children.length>0?be.assignXmlToObject(e,n[s]):n[s][e.name]=be.getText(e)}),Object.assign(t,n)}static parseExtraParams(e){if(!e)return null;const t={attachments:[]};let r=null;return e.children.forEach(s=>{if("string"!=typeof s){if("attachment"===s.name){const e={};Object.keys(s.attrs).forEach(t=>{e[t]="size"===t?parseInt(s.attrs.size):s.attrs[t]}),t.attachments.push(e)}else"dialog_id"===s.name&&(r=be.getElementText(e,"dialog_id"),t.dialog_id=r);s.children.length&&be.assignXmlToObject(s,t)}}),0===t.attachments.length&&delete t.attachments,t.moduleIdentifier&&delete t.moduleIdentifier,{extension:t,dialogId:r}}static buildErrorFromXMPPErrorStanza(e){const t=be.getElement(e,"error");return{code:t?parseInt(be.getAttr(t,"code")):0,info:t?be.getElementText(t,"text"):null}}static getUniqueId(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return"string"==typeof e||"number"==typeof e?`${t}:${e}`:t}static parseReactions(e){return be.getChildElements(e).map(e=>({add:"true"===be.getAttr(e,"add"),remove:"true"===be.getAttr(e,"remove"),reaction:be.getAttr(e,"type")})).reduce((e,{add:t,remove:r,reaction:s})=>(t?e.add=s:r&&(e.remove=s),e),{})}}class Ce{constructor(){this.xmppJID="",this.getUniqueId=be.getUniqueId,this.getBsonObjectId=he.getBsonObjectId}get userCurrentJid(){return this.xmppJID}set userCurrentJid(e){this.xmppJID=e||""}isNumeric(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)}jidOrUserId(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)}typeChat(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}}getUserJid(e){return`${e}-${ue.creds.appId}@${ue.endpoints.chat}`}getUserNickWithMucDomain(e){return`${ue.endpoints.muc}/${e}`}getUserIdFromJID(e=this.userCurrentJid){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}getDialogIdFromJID(e){return e?.includes("@")?e.split("@")[0].split("_")[1]:null}getRoomJidFromDialogId(e){return`${ue.creds.appId}_${e}@${ue.endpoints.muc}`}getRoomJid(e){return`${e}/${this.getUserIdFromJID(this.userCurrentJid)}`}getIdFromResource(e){const t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null}getRoomJidFromRoomFullJid(e){const t=e.split("/");return t.length>1?t[0]:null}getUserIdFromRoomJid(e){const t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null}getDialogJid(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)}}var Se;!function(e){e.ENABLE="enable",e.ENABLED="enabled",e.REQUEST="r",e.ANSWER="a"}(Se||(Se={}));class ve{constructor(e){this.chat=e,this.xmlns="urn:xmpp:sm:3",this.enabled=!1,this.clientHandledCounter=0,this.serverHandledCounter=0,this.messagesQueue=new Set,this.elementHandler=e=>{const[t,r]=[e.name,be.getAttr(e,"xmlns")];if(r===this.xmlns&&t===Se.ENABLED)return this.clientHandledCounter=0,this.serverHandledCounter=0,void(this.enabled=!0);if(r!==this.xmlns&&this.clientHandledCounter++,t!==Se.REQUEST){if(t===Se.ANSWER){const t=parseInt(be.getAttr(e,"h"),10),r=Number.isNaN(t)?this.serverHandledCounter:t,s=r-this.serverHandledCounter;this.serverHandledCounter=r,this.markMessagesQueueAsSent(s),this.markMessagesQueueAsLostByTimeout()}}else this.sendNonza(Se.ANSWER)}}get supported(){return ue.chatProtocol.active===G.WS&&ue.chat.streamManagement?.enable}start(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.addElementHandler(),this.sendNonza(Se.ENABLE))}stop(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.markMessagesQueueAsLost())}async sendAndCount(e,t){const r=be.getAttr(e,"type"),s=be.getElementText(e,"body"),n=be.getAllElements(e,"attachment"),i="message"===e.name,a=r===F.CHAT||r===F.GROUPCHAT,o=Boolean(s||n.length);try{await this.chat.xmppClient.sendOnline(e),this.enabled&&i&&a&&o&&(this.messagesQueue.add(t),this.sendNonza(Se.REQUEST))}catch{this.markMessageAsLost(t)}}markMessageAsSent(e){he.safeCallbackCall(this.chat.onSentMessageCallback)(null,e),this.messagesQueue.delete(e)}markMessageAsLost(e,t=!0){he.safeCallbackCall(this.chat.onSentMessageCallback)(e,null),t&&this.messagesQueue.delete(e)}markMessagesQueueAsSent(e=0){const t=this.messagesQueue.values();for(let r=0;r<e;r++){const{done:e,value:r}=t.next();if(e)break;this.markMessageAsSent(r)}}markMessagesQueueAsLost(){clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=void 0,this.messagesQueue.size>0&&(this.messagesQueue.forEach(e=>{this.markMessageAsLost(e,!1)}),this.messagesQueue.clear())}markMessagesQueueAsLostByTimeout(){const e=1e3*(ue.chat.streamManagement?.acknowledgementTimeout??30);clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=setTimeout(()=>{this.markMessagesQueueAsLost()},e)}sendNonza(e){const t={xmlns:this.xmlns,...e===Se.ANSWER&&{h:this.clientHandledCounter}},r=be.createNonza(e,t);return this.chat.xmppClient.sendOnline(r)}removeElementHandler(){this.chat.xmppClient.removeListener("element",this.elementHandler)}addElementHandler(){this.chat.xmppClient.on("element",this.elementHandler)}}class Ee{constructor(e){this.xmlns="jabber:iq:privacy",this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async create(e){return new Promise((t,r)=>{const s=e.items.reduce((e,{user_id:t,action:r,mutualBlock:s})=>(e[t]={action:r,mutualBlock:s},e),{}),n=Object.keys(s),i={type:"set",from:this.helpers.userCurrentJid,id:be.getUniqueId("edit")};let a=be.createIqStanza(i);a.c("query",{xmlns:this.xmlns}).c("list",{name:e.name});for(let e=0,t=0,r=n.length;e<r;e++,t+=2){const r=n[e],{action:i,mutualBlock:o}=s[r],c=(o&&"deny"===i)??!1,l=this.helpers.jidOrUserId(parseInt(r,10)),d=this.helpers.getUserNickWithMucDomain(r);this.assignPrivacyItem(a,{order:t+1,value:l,action:i,isMutual:c}),this.assignPrivacyItem(a,{order:t+2,value:d,action:i,isMutual:c})}this.stanzasCallbacks[i.id]=e=>{be.isErrorStanza(e)?r(be.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(a)})}async getList(e){return new Promise((t,r)=>{const s=be.getUniqueId("getlist"),n=be.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:s});n.c("query",{xmlns:this.xmlns}).c("list",{name:e}),this.stanzasCallbacks[s]=e=>{const r=be.getElement(e,"query"),n=be.getElement(r,"list"),i={name:be.getAttr(n,"name"),items:be.getChildElements(n).map((e,t)=>{if(t%2==0){const{action:t,value:r}=e.attrs;return{user_id:this.helpers.getUserIdFromJID(r),action:t}}return null}).filter(e=>null!==e)};t(i),delete this.stanzasCallbacks[s]},this.xmppClient.sendOnline(n)})}async update(e){try{const t=await this.getList(e.name),r=new Map(t.items.map(e=>[e.user_id,e]));for(const t of e.items)if(t.action===q.ALLOW)r.delete(t.user_id);else{const e=Object.assign({},r.get(t.user_id),t);r.set(t.user_id,e)}const s=Array.from(r.values()),n={name:e.name,items:s};await this.create(n)}catch(e){throw e}}async getNames(){return new Promise((e,t)=>{const r=be.getUniqueId("getNames"),s=be.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:r});s.c("query",{xmlns:this.xmlns}),this.stanzasCallbacks[r]=r=>{if(be.isErrorStanza(r))t(be.buildErrorFromXMPPErrorStanza(r));else{const t=be.getElement(r,"query"),s=be.getElement(t,"default"),n=be.getElement(t,"active"),i=be.getAttr(s,"name"),a=be.getAttr(n,"name"),o=be.getChildElements(t).map(e=>be.getAttr(e,"name"));e({default:i,active:a,names:o})}},this.xmppClient.sendOnline(s)})}async delete(e){return new Promise((t,r)=>{const s=be.getUniqueId("remove"),n=be.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:s});n.c("query",{xmlns:this.xmlns}).c("list",{name:e||""}),this.stanzasCallbacks[s]=e=>{be.isErrorStanza(e)?r(be.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(n)})}async setAsDefault(e){return new Promise((t,r)=>{const s=be.getUniqueId("default"),n=be.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:s});n.c("query",{xmlns:this.xmlns}).c("default",e?{name:e}:{}),this.stanzasCallbacks[s]=e=>{be.isErrorStanza(e)?r(be.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(n)})}assignPrivacyItem(e,t){const{value:r,action:s,order:n,isMutual:i}=t,a=be.getElement(e,"query"),o=be.getElement(a,"list").c("item",{type:"jid",value:r,action:s,order:n});i?(o.up(),n%2==0&&e.up().up()):o.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()}}class Te{constructor(e){this.xmlns="http://jabber.org/protocol/muc",this.joinedRooms={},this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async join(e){return new Promise((t,r)=>{const s=be.getUniqueId("join"),n=this.helpers.getDialogJid(e),i=be.createPresenceStanza({id:s,from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(n)});i.c("x",{xmlns:this.xmlns}).c("history",{maxstanzas:0}),this.stanzasCallbacks[s]=e=>{const i=be.getElement(e,"x"),a=be.getElement(i,"status"),o=be.getAttr(a,"code");if(a&&"110"==o)this.joinedRooms[n]=!0,t();else{const t=be.getAttr(i,"xmlns")===this.xmlns&&s.endsWith(":join"),n="error"===be.getAttr(e,"type");if(t&&n){const t=be.getElement(e,"error"),s={code:be.getAttr(t,"code"),message:be.getElementText(t,"text")||"Unknown issue"};r(s)}}},this.xmppClient.sendOnline(i)})}async leave(e){return new Promise((t,r)=>{const s=this.helpers.getDialogJid(e),n=be.createPresenceStanza({type:"unavailable",from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(s)});delete this.joinedRooms[s],this.stanzasCallbacks["muc:leave"]=e=>{t()},this.xmppClient.sendOnline(n)})}async listOnlineUsers(e){return new Promise((t,r)=>{const s=be.getUniqueId("muc_disco_items"),n=be.createIqStanza({type:"get",to:this.helpers.getDialogJid(e),from:this.helpers.userCurrentJid,id:s});n.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),this.stanzasCallbacks[s]=e=>{const r=be.getAttr(e,"id");if(this.stanzasCallbacks[r]){const r=be.getAttr(e,"query"),s=be.getChildElements(r).map(e=>{const t=be.getAttr(e,"jid");return this.helpers.getUserIdFromRoomJid(t)}).filter(e=>null!==e);t(s)}},this.xmppClient.sendOnline(n)})}}class we{constructor(p){this.isConnected=!1,this.isConnecting=!1,this.isLogout=!1,this.isReconnect=!1,this.stanzasCallbacks={},this.xmppClientListeners=new Map,this.connectPromise=null,this.earlyIncomingMessagesQueue=[],this.proxy=p,this.dialog=new fe(p),this.message=new ye(p),this.helpers=new Ce,this.xmppClient=function(p){const{resource:m,credentials:g,username:f,password:y,...b}=p,{domain:C,service:S}=b;!C&&S&&(b.domain=(S.split("://")[1]||S).split(":")[0].split("/")[0]);const v=new e.Client(b),E=t({entity:v}),T=r({entity:v}),w=s({entity:v}),I=n({middleware:w}),k=i({middleware:w,entity:v}),D=a({middleware:w,entity:v}),A=s({entity:v}),x=o({entity:v}),O=c({streamFeatures:I},g||{username:f,password:y}),R=l({iqCaller:k,streamFeatures:I},m),P=d({iqCaller:k,streamFeatures:I}),L=Object.entries({plain:h,anonymous:u}).map(([e,t])=>({[e]:t(O)}));return Object.assign(v,{entity:v,reconnect:E,websocket:T,middleware:w,streamFeatures:I,iqCaller:k,iqCallee:D,starttls:A,resolve:x,sasl:O,resourceBinding:R,sessionEstablishment:P,mechanisms:L,sendOnline:function(e,...t){if("online"===v.status)return v.send.call(v,e,...t);{const e="You are not connected to chat. Please call 'connect' function first";return he.DLog("[Chat][Error]",e),Promise.reject(new Error(e))}}})}({service:ue.chatProtocol.websocket,credentials:(e,t)=>e({username:this.xmppClient.options.username||"",password:this.xmppClient.options.password||""})}),ue.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*ue.chat.reconnect.timeInterval);const m={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.muc=new Te(m),this.privacylist=new Ee(m),this.streamManagement=new ve(this)}get connectionStatus(){return this.xmppClient.status}async connect(e){return this.connectPromise=new Promise((t,r)=>(he.DLog("[Chat]","Connect with parameter:",e),this.isConnecting?(he.DLog("[Chat]","Warning! Already in CONNECTING state"),void t(!1)):this.isConnected?(he.DLog("[Chat]","Warning! Chat is already connected!"),void t(!1)):(this.isConnecting=!0,this.isLogout=!1,this.removeAllXMPPClientListeners(),this.addXMPPClientListener("connect",()=>{he.DLog("[Chat]",this.isReconnect?"RECONNECTING":"CONNECTING")}),this.addXMPPClientListener("online",()=>{he.DLog("[Chat]","ONLINE"),this.postConnectActions(),t(!0),this.connectPromise=null}),this.addXMPPClientListener("offline",()=>{he.DLog("[Chat]","OFFLINE")}),this.addXMPPClientListener("disconnect",()=>{he.DLog("[Chat]","DISCONNECTED"),he.safeCallbackCall(this.onDisconnectedListener)(),ue.chat.reconnect.enable?(this.isConnected=!1,this.isConnecting=!1):this.disconnect()}),this.addXMPPClientListener("status",(e,t)=>{he.DLog("[Chat]",`status - ${e}`,"object"==typeof t?JSON.stringify(t):""),he.safeCallbackCall(this.onChatStatusListener)(e)}),this.addXMPPClientListener("stanza",e=>{if(e.is("message")&&!this.isConnected)return this.earlyIncomingMessagesQueue.push(e),void he.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?this.onPresence(e):e.is("iq")?this.onIQ(e):e.is("message")&&("headline"===e.attrs.type?this.onSystemMessage(e):"error"===e.attrs.type?this.onMessageError(e):this.onMessage(e))}),this.addXMPPClientListener("error",e=>{he.DLog("[Chat]","ERROR:",e,{isReconnect:this.isReconnect,connectPromise:!!this.connectPromise}),this.connectPromise?this.isReconnect||(r("SASLError"==e.name?e.condition:e),this.connectPromise=null):he.safeCallbackCall(this.onConnectionErrorListener)(e)}),this.addXMPPClientListener("output",e=>{he.callTrafficUsageCallback("xmppDataWrite",{body:e}),he.DLog("[Chat]","SENT:",e)}),this.addXMPPClientListener("input",e=>{he.callTrafficUsageCallback("xmppDataRead",{body:e}),he.DLog("[Chat]","RECV:",e)}),this.xmppClient.options.username=be.buildUserJidLocalPart(e.userId),this.xmppClient.options.password=e.password,void this.xmppClient.start().catch(e=>{console.error("[Chat] xmppClient.start error",e),this.connectPromise?(r(e),this.connectPromise=null):he.safeCallbackCall(this.onConnectionErrorListener)(e)})))),this.connectPromise}async ping(){return new Promise((e,t)=>{const r=be.getUniqueId("ping"),s=be.createIqStanza({id:r,type:"get",to:ue.endpoints.chat});s.c("ping",{xmlns:"urn:xmpp:ping"}),this.stanzasCallbacks[r]=r=>{const s=be.getElement(r,"error");s?t(be.buildErrorFromXMPPErrorStanza(s)):e()},this.xmppClient.sendOnline(s)})}async pingWithTimeout(e=5e3){return Promise.race([this.ping(),new Promise((t,r)=>setTimeout(()=>{const e="Chat ping() timed out";he.safeCallbackCall(this.onConnectionErrorListener)(e),r(e)},e))])}send(e,t={}){const r=t.id??he.getBsonObjectId(),s=be.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:t.type??this.helpers.typeChat(e),id:r});return t.id||(t.id=r),t.body&&s.c("body").t(t.body).up(),t.markable&&s.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(s.c("extraParams",{xmlns:"jabber:client"}),be.assignExtraParamsToXml(s,t.extension)),this.streamManagement.supported?this.streamManagement.sendAndCount(s,t):this.xmppClient.sendOnline(s),r}sendSystemMessage(e,t){const r=t.id??he.getBsonObjectId(),s=be.createMessageStanza({type:"headline",id:r,to:this.helpers.jidOrUserId(e)});return t.body&&s.c("body").t(t.body).up(),t.extension&&(s.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),be.assignExtraParamsToXml(s,t.extension)),this.xmppClient.sendOnline(s),r}sendIsTypingStatus(e){const t=be.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendIsStopTypingStatus(e){const t=be.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendDeliveredStatus(e){const t=be.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:he.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}sendReadStatus(e){const t=be.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:he.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}editMessage(e){const t=be.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:he.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&be.assignExtraParamsToXml(t,e.extension),this.xmppClient.sendOnline(t)}deleteMessage(e){const t=be.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:he.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}getLastUserActivity(e){return new Promise((t,r)=>{const s=be.getUniqueId("lastActivity"),n=be.createIqStanza({type:"get",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),id:s});n.c("query",{xmlns:"jabber:iq:last"}),this.stanzasCallbacks[s]=e=>{be.getElement(e,"error")?r(be.buildErrorFromXMPPErrorStanza(e)):t(this.onLastActivityStanza(e))},this.xmppClient.sendOnline(n)})}onLastActivityStanza(e){const t=be.getAttr(e,"from"),r=this.helpers.getUserIdFromJID(t),s=be.getElement(e,"query"),n=s?parseInt(be.getAttr(s,"seconds")):0;return he.safeCallbackCall(this.onLastUserActivityListener)(r,n),{userId:r,seconds:n}}markActive(){const e=be.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.sendOnline(e)}markInactive(){const e=be.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.sendOnline(e)}async disconnect(){if(he.DLog("[Chat]","disconnect"),this.isLogout)return he.DLog("[Chat]","Warning! Chat is already disconnected!"),!0;this.isLogout=!0,this.isReconnect=!1,this.isConnected=!1,this.isConnecting=!1,this.muc.joinedRooms={},this.helpers.userCurrentJid="",this.streamManagement.stop();try{return await this.xmppClient.stop(),!0}catch{return!1}}terminate(){he.DLog("[Chat]","terminated"),this.isConnected=!1,this.isConnecting=!1,this.streamManagement.stop(),this.xmppClient.socket.end()}async search(e){const t=Object.assign({},e);t.start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),he.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(","));const r={type:ie.GET,url:he.getUrl(`${ue.urls.chat}/search`),data:t};return this.proxy.ajax(r)}onMessage(e){const t=be.getElementTreePath(e,["sent","forwarded","message"]),r=t||e,s=be.getAttr(r,"from"),n=be.getAttr(r,"type"),i=be.getElement(r,"invite"),a=this.xmppClient.jid?.getResource()||"",o="chat"===n;if(o&&s.includes(a)||i)return;const c=be.getAttr(r,"id"),l=be.getElement(r,"markable"),d=be.getElement(r,"received"),u=be.getElement(r,"displayed"),h=be.getElement(r,"replace"),p=be.getElement(r,"reactions"),m=be.getElement(r,"remove"),g=Boolean(be.getElement(r,"composing")),f=be.getElement(r,"paused"),y=be.getElement(r,"delay"),b=be.getElement(r,"extraParams"),C=be.getElementText(r,"body"),S=Boolean(t),v="groupchat"===n,E=o?be.getAttr(r,"to"):null,T=E?this.helpers.getUserIdFromJID(E):null,w=b?be.parseExtraParams(b):null,I=w?w.extension:null,k=v?this.helpers.getDialogIdFromJID(s):w?.dialogId??null,D=v?this.helpers.getIdFromResource(s):this.helpers.getUserIdFromJID(s),A=this.xmppClient.jid?.toString(),x=A?this.helpers.getUserIdFromJID(A):0;if(g||f)return void((o||v||!y)&&he.safeCallbackCall(this.onMessageTypingListener)(g,D,k));if(h)return void he.safeCallbackCall(this.onMessageUpdateListener)(be.getAttr(h,"id"),"true"===be.getAttr(h,"last"),C,k,D,I);if(p){if(S&&v)return;const e=be.getAttr(p,"message_id"),t=parseInt(be.getAttr(p,"user_id")),{add:r,remove:s}=be.parseReactions(p);return void he.safeCallbackCall(this.onMessageReactionsListener)(e,t,k,r,s)}if(m){const e=be.getAttr(m,"id");return void he.safeCallbackCall(this.onMessageDeleteListener)(e,k,D)}if(d||u){if(d&&o){const e=be.getAttr(d,"id");he.safeCallbackCall(this.onDeliveredStatusListener)(e,k,D)}if(u&&o){const e=be.getAttr(u,"id");he.safeCallbackCall(this.onReadStatusListener)(e,k,D)}return}l&&k&&D&&D!==x&&this.sendDeliveredStatus({messageId:c,dialogId:k,userId:D});const O={id:c,dialog_id:k,recipient_id:T,is_forwarded:S,type:n,body:C,extension:I,delay:y};l&&(O.markable=1),(o||v)&&he.safeCallbackCall(this.onMessageListener)(D,O)}onPresence(e){const t=be.getAttr(e,"from"),r=be.getAttr(e,"id"),s=be.getAttr(e,"type"),n=this.xmppClient.jid?.toString(),i=this.helpers.getUserIdFromJID(n),a=be.getElement(e,"x"),o=a?be.getAttr(a,"xmlns"):null,c=a?be.getElement(a,"xmlns"):null,l=c?be.getElementText(c,"code"):null;if(o&&o.startsWith("http://jabber.org/protocol/muc")){if("error"===s)return void(r.endsWith(":join")&&he.safeCallbackCall(this.stanzasCallbacks[r])(e));const n=this.helpers.getDialogIdFromJID(t),a=this.helpers.getUserIdFromRoomJid(t);if(c){if("301"===l){const r=be.getElement(e,"item"),s=r?be.getElement(r,"actor"):null,i=s?be.getAttr(s,"jid"):null,a=this.helpers.getUserIdFromJID(i),o=this.helpers.getRoomJidFromRoomFullJid(t);return he.safeCallbackCall(this.onKickOccupant)(n,a),void(o&&delete this.muc.joinedRooms[o])}if("unavailable"===s)return void(c&&"110"===l&&he.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(r.endsWith(":join")&&c&&"110"===l)return void this.stanzasCallbacks[r]?.(e)}else if(a!=i){const e="unavailable"===s?"onLeaveOccupant":"onJoinOccupant";return void he.safeCallbackCall(this[e])(n,a)}}}onIQ(e){const t=be.getAttr(e,"id");if(this.stanzasCallbacks[t])he.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{const t=be.getAttr(e,"from"),r=be.getElement(e,"query");t&&r&&this.onLastActivityStanza(e)}}onSystemMessage(e){const t=be.getElementTreePath(e,["sent","forwarded","message"])||e,r=be.getAttr(t,"from"),s=be.getAttr(t,"id"),n=be.getElement(t,"extraParams"),i=this.helpers.getUserIdFromJID(r),a=be.getElement(t,"delay"),o=n?be.getElementText(n,"moduleIdentifier"):null,c=be.getElementText(t,"body"),l=n?be.parseExtraParams(n):null,d=l?l.extension:null;switch(o){case"SystemNotifications":he.safeCallbackCall(this.onSystemMessageListener)({id:s,userId:i,body:c,extension:d});break;case"WebRTCVideoChat":this.webrtcSignalingProcessor&&!a&&he.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(i,n)}}onMessageError(e){const t=be.getAttr(e,"id"),r=be.buildErrorFromXMPPErrorStanza(e);he.safeCallbackCall(this.onMessageErrorListener)(t,r)}postConnectActions(){he.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");const e=be.createPresenceStanza();if(this.streamManagement.start(),this.helpers.userCurrentJid=this.xmppClient.jid?.toString()??null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.sendOnline(e),this.isReconnect?he.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){he.DLog("[Chat]",`Flush 'earlyIncomingMessagesQueue' (length=${this.earlyIncomingMessagesQueue.length})`);const e=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach(t=>{e?.(t)}),this.earlyIncomingMessagesQueue=[]}}enableCarbons(){const e=be.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:be.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.sendOnline(e)}setSubscriptionToUserLastActivity(e,t){const r=be.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});r.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.sendOnline(r)}subscribeToUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!0)}unsubscribeFromUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!1)}addXMPPClientListener(e,t){this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)}removeXMPPClientListener(e){const t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)}removeAllXMPPClientListeners(){this.xmppClientListeners.forEach((e,t)=>this.removeXMPPClientListener(t))}getListenerByName(e){switch(e){case W.STATUS:return"onChatStatusListener";case W.ERROR:return"onConnectionErrorListener";case W.DISCONNECTED:return"onDisconnectedListener";case W.RECONNECTED:return"onReconnectListener";case W.MESSAGE:return"onMessageListener";case W.SYSTEM_MESSAGE:return"onSystemMessageListener";case W.ERROR_MESSAGE:return"onMessageErrorListener";case W.TYPING_MESSAGE:return"onMessageTypingListener";case W.UPDATE_MESSAGE:return"onMessageUpdateListener";case W.DELETE_MESSAGE:return"onMessageDeleteListener";case W.REACTIONS_MESSAGE:return"onMessageReactionsListener";case W.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case W.READ_MESSAGE:return"onReadStatusListener";case W.SENT_MESSAGE:return"onSentMessageCallback";case W.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case W.JOIN:return"onJoinOccupant";case W.LEAVE:return"onLeaveOccupant";case W.KICK:return"onKickOccupant";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}function Ie(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function ke(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var r=function e(){var r=!1;try{r=this instanceof e}catch{}return r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var s=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,s.get?s:{enumerable:!0,get:function(){return e[t]}})}),r}var De,Ae,xe=ke(j);var Oe=function(){if(Ae)return De;Ae=1;const{adapter:e,navigator:t,MediaStream:r,MediaStreamTrack:s,RTCPeerConnection:n,RTCRtpReceiver:i,RTCRtpSender:a,isReactNative:o}=xe;l.sessions={},l.mobile=o,l.isExtensionEnabled=function(){if(l.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||l.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!l.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(l.mobile)e();else{let t=window.setTimeout(function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,l.mobile||window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let r=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",r(e)}else r(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)})}};function l(e){if((e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:l.noop,!l.initDone)return e.error("Library not initialized"),{};if(!l.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(l.log("Library initialized: "+l.initDone),!e.server)return e.error("Invalid server url"),{};let o=!1,c=null,d={},u=null,h=null,p=0,m=e.server;l.isArray(m)?(l.log("Multiple servers provided ("+m.length+"), will use the first that works"),m=null,h=e.server,l.debug(h)):0===m.indexOf("ws")?(o=!0,l.log("Using WebSockets to contact Janus: "+m)):(o=!1,l.log("Using REST API to contact Janus: "+m));let g=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],f=e.iceTransportPolicy,y=e.bundlePolicy,b=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(b=!0===e.withCredentials);let C=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(C=e.max_poll_events),C<1&&(C=1);let S=null;void 0!==e.token&&null!==e.token&&(S=e.token);let v=null;void 0!==e.apisecret&&null!==e.apisecret&&(v=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let E=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(E=e.keepAlivePeriod),isNaN(E)&&(E=25e3);let T=6e4;function w(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(T=e.longPollTimeout),isNaN(T)&&(T=6e4);let I=!1,k=null,D={},A=this,x=0,O={};function R(){if(null==k)return;if(l.debug("Long poll..."),!I)return void l.warn("Is the server down? (connected=false)");let t=m+"/"+k+"?rid="+(new Date).getTime();C&&(t=t+"&maxev="+C),S&&(t=t+"&token="+encodeURIComponent(S)),v&&(t=t+"&apisecret="+encodeURIComponent(v)),l.httpAPICall(t,{verb:"GET",withCredentials:b,success:P,timeout:T,error:function(t,r){if(l.error(t+":",r),x++,x>3)return I=!1,void e.error("Lost connection to the server (is it down?)");R()}})}function P(e,t){if(x=0,o||null==k||!0===t||R(),o||!l.isArray(e))if("keepalive"!==e.janus){if("server_info"===e.janus){l.debug("Got info on the Janus instance"),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("ack"===e.janus){l.debug("Got an ack on session "+k),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("success"===e.janus){l.debug("Got a success on session "+k),l.debug(e);const t=e.transaction;if(t){const r=O[t];r&&r(e),delete O[t]}return}if("trickle"===e.janus){const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];if(!r)return void l.debug("This handle is not attached to this session");let s=e.candidate;l.debug("Got a trickled candidate on session "+k),l.debug(s);let n=r.webrtcStuff;n.pc&&n.remoteSdp?(l.debug("Adding remote candidate:",s),s&&!0!==s.completed?n.pc.addIceCandidate(s):n.pc.addIceCandidate(l.endOfCandidates)):(l.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),n.candidates||(n.candidates=[]),n.candidates.push(s),l.debug(n.candidates))}else{if("webrtcup"===e.janus){l.debug("Got a webrtcup event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];return r?void r.webrtcState(!0):void l.debug("This handle is not attached to this session")}if("hangup"===e.janus){l.debug("Got a hangup event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];if(!r)return void l.debug("This handle is not attached to this session");r.webrtcState(!1,e.reason),r.hangup()}else if("detached"===e.janus){l.debug("Got a detached event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];if(!r)return;r.ondetached(),r.detach()}else if("media"===e.janus){l.debug("Got a media event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];if(!r)return void l.debug("This handle is not attached to this session");r.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){l.debug("Got a slowlink event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const r=D[t];if(!r)return void l.debug("This handle is not attached to this session");r.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){l.error("Ooops: "+e.error.code+" "+e.error.reason),l.debug(e);let t=e.transaction;if(t){let r=O[t];r&&r(e),delete O[t]}return}if("event"===e.janus){l.debug("Got a plugin event on session "+k),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");let r=e.plugindata;if(!r)return void l.warn("Missing plugindata...");l.debug("  -- Event is coming from "+t+" ("+r.plugin+")");let s=r.data;l.debug(s);const n=D[t];if(!n)return void l.warn("This handle is not attached to this session");let i=e.jsep;i&&(l.debug("Handling SDP as well..."),l.debug(i));let a=n.onmessage;a?(l.debug("Notifying application..."),a(s,i)):l.debug("No provided notification callback")}else{if("timeout"===e.janus)return l.error("Timeout on session "+k),l.debug(e),void(o&&c.close(3504,"Gateway timeout"));l.warn("Unknown message/event  '"+e.janus+"' on session "+k),l.debug(e)}}}}else l.vdebug("Got a keepalive on session "+k);else for(let t=0;t<e.length;t++)P(e[t],!0)}function L(){if(!m||!o||!I)return;u=setTimeout(L,E);let e={janus:"keepalive",session_id:k,transaction:l.randomString(12)};S&&(e.token=S),v&&(e.apisecret=v),c.send(JSON.stringify(e))}function N(t){let r=l.randomString(12),s={janus:"create",transaction:r};if(t.reconnect&&(I=!1,s.janus="claim",s.session_id=k,c&&(c.onopen=null,c.onerror=null,c.onclose=null,u&&(clearTimeout(u),u=null))),S&&(s.token=S),v&&(s.apisecret=v),!m&&l.isArray(h)&&(m=h[p],0===m.indexOf("ws")?(o=!0,l.log("Server #"+(p+1)+": trying WebSockets to contact Janus ("+m+")")):(o=!1,l.log("Server #"+(p+1)+": trying REST API to contact Janus ("+m+")"))),o){c=l.newWebSocket(m,"janus-protocol"),d={error:function(){if(l.error("Error connecting to the Janus WebSockets server... "+m),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){N(t)},200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){O[r]=function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);u=setTimeout(L,E),I=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+k):l.log("Created session: "+k),l.sessions[k]=A,t.success()},c.send(JSON.stringify(s))},message:function(e){P(JSON.parse(e.data))},close:function(){m&&I&&(I=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in d)c.addEventListener(e,d[e])}else l.httpAPICall(m,{verb:"POST",withCredentials:b,body:s,success:function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);I=!0,k=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+k):l.log("Created session: "+k),l.sessions[k]=A,R(),t.success()},error:function(e,r){if(l.error(e+":",r),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){N(t)},200));""===r?t.error(e+": Is the server down?"):r&&r.error?t.error(e+": "+r.error.message):t.error(e+": "+r)}})}function j(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,!I)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let r=D[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let s=t.message,n=t.jsep,i=l.randomString(12),a={janus:"message",body:s,transaction:i};if(r.token&&(a.token=r.token),v&&(a.apisecret=v),n&&(a.jsep={type:n.type,sdp:n.sdp},n.e2ee&&(a.jsep.e2ee=!0),"hml"!==n.rid_order&&"lmh"!==n.rid_order||(a.jsep.rid_order=n.rid_order),n.force_relay&&(a.jsep.force_relay=!0)),l.debug("Sending message to plugin (handle="+e+"):"),l.debug(a),o)return a.session_id=k,a.handle_id=e,O[i]=function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let r=e.plugindata;if(!r)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+r.plugin+")");let s=r.data;return l.debug(s),void t.success(s)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(a));l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:a,success:function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let r=e.plugindata;if(!r)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+r.plugin+")");let s=r.data;return l.debug(s),void t.success(s)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},error:function(e,r){l.error(e+":",r),t.error(e+": "+r)}})}function M(e,t){if(!I)return void l.warn("Is the server down? (connected=false)");let r=D[e];if(!r||!r.webrtcStuff)return void l.warn("Invalid handle");let s={janus:"trickle",candidate:t,transaction:l.randomString(12)};if(r.token&&(s.token=r.token),v&&(s.apisecret=v),l.vdebug("Sending trickle candidate (handle="+e+"):"),l.vdebug(s),o)return s.session_id=k,s.handle_id=e,void c.send(JSON.stringify(s));l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:s,success:function(e){l.vdebug("Candidate sent!"),l.vdebug(e),"ack"===e.janus||l.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){l.error(e+":",t)}})}function U(e,t,r,s,n){let i=D[e];if(!i||!i.webrtcStuff)return void l.warn("Invalid handle");let a=i.webrtcStuff;if(!a.pc)return void l.warn("Invalid PeerConnection");let o=function(e){l.log("Received state change on data channel:",e);let t=e.target.label,r=e.target.protocol,s=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(l.log("State change on <"+t+"> data channel: "+s),"open"===s){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){l.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length);for(let e of a.dataChannel[t].pending)l.log("Sending data on data channel <"+t+">"),l.debug(e),a.dataChannel[t].send(e);a.dataChannel[t].pending=[]}i.ondataopen(t,r)}};if(s)a.dataChannel[t]=s;else{let e=a.dataChannelOptions;r&&(e.protocol=r),a.dataChannel[t]=a.pc.createDataChannel(t,e)}a.dataChannel[t].onmessage=function(e){l.log("Received message on data channel:",e);let t=e.target.label;i.ondata(e.data,t)},a.dataChannel[t].onopen=o,a.dataChannel[t].onclose=o,a.dataChannel[t].onerror=function(e){l.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],n&&a.dataChannel[t].pending.push(n)}function _(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=D[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let s=r.webrtcStuff,n=t.text||t.data;if(!n)return l.warn("Invalid data"),void t.error("Invalid data");let i=t.label?t.label:l.dataChanDefaultLabel;return s.dataChannel[i]?"open"!==s.dataChannel[i].readyState?(s.dataChannel[i].pending.push(n),void t.success()):(l.log("Sending data on data channel <"+i+">"),l.debug(n),s.dataChannel[i].send(n),void t.success()):(U(e,i,t.protocol,!1,n,t.protocol),void t.success())}function J(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=D[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let s=r.webrtcStuff;if(!s.dtmfSender){if(s.pc){let e=s.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!e)return l.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");s.dtmfSender=e.dtmf,s.dtmfSender&&(l.log("Created DTMF Sender"),s.dtmfSender.ontonechange=function(e){l.debug("Sent DTMF tone: "+e.tone)})}if(!s.dtmfSender)return l.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let n=t.dtmf;if(!n)return l.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let i=n.tones;if(!i)return l.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let a="number"==typeof n.duration?n.duration:500,o="number"==typeof n.gap?n.gap:50;l.debug("Sending DTMF string "+i+" (duration "+a+"ms, gap "+o+"ms)"),s.dtmfSender.insertDTMF(i,a,o),t.success()}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=!0===t.noRequest;l.log("Destroying handle "+e+" (only-locally="+r+")"),ee(e);let s=D[e];if(!s||s.detached)return delete D[e],void t.success();if(s.detached=!0,r)return delete D[e],void t.success();if(!I)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let n={janus:"detach",transaction:l.randomString(12)};if(s.token&&(n.token=s.token),v&&(n.apisecret=v),o)return n.session_id=k,n.handle_id=e,c.send(JSON.stringify(n)),delete D[e],void t.success();l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:n,success:function(r){l.log("Destroyed handle:"),l.debug(r),"success"!==r.janus&&l.error("Ooops: "+r.error.code+" "+r.error.reason),delete D[e],t.success()},error:function(r,s){l.error(r+":",s),delete D[e],t.success()}})}function $(e,t){let r=D[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let s=r.webrtcStuff;if(s.pc)return;let i={iceServers:g,iceTransportPolicy:f,bundlePolicy:y,sdpSemantics:"unified-plan"},o=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){o=!0;break}a&&(a.prototype.createEncodedStreams||a.prototype.createEncodedAudioStreams&&a.prototype.createEncodedVideoStreams)&&o&&(s.insertableStreams=!0,i.forceEncodedAudioInsertableStreams=!0,i.forceEncodedVideoInsertableStreams=!0,i.encodedInsertableStreams=!0),l.log("Creating PeerConnection"),s.pc=new n(i),l.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),l.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(){s.pc&&r.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(r){if(!r.candidate||r.candidate.candidate&&r.candidate.candidate.indexOf("endOfCandidates")>0)l.log("End of candidates."),s.iceDone=!0,!0===s.trickle?M(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let r=D[e];if(!r||!r.webrtcStuff)return void l.warn("Invalid handle, not sending anything");let s=r.webrtcStuff;if(l.log("Sending offer/answer SDP..."),!s.mySdp)return void l.warn("Local SDP instance is invalid, not sending anything...");s.mySdp={type:s.pc.localDescription.type,sdp:s.pc.localDescription.sdp},!1===s.trickle&&(s.mySdp.trickle=!1);l.debug(t),s.sdpSent=!0,t.success(s.mySdp)}(e,t);else{let t={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===s.trickle&&M(e,t)}},s.pc.ontrack=function(e){if(l.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{r.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){l.error("Error calling onremotetrack",e)}if(e.track.onended)return;let n=null;l.log("Adding onended callback to track:",e.track),e.track.onended=function(e){l.log("Remote track removed:",e),clearTimeout(n);let t=s.pc?s.pc.getTransceivers():null,i=t?t.find(t=>{const r=t.receiver||t._receiver;return(r.track||r._track)===e.target}):null,a=i?i.mid||i._mid:e.target.id;try{r.onremotetrack(e.target,a,!1,{reason:"ended"})}catch(e){l.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(l.log("Remote track muted:",e),!n){const t=e.target;n=setTimeout(function(){l.log("Removing remote track");let e=s.pc?s.pc.getTransceivers():null,i=e?e.find(e=>{const r=e.receiver||e._receiver;return(r.track||r._track)===t}):null,a=i?i.mid||i._mid:t.id;try{r.onremotetrack(t,a,!1,{reason:"mute"})}catch(e){l.error("Error calling onremotetrack on mute",e)}n=null},2520)}},e.track.onunmute=function(e){if(l.log("Remote track flowing again:",e),null!=n)clearTimeout(n),n=null;else try{let t=s.pc?s.pc.getTransceivers():null,n=t?t.find(t=>{const r=t.receiver||t._receiver;return(r.track||r._track)===e.target}):null,i=n?n.mid||n._mid:e.target.id;r.onremotetrack(e.target,i,!0,{reason:"unmute"})}catch(e){l.error("Error calling onremotetrack on unmute",e)}}}}async function F(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:l.noop,r.error="function"==typeof r.error?r.error:Z;let s=r.jsep;if(t&&s)return l.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(t||s&&s.type&&s.sdp))return l.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");if(r.media&&!r.tracks){if(r.tracks=l.mediaToTracks(r.media),!0===r.simulcast||!0===r.simulcast2||r.svc)for(let e of r.tracks)if("video"===e.type){!0===r.simulcast||!0===r.simulcast2?e.simulcast=!0:r.svc&&(e.svc=r.svc);break}l.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",r.tracks)}if(r.tracks&&!Array.isArray(r.tracks))return l.error("Tracks must be an array"),void r.error("Tracks must be an array");let n=D[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void r.error("Invalid handle");let i=n.webrtcStuff;var a;i.trickle=(a=r.trickle,l.debug("isTrickleEnabled:",a),!1!==a);try{if($(e,r),t&&await G(e,r),s){if(await i.pc.setRemoteDescription(s),l.log("Remote description accepted!"),i.remoteSdp=s.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(l.endOfCandidates)}i.candidates=[]}await G(e,r);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=D[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let s=r.webrtcStuff;l.log("Creating answer (iceDone="+s.iceDone+")");let n=await s.pc.createAnswer();l.debug(n);let i={type:"answer",sdp:n.sdp};if(t.customizeSdp(i),n.sdp=i.sdp,l.log("Setting local description"),s.mySdp={type:"answer",sdp:n.sdp},await s.pc.setLocalDescription(n),!s.iceDone&&!s.trickle)return l.log("Waiting for all candidates..."),null;s.insertableStreams&&(n.e2ee=!0);return n}(e,r);r.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=D[e];if(!r||!r.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let s=r.webrtcStuff;l.log("Creating offer (iceDone="+s.iceDone+")");let n={},i=!0===t.iceRestart;i&&(n.iceRestart=!0);l.debug(n);let a=await s.pc.createOffer(n);l.debug(a);let o={type:"offer",sdp:a.sdp};if(t.customizeSdp(o),a.sdp=o.sdp,l.log("Setting local description"),s.mySdp={type:"offer",sdp:a.sdp},await s.pc.setLocalDescription(a),s.mediaConstraints=n,!s.iceDone&&!s.trickle)return l.log("Waiting for all candidates..."),null;s.insertableStreams&&(a.e2ee=!0);return a}(e,r);r.success(t)}}catch(e){l.error(e),r.error(e)}}function W(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:Z,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let r=t.jsep,s=D[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=s.webrtcStuff;if(r){if(!n.pc)return l.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(r),n.pc.setRemoteDescription(r).then(function(){if(l.log("Remote description accepted!"),n.remoteSdp=r.sdp,n.candidates&&n.candidates.length>0){for(let e=0;e<n.candidates.length;e++){let t=n.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?n.pc.addIceCandidate(t):n.pc.addIceCandidate(l.endOfCandidates)}n.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}async function q(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,t.tracks&&!Array.isArray(t.tracks))return l.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await G(e,t),t.success()}catch(e){l.error(e),t.error(e)}}async function G(e,n){let o=D[e];if(!o||!o.webrtcStuff)throw l.warn("Invalid handle, not sending anything"),"Invalid handle";let c=o.webrtcStuff;if(!c.pc)throw l.warn("Invalid PeerConnection"),"Invalid PeerConnection";let d=n.tracks;if(!d||!Array.isArray(d)||0===d.length)return;let u=!1,h={};for(let e of d){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof s)continue;let t=e.group?e.group:"default";h[t]||(h[t]={}),h[t][e.type]||(e.gumGroup=t,h[t][e.type]=e)}let p=Object.keys(h);for(let e of p){let t=h[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete h[e])}let m=!!n.jsep;for(let n of d){if(!n.type){l.warn("Missing track type:",n);continue}if("data"===n.type){if(c.pc.ondatachannel){l.warn("Data channel exists already, not creating another one");continue}l.log("Creating default data channel"),U(e,l.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){l.log("Data channel created by Janus:",t),U(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===n.add&&null===n.add&&void 0===n.remove&&null===n.remove&&void 0===n.replace&&null===n.replace&&(n.add=!0),n.add&&n.remove||n.add&&n.remove&&n.replace){l.warn("Conflicting actions for track, ignoring:",n);continue}n.add&&n.replace?(l.warn("Both add and replace provided, falling back to replace:",n),delete n.add):n.remove&&n.replace&&(l.warn("Both remove and replace provided, falling back to remove:",n),delete n.replace);let d=n.type;"screen"===n.type&&(d="video");let p=null,g=null;if(p=n.mid?c.pc.getTransceivers().find(e=>e.mid===n.mid&&e.receiver.track.kind===d):c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),n.replace||n.remove){if(!p){l.warn("Couldn't find a transceiver for track:",n);continue}if(!p.sender){l.warn("No sender in the transceiver for track:",n);continue}g=p.sender}if(m&&!p&&(p=c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),!p)){l.warn("Couldn't find a transceiver for track:",n);continue}let f=null,y=null;if(n.remove)l.log("Removing track from PeerConnection",n),y=g.track?g.track.id:null,await g.replaceTrack(null);else if(n.capture){if(n.gumGroup&&h[n.gumGroup]&&h[n.gumGroup].stream){let e=h[n.gumGroup].stream;f="audio"===n.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete h[n.gumGroup].stream,delete h[n.gumGroup],delete n.gumGroup}else if(n.capture instanceof s)f=n.capture;else{u||(u=!0,o.consentDialog(!0));let e=l.trackConstraints(n),r=null;if("audio"===n.type||"video"===n.type){if(n.gumGroup){let t="audio"===n.type?"video":"audio";if(h[n.gumGroup]&&h[n.gumGroup][t]){let r=h[n.gumGroup][t],s=l.trackConstraints(r);e[t]=s[t]}}r=await t.mediaDevices.getUserMedia(e),n.gumGroup&&e.audio&&e.video&&(h[n.gumGroup].stream=r,delete n.gumGroup)}else r=await t.mediaDevices.getDisplayMedia(e);f="audio"===n.type?r.getAudioTracks()[0]:r.getVideoTracks()[0]}if(n.replace){await g.replaceTrack(f);let e="sendrecv";!1!==n.recv&&"inactive"!==p.direction&&"sendonly"!==p.direction||(e="sendonly"),p.setDirection?p.setDirection(e):p.direction=e}else{if(c.myStream||(c.myStream=new r),"audio"===d||!n.simulcast&&!n.svc)g=c.pc.addTrack(f,c.myStream),p=c.pc.getTransceivers().find(e=>e.sender===g);else if(n.simulcast){if("firefox"!==l.webRTCAdapter.browserDetails.browser){l.log("Enabling rid-based simulcasting:",f);let e=w(n.simulcastMaxBitrates);p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream],sendEncodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(l.log("Enabling Simulcasting for Firefox (RID)"),p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream]}),g=p?p.sender:null,g){let e=g.getParameters();e||(e={});let t=w(n.simulcastMaxBitrates);e.encodings=n.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],g.setParameters(e)}}else l.log("Enabling SVC ("+n.svc+"):",f),p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:n.svc}]});if(g||(g=p?p.sender:null),n.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",n);else if("string"!=typeof n.codec)l.warn("Invalid codec value, ignoring for track:",n);else{let e=d+"/"+n.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length){if(p)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}}else l.warn("Codec not supported in this browser for this track, ignoring:",n)}if(n.bitrate)if(n.simulcast||n.svc)l.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(n.bitrate)||n.bitrate<0)l.warn("Ignoring invalid bitrate for track:",n);else if(g){let e=g.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=n.bitrate,await g.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring bitrate for track:",n)}if("video"===d&&n.framerate)if(n.simulcast||n.svc)l.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(n.framerate)||n.framerate<0)l.warn("Ignoring invalid framerate for track:",n);else if(g){let e=g.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=n.framerate,await g.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring framerate for track:",n)}if(n.transforms){if(g&&n.transforms.sender){let e=null;a.prototype.createEncodedStreams?e=g.createEncodedStreams():(a.prototype.createAudioEncodedStreams||a.prototype.createEncodedVideoStreams)&&("audio"===d?e=g.createEncodedAudioStreams():"video"===d&&(e=g.createEncodedVideoStreams())),e&&(l.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(n.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(n.transforms.sender).pipeTo(e.writable))}if(p&&p.receiver&&n.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(n.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(n.transforms.receiver).pipeTo(e.writable))}}}f&&!0===n.dontStop&&(f.dontStop=!0)}else if(n.recv&&!p&&(p=c.pc.addTransceiver(d),p)){if(n.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",n);else if("string"!=typeof n.codec)l.warn("Invalid codec value, ignoring for track:",n);else{let e=d+"/"+n.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}else l.warn("Codec not supported in this browser for this track, ignoring:",n)}if(p.receiver&&n.transforms&&n.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(n.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(n.transforms.receiver).pipeTo(e.writable))}}if(y&&c.myStream){let e=null;if("audio"===d&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===y&&(e=t,l.log("Removing audio track:",e));else if("video"===d&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===y&&(e=t,l.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),o.onlocaltrack(e,!1)}catch(e){l.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(f){c.myStream.addTrack(f),f.onended=function(e){l.log("Local track removed:",e);try{o.onlocaltrack(e.target,!1)}catch(e){l.error("Error calling onlocaltrack following end",e)}};try{o.onlocaltrack(f,!0)}catch(e){l.error("Error calling onlocaltrack for track add",e)}}if(p){let e=p.direction,t=null,r=f&&p.sender.track,s=!1!==n.recv&&p.receiver.track;r&&s?t="sendrecv":r&&!s?t="sendonly":!r&&s?t="recvonly":r||s||(t="inactive"),t&&t!==e&&(l.warn("Changing direction of transceiver to "+t+" (was "+e+")",n),p.setDirection?p.setDirection(t):p.direction=t)}}u&&o.consentDialog(!1)}function B(e){let t=D[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let r=t.webrtcStuff;if(!r.pc)return l.warn("Invalid PeerConnection"),null;let s=[],n=r.pc.getTransceivers();for(let e of n){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&s.push(t)}return s}function z(e){let t=D[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let r=t.webrtcStuff;if(!r.pc)return l.warn("Invalid PeerConnection"),null;let s=[],n=r.pc.getTransceivers();for(let e of n){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&s.push(t)}return s}function H(e,t,r,s){s="function"==typeof s?s:l.noop;let n=D[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void s(0);let i=r?"remote":"local",a=n.webrtcStuff;if(a.volume[i]||(a.volume[i]={value:0}),a.pc&&a.pc.getStats&&("chrome"===l.webRTCAdapter.browserDetails.browser||"safari"===l.webRTCAdapter.browserDetails.browser)){let e=a.pc;if(t){let n=a.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!n)return l.warn("No audio transceiver with mid "+t),void s(0);if(r&&!n.receiver)return l.warn("Remote transceiver track unavailable"),void s(0);if(!r&&!n.sender)return l.warn("Local transceiver track unavailable"),void s(0);e=r?n.receiver:n.sender}return e.getStats().then(function(e){e.forEach(function(e){e&&"audio"===e.kind&&(r&&!e.remoteSource||!r&&"media-source"!==e.type||s(e.audioLevel?e.audioLevel:0))})}),a.volume[i].value}return l.warn("Getting the "+i+" volume unsupported by browser"),void s(0)}function X(e,t,r){let s=D[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),!0;let n=s.webrtcStuff;if(!n.pc)return l.warn("Invalid PeerConnection"),!0;if(!n.myStream)return l.warn("Invalid local MediaStream"),!0;if(r){if(!n.myStream.getVideoTracks()||0===n.myStream.getVideoTracks().length)return l.warn("No video track"),!0;if(t){let e=n.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No video sender with mid "+t),!0):(l.warn("No video transceiver with mid "+t),!0)}return!n.myStream.getVideoTracks()[0].enabled}if(!n.myStream.getAudioTracks()||0===n.myStream.getAudioTracks().length)return l.warn("No audio track"),!0;if(t){let e=n.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No audio sender with mid "+t),!0):(l.warn("No audio transceiver with mid "+t),!0)}return!n.myStream.getAudioTracks()[0].enabled}function Q(e,t,r,s){let n=D[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),!1;let i=n.webrtcStuff;if(!i.pc)return l.warn("Invalid PeerConnection"),!1;if(!i.myStream)return l.warn("Invalid local MediaStream"),!1;if(r){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return l.warn("No video track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!e)return l.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!s}else for(const e of i.myStream.getVideoTracks())e.enabled=!s}else{if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return l.warn("No audio track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!e)return l.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!s}else for(const e of i.myStream.getAudioTracks())e.enabled=!s}return!0}function K(e,t){let r=D[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),"Invalid handle";let s=r.webrtcStuff;if(!s.pc)return"Invalid PeerConnection";if(s.pc.getStats){let e=s.pc,r=t||"default";if(t){let r=s.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!r)return l.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!r.receiver)return l.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=r.receiver}return s.bitrate[r]||(s.bitrate[r]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),s.bitrate[r].timer?s.bitrate[r].value:(l.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),s.bitrate[r].timer=setInterval(function(){e.getStats().then(function(e){e.forEach(function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(s.bitrate[r].bsnow=e.bytesReceived,s.bitrate[r].tsnow=e.timestamp,null===s.bitrate[r].bsbefore||null===s.bitrate[r].tsbefore)s.bitrate[r].bsbefore=s.bitrate[r].bsnow,s.bitrate[r].tsbefore=s.bitrate[r].tsnow;else{let e=s.bitrate[r].tsnow-s.bitrate[r].tsbefore;"safari"===l.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(s.bitrate[r].bsnow-s.bitrate[r].bsbefore)/e);"safari"===l.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),s.bitrate[r].value=t+" kbits/sec",s.bitrate[r].bsbefore=s.bitrate[r].bsnow,s.bitrate[r].tsbefore=s.bitrate[r].tsnow}})})},1e3),"0 kbits/sec")}return l.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function Y(e,t,r){let s=D[e];if(!s||!s.webrtcStuff)return void l.warn("Invalid handle");let n=s.webrtcStuff;if(!n.pc)return void l.warn("Invalid PeerConnection");let i=n.pc.getTransceivers().find(e=>e.mid===t);if(!i)return void l.warn("No transceiver with mid",t);if(!i.sender)return void l.warn("No sender for transceiver with mid",t);let a=i.sender.getParameters();a&&a.encodings&&0!==a.encodings.length?a.encodings.length>1?l.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(r)||r<0?l.warn("Invalid bitrate (must be a positive integer)"):(a.encodings[0].maxBitrate=r,i.sender.setParameters(a)):l.warn("No parameters encodings")}function Z(e){l.error("WebRTC error:",e)}function ee(e,t){l.log("Cleaning WebRTC stuff");let r=D[e];if(!r)return;let s=r.webrtcStuff;if(s){if(!0===t){let t={janus:"hangup",transaction:l.randomString(12)};r.token&&(t.token=r.token),v&&(t.apisecret=v),l.debug("Sending hangup request (handle="+e+"):"),l.debug(t),o?(t.session_id=k,t.handle_id=e,c.send(JSON.stringify(t))):l.httpAPICall(m+"/"+k+"/"+e,{verb:"POST",withCredentials:b,body:t})}s.volume&&(s.volume.local&&s.volume.local.timer&&clearInterval(s.volume.local.timer),s.volume.remote&&s.volume.remote.timer&&clearInterval(s.volume.remote.timer));for(let e in s.bitrate)s.bitrate[e].timer&&clearInterval(s.bitrate[e].timer);s.bitrate={},!s.streamExternal&&s.myStream&&(l.log("Stopping local stream tracks"),l.stopAllTracks(s.myStream)),s.streamExternal=!1,s.myStream=null;try{s.pc.close()}catch(e){}s.pc=null,s.candidates=null,s.mySdp=null,s.remoteSdp=null,s.iceDone=!1,s.dataChannel={},s.dtmfSender=null,s.insertableStreams=!1}r.oncleanup()}N(e),this.getServer=function(){return m},this.isConnected=function(){return I},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.reconnect=!0,N(e)},this.getSessionId=function(){return k},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,l.log("Getting info on Janus instance"),!I)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=l.randomString(12),r={janus:"info",transaction:t};S&&(r.token=S);v&&(r.apisecret=v);if(o)return O[t]=function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(r));l.httpAPICall(m,{verb:"POST",withCredentials:b,body:r,success:function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,r){l.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)},this.destroy=function(r){!function(r){r=r||{},r.success="function"==typeof r.success?r.success:l.noop,r.error="function"==typeof r.error?r.error:l.noop;let s=!0===r.unload,n=!0;void 0!==r.notifyDestroyed&&null!==r.notifyDestroyed&&(n=!0===r.notifyDestroyed);let i=!0===r.cleanupHandles;if(l.log("Destroying session "+k+" (unload="+s+")"),!k)return l.warn("No session to destroy"),r.success(),void(n&&e.destroyed());if(i)for(let e in D)V(e,{noRequest:!0});if(!I)return l.warn("Is the server down? (connected=false)"),k=null,void r.success();let a={janus:"destroy",transaction:l.randomString(12)};S&&(a.token=S);v&&(a.apisecret=v);if(s)return o?(c.onclose=null,c.close(),c=null):t.sendBeacon(m+"/"+k,JSON.stringify(a)),l.log("Destroyed session:"),k=null,I=!1,r.success(),void(n&&e.destroyed());if(o){a.session_id=k;let t=function(){for(let e in d)c.removeEventListener(e,d[e]);c.removeEventListener("message",s),c.removeEventListener("error",i),u&&clearTimeout(u),c.close()},s=function(s){let i=JSON.parse(s.data);i.session_id==a.session_id&&i.transaction==a.transaction&&(t(),r.success(),n&&e.destroyed())},i=function(){t(),r.error("Failed to destroy the server: Is the server down?"),n&&e.destroyed()};return c.addEventListener("message",s),c.addEventListener("error",i),void(1===c.readyState?c.send(JSON.stringify(a)):i())}l.httpAPICall(m+"/"+k,{verb:"POST",withCredentials:b,body:a,success:function(t){l.log("Destroyed session:"),l.debug(t),k=null,I=!1,"success"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),r.success(),n&&e.destroyed()},error:function(t,s){l.error(t+":",s),k=null,I=!1,r.success(),n&&e.destroyed()}})}(r)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:l.noop,e.iceState="function"==typeof e.iceState?e.iceState:l.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:l.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:l.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:l.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:l.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:l.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:l.noop,e.ondata="function"==typeof e.ondata?e.ondata:l.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:l.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:l.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:l.noop,!I)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return l.error("Invalid plugin"),void e.error("Invalid plugin");let r=e.opaqueId,s=e.loopIndex,n=e.token?e.token:S,i=l.randomString(12),a={janus:"attach",plugin:t,opaque_id:r,loop_index:s,transaction:i};n&&(a.token=n);v&&(a.apisecret=v);if(o)return O[i]=function(r){if(l.debug(r),"success"!==r.janus)return l.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);let s=r.data.id;l.log("Created handle: "+s);let i={session:A,plugin:t,id:s,token:n,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return s},getPlugin:function(){return t},getVolume:function(e,t){return H(s,e,!0,t)},getRemoteVolume:function(e,t){return H(s,e,!0,t)},getLocalVolume:function(e,t){return H(s,e,!1,t)},isAudioMuted:function(e){return X(s,e,!1)},muteAudio:function(e){return Q(s,e,!1,!0)},unmuteAudio:function(e){return Q(s,e,!1,!1)},isVideoMuted:function(e){return X(s,e,!0)},muteVideo:function(e){return Q(s,e,!0,!0)},unmuteVideo:function(e){return Q(s,e,!0,!1)},getBitrate:function(e){return K(s,e)},setMaxBitrate:function(e,t){return Y(s,e,t)},send:function(e){j(s,e)},data:function(e){_(s,e)},dtmf:function(e){J(s,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(s,!0,e)},createAnswer:function(e){F(s,!1,e)},handleRemoteJsep:function(e){W(s,e)},replaceTracks:function(e){q(s,e)},getLocalTracks:function(){return B(s)},getRemoteTracks:function(){return z(s)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(s,!0===e)},detach:function(e){V(s,e)}};D[s]=i,e.success(i)},a.session_id=k,void c.send(JSON.stringify(a));l.httpAPICall(m+"/"+k,{verb:"POST",withCredentials:b,body:a,success:function(r){if(l.debug(r),"success"!==r.janus)return l.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);let s=r.data.id;l.log("Created handle: "+s);let i={session:A,plugin:t,id:s,token:n,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return s},getPlugin:function(){return t},getVolume:function(e,t){return H(s,e,!0,t)},getRemoteVolume:function(e,t){return H(s,e,!0,t)},getLocalVolume:function(e,t){return H(s,e,!1,t)},isAudioMuted:function(e){return X(s,e,!1)},muteAudio:function(e){return Q(s,e,!1,!0)},unmuteAudio:function(e){return Q(s,e,!1,!1)},isVideoMuted:function(e){return X(s,e,!0)},muteVideo:function(e){return Q(s,e,!0,!0)},unmuteVideo:function(e){return Q(s,e,!0,!1)},getBitrate:function(e){return K(s,e)},setMaxBitrate:function(e,t){return Y(s,e,t)},send:function(e){j(s,e)},data:function(e){_(s,e)},dtmf:function(e){J(s,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(s,!0,e)},createAnswer:function(e){F(s,!1,e)},handleRemoteJsep:function(e){W(s,e)},replaceTracks:function(e){q(s,e)},getLocalTracks:function(){return B(s)},getRemoteTracks:function(){return z(s)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(s,!0===e)},detach:function(e){V(s,e)}};D[s]=i,e.success(i)},error:function(t,r){l.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)}}return l.useDefaultDependencies=function(t){let r=t&&t.fetch||fetch,s=t&&t.Promise||Promise,n=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let n={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(n.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(n.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(n.body=JSON.stringify(t.body));let i=r(e,n).catch(function(e){return s.reject({message:"Probably a network error, is the server down?",error:e})});if(t.timeout){let e=new s(function(e,r){let s=setTimeout(function(){return clearTimeout(s),r({message:"Request timed out",timeout:t.timeout})},t.timeout)});i=s.race([i,e])}return i.then(function(e){return e.ok?typeof t.success==typeof l.noop?e.json().then(function(e){try{t.success(e)}catch(e){l.error("Unhandled httpAPICall success callback error",e)}},function(t){return s.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:s.reject({message:"API call failed",response:e})}).catch(function(e){typeof t.error==typeof l.noop&&t.error(e.message||"<< internal error >>",e)}),i}}},l.useOldDependencies=function(t){let r=t&&t.jQuery||jQuery,s=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new s(e,t)},isArray:function(e){return r.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let s=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},n=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return r.ajax(r.extend(s,n,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof l.noop&&t.success(e)},error:function(e,r,s){typeof t.error==typeof l.noop&&t.error(r,s)}}))}}},l.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let r={type:"audio"};e.removeAudio?r.remove=!0:(e.addAudio?r.add=!0:e.replaceAudio&&(r.replace=!0),!1!==e.audioSend&&(r.capture=e.audio||!0),!1!==e.audioRecv&&(r.recv=!0)),(r.remove||r.capture||r.recv)&&t.push(r)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let r={type:"video"};e.removeVideo?r.remove=!0:(e.addVideo?r.add=!0:e.replaceVideo&&(r.replace=!0),!1!==e.videoSend&&(r.capture=e.video||!0,["screen","window","desktop"].includes(r.capture)&&(r.type="screen",r.capture={video:{}},e.screenshareFrameRate&&(r.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(r.capture.height=e.screenshareHeight),e.screenshareWidth&&(r.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(r.recv=!0)),(r.remove||r.capture||r.recv)&&t.push(r)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},l.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let r=0,s=0;"lowres"===e.capture?(r=320,s=240):"lowres-16:9"===e.capture?(r=320,s=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(r=1280,s=720):"fhdres"===e.capture?(r=1920,s=1080):"4kres"===e.capture?(r=3840,s=2160):"stdres"===e.capture?(r=640,s=480):"stdres-16:9"===e.capture?(r=640,s=360):(l.log("Default video setting is stdres 4:3"),r=640,s=480),t.video={width:{ideal:r},height:{ideal:s}}}else"screen"===e.type&&(t.video=e.capture);return t},l.noop=function(){},l.dataChanDefaultLabel="JanusDataChannel",l.endOfCandidates=null,l.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)l.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},l.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:l.noop,l.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),l.trace=l.noop,l.debug=l.noop,l.vdebug=l.noop,l.log=l.noop,l.warn=l.noop,l.error=l.noop,!0===e.debug||"all"===e.debug)l.trace=console.trace.bind(console),l.debug=console.debug.bind(console),l.vdebug=console.debug.bind(console),l.log=console.log.bind(console),l.warn=console.warn.bind(console),l.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":l.trace=console.trace.bind(console);break;case"debug":l.debug=console.debug.bind(console);break;case"vdebug":l.vdebug=console.debug.bind(console);break;case"log":l.log=console.log.bind(console);break;case"warn":l.warn=console.warn.bind(console);break;case"error":l.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}l.log("Initializing library");let r=e.dependencies||l.useDefaultDependencies();if(l.isArray=r.isArray,l.webRTCAdapter=r.webRTCAdapter,l.httpAPICall=r.httpAPICall,l.newWebSocket=r.newWebSocket,l.extension=r.extension,l.extension.init(),l.listDevices=function(e,r){e="function"==typeof e?e:l.noop,r||(r={audio:!0,video:!0}),l.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(r).then(function(r){t.mediaDevices.enumerateDevices().then(function(t){l.debug(t),e(t),l.stopAllTracks(r)})}).catch(function(t){l.error(t),e([])}):(l.warn("navigator.mediaDevices unavailable"),e([]))},l.safariVp8=!1,"safari"===l.webRTCAdapter.browserDetails.browser&&l.webRTCAdapter.browserDetails.version>=605)if(a&&a.getCapabilities&&a.getCapabilities("video")&&a.getCapabilities("video").codecs&&a.getCapabilities("video").codecs.length){for(let e of a.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){l.safariVp8=!0;break}l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new n({});e.createOffer({offerToReceiveVideo:!0}).then(function(t){l.safariVp8=-1!==t.sdp.indexOf("VP8"),l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null})}l.initDone=!0,e.callback()}},l.isWebrtcSupported=function(){return!!n},l.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},l.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let s=0;s<e;s++){let e=Math.floor(62*Math.random());r+=t.charAt(e)}return r},De=l}(),Re=Ie(Oe);class Pe{constructor(e){if(this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentRoomId=null,this.currentUserId=null,this.remoteFeeds={},this.remoteJseps={},this.remoteFeedsAttachingInProgress={},this.bitrateTimers={},this.emitter=new p,!he.env.isReactNative&&!P)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=ue.conference.server,this.debug=ue.conference.debug??B.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}createSession({success:e=()=>{},error:t=()=>{},destroyed:r=()=>{},timeoutSessionCallback:s=()=>{}}){Re.init({debug:this.debug,callback:()=>{Re.isWebrtcSupported()?this.engine=new Re({server:this.server,iceServers:ue.videochat.iceServers,token:this.token,success:()=>he.safeCallbackCall(e)(),error:e=>he.safeCallbackCall(t)(e),destroyed:()=>he.safeCallbackCall(r)(),timeoutSessionCallback:()=>he.safeCallbackCall(s)()}):he.safeCallbackCall(t)("Your browser does not support WebRTC, so you can't use this functionality.")}})}getSessionId(){return this.engine?.getSessionId()??null}destroySession({success:e=()=>{},error:t=()=>{}}){this.engine.destroy({success:()=>he.safeCallbackCall(e)(),error:e=>he.safeCallbackCall(t)(e)})}attachVideoConferencingPlugin(e,t,r,s){let n=null;const i=s.localStream;delete s.localStream;const a=s.displayName;delete s.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:r=>{if(e){n=r,n.userId=t,this.remoteFeedsAttachingInProgress[t]=n;const e={request:"join",room:this.currentRoomId,ptype:"listener",feed:t,display:a};n?.send({message:e})}else this.videoRoomPlugin=r;he.safeCallbackCall(s.success)()},error:e=>{he.safeCallbackCall(s.error)(e)},consentDialog:e=>{he.safeCallbackCall(s.consentDialog)(e)},mediaState:(e,t)=>{he.safeCallbackCall(s.mediaState)(e,t)},webrtcState:e=>{he.safeCallbackCall(s.webrtcState)(e)},slowLink:(e,t)=>{he.safeCallbackCall(s.slowLink)(e,t)},iceState:e=>{he.safeCallbackCall(s.iceState)(e)},onmessage:(t,n)=>{const a=t.videoroom;if(e){if(a)if("attached"===a){const e=t.id;this.remoteFeeds[e]=this.remoteFeedsAttachingInProgress[e],this.remoteFeedsAttachingInProgress[e]=null}else t.error&&he.safeCallbackCall(s.error)(t.error);if(n){const e=t.id;this.remoteJseps[e]=n,this.createAnswer({remoteFeed:this.remoteFeeds[e],jsep:n},i,{success:()=>{},error:e=>{he.safeCallbackCall(s.error)(e)}})}}else{if(a)if("joined"===a){const e={media:r?{audio:!1,video:!1}:{audio:!0,video:!0},stream:r?void 0:i};this.createOffer(e,{success:()=>{if(t.publishers){const e=t.publishers;for(const t in e){const r=e[t].id,s=e[t].display;this.emitter.emit(Z.PARTICIPANT_JOINED,r,s,!0)}}},error:e=>{he.safeCallbackCall(s.error)(e)}})}else if("event"===a)if(t.publishers){const e=t.publishers;for(const t in e){const r=e[t].id,s=e[t].display;this.emitter.emit(Z.PARTICIPANT_JOINED,r,s,!1)}}else if(t.leaving){const e=t.leaving;this.detachRemoteFeed(e)&&this.emitter.emit(Z.PARTICIPANT_LEFT,e,null)}else if(t.unpublished){const e=t.unpublished;if("ok"!=e){this.detachRemoteFeed(e)&&this.emitter.emit(Z.PARTICIPANT_LEFT,e,null)}}else t.error&&(he.DLog("[janus error message]",t.error),this.emitter.emit(Z.ERROR,t),he.safeCallbackCall(s.error)(t.error));n&&this.videoRoomPlugin.handleRemoteJsep({jsep:n})}},onlocaltrack:(e,t)=>{he.DLog("[onlocaltrack]",e,t),this.onLocalTrack(e,t)},onremotetrack:(e,t,r,s)=>{he.DLog("[onremotetrack]",e,t,r,s),this.onRemoteTrack(n,e,t,r,s)},ondataopen:e=>{he.DLog("[ondataopen]",e),this.emitter.emit(Z.DATA_CHANNEL_OPEN,e)},ondata:(e,t)=>{he.DLog("[ondata]",t,e),this.emitter.emit(Z.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:()=>{he.safeCallbackCall(s.oncleanup)()},detached:()=>{}})}onLocalTrack(e,t){}onRemoteTrack(e,t,r,s,n){const i=n&&n.reason;if(i===te.CREATED){const s=!e.stream||!e.tracks;s?(e.tracks={[r]:t},e.stream=new w([t])):(e.tracks[r]=t,e.stream.addTrack(t)),s&&this.emitter.emit(Z.REMOTE_STREAM,e.userId,e.stream)}else if(i===te.ENDED){delete e.tracks[r];const s=e.stream.getTracks().find(e=>e.kind===t.kind);e.stream.removeTrack(s)}this.emitter.emit(Z.REMOTE_TRACKS_UPDATED,e.userId,t,i)}getPluginId(){return this.videoRoomPlugin?.getId()??null}detachVideoConferencingPlugin(e){const t=()=>{this.videoRoomPlugin=null,Object.keys(this.remoteFeeds).forEach(e=>{this.detachRemoteFeed(Number(e))}),this.remoteFeeds={},this.remoteJseps={}};this.videoRoomPlugin.detach({success:()=>{t(),he.safeCallbackCall(e.success)()},error:r=>{t(),he.safeCallbackCall(e.error)(r)}})}join(e,t,r,s){const n=s.displayName;delete s.displayName,this.isOnlyAudio=r,he.DLog("isOnlyAudio: "+this.isOnlyAudio);const i={request:"join",room:e,ptype:"publisher",id:t,display:n};this.videoRoomPlugin.send({message:i,success:r=>{this.currentRoomId=e,this.currentUserId=t,he.safeCallbackCall(s.success)()},error:e=>{he.safeCallbackCall(s.error)(e)}})}leave(e){if(he.DLog("leave"),!this.engine.isConnected())return void he.safeCallbackCall(e.success)();const t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,he.safeCallbackCall(e.success)()}listOnlineParticipants(e,t){const r={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:r,success:e=>{const r=e?e.participants:[];he.safeCallbackCall(t.success)(r)},error:e=>{he.safeCallbackCall(t.error)(e)}})}toggleAudioMute(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()}isAudioMuted(){return this.videoRoomPlugin.isAudioMuted()}toggleRemoteAudioMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getAudioTracks();if(r&&r.length>0){for(let e=0;e<r.length;++e)r[e].enabled=!r[e].enabled;return!r[0].enabled}return!1}isRemoteAudioMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getAudioTracks();return!!(r&&r.length>0)&&!r[0].enabled}toggleVideoMute(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()}isVideoMuted(){return this.videoRoomPlugin.isVideoMuted()}toggleRemoteVideoMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getVideoTracks();if(r&&r.length>0){for(let e=0;e<r.length;++e)r[e].enabled=!r[e].enabled;return!r[0].enabled}return!1}isRemoteVideoMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const r=t.stream.getVideoTracks();return!!(r&&r.length>0)&&!r[0].enabled}sendKeyframeRequest(e,t){const r={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:r,success:e=>{he.safeCallbackCall(t.success)(e)},error:e=>{he.safeCallbackCall(t.error)(e)}})}getTracksFromStream(e){const t=[],r=e.getAudioTracks();if(r.length){const e=r[0];t.push({type:"audio",capture:e,recv:!1})}const s=e.getVideoTracks();if(s.length){const e=s[0];t.push({type:"video",capture:e,recv:!1})}return t}createOffer(e,t){he.DLog("[JanusWrapper][createOffer]",e);const{stream:r,media:s,replace:n}=e,i={tracks:[{type:"data"}]};if(r){const e=this.getTracksFromStream(r);i.tracks=i.tracks.concat(e)}else if(s){const e=[];s.audio&&e.push({type:"audio",capture:s.audio,recv:!1,replace:!!n}),s.video&&e.push({type:"video",capture:s.video,recv:!1,replace:!!n}),i.tracks=i.tracks.concat(e)}else i.tracks=i.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!n},{type:"video",capture:!0,recv:!1,replace:!!n}]);he.DLog("[JanusWrapper][createOffer][params]",i),i.customizeSdp=e=>{},i.success=e=>{const r={request:"configure",audio:!!s.audio,video:!!s.video};he.DLog("[JanusWrapper][createOffer][success]",r),this.videoRoomPlugin.send({message:r,jsep:e}),he.safeCallbackCall(t.success)()},i.error=e=>{he.DLog("[JanusWrapper][createOffer][error]",e),s.audio?this.createOffer({media:{video:!1,audio:!1}},t):he.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(i)}getTracksMidsFromStream(e){const t=[],r=e.getAudioTracks();if(r.length){const e=r[0];t.push({type:"audio",mid:e.id,recv:!0})}const s=e.getVideoTracks();if(s.length){const e=s[0];t.push({type:"video",mid:e.id,recv:!0})}return t}createAnswer({remoteFeed:e,jsep:t},r,s){he.DLog("[JanusWrapper][createAnswer]",t,r);let n=[{type:"data"}];if(r){const e=this.getTracksMidsFromStream(r);n=n.concat(e)}he.DLog("[JanusWrapper][createAnswer][tracks]",n),e.createAnswer({jsep:t,tracks:n,success:t=>{const r={request:"start",room:this.currentRoomId};he.DLog("[JanusWrapper][createAnswer][success]",r),e.send({message:r,jsep:t}),he.safeCallbackCall(s.success)()},error:e=>{he.DLog("[JanusWrapper][createAnswer][error]",e),he.safeCallbackCall(s.error)(e)}})}detachRemoteFeed(e){const t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)}getUserBitrate(e){return this.remoteFeeds[e].getBitrate()}getVolume(e){return this.videoRoomPlugin.getLocalVolume(null,e)}getUserVolume(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)}showBitrate(e,t){const r=this.remoteFeeds[e];he.env.isReactNative||"chrome"!==P.browserDetails.browser&&"firefox"!==P.browserDetails.browser||(this.bitrateTimers[e]=setInterval(()=>{const e=r.getBitrate();t.text(e)},1e3))}hideBitrate(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null}on(e,t){return this.emitter.addListener(e,t)}removeAllListeners(e){return this.emitter.removeAllListeners(e)}}class Le{constructor(e){this.id=`${Math.random()}`,this.mediaParams={},this.onParticipantJoined=(e,t,r)=>{he.DLog("[onParticipantJoined]",e,t,r),this.createHandler(e,!0,!1),he.safeCallbackCall(this.onParticipantJoinedListener)(this,e,t,r)},this.onParticipantLeft=(e,t)=>{he.DLog("[onParticipantLeft]",e,t),he.safeCallbackCall(this.onParticipantLeftListener)(this,e,t)},this.onError=e=>{he.DLog("[onError]",JSON.stringify(e)),he.safeCallbackCall(this.onErrorListener)(this,e)},this.onDataChannelOpen=e=>{he.DLog("[onDataChannelOpen]",e),he.safeCallbackCall(this.onDataChannelOpenedListener)(this,e)},this.onDataChannelMessage=(e,t)=>{he.DLog("[onDataChannelMessage]",e,t),he.safeCallbackCall(this.onDataChannelMessageListener)(this,e,t)},this.onLocalIceStateChanged=e=>{he.DLog("[onLocalIceStateChanged]",e),he.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e)},this.onRemoteIceStateChanged=(e,t)=>{he.DLog("[onRemoteIceStateChanged]",e,t),he.safeCallbackCall(this.onRemoteConnectionStateChangedListener)(this,e,t)},this.onRemoteStream=(e,t)=>{he.DLog("[onRemoteStream]",e,t),he.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)},this.onRemoteTracksUpdated=(e,t,r)=>{he.DLog("[onRemoteTracksUpdated]",e,t,r),he.safeCallbackCall(this.onRemoteTracksUpdatedListener)(this,e,t,r)},this.onSlowLink=(e,t,r)=>{he.DLog("[onSlowLink]",e,t,r),he.safeCallbackCall(this.onSlowLinkListener)(this,e,t,r)},this.client=new Pe(e),this.client.on(Z.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(Z.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(Z.REMOTE_STREAM,this.onRemoteStream),this.client.on(Z.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(Z.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(Z.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(Z.ERROR,this.onError)}get currentRoomId(){return this.client.currentRoomId}set currentRoomId(e){this.client.currentRoomId=e}get currentPublisherPC(){return this.client.videoRoomPlugin.webrtcStuff.pc}async createSession(){let e=!1;return new Promise((t,r)=>{this.client.createSession({success:()=>{e=!0,t(void 0)},error:t=>{e?this.onError(t):r(t)}})})}async join(e,t,r){this.currentUserDisplayName=r,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!1),await this.joinInternal(this.currentRoomId,t)}async joinAsListener(e,t,r){this.currentUserDisplayName=r,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!0),await this.joinInternal(this.currentRoomId,t)}async sendKeyframeRequest(e){return new Promise((t,r)=>{this.client.sendKeyframeRequest(e,{success:t,error:r})})}async createHandler(e,t,r=!1){return new Promise((s,n)=>{this.client.attachVideoConferencingPlugin(t,e,r,{success:s,error:n,iceState:t?t=>this.onRemoteIceStateChanged(e,t):e=>this.onLocalIceStateChanged(e),slowLink:t?(t,r)=>this.onSlowLink(e,t,r):(e,t)=>this.onSlowLink(null,e,t),localStream:this.localStream,displayName:this.currentUserDisplayName})})}async joinInternal(e,t){return new Promise((r,s)=>{this.client.join(e,t,!1,{success:r,error:s,displayName:this.currentUserDisplayName})})}async listOfOnlineParticipants(){return new Promise((e,t)=>{this.currentRoomId?this.client.listOnlineParticipants(this.currentRoomId,{success:e,error:t}):t("Room ID is not set")})}async leave(){this.currentRoomId=null,this.currentUserDisplayName=void 0,await this.leaveGroup(),await this.detachVideoConferencingPlugin(),await this.destroy(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}async leaveGroup(){return new Promise((e,t)=>{this.client.leave({success:e,error:t})})}async destroy(){return new Promise((e,t)=>{this.client.destroySession({success:e,error:t})})}async detachVideoConferencingPlugin(){return new Promise((e,t)=>{this.client.detachVideoConferencingPlugin({success:e,error:t})})}async getDisplayMedia(e){if(!T.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,r=e&&e.options,s={...e};this.mediaParams=s,delete s.elementId,delete s.options;try{const e=await T.getDisplayMedia(s);return this.upsertStream(e,t,r)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,r=e&&e.options,s={...e};this.mediaParams=s,delete s.elementId,delete s.options;try{const e=await T.getUserMedia(s);return this.upsertStream(e,t,r)}catch(e){throw e}}upsertStream(e,t=null,r={}){const s=!!this.localStream;if(s?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(s&&this.detachMediaStream(t,r),this.attachMediaStream(t,this.localStream,r)),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===ee.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{const t=this.currentPublisherPC.getSenders().find(({track:t})=>e.kind===t.kind);e.kind===ee.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,t?(t.replaceTrack(e),this.localStream?.addTrack(e)):console.warn(`No sender found for track kind: ${e.kind}`)}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async switchMediaTracks(e){[ee.AUDIO,ee.VIDEO].forEach(t=>{const r=t===ee.AUDIO?e.audio:t===ee.VIDEO?e.video:{},s="string"==typeof r?r:r?.deviceId??null;s&&("object"==typeof this.mediaParams[t]?this.mediaParams[t].deviceId=s:this.mediaParams[t]={deviceId:s})});try{const e={audio:this.mediaParams?.audio??!1,video:this.mediaParams?.video??!1},t=await T.getDisplayMedia(e);return this.replaceTracks(t)}catch(e){throw e}}muteVideo(){this.isVideoMuted()||this.client.toggleVideoMute()}unmuteVideo(){this.isVideoMuted()&&this.client.toggleVideoMute()}muteAudio(){this.isAudioMuted()||this.client.toggleAudioMute()}unmuteAudio(){this.isAudioMuted()&&this.client.toggleAudioMute()}isVideoMuted(){return this.client.isVideoMuted()}isAudioMuted(){return this.client.isAudioMuted()}async getUserVolume(){return new Promise((e,t)=>this.client.getVolume(e))}getRemoteUserBitrate(e){return this.client.getUserBitrate(e)}async getRemoteUserVolume(e){return new Promise((t,r)=>this.client.getUserVolume(e,t))}attachMediaStream(e,t,r){const s=document.getElementById(e);if(!("srcObject"in s))throw new Error(`Unable to attach media stream, element #${e} is undefined`);s.srcObject=t,s.style.transform=r?.mirror?"scaleX(-1)":"none","boolean"==typeof r?.muted&&(s.muted=r?.muted),s.onloadedmetadata=e=>{s.play()}}detachMediaStream(e,t){const r=document.getElementById(e);if(!("srcObject"in r))throw new Error(`Unable to attach media stream, element #${e} is undefined`);r.pause(),r.srcObject=null,r.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(r.muted=t?.muted)}async sendData(e,t){return new Promise((r,s)=>{this.client.videoRoomPlugin.data({data:e,label:t,success:r,error:s})})}}class Ne{constructor(e){this.DeviceInputType=Y,this.JanusCallType=ee,this.sessionsStore={},this.proxy=e}createNewSession(){const e=new Le(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e}async getMediaDevices(e){if(T?.enumerateDevices){const t=await T.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}clearSession(e){delete this.sessionsStore[e]}getCurrentSessionToken(){const e=this.proxy.getSession();if(e?.token)return e.token;throw new Error("Session does not exist")}getListenerByName(e){switch(e){case re.JOIN:return"onParticipantJoinedListener";case re.LEFT:return"onParticipantLeftListener";case re.SLOW_LINK:return"onSlowLinkListener";case re.REMOTE_STREAM:return"onRemoteStreamListener";case re.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case re.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case re.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case re.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case re.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case re.ERROR:return"onErrorListener";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}class je{constructor(e){this.route=ue.urls.data,this.proxy=e}async create(e,t={}){const r=he.isArray(t),s=r?"multi":void 0,n={type:ie.POST,url:he.getUrl(this.route,e,s),data:r?{record:this.createRecord(t)}:t};return this.proxy.ajax(n)}async list(e,t={}){const r="string"==typeof t?t:he.isArray(t)?t.toString():void 0,s={url:he.getUrl(this.route,e,r),data:r?void 0:t};return this.proxy.ajax(s)}async readPermissions(e,t){const r={url:he.getUrl(this.route,e,t),data:{permissions:1}};return this.proxy.ajax(r)}async update(e,t={}){const r=he.isArray(t),s=!r&&t.search_criteria,n=r?"multi":s?"by_criteria":t.id||t._id,i={type:ie.PUT,url:he.getUrl(this.route,e,n),data:r?{record:this.createRecord(t)}:t};return this.proxy.ajax(i)}async delete(e,t){const r=he.isObject(t),s="string"==typeof t||he.isArray(t)&&1===t.length,n=r?"by_criteria":t.toString(),i={type:ie.DELETE,url:he.getUrl(this.route,e,n),data:r?t:void 0,dataType:s?ae.TEXT:void 0};return this.proxy.ajax(i)}createRecord(e=[]){return e.reduce((e,t,r)=>{const s=r+1,n=t.id||t._id,i=n?{...t,id:n}:t;return{...e,[s]:i}},{})}}class Me{constructor(e){this.route=ue.urls.meetings,this.proxy=e}async get(e={}){const t={type:ie.GET,url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t=Math.ceil(Date.now()/1e3),r=t+3600,s={name:new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),start_date:t,end_date:r,attendees:[],record:!1,chat:!1},n={type:ie.POST,url:he.getUrl(this.route),data:{...s,...e}};return this.proxy.ajax(n)}async update(e,t){const r={type:ie.PUT,url:he.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e){const t={type:ie.DELETE,url:he.getUrl(this.route,e),dataType:ae.TEXT};return this.proxy.ajax(t)}async getRecordings(e){const t={type:ie.GET,url:he.getUrl(this.route,"recordings",e)};return this.proxy.ajax(t)}}class Ue{constructor(){this.sdkInstance={config:ue,session:null},this.requestsNumber=0,this.fetchImpl=S,this.abortControllersMap={},this.requestMethod=ie,this.responseType=ae}setSession(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)}getSession(){return this.sdkInstance.session}setCurrentUserId(e){this.currentUserId=e||void 0}getCurrentUserId(){return this.currentUserId}logRequest(e,t){he.DLog(`[Request][${t}]`,`${e.type||"GET"} ${e.url}`,e)}logResponse(e,t){he.DLog(`[Response][${t}]`,e)}buildRequestAndURL(e){const t=!e.type||"GET"===e.type||"HEAD"===e.type,r=!!e.type&&("POST"===e.type||"PUT"===e.type),s=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,n=-1===e.url.indexOf("s3.amazonaws.com"),i=!1===e.contentType,a=e.authKey;let o,c=e.url;const l={};return l.method=e.type||"GET",e.data&&(o=this.buildRequestBody(e,i,r),t?c+=`?${o}`:l.body=o),i||(l.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),n&&(l.headers||(l.headers={}),l.headers["CB-SDK"]=`JS ${ue.version} - Client`,s?l.headers["CB-Token"]=s:a&&(l.headers["CB-AuthKey"]=a)),ue.timeout&&(l.timeout=ue.timeout),[l,c]}buildRequestBody(e,t,r){const s=e.data,n=e.useArrayQuery;let i;return t?(i=new v,Object.keys(s).forEach(function(t){e.fileToCustomObject&&"file"===t?i.append(t,s[t].data,s[t].name):i.append(t,e.data[t])})):i=r?JSON.stringify(s):this.serializeQueryParams(s,"",n,0),i}serializeQueryParams(e,t,r,s=0){const n=[];for(let i in e){let a=this.encodeURIComponent(i);he.isArray(e)&&(a="");const o=t?t+`[${a}]`:a;let c=e[i];const l=he.isArray(c);l&&(r||0===s)||he.isObject(c)?n.push(this.serializeQueryParams(c,o,r,++s)):(c=l?c.sort().join(","):c,n.push(`${o}=${this.encodeURIComponent(c)}`))}return n.sort().join("&")}encodeURIComponent(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,e=>`%${e.charCodeAt(0).toString(16)}`)}abortRequest(e){if(this.abortControllersMap[e]){(this.abortControllersMap[e].controllers||[]).forEach(e=>{e.abort()})}}processSuccessfulOrFailedRequest(e){if(!e||!this.abortControllersMap[e])return;const t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1;this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}async ajax(e){const t=++this.requestsNumber;return new Promise((r,s)=>{this.logRequest(e,t);const[n,i]=this.buildRequestAndURL(e),a=e.abort_id;if(a){let e=0;if(this.abortControllersMap[a]){const t=this.abortControllersMap[a].controllers||[];this.abortControllersMap[a].controllers.push(new AbortController),e=t.length-1}else this.abortControllersMap[a]={controllers:[new AbortController]};const t=this.abortControllersMap[a].controllers[e].signal;Object.assign(n,{signal:t})}let o;S(i,n).then(t=>{o=t;return(e.dataType||ae.JSON)===ae.TEXT?o.text():o.json()}).then(n=>{this.processSuccessfulOrFailedRequest(a),o.ok?this.processAjaxResponse(n,r,t):this.processAjaxError(o,n,null,s,r,e,t)}).catch(n=>{this.processSuccessfulOrFailedRequest(a),this.processAjaxError(o," ",n,s,r,e,t)})})}processAjaxResponse(e,t,r){const s=e&&" "!==e?e:"empty body";this.logResponse(s,r),t(e)}processAjaxError(e,t,r,s,n,i,a){if(!e&&r&&!r.code)return void s(r);const o=t||r||t.errors,c=e?.status,l={code:e&&c||r&&r.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||r&&r.errno};this.logResponse(o,a),-1===e?.url.indexOf(ue.urls.session)&&this.isExpiredSessionError(l)&&"function"==typeof ue.on.sessionExpired?this.handleExpiredSessionResponse(l,null,s,n,i):s(l)}handleExpiredSessionResponse(e,t,r,s,n){const i=()=>{e?r(e):s(t)},a=e=>{e&&(this.setSession(e),this.ajax(n).then(s).catch(r))};"function"==typeof ue.on.sessionExpired&&ue.on.sessionExpired(i,a)}isExpiredSessionError(e){try{return e&&401===e.code&&"Required session does not exist"===e.info?.errors?.base?.[0]}catch{return!1}}}class _e{constructor(e){this.base64Encode=m,this.proxy=e,this.subscriptions=new Je(e),this.events=new Ve(e)}}class Je{constructor(e){this.route=ue.urls.subscriptions,this.proxy=e}async create(e){const t={type:ie.POST,url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async list(){const e={type:ie.GET,url:he.getUrl(this.route)};return this.proxy.ajax(e)}async delete(e){const t={type:ie.DELETE,dataType:ae.TEXT,url:he.getUrl(this.route,e)};return this.proxy.ajax(t)}}class Ve{constructor(e){this.route=ue.urls.events,this.proxy=e}async create(e){const t={type:ie.POST,url:he.getUrl(this.route),data:{event:e}};return this.proxy.ajax(t)}}class $e{constructor(e){this.route=ue.urls.blobs,this.proxy=e}async list(e={}){const t={type:ie.GET,url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t={type:ie.POST,url:he.getUrl(this.route),data:{blob:e}};return this.proxy.ajax(t)}async delete(e){const t={type:ie.DELETE,url:he.getUrl(this.route,e),dataType:ae.TEXT};return this.proxy.ajax(t)}async createAndUpload(e){const{name:t,file:r,size:s,abort_id:n,type:i,public:a=!0}=e,o={name:t,content_type:i,public:a};let c;return this.create(o).then(({blob:e})=>{c=e;const t=this.parseUri(c.blob_object_access?.params),s={url:`${t.protocol}://${t.authority}${t.path}`,data:{}};return n&&(s.abort_id=n),Object.keys(t.queryKey).forEach(e=>{s.data[e]=decodeURIComponent(t.queryKey[e])}),s.data.file=r,this.upload(s).then(()=>c)}).then(e=>this.markUploaded({id:e.id,size:s}).then(()=>e)).then(e=>({...e,size:s}))}async upload(e){const t={...e,type:ie.POST,dataType:ae.TEXT,contentType:!1};return this.proxy.ajax(t)}async markUploaded(e){const t={type:ie.PUT,url:he.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:ae.TEXT};return this.proxy.ajax(t)}async getInfo(e){const t={url:he.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFile(e){const t={url:he.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFileObject(e,t){const r={type:ie.GET,url:he.getUrl(this.route,e,"object"),data:t};return this.proxy.ajax(r)}async update(e){const t={blob:{}};void 0!==e.name&&(t.blob.name=e.name);const r={url:he.getUrl(this.route,e.id),data:t};return this.proxy.ajax(r)}privateUrl(e=""){return`https://${ue.endpoints.api}/blobs/${e}?token=${this.proxy.getSession()?.token}`}publicUrl(e=""){return`https://${ue.endpoints.api}/blobs/${e}`}parseUri(e=""){const t={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},r=t.parser.loose.exec(e)??{},s={};let n=14;for(;n--;)s[t.key[n]]=r[n]||"";return s[t.q.name]={},s[t.key[12]].replace(t.q.parser,(e,r,n)=>{r&&(s[t.q.name][r]=n)}),s}}class Fe{constructor(e){this.route=ue.urls.users,this.proxy=e}async getV2(e){const t={type:ie.GET,url:he.getUrl(this.route,"v2"),useArrayQuery:!0,data:e};return this.proxy.ajax(t)}async signup(e,t){const r={authKey:t??ue.creds.authKey,type:ie.POST,url:he.getUrl(this.route),data:{user:e}};return this.proxy.ajax(r)}async update(e={}){const t={type:ie.PUT,url:he.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}};return this.proxy.ajax(t)}async delete(){const e={type:ie.DELETE,url:he.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:ae.TEXT};return this.proxy.ajax(e)}async resetPassword(e=""){const t={type:ie.POST,url:he.getUrl(this.route,"password","reset"),data:{email:e},dataType:ae.TEXT};return this.proxy.ajax(t)}async listOnline(e={}){const t={type:ie.GET,url:he.getUrl(this.route,"online"),data:e};return this.proxy.ajax(t)}async getOnlineCount(){const e={type:ie.GET,url:he.getUrl(this.route,"online"),data:{count:!0}};return this.proxy.ajax(e)}async get(e){let t=he.cloneObject(e),r="";const s=[],n=["created_at","updated_at","last_request_at"],i=["id","external_user_id"],a={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"};function o(e){const t=he.cloneObject(e);let r=n.includes(t.field)?"date":typeof t.value;return he.isArray(t.value)&&("object"===r&&(r=typeof t.value[0]),t.value=t.value.toString()),[r,t.field,t.param,t.value].join(" ")}if(t.order){const e=t.order.field in n?"date":t.order.field in i?"number":"string";t.order=[t.order.sort,e,t.order.field].join(" ")}if(t&&t.filter&&(he.isArray(t.filter)?t.filter.forEach(e=>{s.push(o(e))}):s.push(o(t.filter)),t.filter=s),"number"==typeof t)r=t,t=void 0;else for(const e in a)if(t[e]){r=a[e],e===a.external&&(r+=`/${t[a.external]}`,t=void 0);break}const c={type:ie.GET,url:he.getUrl(this.route,r),data:t};return this.proxy.ajax(c)}}class We{static getUserJid(e){return`${e}-${ue.creds.appId}@${ue.endpoints.chat}`}static getUserIdFromJID(e){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}static trace(e){ue.debug&&console.log("[VideoChat]:",e)}static traceWarning(e){ue.debug&&console.warn("[VideoChat]:",e)}static traceError(e){ue.debug&&console.error("[VideoChat]:",e)}static get getVersionFirefox(){const e=E?.userAgent??null;let t=0;if(e){const r=e.match(/(?:firefox)[ \/](\d+)/i)||[];t=r[1]?+r[1]:0}return"string"==typeof t?parseInt(t):t}static get getVersionSafari(){const e=E?.userAgent??null;let t=0;if(e){if((e.match(/(?:safari)[ \/](\d+)/i)||[]).length){const r=e.match(/(?:version)[ \/](\d+)/i)||[];r&&(t=r[1]?+r[1]:0)}}return"string"==typeof t?parseInt(t):t}}class qe{constructor(e,t,r){this.remoteSDP=null,this.state=$.NEW,this.iceCandidates=[],this.remoteStream=new w,this.answerTimeInterval=0,this.onStatusClosedChecker=null,this.dialingTimer=null,this.statsReportTimer=null,this.waitingReconnectTimeoutCallback=null,this.released=!1,this.onMediaTrackHandler=e=>{this.remoteStream.addTrack(e.track),(this.session.callType==J.VIDEO&&this.remoteStream.getVideoTracks().length||this.session.callType==J.AUDIO&&this.remoteStream.getAudioTracks().length)&&this.session.onRemoteStream(this.userID,this.remoteStream),this.getWrappedStats()},this.onIceCandidateHandler=e=>{if(e.candidate){const{sdpMLineIndex:t,sdpMid:r,candidate:s}=e.candidate,n={sdpMLineIndex:t,sdpMid:r,candidate:s};"stable"===this.signalingState&&this.original.canTrickleIceCandidates?this.session.processIceCandidates(this.userID,[n]):this.iceCandidates.push(n)}},this.onSignalingStateHandler=async()=>{We.trace(`onSignalingStateHandler: ${this.signalingState}`),"stable"===this.signalingState&&this.iceCandidates.length>0&&(this.session.processIceCandidates(this.userID,this.iceCandidates),this.iceCandidates.length=0)},this.onIceConnectionStateHandler=()=>{switch(We.trace(`onIceConnectionStateHandler: ${this.iceConnectionState}`),this.onStatusClosedChecker&&We.getVersionSafari>=11&&clearTimeout(this.onStatusClosedChecker),this.iceConnectionState){case"checking":this.state=$.CHECKING,this.session.onSessionConnectionStateChanged(this.userID,U.CONNECTING);break;case"connected":this.state=$.CONNECTED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,U.CONNECTED);break;case"completed":this.state=$.COMPLETED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,U.COMPLETED);break;case"failed":this.state=$.FAILED,this.session.onSessionConnectionStateChanged(this.userID,U.FAILED);break;case"disconnected":this.state=$.DISCONNECTED,this.startWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,U.DISCONNECTED),We.getVersionSafari>=11&&(this.onStatusClosedChecker=setTimeout(()=>{this.onIceConnectionStateHandler()},500));break;case"closed":this.state=$.CLOSED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,U.CLOSED)}},this.create(),this.setup(e,t,r)}create(){const e={iceTransportPolicy:ue.videochat.alwaysRelayCalls?"relay":"all",iceServers:ue.videochat.iceServers.map(e=>({urls:e.urls??e.url,username:e.username,credential:e.credential}))};this.original=D?new D(e):{},We.trace(`new RTCPeerConnection(${JSON.stringify(e,null,2)})`)}setup(e,t,r){this.type=r,this.userID=t,this.session=e,this.session.startCallTime=Date.now(),this.original.addEventListener("track",this.onMediaTrackHandler),this.original.addEventListener("icecandidate",this.onIceCandidateHandler),this.original.addEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.addEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),We.trace(`RTCPeerConnection init. ${this.toString()}`)}clearWaitingReconnectTimer(){this.waitingReconnectTimeoutCallback&&(We.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)}startWaitingReconnectTimer(){const e=1e3*ue.videochat.disconnectTimeInterval;We.trace(`startWaitingReconnectTimer, timeout: ${e}`),this.waitingReconnectTimeoutCallback=setTimeout(()=>{We.trace("waitingReconnectTimeoutCallback"),this.waitingReconnectTimeoutCallback&&clearTimeout(this.waitingReconnectTimeoutCallback),this.release(),this.session.closeSessionIfAllConnectionsClosed()},e)}clearStatsReportTimer(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)}async addCandidates(e){for(const t of e)if(t?.candidate)try{await this.addIceCandidate(t),We.trace(`'addIceCandidate' success: ${this.signalingState}`)}catch(e){We.traceError(`'addIceCandidate' error: ${e}`)}}release(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),We.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.original.removeEventListener("track",this.onMediaTrackHandler),this.original.removeEventListener("icecandidate",this.onIceCandidateHandler),this.original.removeEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),this.released=!0,We.trace(`RTCPeerConnection closed. ${this.toString()}`)}clearDialingTimer(){this.dialingTimer&&(We.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)}async getAndSetLocalSessionDescription(e,t=!1){this.state=$.CONNECTING;try{const r=t?{iceRestart:t}:void 0,s="offer"===this.type?await this.createOffer(r):await this.createAnswer();return await this.setLocalDescription(s),this.setRTCRtpSenderMaxBandwidth(e),s}catch(e){throw e}}setRTCRtpSenderMaxBandwidth(e){const t=this.getSenders()||[],r=e?Math.round(1e3*e):0;t.forEach(t=>{if(t.track?.kind===se.VIDEO){const s=t.getParameters();s.encodings??(s.encodings=[{}]),s.encodings.forEach(e=>{r>0?e.maxBitrate=r:delete e.maxBitrate}),t.setParameters(s).then(()=>{We.trace(`Set 'maxBandwidth' for ${this.userID}: ${e>0?`${e} kbps`:"unlimited"}`)}).catch(e=>{We.traceWarning(`Set 'maxBandwidth' for ${this.userID}: ${e}`)})}})}startDialingTimer(e,t){const r=1e3*ue.videochat.dialingTimeInterval;We.trace(`startDialingTimer, dialingTimeInterval: ${JSON.stringify(r)}`);const s=(e,t,r)=>{r||(this.answerTimeInterval+=1e3*ue.videochat.dialingTimeInterval),We.trace(`dialingCallback, extension: ${JSON.stringify(e)}`),this.answerTimeInterval>=1e3*ue.videochat.answerTimeInterval?(this.clearDialingTimer(),t&&this.session.processOnNotAnswer(this)):this.session.processCall(this,e)};this.dialingTimer=setInterval(s,r,e,t,!1),s(e,t,!0)}async setRemoteSessionDescription(e,t){const r=new O({sdp:t,type:e});return this.setRemoteDescription(r)}getWrappedStats(){if(ue.videochat.statsReportTimeInterval){let e;We.trace("Stats tracker has been started"),this.statsReportTimer=setInterval(()=>{this.getStatsCustom(e,(t,r)=>{e=r,this.session.onCallStatsReport(this.userID,t)},e=>{We.traceError(`Get stats error. ${e.name}: ${e.message}`),this.session.onCallStatsReport(this.userID,null,e)})},1e3*ue.videochat.statsReportTimeInterval)}}set sdpRemote(e){e&&(this.remoteSDP=e)}get sdpRemote(){return this.remoteSDP}toString(){return`sessionID: ${this.session.ID}, userID: ${this.userID}, type: ${this.type}, state: ${this.state}`}getStatsCustom(e,t,r){const s={audio:{},video:{},candidate:{}},n={local:Object.assign({},s),remote:Object.assign({},s)};if(We.getVersionFirefox){const e=this.session.localStream,t=e?.getVideoTracks()[0].getSettings();t&&(n.local.video.frameHeight=t.height,n.local.video.frameWidth=t.width)}this.getStats().then(r=>{r.forEach(t=>{let r;t.bytesReceived&&"inbound-rtp"===t.type?(r=n.remote[t.mediaType],r.bitrate=this.getBitratePerSecond(t,e,!1),r.bytesReceived=t.bytesReceived,r.packetsReceived=t.packetsReceived,r.timestamp=t.timestamp,t.mediaType===se.VIDEO&&t.framerateMean&&(r.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?(r=n.local[t.mediaType],r.bitrate=this.getBitratePerSecond(t,e,!0),r.bytesSent=t.bytesSent,r.packetsSent=t.packetsSent,r.timestamp=t.timestamp,t.mediaType===se.VIDEO&&t.framerateMean&&(r.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(r=n.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(r.protocol=t.transport,r.ip=t.ipAddress,r.port=t.portNumber):We.getVersionFirefox||(r.protocol=t.protocol,r.ip=t.ip,r.port=t.port)):"remote-candidate"===t.type?(r=n.remote.candidate,r.protocol=t.protocol||t.transport,r.ip=t.ip||t.ipAddress,r.port=t.port||t.portNumber):"track"!==t.type||t.kind!==se.VIDEO||We.getVersionFirefox||(t.remoteSource?(r=n.remote.video,r.frameHeight=t.frameHeight,r.frameWidth=t.frameWidth,r.framesPerSecond=this.getFramesPerSecond(t,e,!1)):(r=n.local.video,r.frameHeight=t.frameHeight,r.frameWidth=t.frameWidth,r.framesPerSecond=this.getFramesPerSecond(t,e,!0)))}),t(n,r)},r)}getBitratePerSecond(e,t,r){const s=t.get(e.id),n=s?(e.timestamp-s.timestamp)/1e3:5,i=s?r?8*(e.bytesSent-s.bytesSent)/(1024*n):8*(e.bytesReceived-s.bytesReceived)/(1024*n):0;return Math.round(i)}getFramesPerSecond(e,t,r){const s=t&&t.get(e.id),n=s?(e.timestamp-s.timestamp)/1e3:5,i=s?r?(e.framesSent-s.framesSent)/n:(e.framesReceived-s.framesReceived)/n:0;return Math.round(10*i)/10}close(){this.original.close?.()}addTrack(e,t){return this.original.addTrack?.(e,t)??null}getSenders(){return this.original.getSenders?.()??null}async createOffer(e){return await(this.original.createOffer?.(e))??null}async createAnswer(e){return await(this.original.createAnswer?.(e))??null}async getStats(e){return await(this.original.getStats?.(e))??null}async addIceCandidate(e){await(this.original.addIceCandidate?.(e))}async setRemoteDescription(e){await(this.original.setRemoteDescription?.(e))}async setLocalDescription(e){await(this.original.setLocalDescription?.(e))}get localDescription(){return this.original.localDescription??null}get signalingState(){return this.original.signalingState??"closed"}get iceConnectionState(){return this.original.iceConnectionState??"closed"}}class Ge{constructor(e){this.ID=null,this.state=_.NEW,this.opponentsIDs=[],this.maxBandwidth=0,this.peerConnections={},this.mediaParams={},this.answerTimer=null,this.waitingOfferOrAnswerTimer=null,this.startCallTime=0,this.acceptCallTime=0,Object.assign(this,e,{ID:e.ID??Be()})}async getDisplayMedia(e){if(!T.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,r=e&&e.options,s={...e};this.mediaParams=s,delete s.elementId,delete s.options;try{const e=await T.getDisplayMedia(s);return this.upsertStream(e,t,r)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,r=e&&e.options,s={...e};this.mediaParams=s,delete s.elementId,delete s.options;try{const e=await T.getUserMedia(s);return this.upsertStream(e,t,r)}catch(e){throw e}}upsertStream(e,t,r){const s=!!this.localStream;if(s?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(s&&this.detachMediaStream(t,r),this.attachMediaStream(t,this.localStream,r)),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===se.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{e.kind===se.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,e&&(Object.values(this.peerConnections).forEach(t=>{t.getSenders().find(({track:t})=>e.kind===t?.kind)?.replaceTrack(e)}),this.localStream?.addTrack(e))}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async setMaxBandwidth(e){const t=this.peerConnections,r=Object.keys(t);if(!(r.length<1))return Promise.all(r.map(r=>t[Number(r)].setRTCRtpSenderMaxBandwidth(e)));We.trace("No 'RTCPeerConnection' to set 'maxBandwidth'")}connectionStateForUser(e){const t=this.peerConnections[e];return t?t.state:null}attachMediaStream(e,t,r){const s=document.getElementById(e);if(!("srcObject"in s))throw new Error(`Unable to attach media stream, element #${e} is undefined`);s.srcObject=t,s.style.transform=r?.mirror?"scaleX(-1)":"none","boolean"==typeof r?.muted&&(s.muted=r?.muted),s.onloadedmetadata=e=>{s.play()}}detachMediaStream(e,t){const r=document.getElementById(e);if(!("srcObject"in r))throw new Error(`Unable to attach media stream, element #${e} is undefined`);r.pause(),r.srcObject=null,r.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(r.muted=t?.muted)}async switchMediaTracks(e={}){he.DLog("switchMediaTracks:",e),[se.AUDIO,se.VIDEO].forEach(t=>{const r=t===se.AUDIO?e.audio:t===se.VIDEO?e.video:{},s="string"==typeof r?r:r?.deviceId;s&&("object"!=typeof this.mediaParams[t]?this.mediaParams[t].deviceId=s:this.mediaParams[t]={deviceId:s})});try{const e={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},t=await T.getUserMedia(e);return this.replaceTracks(t)}catch(e){throw e}}call(e={}){const t=ze(e);We.trace(`Call, extension: ${JSON.stringify(t)}`),this.state=_.ACTIVE,this.maxBandwidth=Number(t.userInfo?.maxBandwidth??0),this.opponentsIDs.forEach(e=>{this.callInternal(e,t,!0)})}async callInternal(e,t,r){const s=new qe(this,e,"offer");this.localStream?.getTracks().forEach(e=>{s.addTrack(e,this.localStream)}),this.peerConnections[e]=s;try{await s.getAndSetLocalSessionDescription(this.maxBandwidth),We.trace("getAndSetLocalSessionDescription success"),s.startDialingTimer(t,r)}catch(e){We.traceError(`getAndSetLocalSessionDescription error: ${e}`)}}accept(e={}){const t=ze(e);if(We.trace(`Accept, extension: ${JSON.stringify(t)}`),this.state===_.ACTIVE)return void We.traceError("Can't accept, the session is already active, return");if(this.state===_.CLOSED)return We.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=_.ACTIVE,this.acceptCallTime=Date.now(),this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,t);const r=this.opponentsIDs.filter(e=>e!==this.currentUserID);r.length>0&&(this.startWaitingOfferOrAnswerTimer(),r.forEach(e=>{this.currentUserID>e&&this.callInternal(e,t,!0)}))}async acceptInternal(e,t){const r=this.peerConnections[e];if(r&&r.sdpRemote){this.localStream?.getTracks().forEach(e=>{r.addTrack(e,this.localStream)});try{await r.setRemoteSessionDescription("offer",r.sdpRemote),We.trace("setRemoteSessionDescription - success"),await r.getAndSetLocalSessionDescription(this.maxBandwidth),We.trace("getAndSetLocalSessionDescription - success");const s=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:r.localDescription.sdp});this.signalingProvider.sendMessage(e,s,M.ACCEPT)}catch(e){We.traceError(`[acceptInternal] Error: ${e}`)}}else We.traceError("Can't accept the call, there is no information about peer connection by some reason")}reject(e={}){const t=ze(e);We.trace(`Reject, extension: ${JSON.stringify(t.userInfo)}`),this.state=_.REJECTED,this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,M.REJECT)}),this.close()}stop(e={}){const t=ze(e);We.trace(`Stop, extension: ${JSON.stringify(t.userInfo)}`),this.state=_.STOPPED,this.answerTimer&&this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,M.STOP)}),this.close()}canInitiateIceRestart(e){return"offer"===this.peerConnections[e]?.type}async iceRestart(e){const t=this.peerConnections[e];if(t)try{const{sdp:r}=await t.getAndSetLocalSessionDescription(this.maxBandwidth,!0),s={sessionID:this.ID??"",sdp:r};this.signalingProvider.sendMessage(e,s,M.RESTART),We.trace("[iceRestart] OK")}catch(e){We.traceError(`[iceRestart] Error: ${e}`)}else We.traceError("Can't restart ice, there is no information about peer connection by some reason")}processOnCall(e,t){[this.initiatorID,...this.opponentsIDs.filter(e=>e!==this.currentUserID)].forEach(r=>{const s=this.peerConnections[r];if(s)r===e&&(s.sdpRemote=t.sdp,e!==this.initiatorID&&this.state===_.ACTIVE&&this.acceptInternal(e,t));else{const s=r!==e&&this.currentUserID>r?"offer":"answer",n=new qe(this,r,s);this.peerConnections[r]=n,r===e&&(n.sdpRemote=t.sdp,this.startAnswerTimer())}})}async processOnAccept(e,t){const r=this.peerConnections[e];r||We.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason");try{r.clearDialingTimer(),await r.setRemoteSessionDescription("answer",t.sdp),We.trace("'setRemoteSessionDescription' success")}catch(e){We.traceError(`'setRemoteSessionDescription' error: ${e}`)}}processOnReject(e){const t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():We.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()}processOnStop(e){if(this.clearAnswerTimer(),e===this.initiatorID){const e=Object.keys(this.peerConnections);e.length>0?e.forEach(e=>{this.peerConnections[Number(e)].release()}):We.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{const t=this.peerConnections[e];t?t.release():We.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()}async processOnIceCandidates(e,t){const r=this.peerConnections[e];r||We.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates&&await r.addCandidates(t.iceCandidates)}async processOnIceRestart(e,t){const r=this.peerConnections[e];r||We.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason');try{await r.setRemoteSessionDescription("offer",t.sdp);const{sdp:s}=await r.getAndSetLocalSessionDescription(this.maxBandwidth),n={sessionID:this.ID??"",sdp:s};this.signalingProvider.sendMessage(e,n,M.RESTART_ACCEPT),We.trace("[processOnIceRestart] Success")}catch(e){We.traceError(`[processOnIceRestart] Error: ${e}`)}}async processOnIceRestartAccept(e,t){const r=this.peerConnections[e];r||We.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason');try{await r.setRemoteSessionDescription("answer",t.sdp),We.trace("[processOnIceRestartAccept] Success")}catch(e){We.traceError(`[processOnIceRestartAccept] Error: ${e}`)}}processCall(e,t={}){const r=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,r,M.CALL)}processIceCandidates(e,t){const r={sessionID:this.ID??"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,r)}processOnNotAnswer(e){We.trace(`Answer timeout callback for session ${this.ID} for user ${e.userID}`),this.clearWaitingOfferOrAnswerTimer(),e.release(),he.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()}onRemoteStream(e,t){he.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)}onCallStatsReport(e,t,r){he.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,r)}onSessionConnectionStateChanged(e,t){he.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)}close(){Object.values(this.peerConnections).forEach(e=>{try{e.release()}catch(e){he.DLog(`Peer close error: ${e}`)}}),this.closeLocalMediaStream(),this.state=_.CLOSED,he.safeCallbackCall(this.onSessionCloseListener)(this)}closeSessionIfAllConnectionsClosed(){let e=!0;Object.values(this.peerConnections).forEach(t=>{let r=!1;try{r="closed"===t.iceConnectionState||"closed"===t.signalingState||t.released}catch(e){We.traceError(e),r=!0}e=r}),We.trace(`All peer connections closed: ${e}`),e&&(this.closeLocalMediaStream(),he.safeCallbackCall(this.onSessionCloseListener)(this),this.state=_.CLOSED)}closeLocalMediaStream(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}mute(e){this.muteStream(!1,e)}unmute(e){this.muteStream(!0,e)}muteStream(e,t=se.NONE){const r=t===se.AUDIO?this.localStream?.getAudioTracks():t===se.VIDEO?this.localStream?.getVideoTracks():[];r?.forEach(t=>{t.enabled=e})}clearAnswerTimer(){this.answerTimer&&(We.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)}startAnswerTimer(){We.trace("startAnswerTimer"),this.answerTimer=setTimeout(()=>{We.trace("answerTimeoutCallback"),this.close(),this.answerTimer=null},1e3*ue.videochat.answerTimeInterval)}clearWaitingOfferOrAnswerTimer(){this.waitingOfferOrAnswerTimer&&(We.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)}startWaitingOfferOrAnswerTimer(){const e=(this.acceptCallTime-this.startCallTime)/1e3,t=Math.min(e,ue.videochat.answerTimeInterval/2),r=Math.max(ue.videochat.answerTimeInterval-t,1);We.trace(`startWaitingOfferOrAnswerTimer, timeout: ${r}`),this.waitingOfferOrAnswerTimer=setTimeout(()=>{We.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(this.peerConnections).forEach(e=>{e.state!==$.CONNECTING&&e.state!==$.NEW||this.processOnNotAnswer(e)}),this.waitingOfferOrAnswerTimer=null},1e3*r)}toString(){return`ID: ${this.ID}, initiatorID: ${this.initiatorID}, opponentsIDs: ${this.opponentsIDs}, state: ${this.state}, callType: ${this.callType}`}}function Be(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)})}function ze(e={}){const t={userInfo:e};try{he.isObject(e)?t.userInfo=he.cloneObject(e,!0):We.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){We.traceWarning(e.message)}return t}class He{constructor(e){this.onMessage=(e,t)=>{const r=this.getExtension(t),s=r?.sessionID??"",n=r?.signalType;switch(delete r?.moduleIdentifier,delete r?.sessionID,delete r?.signalType,n){case M.CALL:this.delegate.onCallHandler(e,s,r);break;case M.ACCEPT:this.delegate.onAcceptHandler(e,s,r);break;case M.REJECT:this.delegate.onRejectHandler(e,s,r);break;case M.STOP:this.delegate.onStopHandler(e,s,r);break;case M.CANDIDATE:this.delegate.onIceCandidatesHandler(e,s,r);break;case M.RESTART:this.delegate.onIceRestartHandler(e,s,r);break;case M.RESTART_ACCEPT:this.delegate.onIceRestartAcceptHandler(e,s,r)}},this.delegate=e}getExtension(e){if(!e)return{};const t={iceCandidates:[],opponentsIDs:[]};return be.getChildElements(e).forEach(e=>{const r=be.getChildElements(e),s=be.getName(e)??"";switch(s){case"callerID":t[s]=parseInt(be.getText(e)||"0");break;case"callType":const n=be.getText(e);t[s]="1"===n?J.VIDEO:"2"===n?J.AUDIO:void 0;break;case"iceCandidates":r.forEach(e=>{const r={};be.getChildElements(e).forEach(e=>{const t=be.getName(e)||"",s=be.getText(e);r[t]="sdpMLineIndex"===t?parseInt(s||"0"):s}),t.iceCandidates?.push(r)});break;case"opponentsIDs":r.forEach(e=>{t.opponentsIDs?.push(parseInt(be.getText(e)||"0"))});break;default:r.length>1?(be.getText(e)||"").length>4096?t[s]=r.reduce((e,t)=>e+be.getText(t),""):be.assignXmlToObject(e,t):"userInfo"===s?be.assignXmlToObject(e,t):t[s]=be.getText(e)}}),0===t.iceCandidates?.length&&delete t.iceCandidates,0===t.opponentsIDs?.length&&delete t.opponentsIDs,t}}class Xe{constructor(e){this.signalingConnection=e}sendCandidate(e,t,r={}){const s=Object.assign({},r,{iceCandidates:t});this.sendMessage(e,s,M.CANDIDATE)}sendMessage(e,t,r){const s=Object.assign({},t);s.moduleIdentifier="WebRTCVideoChat",s.signalType=r,s.platform=he.env.isBrowser?"web":he.env.isReactNative||he.env.isExpo?"mobile":"node",s.userInfo&&(Object.keys(s.userInfo).length?0===s.userInfo.maxBandwidth&&delete s.userInfo.maxBandwidth:delete s.userInfo);let n=be.createMessageStanza({to:We.getUserJid(e),type:"headline",id:he.getBsonObjectId()}).c("extraParams",{xmlns:"jabber:client"});Object.keys(s).forEach(e=>{const t=s[e];"iceCandidates"===e?(n=n.c("iceCandidates"),t.forEach(e=>{n=n.c("iceCandidate"),Object.keys(e).forEach(t=>{n=n.c(t).t(e[t]).up()}),n=n.up()}),n=n.up()):"opponentsIDs"===e?(n=n.c("opponentsIDs"),t.forEach(e=>{n=n.c("opponentID").t(e).up()}),n=n.up()):"object"==typeof t?be.assignObjectToXml(n,t,e):n=n.c(e).t(t).up()}),n=n.up(),this.signalingConnection.sendOnline(n)}}class Qe{constructor(e,t){this.SessionConnectionState=U,this.PeerConnectionState=$,this.CallType=J,this.sessions={},this.onDevicesChangeListener=()=>{},this.connection=e,this.proxy=t,this.signalingProcessor=new He(this),this.signalingProvider=new Xe(e),T&&(T.ondevicechange=he.safeCallbackCall(this.onDevicesChangeListener))}get currentUserID(){const e=this.connection.jid?.toString()??"";return We.getUserIdFromJID(e)??0}async getMediaDevices(e){if(T?.enumerateDevices){const t=await T.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}createNewSession(e,t,r){const s=(r?.maxBandwidth||r?.bandwidth)??0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,this.currentUserID,e,t,s)}createAndStoreSession(e,t,r,s,n=0){const i=new Ge({ID:e,initiatorID:t,opponentsIDs:r,callType:s,signalingProvider:this.signalingProvider,currentUserID:this.currentUserID,maxBandwidth:n});return i.onUserNotAnswerListener=this.onUserNotAnswerListener,i.onRemoteStreamListener=this.onRemoteStreamListener,i.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,i.onSessionCloseListener=this.onSessionCloseListener,i.onCallStatsReportListener=this.onCallStatsReport,i?.ID&&(this.sessions[i.ID]=i),i}clearSession(e){delete this.sessions[e]}callRejectRequest(e){const t={type:ie.POST,url:he.getUrl(ue.urls.calls,"reject"),data:e};return this.proxy.ajax(t)}onCallHandler(e,t,r){const s=r.userInfo||{},n=Number(s.maxBandwidth??0);let i=this.sessions[t];We.trace(`onCall. userID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),i||(i=this.createAndStoreSession(t,r.callerID||0,r.opponentsIDs||[],r.callType||J.VIDEO,n),he.safeCallbackCall(this.onCallListener)(i,s)),i.processOnCall(e,r)}onAcceptHandler(e,t,r){const s=this.sessions[t],n=r.userInfo||{};We.trace(`onAccept. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),!s||s.state!==_.ACTIVE&&s.state!==_.NEW?We.traceWarning(`Ignore 'onAccept', there is no information about session ${t}`):(he.safeCallbackCall(this.onAcceptCallListener)(s,e,n),s.processOnAccept(e,r))}onRejectHandler(e,t,r){const s=this.sessions[t];if(We.trace(`onReject. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`),s){const t=r.userInfo||{};he.safeCallbackCall(this.onRejectCallListener)(s,e,t),s.processOnReject(e)}else We.traceWarning(`Ignore 'onReject', there is no information about session ${t}`)}onStopHandler(e,t,r){We.trace(`onStop. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(r)}`);const s=this.sessions[t],n=r.userInfo||{};!s||s.state!==_.ACTIVE&&s.state!==_.NEW?(he.safeCallbackCall(this.onInvalidEventsListener)(s,e,n),We.traceWarning(`Ignore 'onStop', there is no information about session ${t} by some reason`)):(s.processOnStop(e),he.safeCallbackCall(this.onStopCallListener)(s,e,n))}onIceCandidatesHandler(e,t,r){const s=this.sessions[t];We.trace(`onIceCandidates. UserID: ${e}. SessionID: ${t}. ICE candidates count: ${r.iceCandidates?.length??0}`),s?s.state===_.ACTIVE?s.processOnIceCandidates(e,r):We.traceWarning(`Ignore 'OnIceCandidates', the session ( ${t} ) has invalid state`):We.traceWarning(`Ignore 'OnIceCandidates', there is no information about session ${t}`)}onIceRestartHandler(e,t,r){const s=this.sessions[t];We.trace(`onIceRestart. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(r)}`),s?s.state===_.ACTIVE?s.processOnIceRestart(e,r):We.traceWarning(`Ignore 'OnIceRestart', the session (${t}) has invalid state`):We.traceWarning(`Ignore 'OnIceRestart', there is no information about session ${t}`)}onIceRestartAcceptHandler(e,t,r){const s=this.sessions[t];We.trace(`onIceRestartAccept. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(r)}`),s?s.state===_.ACTIVE?s.processOnIceRestartAccept(e,r):We.traceWarning(`Ignore 'onIceRestartAccept', the session (${t}) has invalid state`):We.traceWarning(`Ignore 'onIceRestartAccept', there is no information about session ${t}`)}getListenerByName(e){switch(e){case V.CALL:return"onCallListener";case V.ACCEPT:return"onAcceptCallListener";case V.REJECT:return"onRejectCallListener";case V.STOP:return"onStopCallListener";case V.INVALID:return"onInvalidEventsListener";case V.NOT_ANSWER:return"onUserNotAnswerListener";case V.REMOTE_STREAM:return"onRemoteStreamListener";case V.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case V.CLOSE:return"onSessionCloseListener";case V.STATS_REPORT:return"onCallStatsReport";case V.DEVICES:return"onDevicesChangeListener";default:return null}}addListener(e,t){const r=this.getListenerByName(e);return r&&(this[r]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=e===V.DEVICES?()=>{}:void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]="onDevicesChangeListener"===e?()=>{}:void 0)})}}class Ke{constructor(e){this.route=ue.urls.whiteboards,this.server=ue.whiteboard.server,this.proxy=e}getURL({id:e,title:t,username:r}){return`${this.server}?whiteboardid=${e}&username=${r}&title=${t}`}async get(e){const t={type:ie.GET,url:he.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e};return this.proxy.ajax(t)}async create(e){const t={type:ie.POST,url:he.getUrl(this.route),data:e};return this.proxy.ajax(t)}async update(e,t){const r={type:ie.PUT,url:he.getUrl(this.route,e),data:t};return this.proxy.ajax(r)}async delete(e){const t={type:ie.DELETE,url:he.getUrl(this.route,e),dataType:ae.TEXT};return this.proxy.ajax(t)}}class Ye{constructor(e){this.cache=new Map,this.route=ue.urls.unfurl,this.server=ue.linkpreview.server,this.proxy=e}async get(e){if(!this.cache.has(e)){let t;try{const r={type:ie.POST,url:`${this.server}/${this.route}`,data:{url:e}};t=await this.proxy.ajax(r)}catch(r){t={url:e,title:this.getHostFromUrl(e),description:"",images:[]}}finally{this.cache.set(e,t)}}return this.cache.get(e)}getHostFromUrl(e){if("function"==typeof URL)return new URL(e).hostname;const t=e.match(/^(?:https?:\/\/)?([^\/]+)/);return t?t[1]:e}}class Ze{init(e,t={}){t&&"object"==typeof t&&ue.set(t),this.utils=he,this.service=new Ue,this.auth=new me(this.service),this.users=new Fe(this.service),this.storage=new $e(this.service),this.pushnotifications=new _e(this.service),this.data=new je(this.service),this.addressbook=new pe(this.service),this.chat=new we(this.service),this.meeting=new Me(this.service),this.whiteboard=new Ke(this.service),this.linkpreview=new Ye(this.service),R&&(this.videochat=new Qe(this.chat.xmppClient,this.service),this.videochatconference=new Ne(this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor),e.token?(ue.creds.appId=e.appId,this.service.setSession({token:e.token})):(ue.creds.appId=e.appId,ue.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout}}const et=new Ze;et.ConnectyCube=Ze,module.exports=et;
//# sourceMappingURL=index.cjs.map
