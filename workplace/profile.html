<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="../css/classified-navbar.css">
    <link rel="icon" type="image/png" href="../assets/logo.jpg">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Check if QR code library loaded
        window.addEventListener('load', function() {
            if (typeof QRCode !== 'undefined') {
                console.log('QR Code library loaded successfully');
            } else {
                console.warn('QR Code library not loaded');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Google Sans', 'Roboto', 'Inter', sans-serif;
        }

        body {
            background: #ffffff;
            min-height: 100vh;
            color: #202124;
            overflow-x: hidden;
            font-family: 'Google Sans', 'Roboto', 'Inter', sans-serif;
        }

        .main-container {
            max-width: 1200px;
            margin: 5rem auto 2rem;
            padding: 0 2rem;
        }

        .form-header {
            background: #ffffff;
            border: 1px solid #dadce0;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-title {
            font-size: 1.75rem;
            font-weight: 400;
            color: #202124;
            margin-bottom: 0.5rem;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .form-subtitle {
            color: #5f6368;
            font-size: 0.875rem;
            font-family: 'Roboto', sans-serif;
        }

        .form-container {
            background: #ffffff;
            border: 1px solid #dadce0;
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 500;
            color: #202124;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dadce0;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Roboto', sans-serif;
        }

        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid #dadce0;
            font-size: 0.875rem;
            color: #202124;
            background: #fff;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }

        .form-input:disabled {
            background: #f8f9fa;
            color: #5f6368;
            cursor: not-allowed;
        }

        .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid #dadce0;
            font-size: 0.875rem;
            color: #202124;
            background: #fff;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .form-select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }

        .form-textarea {
            padding: 0.75rem 1rem;
            border: 1px solid #dadce0;
            font-size: 0.875rem;
            color: #202124;
            background: #fff;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }

        .profile-pic-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .profile-pic {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #dadce0;
        }

        .profile-pic-upload {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .upload-btn {
            padding: 0.5rem 1rem;
            background: #1a73e8;
            color: #fff;
            border: 1px solid #1a73e8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.3s;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .upload-btn:hover {
            background: #1557b0;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #dadce0;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: 1px solid #1a73e8;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .btn-primary {
            background: #1a73e8;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-secondary {
            background: #fff;
            color: #1a73e8;
            border: 1px solid #1a73e8;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .btn-danger {
            background: #ea4335;
            color: #fff;
            border: 1px solid #ea4335;
        }

        .btn-danger:hover {
            background: #d93025;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
        }

        .status-complete {
            background: #e6f4ea;
            color: #137333;
        }

        .status-incomplete {
            background: #fce8e6;
            color: #c5221f;
        }

        .status-loading {
            background: #e8f0fe;
            color: #1a73e8;
        }

        footer {
            background: #fff;
            padding: 1rem;
            text-align: center;
            border-top: 1px solid #dadce0;
            color: #5f6368;
            font-size: 0.75rem;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            font-family: 'Roboto', sans-serif;
        }

        footer a {
            color: #1a73e8;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
        }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
            }

            .nav-menu {
                display: none;
                position: absolute;
                top: 56px;
                left: 0;
                right: 0;
                background: #fff;
                flex-direction: column;
                padding: 1rem;
                border: 1px solid #dadce0;
                z-index: 999;
            }

            .nav-menu.active {
                display: flex;
            }

            .hamburger {
                display: block;
            }

            .main-container {
                padding: 0 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .form-container {
                padding: 1.5rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .post-content {
                flex-direction: column;
                min-height: auto;
            }

            .post-media-section {
                flex: none;
                height: 300px;
            }

            .post-media-section img,
            .post-media-section video {
                height: 300px;
            }

            .post-details-section {
                min-height: auto;
            }

            .post-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .media-buttons {
                justify-content: center;
            }
            
            .create-post-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 0 0.75rem;
            }

            .form-header {
                padding: 1.5rem;
            }

            .form-container {
                padding: 1rem;
            }

            .form-title {
                font-size: 1.5rem;
            }
            }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #dadce0;
            }
        .tab-btn {
            background: none;
            border: none;
                font-size: 1rem;
            font-weight: 500;
            color: #5f6368;
            padding: 1rem 2rem 0.75rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom 0.2s;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }
        .tab-btn.active {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            background: #f8f9fa;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Portfolio Styles */
        .portfolio-header {
            background: #ffffff;
            border: 1px solid #dadce0;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .portfolio-header h2 {
            font-size: 1.75rem;
            font-weight: 400;
            color: #202124;
            margin-bottom: 0.5rem;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .portfolio-header p {
            color: #5f6368;
            font-size: 0.875rem;
            font-family: 'Roboto', sans-serif;
        }

        .create-post-section {
            margin-bottom: 2rem;
        }

        .create-post-card {
            background: #ffffff;
            border: 1px solid #dadce0;
            padding: 1.5rem;
        }

        .post-input-area {
            margin-bottom: 1rem;
        }

        #post-content {
            width: 100%;
            border: 1px solid #dadce0;
            padding: 1rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 80px;
            font-family: 'Roboto', sans-serif;
        }

        #post-content:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.1);
        }

        .post-media-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .media-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .media-btn {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dadce0;
            color: #5f6368;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Roboto', sans-serif;
        }

        .media-btn:hover {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .create-post-btn {
            padding: 0.75rem 1.5rem;
            background: #1a73e8;
            color: #fff;
            border: 1px solid #1a73e8;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .create-post-btn:hover {
            background: #1557b0;
        }

        .create-post-btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }

        .portfolio-feed {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        /* Portfolio Card Types */
        .portfolio-card {
            background: #ffffff;
            border: 1px solid #dadce0;
            overflow: hidden;
            transition: transform 0.2s ease;
            height: fit-content;
            display: flex;
            flex-direction: column;
        }

        .portfolio-card:hover {
            transform: translateY(-2px);
        }

        /* Text Only Card */
        .portfolio-card.text-only {
            padding: 1.5rem;
            min-height: 200px;
        }

        .portfolio-card.text-only .card-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        .portfolio-card.text-only .card-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #202124;
            flex: 1;
            font-family: 'Roboto', sans-serif;
        }

        /* Image Only Card */
        .portfolio-card.image-only {
            height: 400px;
        }

        .portfolio-card.image-only .card-media {
            width: 100%;
            height: 320px;
            overflow: hidden;
            position: relative;
        }

        .portfolio-card.image-only .card-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .portfolio-card.image-only:hover .card-media img {
            transform: scale(1.05);
        }

        .portfolio-card.image-only .card-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Video Only Card */
        .portfolio-card.video-only {
            height: 400px;
        }

        .portfolio-card.video-only .card-media {
            width: 100%;
            height: 320px;
            overflow: hidden;
        }

        .portfolio-card.video-only .card-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portfolio-card.video-only .card-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Image with Text Card */
        .portfolio-card.image-text {
            height: 450px;
        }

        .portfolio-card.image-text .card-media {
            width: 100%;
            height: 250px;
            overflow: hidden;
            position: relative;
        }

        .portfolio-card.image-text .card-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .portfolio-card.image-text:hover .card-media img {
            transform: scale(1.05);
        }

        .portfolio-card.image-text .card-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Video with Text Card */
        .portfolio-card.video-text {
            height: 450px;
        }

        .portfolio-card.video-text .card-media {
            width: 100%;
            height: 250px;
            overflow: hidden;
        }

        .portfolio-card.video-text .card-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portfolio-card.video-text .card-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Card Header */
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-avatar {
            width: 40px;
            height: 40px;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #dadce0;
        }

        .card-author-info {
            flex: 1;
            min-width: 0;
        }

        .card-author-name {
            font-weight: 500;
            color: #202124;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        .card-timestamp {
            color: #5f6368;
            font-size: 0.75rem;
            font-family: 'Roboto', sans-serif;
        }

        .card-actions-menu {
            position: relative;
            flex-shrink: 0;
        }

        .card-menu-btn {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 0.5rem;
            transition: background 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .card-menu-btn:hover {
            background: #f5f5f5;
        }

        /* Dropdown Menu */
        .card-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #dadce0;
            z-index: 1000;
            min-width: 120px;
            display: none;
            overflow: hidden;
        }

        .card-dropdown.active {
            display: block;
        }

        .card-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #202124;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'Roboto', sans-serif;
        }

        .card-dropdown-item:hover {
            background: #f5f5f5;
        }

        .card-dropdown-item.delete {
            color: #ea4335;
        }

        .card-dropdown-item.delete:hover {
            background: #fdf2f2;
        }

        /* Card Content */
        .card-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        .card-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #202124;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            font-family: 'Roboto', sans-serif;
        }

        /* Card Footer */
        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .card-stats {
            font-size: 0.8rem;
            color: #5f6368;
            font-family: 'Roboto', sans-serif;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-action-btn {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-family: 'Roboto', sans-serif;
        }

        .card-action-btn:hover {
            background: #f5f5f5;
            color: #202124;
        }

        .card-action-btn.endorsed {
            color: #ea4335;
        }

        .card-action-btn.endorsed:hover {
            background: #fdf2f2;
        }

        /* Endorsements Section */
        .card-endorsements {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-top: 1px solid #dadce0;
        }

        .endorsements-title {
            font-size: 0.8rem;
            color: #5f6368;
            margin-bottom: 0.5rem;
            font-family: 'Roboto', sans-serif;
        }

        .endorsements-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .endorsement-item {
            background: #fff;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #5f6368;
            border: 1px solid #dadce0;
            font-family: 'Roboto', sans-serif;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .portfolio-feed {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .portfolio-card {
                min-height: auto;
            }
            
            .portfolio-card.image-only,
            .portfolio-card.video-only {
                height: auto;
            }
            
            .portfolio-card.image-only .card-media,
            .portfolio-card.video-only .card-media {
                height: 250px;
            }
            
            .portfolio-card.image-text,
            .portfolio-card.video-text {
                height: auto;
            }
            
            .portfolio-card.image-text .card-media,
            .portfolio-card.video-text .card-media {
                height: 200px;
            }
            
            .post-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .media-buttons {
                justify-content: center;
            }
        }

        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }
        .loading-content {
            position: relative;
            z-index: 2;
            background: #fff;
            border: 1px solid #dadce0;
            padding: 2rem 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 220px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-bar-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            margin-top: 1rem;
            overflow: hidden;
        }
        .loading-bar {
            height: 100%;
            width: 0%;
            background: #1a73e8;
            transition: width 0.2s;
        }
/* Portfolio List Modern Styles */
#portfolio-list {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
  margin-top: 1.5rem;
}
.portfolio-card-fashion {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #ffffff;
  border: 1px solid #dadce0;
  padding: 1.5rem 2rem;
  transition: transform 0.18s;
  position: relative;
  cursor: pointer;
}
.portfolio-card-fashion:hover {
  border-color: #1a73e8;
  box-shadow: none;
  transform: translateY(-2px) scale(1.01);
}
.portfolio-card-accent {
  width: 6px;
  height: 48px;
  margin-right: 1.2rem;
  flex-shrink: 0;
  border-radius: 0;
}
.portfolio-card-main {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}
.portfolio-card-title {
  font-size: 1.18rem;
  font-weight: 600;
  color: #202124;
  letter-spacing: -0.01em;
  font-family: 'Google Sans', 'Roboto', 'Inter', Arial, sans-serif;
  margin-bottom: 0.1rem;
}
.portfolio-card-type {
  font-size: 0.98rem;
  color: #5f6368;
  font-weight: 500;
  text-transform: capitalize;
}
.portfolio-card-actions .btn {
  font-size: 0.97rem;
  padding: 0.5rem 1.2rem;
  border-radius: 0;
  font-weight: 500;
  transition: background 0.18s, color 0.18s, border 0.18s;
  font-family: 'Google Sans', 'Roboto', 'Inter', Arial, sans-serif;
}
.portfolio-card-actions .btn-primary {
  background: #1a73e8;
  color: #fff;
  border: 1px solid #1a73e8;
}
.portfolio-card-actions .btn-primary:hover {
  background: #1557b0;
  color: #fff;
}
.portfolio-card-actions .btn-secondary {
  background: #fff;
  color: #1a73e8;
  border: 1px solid #1a73e8;
}
.portfolio-card-actions .btn-secondary:hover {
  background: #f8f9fa;
  color: #111;
  border-color: #1a73e8;
}
.portfolio-card-actions .btn-danger {
  background: #fff;
  color: #ea4335;
  border: 1px solid #ea4335;
}
.portfolio-card-actions .btn-danger:hover {
  background: #ea4335;
  color: #fff;
}
#portfolio-modal-content {
  border-radius: 0 !important;
  box-shadow: none;
  font-family: 'Google Sans', 'Roboto', 'Inter', Arial, sans-serif;
}
#portfolio-modal-content h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #202124;
  margin-bottom: 0.5rem;
}
#portfolio-modal-content label {
  font-weight: 500;
  color: #222;
}
#portfolio-modal-content .form-input, #portfolio-modal-content .form-select, #portfolio-modal-content .form-textarea {
  border-radius: 0;
  font-size: 1rem;
  font-family: 'Google Sans', 'Roboto', 'Inter', Arial, sans-serif;
}
#portfolio-modal-content .btn-primary {
  background: #1a73e8;
  color: #fff;
  border-radius: 0;
  font-weight: 600;
}
#portfolio-modal-content .btn-primary:hover {
  background: #1557b0;
  color: #fff;
}
#portfolio-modal-content .btn {
  font-size: 1.05rem;
  padding: 0.7rem 1.5rem;
}
#close-portfolio-modal {
  font-size: 2rem !important;
  color: #888;
  transition: color 0.18s;
}
#close-portfolio-modal:hover {
  color: #1a73e8;
}
.portfolio-thumb {
  background: #fff;
  border-radius: 0;
  box-shadow: none;
  display: flex;
    flex-direction: column;
  align-items: center;
  padding: 0.3rem 0.1rem 0.2rem 0.1rem;
  cursor: pointer;
  border: 1px solid #dadce0;
  min-width: 0;
  transition: border-color 0.18s;
  }
.portfolio-thumb:hover {
  border-color: #1a73e8;
  box-shadow: none;
  transform: translateY(-2px) scale(1.03);
}
.portfolio-thumb img {
  width: 140px;
  height: 140px;
  object-fit: cover;
  border-radius: 0;
  box-shadow: none;
  margin-bottom: 0.3rem;
  background: #f3f3f3;
}
.portfolio-thumb .thumb-title {
  font-size: 0.9rem;
  color: #202124;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 140px;
  font-family: 'Roboto', sans-serif;
  font-weight: 400;
  text-decoration: none;
}

#drive-portfolio {
  margin-top: 2.5rem;
}

#drive-thumbnails {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.7rem;
  margin-top: 0.5rem;
}

.portfolio-thumb {
  background: #fff;
  border-radius: 0;
  box-shadow: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.3rem 0.1rem 0.2rem 0.1rem;
  cursor: pointer;
  border: 1px solid #dadce0;
  min-width: 0;
  transition: border-color 0.18s;
}

.portfolio-thumb:hover {
  border-color: #1a73e8;
  box-shadow: none;
  transform: translateY(-2px) scale(1.03);
}

.portfolio-thumb img {
  width: 140px;
  height: 140px;
  object-fit: cover;
  border-radius: 0;
  box-shadow: none;
  margin-bottom: 0.3rem;
  background: #f3f3f3;
}

.portfolio-thumb .thumb-title {
  font-size: 0.9rem;
  color: #202124;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 140px;
  font-family: 'Roboto', sans-serif;
  font-weight: 400;
  text-decoration: none;
}

        /* Edit Portfolio Folder Modal Styles */
        .edit-portfolio-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
  display: flex;
  align-items: center;
            justify-content: center;
        }

        .edit-portfolio-modal-content {
            background: #fff;
            border-radius: 1.2rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .edit-portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .edit-portfolio-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .close-edit-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
  cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-edit-modal:hover {
            background: #f5f5f5;
        }

        .edit-portfolio-form {
            margin-bottom: 1.5rem;
        }

        .edit-portfolio-form input[type="url"] {
            width: 100%;
            margin-bottom: 1rem;
        }

        .edit-portfolio-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .cancel-edit-btn, .update-drive-folder-btn {
            padding: 0.75rem 1.5rem;
        }

        #edit-portfolio-modal { display: none; }

        @media (max-width: 600px) {
          #drive-thumbnails {
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 0.4rem !important;
          }
          .portfolio-thumb {
            padding: 0.08rem 0.02rem 0.08rem 0.02rem;
            border-radius: 0.2rem;
            min-width: 0;
}
.portfolio-thumb img {
            width: 60px;
            height: 60px;
            border-radius: 0.1rem;
            margin-bottom: 0.08rem;
          }
          .portfolio-thumb .thumb-title {
            font-size: 0.72rem;
            max-width: 60px;
          }
}
    </style>
</head>
<body>
    <nav class="navbar_classified">
        <a href="../index.html">
        <div class="logo"><img src="../assets/logo.png" alt="Taska Logo" style="height:48px;vertical-align:middle;"></div>
        </a>
        <ul class="nav-menu">
            <li><a href="tasks.html">Workplace</a></li>
            <li><a href="profile.html" class="active">Account</a></li>
        </ul>
        <div class="hamburger">☰</div>
    </nav>

    <main class="main-container">
        <div class="tabs">
            <button class="tab-btn active" id="profile-tab-btn">Profile</button>
            <button class="tab-btn" id="portfolio-tab-btn">Portfolio</button>
            <button class="tab-btn" id="settings-tab-btn">Settings</button>
        </div>
        <div id="profile-tab" class="tab-content active" style="padding-bottom: 4.5rem;">
            <div class="form-header">
                <h1 class="form-title">Student Profile</h1>
                <p class="form-subtitle">Complete your profile information to get matched with the best opportunities</p>
                <!-- View Profile Button INSIDE the card -->
                <div style="display: flex; justify-content: flex-end; margin-top: 1rem; gap: 0.8rem;">
                    <button id="invite-connect-btn" class="btn btn-secondary" style="font-size:0.85rem; padding:0.35rem 1.1rem; height:2.1rem; min-width:unset; background: #34a853; border-color: #34a853; color: white; display:none;">
                        <i class="fas fa-share-alt"></i> Invite to Connect
                    </button>
                    <button id="view-own-profile-btn" class="btn btn-secondary" style="font-size:0.85rem; padding:0.35rem 1.1rem; height:2.1rem; min-width:unset;">
                        <i class="fas fa-user"></i> View Profile
                    </button>
                </div>
            </div>

            <div class="form-container">
                <form id="profile-form">
                    <div class="form-grid">
                        <!-- Personal Information Column -->
                        <div class="form-section">
                            <h2 class="section-title">Personal Information</h2>
                            
                            <div class="profile-pic-container">
            <img id="profile-pic" class="profile-pic" src="../assets/avatar/1.png" alt="Profile Picture">
                                <div class="profile-pic-upload">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('profile-upload').click()">
                                        <i class="fas fa-camera"></i> Upload Photo
                                    </button>
                                    <input type="file" id="profile-upload" accept="image/*" style="display: none;">
                                </div>
        </div>

                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="name" class="form-input" placeholder="Enter your full name">
            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="email" class="form-input" placeholder="your.email@example.com">
        </div>

                            <div class="form-group">
                                <label class="form-label">WhatsApp Number</label>
                                <input type="tel" id="whatsapp" class="form-input" placeholder="+1234567890">
            </div>

                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select id="gender" class="form-select">
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="other">Other</option>
                                </select>
        </div>

                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" id="location" class="form-input" placeholder="City, Country">
            </div>

                            <div class="form-group">
                                <label class="form-label">LinkedIn Profile</label>
                                <input type="url" id="linkedin" class="form-input" placeholder="https://linkedin.com/in/username">
        </div>

                            <div class="form-group">
                                <label class="form-label">About Me</label>
                                <textarea id="about" class="form-textarea" placeholder="Tell us about yourself, your interests, and career goals..."></textarea>
            </div>
        </div>

                        <!-- Educational Information Column -->
                        <div class="form-section">
                            <h2 class="section-title">Educational Information</h2>

                            <div class="form-group">
                                <label class="form-label">College/University</label>
                                <input type="text" id="college" class="form-input" placeholder="Your college name">
            </div>

                            <div class="form-group">
                                <label class="form-label">Degree</label>
                                <select id="degree" class="form-select">
                                    <option value="">Select degree</option>
                                    <option value="B tech">B Tech</option>
                                    <option value="M tech">M Tech</option>
                                    <option value="PhD">PhD</option>
                                    <option value="Diploma">Diploma</option>
                                    <option value="other">Other</option>
                                </select>
        </div>

                            <div class="form-group">
                                <label class="form-label">Branch/Field</label>
                                <input type="text" id="branch" class="form-input" placeholder="Computer Science, Engineering, etc.">
            </div>

                            <div class="form-group">
                                <label class="form-label">Year of Study</label>
                                <select id="year" class="form-select">
                                    <option value="">Select year</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                    <option value="5">5th Year</option>
                                    <option value="graduated">Graduated</option>
                                </select>
        </div>

                            <div class="form-group">
                                <label class="form-label">CGPA</label>
                                <input type="number" id="cgpa" class="form-input" placeholder="8.5" step="0.01" min="0" max="10">
            </div>

                            <div class="form-group">
                                <label class="form-label">Expected Graduation</label>
                                <input type="month" id="graduation" class="form-input">
        </div>

                            <div class="form-group">
                                <label class="form-label">Academic Achievements</label>
                                <textarea id="achievements" class="form-textarea" placeholder="List your academic achievements, awards, scholarships..."></textarea>
            </div>
        </div>

                        <!-- Professional Information Column -->
                        <div class="form-section">
                            <h2 class="section-title">Professional Information</h2>
                            <!-- Headline input moved here -->
                            <div class="form-group">
                                <label class="form-label">Headline</label>
                                <input type="text" id="headline" class="form-input" placeholder="e.g. Aspiring Machine Learning Engineer | Student">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Skills</label>
                                <textarea id="skills" class="form-textarea" placeholder="List your technical skills, separated by commas (e.g., Python, React, AWS)"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Work Experience</label>
                                <textarea id="workExperience" class="form-textarea" placeholder="Briefly describe your work experience, internships, or relevant projects, separated by commas..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Preferred Roles</label>
                                <textarea id="roles" class="form-textarea" placeholder="What roles are you interested in? (e.g., Frontend Developer, Data Scientist)..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="save-profile-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Social Accounts Section -->
        <div id="social-tab" class="tab-content" style="display:none;">
          <form id="social-accounts-form" style="max-width:480px;padding:0;margin:0;display:flex;flex-direction:column;gap:0.5rem;align-items:flex-start;">
            <div class="form-group" style="display:flex;flex-direction:row;align-items:center;gap:0.7rem;width:100%;">
              <span style="display:inline-flex;width:1.1rem;height:1.1rem;align-items:center;justify-content:center;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1.1em" height="1.1em" fill="#888"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.761 0 5-2.239 5-5v-14c0-2.761-2.239-5-5-5zm-7 19c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8zm0-14c-3.313 0-6 2.687-6 6s2.687 6 6 6 6-2.687 6-6-2.687-6-6-6zm0 10c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/></svg>
              </span>
              <input type="url" id="social-linkedin" class="form-input" placeholder="LinkedIn URL" style="flex:1;min-width:0;">
            </div>
            <div class="form-group" style="display:flex;flex-direction:row;align-items:center;gap:0.7rem;width:100%;">
              <span style="display:inline-flex;width:1.1rem;height:1.1rem;align-items:center;justify-content:center;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1.1em" height="1.1em" fill="#888"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.387.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.416-4.042-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.084-.729.084-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.834 2.809 1.304 3.495.997.108-.775.418-1.305.762-1.605-2.665-.305-5.466-1.334-5.466-5.931 0-1.31.469-2.381 1.236-3.221-.124-.303-.535-1.523.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.553 3.297-1.23 3.297-1.23.653 1.653.242 2.873.119 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.803 5.624-5.475 5.921.43.372.823 1.102.823 2.222 0 1.606-.014 2.898-.014 3.293 0 .322.216.694.825.576 4.765-1.588 8.199-6.084 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
              </span>
              <input type="url" id="social-github" class="form-input" placeholder="GitHub URL" style="flex:1;min-width:0;">
            </div>
            <div class="form-group" style="display:flex;flex-direction:row;align-items:center;gap:0.7rem;width:100%;">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/leetcode.svg" alt="LeetCode" style="width:1.1em;height:1.1em;filter:grayscale(1);">
              <input type="url" id="social-leetcode" class="form-input" placeholder="LeetCode URL" style="flex:1;min-width:0;">
            </div>
            <div class="form-group" style="display:flex;flex-direction:row;align-items:center;gap:0.7rem;width:100%;">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/codeforces.svg" alt="Codeforces" style="width:1.1em;height:1.1em;filter:grayscale(1);">
              <input type="url" id="social-codeforces" class="form-input" placeholder="Codeforces URL" style="flex:1;min-width:0;">
            </div>
            <div id="custom-social-links" style="display:flex;flex-direction:column;gap:0.5rem;width:100%;"></div>
            <div class="form-actions" style="justify-content:flex-end;width:100%;margin-top:0.7rem;">
              <button type="submit" class="btn btn-primary" id="save-social-btn" style="font-size:0.98rem;padding:0.5rem 1.2rem;">Save</button>
            </div>
          </form>
        </div>
        <!-- Portfolio Drive Thumbnails Section (now under Portfolio tab only) -->
        <div id="portfolio-tab" class="tab-content" style="display:none; padding-bottom: 8.5rem;">
          <div id="drive-portfolio" style="margin-top:3.5rem;">
            <!-- Portfolio Synced Indicator and Edit Button (now above grid) -->
            <div id="portfolio-synced-indicator" style="display:none; background:#e6f4ea; color:#137333; border-radius:1.2rem; padding:0.5rem 1.2rem 0.5rem 1rem; display:flex; align-items:center; gap:0.7rem; font-weight:500; box-shadow:0 1px 4px rgba(20,85,20,0.07); margin-bottom:1.2rem;">
              <span style="display:inline-flex;align-items:center;justify-content:center;">
                <svg width="1.3em" height="1.3em" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#43e97b"/><path d="M6 10.5l2.5 2.5L14 8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </span>
              Portfolio Synced
              <button id="edit-drive-folder-btn" class="btn btn-secondary" style="margin-left:1.2rem; font-size:0.95rem; padding:0.3rem 1.1rem; border-radius:0.7rem;">Edit</button>
            </div>
            <!-- Google Drive Portfolio Setup UI (for first-time setup) -->
            <div id="drive-setup-container" style="display:none; max-width:520px; margin:0 auto 2.5rem auto; background:#fff; padding:2.5rem 2rem 2rem 2rem; border-radius:1.1rem; box-shadow:0 2px 12px 0 rgba(26,115,232,0.07); font-family:'Inter','Poppins',Arial,sans-serif;">
              <h3 style="font-size:2rem; font-weight:700; color:#202124; margin-bottom:1.1rem; letter-spacing:-0.01em;">Add Your Google Drive Portfolio Folder</h3>
              <div style="font-size:1.18rem; color:#444; margin-bottom:1.7rem; line-height:1.7; max-width:480px;">
                Link your Google Drive folder to showcase your portfolio files. This folder should be public so others can view your work. Follow these steps:
              </div>
              <ol style="font-size:1.22rem; color:#222; margin-bottom:1.5rem; padding-left:1.5rem; line-height:2.1; font-family:'Poppins','Inter',Arial,sans-serif;">
                <li style="margin-bottom:0.7rem;">Go to <b>Google Drive</b> and create a folder for your portfolio files.</li>
                <li style="margin-bottom:0.7rem;">Right-click the folder, select <b>Share</b> → <b>Anyone with the link</b> can <b>View</b>.</li>
                <li>Copy the folder link and paste it below.</li>
              </ol>
              <div style="display:flex; flex-direction:column; gap:1rem;">
                <input type="url" id="drive-folder-link" class="form-input" placeholder="Paste your Google Drive folder link here" style="width:100%; font-size:1.18rem; padding:1.1rem 1.2rem; border-radius:0.7rem; border:1.5px solid #e0e0e0; font-family:'Inter','Poppins',Arial,sans-serif;">
                <button id="save-drive-folder-btn" class="btn btn-primary" style="width:100%; font-size:1.18rem; padding:1.1rem 0; border-radius:0.7rem; font-weight:600; letter-spacing:0.01em; font-family:'Inter','Poppins',Arial,sans-serif; justify-content:center;">Save Portfolio Folder</button>
              </div>
            </div>
            <div id="drive-thumbnails"></div>
          </div>
        </div>

        <!-- Edit Portfolio Folder Modal -->
        <div id="edit-portfolio-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; border-radius:1.2rem; padding:2rem; max-width:500px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.15);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
              <h3 style="font-size:1.25rem; font-weight:600; color:#1a1a1a; margin:0;">Edit Portfolio Folder</h3>
              <button id="close-edit-modal" style="background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer; padding:0.5rem; border-radius:50%; transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">×</button>
            </div>
            <div style="margin-bottom:1.5rem;">
              <ol style="font-size:0.95rem; color:#444; margin-bottom:1.2rem; padding-left:1.2rem; line-height:1.6;">
                <li>1. Go to <b>Google Drive</b> and create a folder for your portfolio files.</li>
                <li>2. Right-click the folder, select <b>Share</b> &rarr; <b>Anyone with the link</b> can <b>View</b>.</li>
                <li>3. Copy the folder link and paste it below.</li>
              </ol>
              <input type="url" id="edit-drive-folder-link" class="form-input" placeholder="Paste your Google Drive folder link here" style="width:100%; margin-bottom:1rem;">
            </div>
            <div style="display:flex; gap:1rem; justify-content:flex-end;">
              <button id="remove-portfolio-btn" class="btn btn-danger" style="padding:0.75rem 1.5rem;">Remove Portfolio</button>
              <button id="update-drive-folder-btn" class="btn btn-primary" style="padding:0.75rem 1.5rem;">Update Folder</button>
            </div>
          </div>
        </div>

        <div id="settings-tab" class="tab-content" style="display:none; padding-bottom: 4.5rem;">
            <div class="form-container" style="max-width:400px;margin:0 auto;">
                <h2 class="section-title" style="text-align: center; margin-bottom: 2rem;">Account Settings</h2>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button type="button" id="logout-btn" class="btn btn-secondary" style="width:100%;font-size:0.95rem;padding:0.75rem 1.5rem;">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="#" id="delete-account-link" style="color: #ea4335; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s;">
                            <i class="fas fa-trash"></i> Delete Account
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display:none;">
        <div class="loading-backdrop"></div>
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loading-text">Uploading...</div>
            <div class="loading-bar-container">
                <div id="loading-bar" class="loading-bar"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 Taska. All rights reserved. | <a href="../footer-pages/privacy-policy.html" target="_blank">Privacy Policy</a></p>
    </footer>

       <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyDZIDlEtaNRxODoFhRw0xF2yYFBqqBexqo",
    authDomain: "taska-45011.firebaseapp.com",
    databaseURL: "https://taska-45011-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "taska-45011",
    storageBucket: "taska-45011.firebasestorage.app",
    messagingSenderId: "205487498813",
    appId: "1:205487498813:web:0de2c9eab567482781ec54"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUserId = null;
let selectedFile = null;
let selectedFileType = null;

document.addEventListener('DOMContentLoaded', () => {
    // Hamburger menu toggle
    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');
    hamburger.addEventListener('click', () => {
        navMenu.classList.toggle('active');
    });

    // Tab switching functionality
    const profileTabBtn = document.getElementById('profile-tab-btn');
    const portfolioTabBtn = document.getElementById('portfolio-tab-btn');
    const settingsTabBtn = document.getElementById('settings-tab-btn');
    const profileTab = document.getElementById('profile-tab');
    const portfolioTab = document.getElementById('portfolio-tab');
    const settingsTab = document.getElementById('settings-tab');

    profileTabBtn.addEventListener('click', () => {
        profileTabBtn.classList.add('active');
        portfolioTabBtn.classList.remove('active');
        settingsTabBtn.classList.remove('active');
        profileTab.style.display = 'block';
        portfolioTab.style.display = 'none';
        settingsTab.style.display = 'none';
    });

    portfolioTabBtn.addEventListener('click', () => {
        portfolioTabBtn.classList.add('active');
        profileTabBtn.classList.remove('active');
        settingsTabBtn.classList.remove('active');
        portfolioTab.style.display = 'block';
        profileTab.style.display = 'none';
        settingsTab.style.display = 'none';
        loadDrivePortfolio();
    });

    settingsTabBtn.addEventListener('click', () => {
        settingsTabBtn.classList.add('active');
        profileTabBtn.classList.remove('active');
        portfolioTabBtn.classList.remove('active');
        settingsTab.style.display = 'block';
        profileTab.style.display = 'none';
        portfolioTab.style.display = 'none';
    });

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            loadProfileData(user.uid);
            // Attach the save folder event listener only after authentication
            document.getElementById('save-drive-folder-btn').addEventListener('click', saveDriveFolderId);
            // Attach the View Profile button event listener here
            const viewProfileBtn = document.getElementById('view-own-profile-btn');
            if (viewProfileBtn) {
                viewProfileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentUserId) {
                        window.open('/workplace/view-profile.html?studentId=' + currentUserId, '_blank');
                    } else {
                        alert('User ID not found. Please log in again.');
                    }
                    return false;
                });
            }
            
            // Attach invite modal event listeners
            const inviteConnectBtn = document.getElementById('invite-connect-btn');
            if (inviteConnectBtn) {
                inviteConnectBtn.addEventListener('click', function() {
                    console.log('Invite button clicked');
                    openInviteModal();
                });
            }
            
            const closeInviteModalBtn = document.getElementById('close-invite-modal');
            if (closeInviteModalBtn) {
                closeInviteModalBtn.addEventListener('click', function() {
                    closeInviteModal();
                });
            }
            
            const copyLinkBtn = document.getElementById('copy-link-btn');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', function() {
                    copyInviteLink();
                });
            }
            
            const shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
            if (shareWhatsappBtn) {
                shareWhatsappBtn.addEventListener('click', function() {
                    shareViaWhatsApp();
                });
            }
            
            const shareEmailBtn = document.getElementById('share-email-btn');
            if (shareEmailBtn) {
                shareEmailBtn.addEventListener('click', function() {
                    shareViaEmail();
                });
            }
            
            // Add click event for modal backdrop
            const inviteConnectModal = document.getElementById('invite-connect-modal');
            if (inviteConnectModal) {
                inviteConnectModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeInviteModal();
                    }
                });
            }
        } else {
            setTimeout(() => {
                alert("Please log in or sign up first.");
                window.location.href = '../login.html';
            }, 1000);
        }
    });

    // Logout button handler
    document.getElementById('logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        
        // Show confirmation dialog
        if (confirm('Are you sure you want to logout? This will clear all your data from this device.')) {
            try {
                // Sign out from Firebase
                await signOut(auth);
                
                // Clear all browser data related to the site
                try {
                    // Clear localStorage
                    localStorage.clear();
                    
                    // Clear sessionStorage
                    sessionStorage.clear();
                    
                    // Clear all cookies
                    const cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i];
                        const eqPos = cookie.indexOf("=");
                        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
                    }
                    
                    // Clear IndexedDB if available
                    if ('indexedDB' in window) {
                        const databases = indexedDB.databases();
                        databases.then(dbList => {
                            dbList.forEach(db => {
                                indexedDB.deleteDatabase(db.name);
                            });
                        }).catch(err => {
                            console.log('IndexedDB deletion failed:', err);
                        });
                    }
                    
                    // Clear service worker cache if available
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            for (let registration of registrations) {
                                registration.unregister();
                            }
                        });
                    }
                    
                    // Clear cache storage if available
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => {
                                caches.delete(name);
                            });
                        });
                    }
                    
                    // Clear application cache if available
                    if ('applicationCache' in window) {
                        window.applicationCache.clear();
                    }
                    
                    // Clear browser cache for this domain
                    if ('caches' in window) {
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    return caches.delete(cacheName);
                                })
                            );
                        });
                    }
                    
                    console.log('All browser data cleared successfully');
                } catch (clearError) {
                    console.log('Error clearing browser data:', clearError);
                }
                
                // Redirect to index page
                window.location.href = '../index.html';
                
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Failed to log out. Please try again.");
            }
        }
    });

    // Delete account button handler
    document.getElementById('delete-account-link').addEventListener('click', async (e) => {
        e.preventDefault();
        
        // Show confirmation dialog
        const confirmed = confirm(
            "Are you sure you want to delete your account? This action cannot be undone and will permanently remove:\n\n" +
            "• All your profile data\n" +
            "• Your portfolio files\n" +
            "• All your connections and messages\n" +
            "• Your account from the system\n\n" +
            "This action is irreversible!"
        );
        
        if (!confirmed) {
            return;
        }
        
        // Ask for reason
        const reason = prompt(
            "Please tell us why you're deleting your account. This helps us improve our service.\n\n" +
            "Reason (optional):"
        );
        
        // Show final confirmation
        const finalConfirmed = confirm(
            "FINAL WARNING: This will permanently delete your account and all associated data. Are you absolutely sure?"
        );
        
        if (!finalConfirmed) {
            return;
        }
        
        try {
            showLoadingOverlay('Deleting account...', 0);
            
            // Store deletion reason in Firebase
            setLoadingBar(10);
            const deletionData = {
                userId: currentUserId,
                reason: reason || 'No reason provided',
                timestamp: new Date().toISOString(),
                userEmail: auth.currentUser?.email || 'Unknown',
                userName: document.getElementById('name').value || 'Unknown'
            };
            
            await push(ref(db, 'account_deletions'), deletionData);
            
            // Delete user data from database
            setLoadingBar(30);
            await set(ref(db, `studentslist/${currentUserId}`), null);
            
            // Delete profile photo from storage
            setLoadingBar(50);
            try {
                const profilePhotoRef = storageRef(storage, `profile/${currentUserId}.webp`);
                await deleteObject(profilePhotoRef);
            } catch (storageError) {
                console.log('No profile photo to delete or already deleted');
            }
            
            // Delete portfolio files from storage
            setLoadingBar(70);
            try {
                const portfolioRef = storageRef(storage, `portfolio/${currentUserId}`);
                // Note: Firebase Storage doesn't have a direct way to delete folders
                // Individual files would need to be deleted separately
                // For now, we'll just delete the user data
            } catch (portfolioError) {
                console.log('No portfolio files to delete or already deleted');
            }
            
            // Delete user from Firebase Authentication
            setLoadingBar(90);
            const user = auth.currentUser;
            if (user) {
                await user.delete();
            }
            
            setLoadingBar(100);
            hideLoadingOverlay();
            
            // Clear all browser data related to the site
            try {
                // Clear localStorage
                localStorage.clear();
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Clear all cookies
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i];
                    const eqPos = cookie.indexOf("=");
                    const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
                }
                
                // Clear IndexedDB if available
                if ('indexedDB' in window) {
                    const databases = indexedDB.databases();
                    databases.then(dbList => {
                        dbList.forEach(db => {
                            indexedDB.deleteDatabase(db.name);
                        });
                    }).catch(err => {
                        console.log('IndexedDB deletion failed:', err);
                    });
                }
                
                // Clear service worker cache if available
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        for (let registration of registrations) {
                            registration.unregister();
                        }
                    });
                }
                
                // Clear cache storage if available
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                console.log('All browser data cleared successfully');
            } catch (clearError) {
                console.log('Error clearing browser data:', clearError);
            }
            
            alert('Account deleted successfully. Thank you for using Taska.');
            window.location.href = '../index.html';
            
        } catch (error) {
            hideLoadingOverlay();
            console.error("Error deleting account:", error);
            
            if (error.code === 'auth/requires-recent-login') {
                alert("For security reasons, you need to re-authenticate before deleting your account. Please log out and log back in, then try again.");
            } else {
                alert("Failed to delete account: " + error.message);
            }
        }
    });

    // Save profile button handler
    document.getElementById('save-profile-btn').addEventListener('click', async () => {
        showLoadingOverlay('Saving profile...', 0);
        try {
            // Fetch current driveFolderId before saving
            let driveFolderId = null;
            try {
                const snapshot = await get(ref(db, `studentslist/${currentUserId}/driveFolderId`));
                driveFolderId = snapshot.exists() ? snapshot.val() : null;
            } catch (e) {
                driveFolderId = null;
            }
            const profileData = {
                personal: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    gender: document.getElementById('gender').value,
                    location: document.getElementById('location').value,
                    linkedin: document.getElementById('linkedin').value,
                    about: document.getElementById('about').value
                },
                education: {
                    college: document.getElementById('college').value,
                    degree: document.getElementById('degree').value,
                    branch: document.getElementById('branch').value,
                    year: document.getElementById('year').value,
                    cgpa: document.getElementById('cgpa').value,
                    graduation: document.getElementById('graduation').value,
                    achievements: document.getElementById('achievements').value
                },
                headline: document.getElementById('headline').value,
                skills: document.getElementById('skills').value,
                experience: document.getElementById('workExperience').value,
                roles: document.getElementById('roles').value,
                driveFolderId: driveFolderId // Preserve driveFolderId
            };

            setLoadingBar(50);
            await set(ref(db, `studentslist/${currentUserId}`), profileData);
            setLoadingBar(100);
            alert('Profile saved successfully!');
        } catch (error) {
            alert('Failed to save profile: ' + error.message);
        }
        hideLoadingOverlay();
    });

    // Profile picture upload handler
    document.getElementById('profile-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            showLoadingOverlay('Processing image...', 0);
            try {
                // Convert to WebP with resizing
                setLoadingBar(10);
                showLoadingOverlay('Resizing and converting to WebP...', 10);
                const webpFile = await convertToWebP(file);
                setLoadingBar(30);
                
                // Upload with user ID as filename
                showLoadingOverlay('Uploading to Firebase Storage...', 30);
                const fileName = `${currentUserId}.webp`;
                const fileRef = storageRef(storage, `profile/${fileName}`);
                
                const uploadTask = uploadBytes(fileRef, webpFile);
                setLoadingBar(60);
                await uploadTask;
                
                const url = await getDownloadURL(fileRef);
                document.getElementById('profile-pic').src = url;
                setLoadingBar(100);
                showLoadingOverlay('Profile photo updated successfully!', 100);
                
                // Hide overlay after a brief success message
                setTimeout(() => {
                    hideLoadingOverlay();
                }, 1000);
                
            } catch (err) {
                hideLoadingOverlay();
                alert('Failed to upload profile photo: ' + err.message);
            }
        }
    });

    // Function to convert image to WebP format with resizing
    async function convertToWebP(file) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Set canvas size to standard profile picture dimensions
                const maxSize = 200; // Standard profile picture size
                let { width, height } = img;
                
                // Calculate new dimensions maintaining aspect ratio
                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
        } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Enable image smoothing for better quality
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Draw resized image on canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to WebP with optimized quality (0.8 = 80%)
                canvas.toBlob((blob) => {
                    if (blob) {
                        // Create a new file with WebP extension
                        const webpFile = new File([blob], `${currentUserId}.webp`, {
                            type: 'image/webp',
                            lastModified: Date.now()
                        });
                        resolve(webpFile);
                    } else {
                        reject(new Error('Failed to convert image to WebP'));
                    }
                }, 'image/webp', 0.8);
            };
            
            img.onerror = () => {
                reject(new Error('Failed to load image'));
            };
            
            // Load image from file
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // File upload handlers for portfolio posts
    document.getElementById('image-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            selectedFileType = 'image';
            showMediaPreview(file, 'image');
        }
    });

    document.getElementById('video-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            selectedFileType = 'video';
            showMediaPreview(file, 'video');
        }
    });

    // Create post handler
    document.getElementById('create-post-btn').addEventListener('click', async () => {
        const content = document.getElementById('post-content').value.trim();
        if (!content && !selectedFile) {
            alert('Please add some content or media to your post.');
            return;
        }
        
        try {
            let mediaUrl = null;
            if (selectedFile) {
                showLoadingOverlay('Uploading media...', 0);
                const fileRef = storageRef(storage, `portfolio/${currentUserId}_${Date.now()}_${selectedFile.name}`);
                const uploadTask = uploadBytes(fileRef, selectedFile);
                setLoadingBar(50);
                await uploadTask;
                mediaUrl = await getDownloadURL(fileRef);
                setLoadingBar(100);
                hideLoadingOverlay();
            }
            
            const postData = {
                authorId: currentUserId,
                content: content,
                mediaUrl: mediaUrl,
                mediaType: selectedFileType,
                timestamp: Date.now(),
                endorsements: [],
                authorName: document.getElementById('name').value || 'Anonymous'
            };
            
            await createPost(postData);
            
            // Clear form
            document.getElementById('post-content').value = '';
            document.getElementById('post-media-preview').style.display = 'none';
            selectedFile = null;
            selectedFileType = null;
            
            // Reload feed
            loadPortfolioFeed();
            
    } catch (error) {
            hideLoadingOverlay();
            alert('Failed to create post: ' + error.message);
        }
    });

    // Add event listener for View Profile button
    document.getElementById('view-own-profile-btn').addEventListener('click', function() {
        if (currentUserId) {
            window.open(`workplace/view-profile.html?studentId=${currentUserId}`, '_blank');
        } else {
            alert('User ID not found. Please log in again.');
        }
    });
});

// Portfolio Functions
function showMediaPreview(file, type) {
    const preview = document.getElementById('post-media-preview');
    const previewImage = document.getElementById('preview-image');
    const previewVideo = document.getElementById('preview-video');
    
    preview.style.display = 'block';
    
    if (type === 'image') {
        previewImage.style.display = 'block';
        previewVideo.style.display = 'none';
        previewImage.src = URL.createObjectURL(file);
    } else {
        previewVideo.style.display = 'block';
        previewImage.style.display = 'none';
        previewVideo.src = URL.createObjectURL(file);
    }
}

async function uploadFile(file) {
    const fileRef = storageRef(storage, `portfolio/${currentUserId}/${Date.now()}_${file.name}`);
    await uploadBytes(fileRef, file);
    return await getDownloadURL(fileRef);
}

async function createPost(postData) {
    const postsRef = ref(db, 'portfolio_posts');
    await push(postsRef, postData);
}

async function loadPortfolioFeed() {
    const feedContainer = document.getElementById('portfolio-feed');
    const postsRef = ref(db, 'portfolio_posts');
    
    try {
        const snapshot = await get(postsRef);
        const posts = [];
        
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                posts.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
        }
        
        // Sort by timestamp (newest first)
        posts.sort((a, b) => b.timestamp - a.timestamp);
        
        // Render posts
        feedContainer.innerHTML = posts.map(post => renderPost(post)).join('');
        
        // Add event listeners to endorsement buttons
        posts.forEach(post => {
            const endorseBtn = document.getElementById(`endorse-${post.id}`);
            if (endorseBtn) {
                endorseBtn.addEventListener('click', () => toggleEndorsement(post.id));
            }
        });
        
    } catch (error) {
        console.error('Error loading portfolio feed:', error);
    }
}

function renderPost(post) {
    const isEndorsed = post.endorsements && post.endorsements.includes(currentUserId);
    const endorsementCount = post.endorsements ? post.endorsements.length : 0;
    
    // Determine card type based on content
    let cardType = 'text-only';
    if (post.mediaUrl && post.content) {
        cardType = post.mediaType === 'image' ? 'image-text' : 'video-text';
    } else if (post.mediaUrl && !post.content) {
        cardType = post.mediaType === 'image' ? 'image-only' : 'video-only';
    }
    
    return `
        <div class="portfolio-card ${cardType}">
            ${post.mediaUrl ? `
                <div class="card-media">
                    ${post.mediaType === 'image' 
                        ? `<img src="${post.mediaUrl}" alt="Post media">`
                        : `<video src="${post.mediaUrl}" controls></video>`
                    }
                </div>
            ` : ''}
            
            <div class="card-content">
                <div class="card-header">
                    <img src="../assets/avatar/1.png" 
                         alt="Avatar" class="card-avatar" 
                         id="post-avatar-${post.id}"
                         onload="loadPostAvatar('${post.authorId}', '${post.id}')">
                    <div class="card-author-info">
                        <div class="card-author-name">${post.authorName}</div>
                        <div class="card-timestamp">${formatTimestamp(post.timestamp)}</div>
                    </div>
                    ${post.authorId === currentUserId ? `
                        <div class="card-actions-menu">
                            <button class="card-menu-btn" onclick="toggleCardMenu('${post.id}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="card-dropdown" id="dropdown-${post.id}">
                                <button class="card-dropdown-item" onclick="editPost('${post.id}')">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                                <button class="card-dropdown-item delete" onclick="deletePost('${post.id}')">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${post.content ? `<div class="card-text">${post.content}</div>` : ''}
            </div>
            
            <div class="card-footer">
                <div class="card-stats">
                    ${endorsementCount} endorsement${endorsementCount !== 1 ? 's' : ''}
                </div>
                <div class="card-actions">
                    <button class="card-action-btn ${isEndorsed ? 'endorsed' : ''}" id="endorse-${post.id}">
                        <i class="fas fa-heart"></i>
                        ${isEndorsed ? 'Endorsed' : 'Endorse'}
                    </button>
                </div>
            </div>
            
            ${endorsementCount > 0 ? `
                <div class="card-endorsements">
                    <div class="endorsements-title">Endorsed by:</div>
                    <div class="endorsements-list">
                        ${post.endorsements.map(userId => `
                            <div class="endorsement-item">User ${userId.slice(0, 8)}...</div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// Function to load profile photo for posts
async function loadPostAvatar(authorId, postId) {
    try {
        const profilePhotoRef = storageRef(storage, `profile/${authorId}.webp`);
        const profilePhotoUrl = await getDownloadURL(profilePhotoRef);
        const avatarImg = document.getElementById(`post-avatar-${postId}`);
        if (avatarImg) {
            avatarImg.src = profilePhotoUrl;
        }
    } catch (error) {
        // If profile photo doesn't exist, keep the default avatar
        console.log(`No profile photo found for user ${authorId}`);
    }
}

function formatTimestamp(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    
    return new Date(timestamp).toLocaleDateString();
}

async function toggleEndorsement(postId) {
    const postsRef = ref(db, `portfolio_posts/${postId}`);
    
    try {
        const snapshot = await get(postsRef);
        const post = snapshot.val();
        let endorsements = post.endorsements || [];
        
        const userIndex = endorsements.indexOf(currentUserId);
        if (userIndex > -1) {
            endorsements.splice(userIndex, 1);
        } else {
            endorsements.push(currentUserId);
        }
        
        await set(ref(db, `portfolio_posts/${postId}/endorsements`), endorsements);
        loadPortfolioFeed(); // Reload to update UI
        
    } catch (error) {
        console.error('Error toggling endorsement:', error);
    }
}

async function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post?')) {
        try {
            await set(ref(db, `portfolio_posts/${postId}`), null);
            loadPortfolioFeed();
        } catch (error) {
            alert('Failed to delete post: ' + error.message);
        }
    }
}

// Profile loading function
async function loadProfileData(userId) {
    try {
        // First, try to load profile photo from Firebase Storage
        try {
            const profilePhotoRef = storageRef(storage, `profile/${userId}.webp`);
            const profilePhotoUrl = await getDownloadURL(profilePhotoRef);
            document.getElementById('profile-pic').src = profilePhotoUrl;
        } catch (storageError) {
            // If profile photo doesn't exist in storage, use default avatar
            console.log('No profile photo found in storage, using default avatar');
        document.getElementById('profile-pic').src = '../assets/avatar/1.png';
        }

        const snapshot = await get(ref(db, `studentslist/${userId}`));
        const data = snapshot.val();

        if (data) {
            // Personal Information
            document.getElementById('name').value = data.personal?.name || '';
            document.getElementById('email').value = data.personal?.email || '';
            document.getElementById('whatsapp').value = data.personal?.whatsapp || '';
            document.getElementById('gender').value = data.personal?.gender || '';
            document.getElementById('location').value = data.personal?.location || '';
            document.getElementById('linkedin').value = data.personal?.linkedin || '';
            document.getElementById('about').value = data.personal?.about || '';

            // Educational Information
            document.getElementById('college').value = data.education?.college || '';
            document.getElementById('degree').value = data.education?.degree || '';
            document.getElementById('branch').value = data.education?.branch || '';
            document.getElementById('year').value = data.education?.year || '';
            document.getElementById('cgpa').value = data.education?.cgpa || '';
            document.getElementById('graduation').value = data.education?.graduation || '';
            document.getElementById('achievements').value = data.education?.achievements || '';

            // Professional Information
            document.getElementById('skills').value = data.skills || '';
            document.getElementById('workExperience').value = data.experience || '';
            document.getElementById('roles').value = data.roles || '';
            document.getElementById('headline').value = data.headline || '';

        } else {
            // Set default values for empty profile
            ['name', 'email', 'whatsapp', 'location', 'linkedin', 'about', 'college', 
             'branch', 'cgpa', 'graduation', 'achievements', 'skills', 
             'roles'].forEach(id => {
                document.getElementById(id).value = '';
            });
            ['gender', 'degree', 'year', 'experience'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
    } catch (error) {
        console.error("Error loading profile:", error);
        alert(`Failed to load profile: ${error.message}`);
    }
}

// Make functions globally available for onclick handlers
window.deletePost = deletePost;
window.toggleEndorsement = toggleEndorsement;
window.loadPostAvatar = loadPostAvatar;
window.toggleCardMenu = toggleCardMenu;
window.editPost = editPost;

// Dropdown menu functionality
function toggleCardMenu(postId) {
    const dropdown = document.getElementById(`dropdown-${postId}`);
    const allDropdowns = document.querySelectorAll('.card-dropdown');
    
    // Close all other dropdowns
    allDropdowns.forEach(dd => {
        if (dd !== dropdown) {
            dd.classList.remove('active');
        }
    });
    
    // Toggle current dropdown
    dropdown.classList.toggle('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.card-actions-menu')) {
        const allDropdowns = document.querySelectorAll('.card-dropdown');
        allDropdowns.forEach(dd => dd.classList.remove('active'));
    }
});

// Edit post functionality
async function editPost(postId) {
    try {
        const postsRef = ref(db, `portfolio_posts/${postId}`);
        const snapshot = await get(postsRef);
        const post = snapshot.val();
        
        if (post) {
            // Populate the create post form with existing data
            document.getElementById('post-content').value = post.content || '';
            
            // If there's media, show it in preview
            if (post.mediaUrl) {
                const preview = document.getElementById('post-media-preview');
                const previewImage = document.getElementById('preview-image');
                const previewVideo = document.getElementById('preview-video');
                
                preview.style.display = 'block';
                
                if (post.mediaType === 'image') {
                    previewImage.style.display = 'block';
                    previewVideo.style.display = 'none';
                    previewImage.src = post.mediaUrl;
                } else {
                    previewVideo.style.display = 'block';
                    previewImage.style.display = 'none';
                    previewVideo.src = post.mediaUrl;
                }
                
                selectedFile = null; // Clear selected file since we're editing
                selectedFileType = post.mediaType;
            }
            
            // Switch to portfolio tab
            document.getElementById('portfolio-tab-btn').click();
            
            // Scroll to create post section
            document.querySelector('.create-post-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // Change create button to update button
            const createBtn = document.getElementById('create-post-btn');
            createBtn.innerHTML = '<i class="fas fa-save"></i> Update Post';
            createBtn.onclick = () => updatePost(postId);
            
            // Close dropdown
            document.getElementById(`dropdown-${postId}`).classList.remove('active');
            
        }
    } catch (error) {
        console.error('Error loading post for editing:', error);
        alert('Failed to load post for editing: ' + error.message);
    }
}

// Update post functionality
async function updatePost(postId) {
    const content = document.getElementById('post-content').value.trim();
    const hasExistingMedia = document.getElementById('preview-image').style.display !== 'none' || 
                            document.getElementById('preview-video').style.display !== 'none';
    
    if (!content && !selectedFile && !hasExistingMedia) {
        alert('Please add some content or media to your post.');
        return;
    }
    
    try {
        showLoadingOverlay('Updating post...', 0);
        
        let mediaUrl = null;
        let mediaType = null;
        
        // Check if there's new media to upload
        if (selectedFile) {
            setLoadingBar(25);
            const fileRef = storageRef(storage, `portfolio/${currentUserId}_${Date.now()}_${selectedFile.name}`);
            const uploadTask = uploadBytes(fileRef, selectedFile);
            setLoadingBar(50);
            await uploadTask;
            mediaUrl = await getDownloadURL(fileRef);
            mediaType = selectedFileType;
            setLoadingBar(75);
        } else {
            // Keep existing media if no new media is selected
            const postsRef = ref(db, `portfolio_posts/${postId}`);
            const snapshot = await get(postsRef);
            const post = snapshot.val();
            mediaUrl = post.mediaUrl;
            mediaType = post.mediaType;
        }
        
        const updateData = {
            content: content,
            mediaUrl: mediaUrl,
            mediaType: mediaType,
            lastEdited: Date.now()
        };
        
        // Update the post
        await set(ref(db, `portfolio_posts/${postId}`), {
            ...updateData,
            authorId: currentUserId,
            timestamp: Date.now(),
            endorsements: [],
            authorName: document.getElementById('name').value || 'Anonymous'
        });
        
        setLoadingBar(100);
        hideLoadingOverlay();
        
        // Reset form
        document.getElementById('post-content').value = '';
        document.getElementById('post-media-preview').style.display = 'none';
        selectedFile = null;
        selectedFileType = null;
        
        // Reset create button
        const createBtn = document.getElementById('create-post-btn');
        createBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post';
        createBtn.onclick = document.getElementById('create-post-btn').onclick; // Restore original handler
        
        // Reload feed
        loadPortfolioFeed();
        
        alert('Post updated successfully!');
        
    } catch (error) {
        hideLoadingOverlay();
        alert('Failed to update post: ' + error.message);
    }
}

function showLoadingOverlay(text = 'Uploading...', progress = 0) {
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-text').textContent = text;
    setLoadingBar(progress);
}

function hideLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function setLoadingBar(progress) {
    document.getElementById('loading-bar').style.width = `${progress}%`;
    }

    // Social Accounts logic
    function getSocialLinksFromForm() {
        return {
            linkedin: document.getElementById('social-linkedin').value.trim(),
            github: document.getElementById('social-github').value.trim(),
            leetcode: document.getElementById('social-leetcode').value.trim(),
            codeforces: document.getElementById('social-codeforces').value.trim()
        };
    }

    function setSocialLinksToForm(socials) {
        document.getElementById('social-linkedin').value = socials?.linkedin || '';
        document.getElementById('social-github').value = socials?.github || '';
        document.getElementById('social-leetcode').value = socials?.leetcode || '';
        document.getElementById('social-codeforces').value = socials?.codeforces || '';
    }

    document.getElementById('social-accounts-form').onsubmit = async (e) => {
        e.preventDefault();
        const socials = getSocialLinksFromForm();
        try {
            showLoadingOverlay('Saving social accounts...', 0);
            await set(ref(db, `studentslist/${currentUserId}/socials`), socials);
            setLoadingBar(100);
            hideLoadingOverlay();
            alert('Social accounts saved!');
        } catch (err) {
            hideLoadingOverlay();
            alert('Failed to save social accounts: ' + err.message);
        }
    };

    async function loadSocialLinks(userId) {
        try {
            const snapshot = await get(ref(db, `studentslist/${userId}/socials`));
            setSocialLinksToForm(snapshot.exists() ? snapshot.val() : {});
        } catch (err) {
            setSocialLinksToForm({});
        }
    }

    // === Google Drive Portfolio Thumbnails Integration (moved here for shared scope) ===
const API_KEY = 'AIzaSyCkrrOkjd6ilFJOR96-Wk-id6rFM_WPgHQ';
    let USER_DRIVE_FOLDER_ID = null;

async function loadDrivePortfolio() {
      // If no folder ID, show setup UI
      if (!USER_DRIVE_FOLDER_ID) {
        document.getElementById('portfolio-synced-indicator').style.display = 'none';
        document.getElementById('drive-setup-container').style.display = 'block';
        document.getElementById('drive-thumbnails').style.display = 'none';
        return;
      }
      // Show synced indicator
      document.getElementById('portfolio-synced-indicator').style.display = 'flex';
      document.getElementById('drive-setup-container').style.display = 'none';
      document.getElementById('drive-thumbnails').style.display = 'grid';
  let files = [];
  let pageToken = '';
  do {
        let url = `https://www.googleapis.com/drive/v3/files?q='${USER_DRIVE_FOLDER_ID}'+in+parents+and+trashed=false&fields=nextPageToken,files(id,name,thumbnailLink,webViewLink,mimeType)&key=${API_KEY}&pageSize=1000`;
    if (pageToken) url += `&pageToken=${pageToken}`;
    const response = await fetch(url);
    const data = await response.json();
    files = files.concat(data.files || []);
    pageToken = data.nextPageToken;
  } while (pageToken);

  const container = document.getElementById('drive-thumbnails');
  if (!container) return;
  container.innerHTML = '';

  if (files.length === 0) {
    container.innerHTML = '<div style="color:#888;">No files found in portfolio.</div>';
    return;
  }

  files.forEach(file => {
    // Skip folders
    if (file.mimeType === 'application/vnd.google-apps.folder') return;
    const thumb = file.thumbnailLink || 'https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png';
    const fileDiv = document.createElement('a');
    fileDiv.href = file.webViewLink;
    fileDiv.target = '_blank';
    fileDiv.className = 'portfolio-thumb';
    fileDiv.innerHTML = `
      <img src="${thumb}" alt="${file.name}">
      <div class="thumb-title">${file.name}</div>
    `;
    container.appendChild(fileDiv);
  });
}

    // Edit button handler - show modal
    document.getElementById('edit-drive-folder-btn').addEventListener('click', function() {
      // Pre-fill the current folder link if available
      if (USER_DRIVE_FOLDER_ID) {
        document.getElementById('edit-drive-folder-link').value = `https://drive.google.com/drive/folders/${USER_DRIVE_FOLDER_ID}`;
      }
      document.getElementById('edit-portfolio-modal').style.display = 'flex';
    });

    // Close modal handlers
    document.getElementById('close-edit-modal').addEventListener('click', function() {
      document.getElementById('edit-portfolio-modal').style.display = 'none';
    });

    // Close modal when clicking backdrop
    document.getElementById('edit-portfolio-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });

    // Update folder handler
    document.getElementById('update-drive-folder-btn').addEventListener('click', async function() {
      if (!currentUserId) {
        alert('You must be logged in to update your portfolio folder.');
        return;
      }
      const link = document.getElementById('edit-drive-folder-link').value.trim();
      const folderId = extractDriveFolderId(link);
      if (!folderId) {
        alert('Invalid Google Drive folder link.');
        return;
      }
      try {
        showLoadingOverlay('Updating portfolio folder...', 0);
        await set(ref(db, `studentslist/${currentUserId}/driveFolderId`), folderId);
        USER_DRIVE_FOLDER_ID = folderId;
        setLoadingBar(100);
        hideLoadingOverlay();
        alert('Portfolio folder updated!');
        // Close modal and refresh
        document.getElementById('edit-portfolio-modal').style.display = 'none';
        loadDrivePortfolio();
      } catch (err) {
        hideLoadingOverlay();
        alert('Failed to update folder: ' + err.message);
      }
    });

    // After saving, show indicator again
    async function saveDriveFolderId() {
      if (!currentUserId) {
        alert('You must be logged in to save your portfolio folder.');
        return;
      }
      const link = document.getElementById('drive-folder-link').value.trim();
      const folderId = extractDriveFolderId(link);
      if (!folderId) {
        alert('Invalid Google Drive folder link.');
        return;
      }
      try {
        showLoadingOverlay('Saving portfolio folder...', 0);
        await set(ref(db, `studentslist/${currentUserId}/driveFolderId`), folderId);
        USER_DRIVE_FOLDER_ID = folderId;
        setLoadingBar(100);
        hideLoadingOverlay();
        alert('Portfolio folder saved!');
        // Show indicator after saving
        document.getElementById('portfolio-synced-indicator').style.display = 'flex';
        document.getElementById('drive-setup-container').style.display = 'none';
        document.getElementById('drive-thumbnails').style.display = 'grid';
        loadDrivePortfolio();
      } catch (err) {
        hideLoadingOverlay();
        alert('Failed to save folder: ' + err.message);
      }
    }

    // Extract folder ID from Google Drive link
    function extractDriveFolderId(link) {
      // Handles links like https://drive.google.com/drive/folders/{id} and sharing links
      const match = link.match(/[-\w]{25,}/);
      return match ? match[0] : null;
    }

    // On Portfolio tab show, load folder ID from Firebase if not loaded
    async function ensureDriveFolderIdLoaded() {
      if (typeof currentUserId === 'undefined' || !currentUserId) return;
      try {
        const snapshot = await get(ref(db, `studentslist/${currentUserId}/driveFolderId`));
        USER_DRIVE_FOLDER_ID = snapshot.exists() ? snapshot.val() : null;
        loadDrivePortfolio();
      } catch (err) {
        USER_DRIVE_FOLDER_ID = null;
        loadDrivePortfolio();
      }
    }

    document.getElementById('portfolio-tab-btn').addEventListener('click', ensureDriveFolderIdLoaded);
    // === End Google Drive Portfolio Integration ===

    // Remove the cancel event listener and add remove portfolio functionality
    document.getElementById('remove-portfolio-btn').addEventListener('click', async function() {
      if (!currentUserId) {
        alert('You must be logged in to remove your portfolio folder.');
        return;
      }
      if (confirm('Are you sure you want to remove your portfolio folder? This will unlink your Google Drive folder and hide your portfolio files.')) {
        try {
          showLoadingOverlay('Removing portfolio folder...', 0);
          await set(ref(db, `studentslist/${currentUserId}/driveFolderId`), null);
          USER_DRIVE_FOLDER_ID = null;
          setLoadingBar(100);
          hideLoadingOverlay();
          alert('Portfolio folder removed!');
          // Close modal and show setup UI
          document.getElementById('edit-portfolio-modal').style.display = 'none';
          document.getElementById('portfolio-synced-indicator').style.display = 'none';
          document.getElementById('drive-setup-container').style.display = 'block';
          document.getElementById('drive-thumbnails').style.display = 'none';
        } catch (err) {
          hideLoadingOverlay();
          alert('Failed to remove folder: ' + err.message);
        }
      }
    });

    // === Invite to Connect Popup ===
    // Invite Connect Popup Modal
    const inviteConnectModal = document.createElement('div');
    inviteConnectModal.id = 'invite-connect-modal';
    inviteConnectModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        backdrop-filter: blur(8px);
    `;
    
    inviteConnectModal.innerHTML = `
        <div style="
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 0;
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        ">
            <!-- macOS-style title bar -->
            <div style="
                background: rgba(248, 249, 250, 0.8);
                padding: 12px 20px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: space-between;
                backdrop-filter: blur(10px);
            ">
                <h2 style="
                    margin: 0;
                    font-size: 16px;
                    font-weight: 500;
                    color: #1d1d1f;
                    flex: 1;
                    text-align: center;
                ">Invite to Connect</h2>
                
                <button id="close-invite-modal" style="
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: #6e6e73;
                    padding: 4px 8px;
                    border-radius: 6px;
                    transition: all 0.2s;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 32px;
                    height: 32px;
                " onmouseover="this.style.background='rgba(0, 0, 0, 0.1)'; this.style.color='#1d1d1f'" onmouseout="this.style.background='none'; this.style.color='#6e6e73'" onclick="closeInviteModal()">×</button>
            </div>
            
            <!-- Modal content -->
            <div style="padding: 32px;">
                <div style="text-align: center; margin-bottom: 24px;">
                    <p style="
                        color: #6e6e73;
                        margin-bottom: 24px;
                        font-size: 15px;
                        line-height: 1.5;
                        font-weight: 400;
                    ">Share this QR code or link to connect with Employers on Taska</p>
                    
                    <div id="qr-code-container" style="
                        display: inline-block;
                        padding: 24px;
                        background: rgba(248, 249, 250, 0.8);
                        border-radius: 16px;
                        margin-bottom: 24px;
                        border: 1px solid rgba(0, 0, 0, 0.08);
                        backdrop-filter: blur(10px);
                    ">
                        <div id="qr-code" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="
                            display: block;
                            text-align: left;
                            font-weight: 500;
                            color: #1d1d1f;
                            margin-bottom: 8px;
                            font-size: 14px;
                        ">Invite Link</label>
                        <div style="
                            display: flex;
                            gap: 8px;
                            align-items: center;
                        ">
                            <input type="text" id="invite-link" readonly style="
                                flex: 1;
                                padding: 12px 16px;
                                border: 1px solid rgba(0, 0, 0, 0.1);
                                border-radius: 8px;
                                font-size: 14px;
                                background: rgba(248, 249, 250, 0.8);
                                color: #6e6e73;
                                font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                                outline: none;
                                transition: all 0.2s;
                            " onfocus="this.style.borderColor='#007aff'; this.style.boxShadow='0 0 0 3px rgba(0, 122, 255, 0.1)'" onblur="this.style.borderColor='rgba(0, 0, 0, 0.1)'; this.style.boxShadow='none'">
                            <button id="copy-link-btn" style="
                                padding: 12px 20px;
                                background: #007aff;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                font-size: 14px;
                                transition: all 0.2s;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                white-space: nowrap;
                            " onmouseover="this.style.background='#0056cc'" onmouseout="this.style.background='#007aff'">Copy</button>
                        </div>
                    </div>
                    
                    <div style="
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        flex-wrap: wrap;
                    ">
                        <button id="share-whatsapp-btn" style="
                            padding: 12px 20px;
                            background: #25d366;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        " onmouseover="this.style.background='#128c7e'" onmouseout="this.style.background='#25d366'">
                            <i class="fab fa-whatsapp" style="font-size: 16px;"></i>
                            WhatsApp
                        </button>
                        
                        <button id="share-email-btn" style="
                            padding: 12px 20px;
                            background: #007aff;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        " onmouseover="this.style.background='#0056cc'" onmouseout="this.style.background='#007aff'">
                            <i class="fas fa-envelope" style="font-size: 14px;"></i>
                            Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(inviteConnectModal);
    
    // Event listeners for invite modal
    document.getElementById('invite-connect-btn').addEventListener('click', function() {
        openInviteModal();
    });
    
    // Add back the close button event listener
    document.getElementById('close-invite-modal').addEventListener('click', function() {
        closeInviteModal();
    });
    
    inviteConnectModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeInviteModal();
        }
    });
    
    document.getElementById('copy-link-btn').addEventListener('click', function() {
        copyInviteLink();
    });
    
    document.getElementById('share-whatsapp-btn').addEventListener('click', function() {
        shareViaWhatsApp();
    });
    
    document.getElementById('share-email-btn').addEventListener('click', function() {
        shareViaEmail();
    });
    
    function openInviteModal() {
        console.log('openInviteModal called');
        if (!currentUserId) {
            alert('You must be logged in to generate an invite link.');
            return;
        }
        
        // Check if current user is a student or professional
        // Students are in studentslist, professionals are in professionalslist
        checkUserRoleAndGenerateLink();
    }
    
    async function checkUserRoleAndGenerateLink() {
        try {
            // Check if user exists in studentslist
            const studentSnapshot = await get(ref(db, `studentslist/${currentUserId}`));
            const professionalSnapshot = await get(ref(db, `professionalslist/${currentUserId}`));
            
            let inviteLink;
            if (studentSnapshot.exists()) {
                // User is a student - invite to checkinvite.html
                inviteLink = `${window.location.origin}/checkinvite.html?invite=${currentUserId}`;
            } else if (professionalSnapshot.exists()) {
                // User is a professional - invite to checkinvite.html
                inviteLink = `${window.location.origin}/checkinvite.html?invite=${currentUserId}`;
            } else {
                // User not found in either list
                alert('User role not found. Please try again.');
                return;
            }
            
            document.getElementById('invite-link').value = inviteLink;
            
            // Show modal first
            inviteConnectModal.style.display = 'flex';
            
            // Generate QR code with a small delay to ensure library is loaded
            setTimeout(() => {
                generateQRCode(inviteLink);
            }, 100);
            
        } catch (error) {
            console.error('Error checking user role:', error);
            alert('Failed to generate invite link. Please try again.');
        }
    }
    
    function closeInviteModal() {
        inviteConnectModal.style.display = 'none';
    }
    
    function generateQRCode(text) {
        const qrContainer = document.getElementById('qr-code');
        qrContainer.innerHTML = '';
        
        console.log('Generating QR code for:', text);
        console.log('QRCode library available:', typeof QRCode !== 'undefined');
        
        // Check if QRCode library is available
        if (typeof QRCode === 'undefined') {
            console.warn('QRCode library not loaded, showing fallback');
            qrContainer.innerHTML = `
                <div style="
                    width: 200px; 
                    height: 200px; 
                    background: #f8f9fa; 
                    border: 2px dashed #dadce0; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: #5f6368; 
                    font-size: 0.875rem; 
                    text-align: center;
                    padding: 1rem;
                ">
                    QR Code not available<br>
                    Please use the invite link below
                </div>
            `;
            return;
        }
        
        try {
            // Create QR code using qrcodejs library
            new QRCode(qrContainer, {
                text: text,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#FFFFFF',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            console.log('QR code generated successfully');
        } catch (error) {
            console.error('Exception in QR code generation:', error);
            qrContainer.innerHTML = `
                <div style="
                    width: 200px; 
                    height: 200px; 
                    background: #f8f9fa; 
                    border: 2px dashed #dadce0; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: #5f6368; 
                    font-size: 0.875rem; 
                    text-align: center;
                    padding: 1rem;
                ">
                    QR Code generation failed<br>
                    Please use the invite link below
                </div>
            `;
        }
    }
    
    function copyInviteLink() {
        const inviteLink = document.getElementById('invite-link');
        inviteLink.select();
        inviteLink.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
            const copyBtn = document.getElementById('copy-link-btn');
            const originalText = copyBtn.textContent;
            const originalBackground = copyBtn.style.background;
            
            copyBtn.textContent = 'Copied!';
            copyBtn.style.background = '#34c759';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = originalBackground || '#007aff';
            }, 2000);
        } catch (err) {
            alert('Failed to copy link. Please copy it manually.');
        }
    }
    
    function shareViaWhatsApp() {
        const inviteLink = document.getElementById('invite-link').value;
        const message = `Hi! I'd like to connect with you on Taska. Here's my invite link: ${inviteLink}`;
        
        // Use WhatsApp Web API to open WhatsApp directly
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        
        // Open WhatsApp in a new window/tab
        window.open(whatsappUrl, '_blank');
    }
    
    function shareViaEmail() {
        const inviteLink = document.getElementById('invite-link').value;
        const subject = 'Connect with me on Taska';
        const body = `Hi! I'd like to connect with you on Taska. Here's my invite link: ${inviteLink}`;
        const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(emailUrl);
    }
    
    // Check for invite parameter in URL when page loads
    function checkForInvite() {
        const urlParams = new URLSearchParams(window.location.search);
        const inviteId = urlParams.get('invite');
        
        if (inviteId && currentUserId && inviteId !== currentUserId) {
            // Show connection request dialog
            showConnectionRequest(inviteId);
        }
    }
    
    async function showConnectionRequest(inviteId) {
        try {
            // Get the inviter's profile data
            const snapshot = await get(ref(db, `studentslist/${inviteId}`));
            if (snapshot.exists()) {
                const inviterData = snapshot.val();
                const inviterName = inviterData.personal?.name || 'A student';
                
                if (confirm(`${inviterName} wants to connect with you on Taska. Would you like to accept this connection request?`)) {
                    await sendConnectionRequest(inviteId);
                    alert('Connection request sent! You can now collaborate on tasks together.');
                }
            }
        } catch (error) {
            console.error('Error processing invite:', error);
        }
    }
    
    async function sendConnectionRequest(inviteId) {
        try {
            // Create connection records for both users
            const connectionData = {
                status: 'connected',
                timestamp: new Date().toISOString()
            };
            
            await set(ref(db, `users/${currentUserId}/connections/${inviteId}`), connectionData);
            await set(ref(db, `users/${inviteId}/connections/${currentUserId}`), connectionData);
            
        } catch (error) {
            console.error('Error sending connection request:', error);
            throw error;
        }
    }
    
    // Call checkForInvite when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // This will be called after the page loads and currentUserId is set
        setTimeout(checkForInvite, 1000);
    });
    
    // === End Invite to Connect Popup ===
</script>
</body>
</html>