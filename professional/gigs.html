<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska - Task Assignment</title>
    <link rel="stylesheet" href="css/gigs.css">
    
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/classified-navbar.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Clean, Minimal Design */
        body {
            background: #fafafa;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Remove old navbar styles - now using classified-navbar.css */
        
        .gigs-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1rem;
            align-items: start;
            margin-top: 90px; /* Adjust for navbar height (1rem top + 1rem bottom padding + content) */
            background: #f8f9fa;
            border: none;
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        /* Assigned Tasks Section - macOS Style */
        .active-gigs {
            background: #ffffff;
            border: 1px solid #e9ecef;
            padding: 1.5rem;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            margin-bottom: 0;
        }

        .active-gigs h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 1.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            letter-spacing: -0.025em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        /* Create Task Button - macOS Style */
        .gigs-actions {
            position: sticky;
            top: 2rem;
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 12px !important;
        }

        .action-card.create-task {
            background: #ffffff;
            border: 1px solid #e9ecef;
            padding: 1.5rem;
            text-align: center;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            margin: 0;
            transition: all 0.2s ease;
        }

        .action-card.create-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .action-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.025em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .action-card p {
            color: #86868b;
            font-size: 0.9rem;
            margin: 0 0 1rem 0;
            line-height: 1.4;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .action-btn.create-btn {
            background: #007aff;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .action-btn.create-btn:hover {
            background: #0056cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* Task Cards - macOS Style Design */
        .gig-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
            border-radius: 12px !important;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .gig-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: rgba(0, 122, 255, 0.3);
        }

        .gig-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            position: relative;
            background: #f8f9fa;
        }

        .gig-title-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .gig-info {
            flex: 1;
        }

        .gig-info h4 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.025em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .gig-description {
            color: #86868b;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0 0 1rem 0;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .gig-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .gig-category {
            background: #f1f3f4;
            color: #1d1d1f;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: capitalize;
            border-radius: 6px !important;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .deadline-info {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px !important;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .deadline-info.urgent {
            background: #ff3b30;
            color: #ffffff;
            border: none;
        }

        .deadline-info.warning {
            background: #ff9500;
            color: #ffffff;
            border: none;
        }

        .deadline-info.normal {
            background: #34c759;
            color: #ffffff;
            border: none;
        }

        .gig-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .assignment-info {
            background: #f8f9fa;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px !important;
        }

        .primary-assignment, .waitlist-info {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .primary-assignment strong {
            color: #34c759;
            font-weight: 600;
        }

        .waitlist-info strong {
            color: #007aff;
            font-weight: 600;
        }

        .view-details-btn {
            background: #007aff;
            color: #ffffff;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .view-details-btn:hover {
            background: #0056cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* Task Details Section - macOS Style */
        .gig-details {
            padding: 1.5rem;
            background: #ffffff;
            border-top: 1px solid #e9ecef;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .detail-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 1rem;
            border-radius: 8px !important;
        }

        .detail-section h5 {
            margin: 0 0 0.75rem 0;
            color: #1d1d1f;
            font-size: 0.95rem;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
            letter-spacing: -0.025em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .detail-item {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.9rem;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .detail-item strong {
            color: #1d1d1f;
            font-weight: 600;
            min-width: 100px;
            display: inline-block;
        }

        .student-detail {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
            border-radius: 8px !important;
            transition: all 0.2s ease;
        }

        .student-detail:hover {
            background: #f8f9fa;
            border-color: #007aff;
        }

        .student-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50% !important;
            border: 2px solid #e9ecef;
        }

        .student-name {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 0.9rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .student-status {
            font-size: 0.8rem;
            color: #86868b;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .student-status.accepted {
            color: #34c759;
            font-weight: 600;
        }

        .student-status.rejected {
            color: #ff3b30;
            font-weight: 600;
        }

        .student-status.pending {
            color: #ff9500;
            font-weight: 600;
        }

        .student-status.waitlist {
            color: #007aff;
            font-weight: 600;
        }

        .student-status.no-primary,
        .student-status.removed,
        .student-status.unknown {
            color: #86868b;
            font-style: italic;
        }

        .student-status i {
            margin-right: 0.25rem;
        }

        .files-section {
            margin-top: 1rem;
        }

        .files-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px !important;
            text-decoration: none;
            color: #1d1d1f;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .file-item:hover {
            background: #f8f9fa;
            border-color: #007aff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-item i {
            color: #007aff;
        }

        /* Action Buttons - macOS Style */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .delete-task-btn {
            background: #ff3b30;
            color: #ffffff;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .delete-task-btn:hover {
            background: #d70015;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .edit-task-btn {
            background: #34c759;
            color: #ffffff;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .edit-task-btn:hover {
            background: #28a745;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        /* Three Dot Menu - macOS Style */
        .three-dot-menu {
            position: relative;
            display: inline-block;
        }

        .three-dot-btn {
            background: #f1f3f4;
            border: none;
            color: #5f6368;
            padding: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50% !important;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .three-dot-btn:hover {
            background: #e8eaed;
            color: #1d1d1f;
            transform: scale(1.05);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            min-width: 150px;
            z-index: 1000;
            display: none;
            margin-top: 0.25rem;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #1d1d1f;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400;
            border-radius: 0;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.edit {
            color: #34c759;
            font-weight: 500;
        }

        .dropdown-item.delete {
            color: #ff3b30;
            font-weight: 500;
        }

        .dropdown-item i {
            width: 16px;
        }

        /* Modal Styles - Clean */
        .gig-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .gig-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border: 1px solid #e0e0e0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .large-modal {
            max-width: 900px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-actions {
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .cancel-btn {
            background: #f1f3f4;
            color: #333;
            border: 1px solid #e0e0e0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .edit-btn, .save-btn, .confirm-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1a73e8;
        }

        /* Priority Management - Vertical List Design */
        .priority-management {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .priority-list {
            background: #ffffff;
            border: 2px solid #808080;
            border-radius: 0 !important;
            overflow: hidden;
            box-shadow: 1px 1px 0 #ffffff inset;
        }

        .priority-header {
            background: #000080;
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            font-family: 'Segoe UI', 'Microsoft Sans Serif', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .primary-student-section {
            background: #f0f8f0;
            border-bottom: 1px solid #808080;
            padding: 1rem;
        }

        .primary-student-section h4 {
            margin: 0 0 0.75rem 0;
            color: #008000;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            font-family: 'Segoe UI', 'Microsoft Sans Serif', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .primary-student-section h4 i {
            color: #008000;
        }

        .waitlist-section {
            padding: 1rem;
            background: #ffffff;
        }

        .waitlist-section h4 {
            margin: 0 0 0.75rem 0;
            color: #000080;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            font-family: 'Segoe UI', 'Microsoft Sans Serif', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .waitlist-section h4 i {
            color: #007aff !important;
        }

        .student-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .student-item:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .student-item:last-child {
            margin-bottom: 0;
        }

        /* Remove drag-related styles and add up/down arrow styles */
        .reorder-controls {
            display: flex;
            flex-direction: row;
            gap: 0.25rem;
            margin-left: auto;
            align-items: center;
        }

        .reorder-btn {
            background: #f1f3f4;
            color: #666;
            border: 1px solid #e0e0e0;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .reorder-btn:hover {
            background: #e9ecef;
            color: #1a73e8;
            border-color: #1a73e8;
        }

        .reorder-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .reorder-btn:disabled:hover {
            background: #f1f3f4;
            color: #666;
            border-color: #e0e0e0;
        }

        /* Remove button styles */
        .remove-btn {
            background: #ff3b30;
            color: #ffffff;
            border: none;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease;
            margin-left: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #d70015;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            flex-shrink: 0;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .student-position {
            font-size: 0.8rem;
            color: #666;
        }

        .primary-badge {
            background: #137333;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: auto;
        }

        .waitlist-badge {
            background: #1a73e8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: auto;
        }

        .empty-state {
            text-align: center;
            padding: 1rem;
            color: #666;
            font-style: italic;
        }

        .change-priority-btn {
            background: #f1f3f4;
            color: #333;
            border: 1px solid #e0e0e0;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 0.75rem;
            transition: all 0.2s;
        }

        .change-priority-btn:hover {
            background: #e9ecef;
            border-color: #1a73e8;
        }

        /* Remove drag over effects and replace with simple hover effects */
        .primary-student-section,
        .waitlist-section {
            transition: background 0.2s;
        }

        .primary-student-section:hover,
        .waitlist-section:hover {
            background: #f8f9fa;
        }

        /* Remove drag & drop styles and replace with simple card styles */
        .draggable-student {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #e0e0e0;
            margin-bottom: 0.25rem;
            transition: background 0.2s;
        }

        .draggable-student:hover {
            background: #f8f9fa;
        }

        .drop-zone {
            min-height: 40px;
            border: 1px solid #e0e0e0;
            margin: 0.5rem 0;
            transition: border-color 0.2s;
            background: #f8f9fa;
        }

        .priority-instructions {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .priority-instructions p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem 2rem;
            }

            .navbar .logo {
                font-size: 1.5rem;
            }

            .navbar .nav-menu {
                display: none;
            }

            .navbar .hamburger {
                display: block;
            }

            .gigs-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
                margin-top: 90px; /* Keep same margin as desktop */
            }

            .gig-actions {
                top: 0.75rem;
                right: 0.75rem;
            }

            .three-dot-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .dropdown-menu {
                right: 0;
                left: auto;
                min-width: 140px;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }
        }

        /* No tasks message - Windows Style */
        .no-gigs {
            text-align: center;
            padding: 2rem;
            color: #808080;
            font-family: 'Segoe UI', 'Microsoft Sans Serif', Tahoma, Geneva, Verdana, sans-serif !important;
            font-weight: 500;
        }

        .no-gigs i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #c0c0c0;
        }

        .no-gigs p {
            font-size: 1rem;
            color: #404040;
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .delete-task-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-task-btn:hover {
            background: #c82333;
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .confirmation-dialog.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirmation-dialog .dialog-box {
            background: #fff;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid #e0e0e0;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirmation-dialog .dialog-box h3 {
            margin: 0 0 1rem;
            color: #1a1a1a;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .confirmation-dialog .dialog-box p {
            margin: 0 0 2rem;
            color: #666;
            font-size: 1rem;
            line-height: 1.5;
        }

        .confirmation-dialog .dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirmation-dialog .dialog-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
            font-family: 'Poppins', sans-serif;
        }

        .confirmation-dialog .dialog-actions .cancel {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .confirmation-dialog .dialog-actions .cancel:hover {
            background: #e9ecef;
            color: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .confirmation-dialog .dialog-actions .confirm {
            background: #4CAF50;
            color: #fff;
        }

        .confirmation-dialog .dialog-actions .confirm:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .confirmation-dialog .dialog-actions .delete {
            background: #FF5252;
            color: #fff;
        }

        .confirmation-dialog .dialog-actions .delete:hover {
            background: #e04848;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.3);
        }

        /* Success Modal Content */
        .success-content {
            text-align: center;
            padding: 1rem;
        }

        .success-content i {
            font-size: 2.5rem;
            color: #16a34a;
            margin-bottom: 0.75rem;
        }

        .success-content h4 {
            font-size: 1.1rem;
            color: #333;
            margin: 0 0 0.75rem 0;
            font-weight: 600;
        }

        .success-content p {
            color: #666;
            margin: 0.25rem 0;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .student-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .drag-instructions {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
        }

        .drag-instructions small {
            color: #666;
            font-size: 0.8rem;
        }

        .drag-instructions i {
            color: #1a73e8;
            margin-right: 0.25rem;
        }

        /* --- MACOS STYLE MODAL & SCROLLBAR --- */
        .gig-modal .modal-content,
        .gig-modal .modal-content.large-modal {
            border-radius: 12px !important;
            border: none !important;
            background: #ffffff !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 8px 32px rgba(0,0,0,0.1) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .modal-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px;
            position: relative;
        }

        .modal-header h3 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.25rem;
            color: #1d1d1f !important;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.025em;
        }

        .modal-header button {
            background: #ff3b30;
            border: none;
            border-radius: 50% !important;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
            font-weight: 300;
            line-height: 1;
            padding: 0;
            text-align: center;
        }
        .modal-header button:hover {
            background: #d70015;
            color: #ffffff;
            transform: scale(1.05);
        }

        .gig-modal .modal-body {
            background: #ffffff;
            border-radius: 0 0 12px 12px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            color: #1d1d1f;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
            border: none;
        }

        /* macOS style text inside modals */
        .gig-modal .modal-body h4,
        .gig-modal .modal-body h5,
        .gig-modal .modal-body h6 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 600 !important;
            color: #1d1d1f !important;
            margin-bottom: 0.75rem;
            letter-spacing: -0.025em;
        }

        /* macOS style for priority-header */
        .gig-modal .modal-body .priority-header {
            color: #ffffff !important;
            background: linear-gradient(135deg, #007aff 0%, #0056cc 100%) !important;
            border-radius: 8px 8px 0 0 !important;
            text-shadow: none !important;
            font-weight: 600 !important;
            letter-spacing: -0.025em !important;
        }

        .gig-modal .modal-body label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 500 !important;
            color: #1d1d1f !important;
            font-size: 0.95rem !important;
            text-shadow: none !important;
            letter-spacing: -0.025em;
        }

        .gig-modal .modal-body input,
        .gig-modal .modal-body textarea,
        .gig-modal .modal-body select {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400 !important;
            color: #1d1d1f !important;
            border: 1px solid #d2d2d7 !important;
            border-radius: 8px !important;
            background: #ffffff !important;
            box-shadow: none !important;
            transition: all 0.2s ease;
        }

        .gig-modal .modal-body input:focus,
        .gig-modal .modal-body textarea:focus,
        .gig-modal .modal-body select:focus {
            border-color: #007aff !important;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1) !important;
            outline: none !important;
        }

        .gig-modal .modal-body p,
        .gig-modal .modal-body span,
        .gig-modal .modal-body div {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400 !important;
            color: #1d1d1f !important;
            text-shadow: none !important;
        }

        .gig-modal .modal-body .student-name {
            font-weight: 600 !important;
            color: #1d1d1f !important;
            text-shadow: none !important;
        }

        .gig-modal .modal-body .student-position {
            font-weight: 500 !important;
            color: #86868b !important;
        }

        .gig-modal .modal-body .primary-badge,
        .gig-modal .modal-body .waitlist-badge {
            font-weight: 600 !important;
            font-size: 0.75rem !important;
            text-shadow: none !important;
            background: #34c759 !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 12px !important;
        }

        .gig-modal .modal-body .waitlist-badge {
            background: #007aff !important;
        }

        .gig-modal .modal-actions {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 12px 12px !important;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* macOS style buttons in modals */
        .gig-modal .modal-actions button,
        .gig-modal .modal-body button {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 500 !important;
            border: none !important;
            border-radius: 8px !important;
            background: #f1f3f4 !important;
            color: #1d1d1f !important;
            box-shadow: none !important;
            text-shadow: none !important;
            transition: all 0.2s ease !important;
            padding: 0.75rem 1.25rem !important;
        }

        .gig-modal .modal-actions button:hover,
        .gig-modal .modal-body button:hover {
            background: #e8eaed !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }

        .gig-modal .modal-actions .cancel-btn:hover,
        .gig-modal .modal-body .cancel-btn:hover {
            background: #ff3b30 !important;
            color: #ffffff !important;
        }

        .gig-modal .modal-actions .create-btn,
        .gig-modal .modal-actions .save-btn,
        .gig-modal .modal-actions .confirm-btn {
            background: #007aff !important;
            color: #ffffff !important;
            border: none !important;
            text-shadow: none !important;
        }

        .gig-modal .modal-actions .create-btn:hover,
        .gig-modal .modal-actions .save-btn:hover,
        .gig-modal .modal-actions .confirm-btn:hover {
            background: #0056cc !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3) !important;
        }

        /* macOS style scrollbar */
        .gig-modal .modal-body::-webkit-scrollbar {
            width: 8px;
            background: transparent;
        }
        .gig-modal .modal-body::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 4px;
            border: none;
        }
        .gig-modal .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a1a1a6;
        }
        .gig-modal .modal-body::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Firefox */
        .gig-modal .modal-body {
            scrollbar-width: thin;
            scrollbar-color: #d2d2d7 transparent;
        }

        /* macOS style for confirmation dialog */
        .confirmation-dialog .dialog-box {
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 8px 32px rgba(0,0,0,0.1) !important;
            border-radius: 12px !important;
            border: none !important;
            background: #ffffff !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        /* macOS style for dialog actions */
        .confirmation-dialog .dialog-actions button {
            border-radius: 8px !important;
            border: none;
            background: #f1f3f4;
            color: #1d1d1f;
            box-shadow: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 500 !important;
            text-shadow: none !important;
            transition: all 0.2s ease;
        }
        .confirmation-dialog .dialog-actions button:hover {
            background: #e8eaed;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .confirmation-dialog .dialog-actions .confirm:hover,
        .confirmation-dialog .dialog-actions .delete:hover {
            background: #ff3b30;
            color: #ffffff;
        }

        /* macOS style for dialog text */
        .confirmation-dialog .dialog-box h3 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 600 !important;
            color: #1d1d1f !important;
            text-shadow: none !important;
            letter-spacing: -0.025em;
        }

        .confirmation-dialog .dialog-box p {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400 !important;
            color: #86868b !important;
            letter-spacing: -0.025em;
        }

        /* macOS style for other elements */
        .file-item, .student-item, .selected-student, .task-file-item {
            border-radius: 8px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400 !important;
            border: 1px solid #d2d2d7 !important;
            background: #ffffff !important;
            color: #1d1d1f !important;
            transition: all 0.2s ease;
        }

        .file-item:hover, .student-item:hover {
            background: #f8f9fa !important;
            border-color: #007aff !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* macOS style for reorder buttons */
        .reorder-btn {
            background: #f1f3f4 !important;
            color: #5f6368 !important;
            border: none !important;
            border-radius: 6px !important;
            box-shadow: none !important;
            transition: all 0.2s ease;
        }

        .reorder-btn:hover {
            background: #e8eaed !important;
            color: #1d1d1f !important;
            transform: scale(1.05);
        }

        .reorder-btn:disabled {
            background: #f1f3f4 !important;
            color: #c7c7cc !important;
            opacity: 0.5;
        }

        /* macOS style for priority sections */
        .priority-list {
            border-radius: 8px !important;
            border: 1px solid #d2d2d7 !important;
            box-shadow: none !important;
        }

        .primary-student-section {
            background: #f0f8ff !important;
            border-bottom: 1px solid #d2d2d7 !important;
        }

        .waitlist-section {
            background: #ffffff !important;
        }

        .primary-student-section h4 {
            color: #34c759 !important;
            text-shadow: none !important;
        }

        .waitlist-section h4 {
            color: #007aff !important;
            text-shadow: none !important;
        }

        .primary-student-section h4 i {
            color: #34c759 !important;
        }

        .waitlist-section h4 i {
            color: #007aff !important;
        }

        /* Remove button styles */
        .remove-btn {
            background: #ff3b30;
            color: #ffffff;
            border: none;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease;
            margin-left: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #d70015;
        }

        /* Assign waitlist button styles */
        .assign-waitlist-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .assign-waitlist-btn {
            background: #007aff;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
        }

        .assign-waitlist-btn:hover {
            background: #0056cc;
            transform: translateY(-1px);
        }

        /* Assign waitlist modal styles */
        .available-students-section,
        .selected-students-section {
            flex: 1;
            padding: 1rem;
        }

        .available-students-section h4,
        .selected-students-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 1rem 0;
        }

        .search-section {
            margin-bottom: 1rem;
            width: 100%;
        }

        .search-section input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .search-section input:focus {
            border-color: #007aff;
        }

        .students-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            width: 100%;
        }

        .student-result {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s ease;
            width: 100%;
        }

        .student-result:last-child {
            border-bottom: none;
        }

        .student-result:hover {
            background: #e9ecef;
        }

        .student-result.selected {
            background: #e3f2fd;
            border-left: 3px solid #007aff;
        }

        .student-checkbox {
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .student-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .student-info {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
            min-width: 0;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .student-details {
            flex: 1;
            min-width: 0;
        }

        .student-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1d1d1f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-headline {
            margin: 0 0 0.25rem 0;
            font-size: 0.85rem;
            color: #1d1d1f;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-education {
            margin: 0 0 0.25rem 0;
            font-size: 0.8rem;
            color: #86868b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-details p {
            margin: 0 0 0.25rem 0;
            font-size: 0.85rem;
            color: #86868b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-skills {
            font-size: 0.8rem;
            color: #007aff;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .assignment-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.25rem;
            flex-shrink: 0;
        }

        .primary-badge {
            background: #34c759;
            color: #ffffff;
        }

        .waitlist-badge {
            background: #007aff;
            color: #ffffff;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #86868b;
            font-style: italic;
        }

        .student-actions {
            display: flex;
            align-items: center;
            margin-left: 0.75rem;
            flex-shrink: 0;
        }

        .view-profile-link {
            color: #007aff;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .view-profile-link:hover {
            background: #e3f2fd;
            color: #0056cc;
            text-decoration: underline;
        }

        /* Extra large modal for profile popup */
        .extra-large-modal {
            width: 85%;
            max-width: 900px;
            height: 80vh;
        }

        .extra-large-modal .modal-body {
            height: calc(80vh - 20px);
            padding: 0;
            overflow: hidden;
        }

        .extra-large-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Medium modal for select students */
        .medium-modal {
            width: 80%;
            max-width: 600px;
        }

        .medium-modal .modal-body {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="mobile-message">
        <p>Please use a desktop for a better experience.</p>
    </div>
    <nav class="navbar_classified">
        <a href="../index.html">
            <div class="logo"><img src="../assets/logo.png" alt="Taska Logo" style="height:48px;vertical-align:middle;"></div>
        </a>
        <ul class="nav-menu">
            <li><a href="explore.html">Explore</a></li>
            <li><a href="tasks.html">Workplace</a></li>
            <li><a href="gigs.html" class="active">Tasks</a></li>
            <li><a href="profile.html">Account</a></li>
        </ul>
        <div class="hamburger">☰</div>
    </nav>

    <div class="gigs-container">
        <div class="active-gigs">
            <h2>Assigned Tasks</h2>
            <div id="active-gigs-list" class="gigs-list">
                <!-- Assigned tasks will be populated here -->
            </div>
        </div>

        <div class="gigs-actions">
            <div class="action-card create-task">
                <h3>Create New Task</h3>
                <p>Create a new task and assign it to one or multiple students</p>
                <button class="action-btn create-btn" onclick="openCreateTaskModal()">
                    <i class="fas fa-plus"></i> Create Task
                </button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="gig-modal" id="create-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Task</h3>
                <button onclick="closeCreateTaskModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="task-title">Task Title</label>
                    <input type="text" id="task-title" placeholder="Enter task title">
                </div>
                <div class="form-group">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" placeholder="Describe the task requirements"></textarea>
                </div>
                <div class="form-group">
                    <label for="task-deadline">Deadline</label>
                    <input type="date" id="task-deadline">
                </div>
                <div class="form-group" style="display: none;">
                    <label for="task-files">Attach Files</label>
                    <input type="file" id="task-files" multiple>
                    <div id="task-files-list"></div>
                </div>
                <div class="form-group">
                    <label>Assign to Students</label>
                    <div class="student-assignment">
                        <div class="assignment-section">
                            <h4>Primary Assignment</h4>
                            <button type="button" class="assign-students-btn primary-btn" onclick="openStudentSearchModal('primary')">
                                <i class="fas fa-user-check"></i> Assign Primary Student
                            </button>
                            <div id="primary-student-list" class="selected-students primary-students">
                                <!-- Primary assigned student will be shown here -->
                            </div>
                        </div>
                        <div class="assignment-section">
                            <h4>Waitlist (Up to 5 students)</h4>
                            <button type="button" class="assign-students-btn waitlist-btn" onclick="openStudentSearchModal('waitlist')">
                                <i class="fas fa-user-clock"></i> Add to Waitlist
                            </button>
                            <div id="waitlist-students-list" class="selected-students waitlist-students">
                                <!-- Waitlisted students will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeCreateTaskModal()">Cancel</button>
                <button class="create-btn" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Student Search Modal -->
    <div class="gig-modal" id="student-search-modal">
        <div class="modal-content medium-modal">
            <div class="modal-header">
                <h3>Select Students</h3>
                <button onclick="closeStudentSearchModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="search-section">
                    <input type="text" id="student-search" placeholder="Search students by name, skills, or education..." onkeyup="filterStudents()">
                </div>
                <div class="students-results" id="students-results">
                    <!-- Search results will be populated here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeStudentSearchModal()">Cancel</button>
                <button class="confirm-btn" onclick="confirmStudentSelection()">Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="gig-modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="success-title">Success!</h3>
                <button onclick="closeSuccessModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="success-message" id="success-message">
                    <!-- Success message will be populated here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="success-btn" onclick="closeSuccessModal()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmation-dialog">
        <div class="dialog-box">
            <h3 id="dialog-title"></h3>
            <p id="dialog-message"></p>
            <div class="dialog-actions">
                <button class="cancel" onclick="closeConfirmation()">Cancel</button>
                <button id="confirm-button" class="confirm"></button>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="gig-modal" id="task-details-modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="task-details-title">Task Details</h3>
                <button onclick="closeTaskDetailsModal()">
                    ×
                </button>
            </div>
            <div class="modal-body" id="task-details-body">
                <!-- Task details will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="edit-btn" onclick="editCurrentTask()">
                    <i class="fas fa-edit"></i> Edit Task
                </button>
                <button class="cancel-btn" onclick="closeTaskDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="gig-modal" id="edit-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button onclick="closeEditTaskModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-task-title">Task Title</label>
                    <input type="text" id="edit-task-title" placeholder="Enter task title">
                </div>
                <div class="form-group">
                    <label for="edit-task-description">Description</label>
                    <textarea id="edit-task-description" placeholder="Describe the task requirements"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-task-deadline">Deadline</label>
                    <input type="date" id="edit-task-deadline">
                </div>
                <div class="form-group">
                    <label>Student Priority Management</label>
                    <div class="priority-management">
                        <div class="priority-list">
                            <div class="priority-header">
                                Assigned Students
                            </div>
                            <div class="primary-student-section">
                                <h4><i class="fas fa-user-check"></i> Primary Student</h4>
                                <div id="edit-primary-student">
                                    <!-- Primary student will be shown here -->
                                </div>
                            </div>
                            <div class="waitlist-section">
                                <h4><i class="fas fa-user-clock"></i> Waitlist Students</h4>
                                <div id="edit-waitlist-students">
                                    <!-- Waitlist students will be shown here -->
                                </div>
                                <div class="priority-instructions">
                                    <p><strong>Instructions:</strong> Use the up/down arrow buttons to reorder waitlist students. Click the arrows to move students up or down in the waitlist.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditTaskModal()">Cancel</button>
                <button class="save-btn" onclick="saveTaskChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Priority Change Modal -->
    <div class="gig-modal" id="priority-change-modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="priority-change-title">Manage Student Priority</h3>
                <button onclick="closePriorityChangeModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="priority-drag-container">
                    <div class="priority-section">
                        <h4>Primary Student</h4>
                        <div id="primary-drop-zone" class="drop-zone">
                            <div id="primary-student-display">
                                <!-- Primary student will be shown here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-section">
                        <h4>Waitlist Students</h4>
                        <div id="waitlist-drop-zone" class="drop-zone">
                            <div id="waitlist-students-display">
                                <!-- Waitlist students will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="priority-instructions">
                    <p><strong>Instructions:</strong> Drag and drop students to reorder them. Move students between primary and waitlist positions.</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closePriorityChangeModal()">Cancel</button>
                <button class="confirm-btn" onclick="confirmPriorityChanges()">Confirm Changes</button>
            </div>
        </div>
    </div>

    <!-- Assign Waitlist Modal -->
    <div class="gig-modal" id="assign-waitlist-modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Assign Students to Waitlist</h3>
                <button onclick="closeAssignWaitlistModal()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <div class="available-students-section">
                    <h4>Available Students</h4>
                    <div class="search-section">
                        <input type="text" id="student-search" placeholder="Search students..." onkeyup="filterAvailableStudents()">
                    </div>
                    <div id="available-students-list" class="students-list">
                        <!-- Available students will be populated here -->
                    </div>
                </div>
                <div class="selected-students-section">
                    <h4>Selected Students (<span id="selected-count">0</span>/<span id="max-slots">5</span>)</h4>
                    <div id="selected-students-list" class="students-list">
                        <!-- Selected students will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAssignWaitlistModal()">Cancel</button>
                <button class="confirm-btn" onclick="confirmAssignWaitlist()">Assign to Waitlist</button>
            </div>
        </div>
    </div>

    <!-- Profile Popup Modal -->
    <div class="gig-modal" id="profile-popup-modal">
        <div class="modal-content extra-large-modal">
            <div class="modal-header">
                <h3 id="profile-popup-title">Student Profile</h3>
                <button onclick="closeProfilePopup()">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <iframe id="profile-iframe" 
                        src="" 
                        frameborder="0" 
                        style="width: 100%; height: 600px; border: none;">
                </iframe>
            </div>
        </div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, get, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyDZIDlEtaNRxODoFhRw0xF2yYFBqqBexqo",
    authDomain: "taska-45011.firebaseapp.com",
    databaseURL: "https://taska-45011-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "taska-45011",
    storageBucket: "gs://taska-45011.firebasestorage.app",
    messagingSenderId: "205487498813",
    appId: "1:205487498813:web:0de2c9eab567482781ec54",
    measurementId: "G-G0G1F6GQ9B"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

let userId = null;
let currentUserProfile = null;
let primaryStudent = null;
let waitlistStudents = [];
let uploadedTaskFiles = [];
let allStudents = [];
let currentAssignmentType = 'primary'; // 'primary' or 'waitlist'
let currentTaskDetails = null;
let currentEditTask = null;
let pendingPriorityChanges = null;

// Initialize the app
async function init() {
    auth.onAuthStateChanged(async user => {
        if (user) {
            userId = user.uid;
            await fetchCurrentUserProfile();
            await fetchAllStudents();
            loadAssignedTasks();
            // Start real-time monitoring
            startRealTimeMonitoring();
        } else {
            console.error("User not authenticated");
            window.location.href = "../index.html";
        }
    });
}

// Start real-time monitoring for student assignment status changes
function startRealTimeMonitoring() {
    const tasksRef = ref(db, 'assignedTasks');
    onValue(tasksRef, (snapshot) => {
        if (snapshot.exists()) {
            const tasks = snapshot.val();
            // Check for tasks that need waitlist promotion
            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.professionalId === userId) {
                    checkAndPromoteWaitlistStudent(taskId, task);
                }
            }
        }
    });
}

// Check if primary student rejected and promote next waitlist student
async function checkAndPromoteWaitlistStudent(taskId, task) {
    if (!task.primaryStudent || !task.waitlistStudents || task.waitlistStudents.length === 0) {
        return;
    }
    
    try {
        // Check primary student's assignment status
        const primaryStudentRef = ref(db, `students/${task.primaryStudent}/assignedTasks/${taskId}`);
        const primarySnapshot = await get(primaryStudentRef);
        
        if (!primarySnapshot.exists()) {
            // Primary student assignment was removed (likely rejected)
            await promoteNextWaitlistStudent(taskId, task);
        } else {
            const primaryAssignment = primarySnapshot.val();
            if (primaryAssignment.status === 'rejected') {
                await promoteNextWaitlistStudent(taskId, task);
            }
        }
    } catch (error) {
        console.error('Error checking waitlist promotion:', error);
    }
}

// Promote the next student from waitlist to primary
async function promoteNextWaitlistStudent(taskId, task) {
    try {
        const waitlist = [...task.waitlistStudents];
        if (waitlist.length === 0) {
            // No more waitlist students, update task to show no primary
            await update(ref(db, `assignedTasks/${taskId}`), {
                primaryStudent: null,
                waitlistStudents: [],
                currentWaitlistIndex: 0
            });
            return;
        }
        
        // Get the next student from waitlist
        const nextStudentId = waitlist.shift();
        
        // Update the main task
        await update(ref(db, `assignedTasks/${taskId}`), {
            primaryStudent: nextStudentId,
            waitlistStudents: waitlist,
            currentWaitlistIndex: 0
        });
        
        // Update the promoted student's assignment
        const nextStudentAssignmentRef = ref(db, `students/${nextStudentId}/assignedTasks/${taskId}`);
        await update(nextStudentAssignmentRef, {
            status: 'pending',
            assignmentType: 'primary',
            waitlistPosition: null,
            promotedAt: new Date().toISOString()
        });
        
        // Remove the old primary student's assignment if it exists
        if (task.primaryStudent) {
            await remove(ref(db, `students/${task.primaryStudent}/assignedTasks/${taskId}`));
        }
        
        console.log(`Promoted student ${nextStudentId} to primary for task ${taskId}`);
        
        // Reload tasks to show updated status
        loadAssignedTasks();
        
    } catch (error) {
        console.error('Error promoting waitlist student:', error);
    }
}

async function fetchCurrentUserProfile() {
    try {
        const snapshot = await get(ref(db, `professionalslist/${userId}`));
        const user = snapshot.val() || {};
        currentUserProfile = {
            name: user.personal?.name || "Unnamed",
            profilePic: user.personal?.profilePic || "../assets/avatar/1.png",
            type: 'professional'
        };
        return currentUserProfile;
    } catch (error) {
        console.error('Error fetching current user profile:', error);
        return { name: "Unnamed", profilePic: "../assets/avatar/1.png", type: 'professional' };
    }
}

async function fetchAllStudents() {
    try {
        const snapshot = await get(ref(db, 'studentslist'));
        const students = snapshot.val() || {};
        allStudents = Object.entries(students).map(([id, data]) => ({
            id,
            ...data,
            personal: data.personal || {},
            education: data.education || {},
            skills: data.skills || ''
        }));
        return allStudents;
    } catch (error) {
        console.error('Error fetching students:', error);
        return [];
    }
}

function openCreateTaskModal() {
    document.getElementById('create-task-modal').classList.add('active');
    resetTaskForm();
}

function closeCreateTaskModal() {
    document.getElementById('create-task-modal').classList.remove('active');
    resetTaskForm();
}

function resetTaskForm() {
    document.getElementById('task-title').value = '';
    document.getElementById('task-description').value = '';
    document.getElementById('task-deadline').value = '';
    document.getElementById('task-files').value = '';
    document.getElementById('task-files-list').innerHTML = '';
    document.getElementById('primary-student-list').innerHTML = '';
    document.getElementById('waitlist-students-list').innerHTML = '';
    primaryStudent = null;
    waitlistStudents = [];
    uploadedTaskFiles = [];
}

function closeStudentSearchModal() {
    document.getElementById('student-search-modal').classList.remove('active');
}

function closeSuccessModal() {
    document.getElementById('success-modal').classList.remove('active');
}

function openStudentSearchModal(type) {
    currentAssignmentType = type;
    document.getElementById('student-search-modal').classList.add('active');
    searchStudents();
    // Show AI suggestions initially
    document.getElementById('ai-suggestions').style.display = 'block';
}

async function searchStudents() {
    const searchTerm = document.getElementById('student-search').value.toLowerCase();
    
    let filteredStudents = allStudents.filter(student => {
        // Filter out students with no names or empty names
        const studentName = student.personal?.name?.trim();
        if (!studentName || studentName === '') {
            return false;
        }
        
        const name = studentName.toLowerCase();
        const skills = student.skills?.toLowerCase() || '';
        const education = student.education?.branch?.toLowerCase() || '';
        const bio = student.personal?.bio?.toLowerCase() || '';
        const interests = student.personal?.interests?.toLowerCase() || '';
        
        // Simple search: check if search term matches any relevant field
        return name.includes(searchTerm) || 
               skills.includes(searchTerm) || 
               education.includes(searchTerm) ||
               bio.includes(searchTerm) ||
               interests.includes(searchTerm);
    });
    
    displayStudentResults(filteredStudents);
}

function filterStudents() {
    searchStudents();
}

function useSuggestion(suggestion) {
    document.getElementById('student-search').value = suggestion;
    searchStudents();
}

function displayStudentResults(students) {
    const resultsContainer = document.getElementById('students-results');
    
    if (students.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">No students found</div>';
        return;
    }
    
    resultsContainer.innerHTML = students.map(student => {
        const isPrimary = primaryStudent === student.id;
        const isWaitlisted = waitlistStudents.some(s => s.id === student.id);
        const isSelected = isPrimary || isWaitlisted;
        
        // Build education info string
        let educationInfo = '';
        if (student.education?.branch && student.education?.institution) {
            educationInfo = `${student.education.branch} at ${student.education.institution}`;
        } else if (student.education?.branch) {
            educationInfo = student.education.branch;
        } else if (student.education?.institution) {
            educationInfo = student.education.institution;
        }
        
        return `
            <div class="student-result ${isSelected ? 'selected' : ''}">
                <div class="student-checkbox">
                    <input type="checkbox" 
                           id="student-${student.id}" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleStudentCheckbox('${student.id}')">
                    <label for="student-${student.id}"></label>
                </div>
                <div class="student-info" onclick="toggleStudentCheckbox('${student.id}')">
                    <img src="${student.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student.personal?.name || 'Unnamed'}" class="student-avatar">
                    <div class="student-details">
                        <h4>${student.personal?.name || 'Unnamed'}</h4>
                        ${student.personal?.headline ? `<p class="student-headline">${student.personal.headline}</p>` : ''}
                        ${educationInfo ? `<p class="student-education">${educationInfo}</p>` : ''}
                        ${student.skills ? `<p class="student-skills">${student.skills}</p>` : ''}
                        ${isPrimary ? '<span class="assignment-badge primary-badge">Primary</span>' : ''}
                        ${isWaitlisted ? '<span class="assignment-badge waitlist-badge">Waitlisted</span>' : ''}
                    </div>
                </div>
                <div class="student-actions">
                    <a href="#" 
                       class="view-profile-link" 
                       onclick="openProfilePopup('${student.id}'); event.stopPropagation(); return false;">
                        View Profile
                    </a>
                </div>
            </div>
        `;
    }).join('');
}

function toggleStudentCheckbox(studentId) {
    const student = allStudents.find(s => s.id === studentId);
    if (!student) return;
    
    if (currentAssignmentType === 'primary') {
        // For primary assignment, only one student can be selected
        if (primaryStudent === studentId) {
            primaryStudent = null;
        } else {
            primaryStudent = studentId;
        }
    } else {
        // For waitlist, up to 5 students can be selected
        const waitlistIndex = waitlistStudents.findIndex(s => s.id === studentId);
        if (waitlistIndex > -1) {
            waitlistStudents.splice(waitlistIndex, 1);
        } else {
            if (waitlistStudents.length < 5) {
                waitlistStudents.push({
                    id: studentId,
                    name: student.personal?.name || 'Unnamed',
                    profilePic: student.personal?.profilePic || '../assets/avatar/1.png'
                });
            } else {
                alert('Waitlist is full (maximum 5 students)');
                // Uncheck the checkbox
                document.getElementById(`student-${studentId}`).checked = false;
                return;
            }
        }
    }
    
    updateSelectedStudentsList();
    searchStudents(); // Refresh the results to update selection state
}

function updateSelectedStudentsList() {
    const primaryContainer = document.getElementById('primary-student-list');
    const waitlistContainer = document.getElementById('waitlist-students-list');
    
    // Update primary student list
    if (primaryStudent) {
        const student = allStudents.find(s => s.id === primaryStudent);
        primaryContainer.innerHTML = `
            <div class="selected-student primary-student">
                <img src="${student.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student.personal?.name || 'Unnamed'}" class="student-avatar">
                <span>${student.personal?.name || 'Unnamed'}</span>
                <span class="assignment-type">Primary</span>
                <button onclick="removeSelectedStudent('${primaryStudent}')" class="remove-student">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    } else {
        primaryContainer.innerHTML = '';
    }
    
    // Update waitlist students
    waitlistContainer.innerHTML = waitlistStudents.map((student, index) => `
        <div class="selected-student waitlist-student">
            <img src="${student.profilePic}" alt="${student.name}" class="student-avatar">
            <span>${student.name}</span>
            <span class="assignment-type">Waitlist #${index + 1}</span>
            <button onclick="removeSelectedStudent('${student.id}')" class="remove-student">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeSelectedStudent(studentId) {
    if (primaryStudent === studentId) {
        primaryStudent = null;
    } else {
        waitlistStudents = waitlistStudents.filter(s => s.id !== studentId);
    }
    updateSelectedStudentsList();
    searchStudents();
}

function confirmStudentSelection() {
    closeStudentSearchModal();
}

async function createTask() {
    const title = document.getElementById('task-title').value.trim();
    const description = document.getElementById('task-description').value.trim();
    const deadline = document.getElementById('task-deadline').value;

    if (!title || !deadline) {
        alert('Please fill in the task title and deadline.');
        return;
    }

    if (!primaryStudent && waitlistStudents.length === 0) {
        alert('Please select at least one student (primary or waitlist) to assign the task to.');
        return;
    }

    try {
        let taskData = {
            title,
            description,
            deadline,
            professionalId: userId,
            professionalName: currentUserProfile.name,
            status: 'assigned',
            createdAt: new Date().toISOString(),
            primaryStudent: primaryStudent,
            waitlistStudents: waitlistStudents.map(s => s.id),
            currentWaitlistIndex: 0
        };

        // Handle file uploads
        if (uploadedTaskFiles.length > 0) {
            taskData.files = {};
            for (let i = 0; i < uploadedTaskFiles.length; i++) {
                const file = uploadedTaskFiles[i];
                if (!file.url) {
                    const storagePath = `tasks/${Date.now()}_${file.name}`;
                    const fileRef = storageRef(storage, storagePath);
                    const uploadTask = await uploadBytesResumable(fileRef, file);
                    const fileUrl = await getDownloadURL(fileRef);
                    taskData.files[i] = {
                        name: file.name,
                        url: fileUrl,
                        type: file.type,
                        size: file.size
                    };
                } else {
                    taskData.files[i] = {
                        name: file.name,
                        url: file.url,
                        type: file.type,
                        size: file.size
                    };
                }
            }
        }

        // Create the task
        const taskRef = ref(db, 'assignedTasks');
        const newTaskRef = await push(taskRef, taskData);
        const taskId = newTaskRef.key;

        // Assign to primary student if exists
        if (primaryStudent) {
            const assignmentRef = ref(db, `students/${primaryStudent}/assignedTasks/${taskId}`);
            await set(assignmentRef, {
                taskId: taskId,
                title,
                description,
                deadline,
                professionalId: userId,
                professionalName: currentUserProfile.name,
                status: 'pending',
                assignedAt: new Date().toISOString(),
                files: taskData.files || {},
                assignmentType: 'primary'
            });
        }

        // Assign to waitlist students
        for (let i = 0; i < waitlistStudents.length; i++) {
            const student = waitlistStudents[i];
            const assignmentRef = ref(db, `students/${student.id}/assignedTasks/${taskId}`);
            await set(assignmentRef, {
                taskId: taskId,
                title,
                description,
                deadline,
                professionalId: userId,
                professionalName: currentUserProfile.name,
                status: 'waitlisted',
                assignedAt: new Date().toISOString(),
                files: taskData.files || {},
                assignmentType: 'waitlist',
                waitlistPosition: i + 1
            });
        }

        closeCreateTaskModal();
        
        // Show success modal
        document.getElementById('success-title').textContent = 'Task Created Successfully!';
        document.getElementById('success-message').innerHTML = `
            <div class="success-content">
                <i class="fas fa-check-circle"></i>
                <h4>Task has been created and assigned!</h4>
                
                <p>Students will be notified and can accept the task to become connections.</p>
            </div>
        `;
        document.getElementById('success-modal').classList.add('active');
        
        loadAssignedTasks();
    } catch (error) {
        console.error('Error creating task:', error);
        alert('Failed to create task.');
    }
}

async function loadAssignedTasks() {
    const activeGigsList = document.getElementById('active-gigs-list');
    
    try {
        const tasksRef = ref(db, 'assignedTasks');
        const snapshot = await get(tasksRef);
        
        activeGigsList.innerHTML = '';
        
        if (snapshot.exists()) {
            const tasks = snapshot.val();
            let hasTasks = false;

            // Filter and collect tasks for the current professional
            const professionalTasks = [];
            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.professionalId === userId) {
                    professionalTasks.push({ taskId, ...task });
                }
            }

            // Sort tasks by deadline (nearest first)
            professionalTasks.sort((a, b) => {
                const deadlineA = new Date(a.deadline);
                const deadlineB = new Date(b.deadline);
                return deadlineA - deadlineB;
            });

            // Create task cards for sorted tasks
            for (const { taskId, ...task } of professionalTasks) {
                hasTasks = true;
                const taskCard = await createTaskCard(task, taskId);
                activeGigsList.appendChild(taskCard);
            }

            if (!hasTasks) {
                activeGigsList.innerHTML = `
                    <div class="no-gigs">
                        <i class="fas fa-info-circle"></i>
                        <p>You haven't assigned any tasks yet. Create a new task to get started!</p>
                    </div>
                `;
            }
        } else {
            activeGigsList.innerHTML = `
                <div class="no-gigs">
                    <i class="fas fa-info-circle"></i>
                    <p>No tasks assigned yet. Create a new task to get started!</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading assigned tasks:', error);
        activeGigsList.innerHTML = `
            <div class="no-gigs">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading tasks. Please try again.</p>
            </div>
        `;
    }
}

async function createTaskCard(task, taskId) {
    const card = document.createElement('div');
    card.className = 'gig-card';
    card.setAttribute('data-task-id', taskId); // Add data attribute for identification
    
    const primaryStudentName = task.primaryStudent ? allStudents.find(s => s.id === task.primaryStudent)?.personal?.name || 'Unknown' : 'None';
    const waitlistCount = task.waitlistStudents ? task.waitlistStudents.length : 0;
    const daysLeft = calculateDaysLeft(task.deadline);
    
    // Get waitlist student names
    const waitlistStudentNames = task.waitlistStudents ? task.waitlistStudents.map(id => 
        allStudents.find(s => s.id === id)?.personal?.name || 'Unknown'
    ) : [];
    
    // Get primary student profile pic
    const primaryStudentPic = task.primaryStudent ? 
        allStudents.find(s => s.id === task.primaryStudent)?.personal?.profilePic || '../assets/avatar/1.png' : 
        '../assets/avatar/1.png';
    
    // Get primary student status
    const primaryStudentStatus = await getPrimaryStudentStatus(task, taskId);
    
    card.innerHTML = `
        <div class="gig-header">
            <div class="gig-actions">
                <div class="three-dot-menu">
                    <button class="three-dot-btn" onclick="toggleDropdown('${taskId}')">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu" id="dropdown-${taskId}">
                        <button class="dropdown-item edit" onclick="editTaskFromCard('${taskId}')">
                            <i class="fas fa-edit"></i>
                            Edit Task
                        </button>
                        <button class="dropdown-item delete" onclick="deleteAssignedTask('${taskId}')">
                            <i class="fas fa-trash"></i>
                            Delete Task
                        </button>
                    </div>
                </div>
            </div>
            <div class="gig-info">
                <h4>${task.title}</h4>
                <p class="gig-description">${task.description}</p>
                <div class="gig-meta">
                    <span class="deadline-info ${daysLeft <= 3 ? 'urgent' : daysLeft <= 7 ? 'warning' : 'normal'}">
                        ${daysLeft} days left
                    </span>
                </div>
            </div>
        </div>
        
        <div class="gig-details">
            <div class="details-grid">
                <div class="detail-section">
                    <h5>Student Assignments</h5>
                    <div class="primary-detail">
                        <div class="detail-item">
                            <strong>Primary Student:</strong>
                        </div>
                        <div class="student-detail">
                            <img src="${primaryStudentPic}" alt="Primary Student" class="student-avatar">
                            <div>
                                <div class="student-name">${primaryStudentName}</div>
                                <div class="student-status ${primaryStudentStatus.class}">
                                    <i class="fas ${primaryStudentStatus.icon}"></i>
                                    ${primaryStudentStatus.text}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="waitlist-detail">
                        <div class="detail-item">
                            <strong>Waitlist Students:</strong> ${waitlistCount}
                        </div>
                        ${waitlistStudentNames.length > 0 ? 
                            waitlistStudentNames.map((name, index) => {
                                const studentPic = allStudents.find(s => s.personal?.name === name)?.personal?.profilePic || '../assets/avatar/1.png';
                                return `
                                    <div class="student-detail">
                                        <img src="${studentPic}" alt="${name}" class="student-avatar">
                                        <div>
                                            <div class="student-name">${name}</div>
                                            <div class="student-status waitlist">Waitlist #${index + 1}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('') : 
                            '<div class="detail-item">No waitlist students</div>'
                        }
                    </div>
                </div>
                
                ${task.files && Object.keys(task.files).length > 0 ? `
                    <div class="detail-section files-section">
                        <h5>Attached Files (${Object.keys(task.files).length})</h5>
                        <div class="files-list">
                            ${Object.values(task.files).map(file => `
                                <a href="${file.url}" download="${file.name}" class="file-item">
                                    <i class="fas fa-file"></i>
                                    <span>${file.name}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    return card;
}

// Function to get primary student status
async function getPrimaryStudentStatus(task, taskId) {
    if (!task.primaryStudent) {
        return { text: 'No Primary Student', class: 'no-primary', icon: 'fa-user-times' };
    }
    
    try {
        const studentTaskRef = ref(db, `students/${task.primaryStudent}/assignedTasks/${taskId}`);
        const snapshot = await get(studentTaskRef);
        
        if (!snapshot.exists()) {
            return { text: 'Student Removed', class: 'removed', icon: 'fa-user-times' };
        }
        
        const studentTask = snapshot.val();
        
        switch (studentTask.status) {
            case 'accepted':
                return { text: 'Accepted', class: 'accepted', icon: 'fa-check-circle' };
            case 'rejected':
                return { text: 'Rejected', class: 'rejected', icon: 'fa-times-circle' };
            case 'pending':
            default:
                return { text: 'Pending', class: 'pending', icon: 'fa-clock' };
        }
    } catch (error) {
        console.error('Error getting student status:', error);
        return { text: 'Unknown', class: 'unknown', icon: 'fa-question-circle' };
    }
}

function calculateDaysLeft(deadline) {
    const now = new Date();
    const deadlineDate = new Date(deadline);
    const diffTime = deadlineDate - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays > 0 ? diffDays : 0;
}

function viewTaskDetails(taskId) {
    try {
        const taskRef = ref(db, `assignedTasks/${taskId}`);
        get(taskRef).then(snapshot => {
            if (snapshot.exists()) {
                const task = snapshot.val();
                currentTaskDetails = { ...task, id: taskId };
                
                const primaryStudentName = task.primaryStudent ? 
                    allStudents.find(s => s.id === task.primaryStudent)?.personal?.name || 'Unknown' : 'None';
                const waitlistStudents = task.waitlistStudents ? task.waitlistStudents.map(id => 
                    allStudents.find(s => s.id === id)?.personal?.name || 'Unknown'
                ) : [];
                const daysLeft = calculateDaysLeft(task.deadline);
                
                document.getElementById('task-details-title').textContent = task.title;
                document.getElementById('task-details-body').innerHTML = `
                    <div class="task-details-grid">
                        <div class="detail-section">
                            <h4>Task Information</h4>
                            <div class="detail-item">
                                <strong>Title:</strong> ${task.title}
                            </div>
                            <div class="detail-item">
                                <strong>Description:</strong> ${task.description}
                            </div>
                            <div class="detail-item">
                                <strong>Deadline:</strong> ${new Date(task.deadline).toLocaleDateString()}
                            </div>
                            <div class="detail-item">
                                <strong>Days Left:</strong> ${daysLeft} days
                            </div>
                            <div class="detail-item">
                                <strong>Created:</strong> ${new Date(task.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Student Assignments</h4>
                            <div class="assignment-details">
                                <div class="primary-detail">
                                    <h5>Primary Student</h5>
                                    <div class="student-detail">
                                        <img src="${task.primaryStudent ? allStudents.find(s => s.id === task.primaryStudent)?.personal?.profilePic || '../assets/avatar/1.png' : '../assets/avatar/1.png'}" 
                                             alt="Primary Student" class="student-avatar">
                                        <div>
                                            <div class="student-name">${primaryStudentName}</div>
                                            <div class="student-status">Primary Assignment</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="waitlist-detail">
                                    <h5>Waitlist Students (${waitlistStudents.length})</h5>
                                    ${waitlistStudents.length > 0 ? 
                                        waitlistStudents.map((name, index) => `
                                            <div class="student-detail">
                                                <img src="${allStudents.find(s => s.personal?.name === name)?.personal?.profilePic || '../assets/avatar/1.png'}" 
                                                     alt="${name}" class="student-avatar">
                                                <div>
                                                    <div class="student-name">${name}</div>
                                                    <div class="student-status">Waitlist #${index + 1}</div>
                                                </div>
                                            </div>
                                        `).join('') : 
                                        '<p>No waitlist students</p>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        ${task.files && Object.keys(task.files).length > 0 ? `
                            <div class="detail-section">
                                <h4>Attached Files (${Object.keys(task.files).length})</h4>
                                <div class="files-list">
                                    ${Object.values(task.files).map(file => `
                                        <a href="${file.url}" download="${file.name}" class="file-item">
                                            <i class="fas fa-file"></i>
                                            <span>${file.name}</span>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('task-details-modal').classList.add('active');
            }
        });
    } catch (error) {
        console.error('Error loading task details:', error);
        alert('Failed to load task details.');
    }
}

function closeTaskDetailsModal() {
    document.getElementById('task-details-modal').classList.remove('active');
    currentTaskDetails = null;
}

function editCurrentTask() {
    if (!currentTaskDetails) return;
    
    currentEditTask = { ...currentTaskDetails };
    
    // Populate edit form
    document.getElementById('edit-task-title').value = currentEditTask.title;
    document.getElementById('edit-task-description').value = currentEditTask.description;
    document.getElementById('edit-task-deadline').value = currentEditTask.deadline;
    
    // Populate student assignments
    updateEditStudentAssignments();
    
    // Close details modal and open edit modal
    closeTaskDetailsModal();
    document.getElementById('edit-task-modal').classList.add('active');
}

function editTaskFromCard(taskId) {
    if (!taskId) {
        console.error('No taskId provided to editTaskFromCard');
        alert('Invalid task ID. Please try again.');
        return;
    }
    
    try {
        const taskRef = ref(db, `assignedTasks/${taskId}`);
        get(taskRef).then(snapshot => {
            if (snapshot.exists()) {
                const task = snapshot.val();
                currentEditTask = { ...task, id: taskId };
                
                // Populate edit form
                const titleInput = document.getElementById('edit-task-title');
                const descriptionInput = document.getElementById('edit-task-description');
                const deadlineInput = document.getElementById('edit-task-deadline');
                
                if (titleInput) titleInput.value = currentEditTask.title || '';
                if (descriptionInput) descriptionInput.value = currentEditTask.description || '';
                if (deadlineInput) deadlineInput.value = currentEditTask.deadline || '';
                
                // Populate student assignments
                updateEditStudentAssignments();
                
                // Open edit modal
                const editModal = document.getElementById('edit-task-modal');
                if (editModal) {
                    editModal.classList.add('active');
                } else {
                    console.error('Edit modal not found');
                    alert('Error opening edit modal. Please try again.');
                }
            } else {
                console.error('Task not found:', taskId);
                alert('Task not found. Please try again.');
            }
        }).catch(error => {
            console.error('Error loading task for editing:', error);
            alert('Failed to load task for editing. Please try again.');
        });
    } catch (error) {
        console.error('Error in editTaskFromCard:', error);
        alert('Failed to load task for editing. Please try again.');
    }
}

function closeEditTaskModal() {
    document.getElementById('edit-task-modal').classList.remove('active');
    currentEditTask = null;
}

function updateEditStudentAssignments() {
    if (!currentEditTask) {
        console.error('currentEditTask is null in updateEditStudentAssignments');
        return;
    }
    
    // Clean up any duplicate students
    cleanupStudentArrays();
    
    // Update primary student display
    const primaryContainer = document.getElementById('edit-primary-student');
    if (!primaryContainer) {
        console.error('edit-primary-student container not found');
        return;
    }
    
    if (currentEditTask.primaryStudent) {
        const student = allStudents.find(s => s.id === currentEditTask.primaryStudent);
        const hasWaitlist = currentEditTask.waitlistStudents && currentEditTask.waitlistStudents.length > 0;
        primaryContainer.innerHTML = `
            <div class="student-item">
                <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
                <div class="student-info">
                    <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                    <div class="student-position">Primary Assignment</div>
                </div>
                <span class="primary-badge">Primary</span>
                <div class="reorder-controls">
                    <button class="reorder-btn" disabled title="Move Up">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="reorder-btn" onclick="window.demotePrimaryToWaitlist()" ${!hasWaitlist ? 'disabled' : ''} title="Demote to Waitlist">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <button class="remove-btn" onclick="window.removePrimaryStudent()" title="Remove Primary Student">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    } else {
        primaryContainer.innerHTML = '<div class="empty-state">No primary student assigned</div>';
    }
    
    // Update waitlist students display with up/down arrow controls
    const waitlistContainer = document.getElementById('edit-waitlist-students');
    if (!waitlistContainer) {
        console.error('edit-waitlist-students container not found');
        return;
    }
    
    if (currentEditTask.waitlistStudents && currentEditTask.waitlistStudents.length > 0) {
        waitlistContainer.innerHTML = currentEditTask.waitlistStudents.map((studentId, index) => {
            const student = allStudents.find(s => s.id === studentId);
            const isFirst = index === 0;
            const isLast = index === currentEditTask.waitlistStudents.length - 1;
            return `
                <div class="student-item" data-index="${index}" data-student-id="${studentId}">
                    <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
                    <div class="student-info">
                        <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                        <div class="student-position">Waitlist #${index + 1}</div>
                    </div>
                    <span class="waitlist-badge">#${index + 1}</span>
                    <div class="reorder-controls">
                        <button class="reorder-btn" onclick="window.moveStudentUp(${index})" ${isFirst ? 'disabled' : ''} title="Move Up">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="reorder-btn" onclick="window.moveStudentDown(${index})" ${isLast ? 'disabled' : ''} title="Move Down">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <button class="reorder-btn" onclick="window.promoteWaitlistToPrimary(${index})" title="Promote to Primary">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="remove-btn" onclick="window.removeWaitlistStudent(${index})" title="Remove from Waitlist">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Add assign waitlist button if less than 5 students
        const waitlistCount = currentEditTask.waitlistStudents.length;
        if (waitlistCount < 5) {
            waitlistContainer.innerHTML += `
                <div class="assign-waitlist-section">
                    <button class="assign-waitlist-btn" onclick="window.openAssignWaitlistModal()">
                        <i class="fas fa-plus"></i> Assign More Students to Waitlist (${waitlistCount}/5)
                    </button>
                </div>
            `;
        }
    } else {
        waitlistContainer.innerHTML = `
            <div class="empty-state">No waitlist students</div>
            <div class="assign-waitlist-section">
                <button class="assign-waitlist-btn" onclick="window.openAssignWaitlistModal()">
                    <i class="fas fa-plus"></i> Assign Students to Waitlist (0/5)
                </button>
            </div>
        `;
    }
}

// Move up/down and promote/demote logic
window.moveStudentUp = function(index) {
    const i = parseInt(index);
    if (i > 0) {
        const temp = currentEditTask.waitlistStudents[i-1];
        currentEditTask.waitlistStudents[i-1] = currentEditTask.waitlistStudents[i];
        currentEditTask.waitlistStudents[i] = temp;
        updateEditStudentAssignments();
    }
};
window.moveStudentDown = function(index) {
    const i = parseInt(index);
    if (i < currentEditTask.waitlistStudents.length - 1) {
        const temp = currentEditTask.waitlistStudents[i+1];
        currentEditTask.waitlistStudents[i+1] = currentEditTask.waitlistStudents[i];
        currentEditTask.waitlistStudents[i] = temp;
        updateEditStudentAssignments();
    }
};
window.promoteWaitlistToPrimary = function(index) {
    const i = parseInt(index);
    const promoted = currentEditTask.waitlistStudents.splice(i, 1)[0];
    if (currentEditTask.primaryStudent) {
        currentEditTask.waitlistStudents.unshift(currentEditTask.primaryStudent);
    }
    currentEditTask.primaryStudent = promoted;
    updateEditStudentAssignments();
};
window.demotePrimaryToWaitlist = function() {
    if (!currentEditTask.primaryStudent) return;
    if (currentEditTask.waitlistStudents.length === 0) return;
    // Swap primary with first waitlist student
    const oldPrimary = currentEditTask.primaryStudent;
    const newPrimary = currentEditTask.waitlistStudents.shift();
    currentEditTask.primaryStudent = newPrimary;
    currentEditTask.waitlistStudents.unshift(oldPrimary);
    updateEditStudentAssignments();
};

function cleanupStudentArrays() {
    if (!currentEditTask) {
        console.error('currentEditTask is null in cleanupStudentArrays');
        return;
    }
    
    // Remove duplicates from waitlist
    if (currentEditTask.waitlistStudents) {
        const uniqueWaitlist = [];
        const seen = new Set();
        
        for (const studentId of currentEditTask.waitlistStudents) {
            if (studentId && !seen.has(studentId)) {
                seen.add(studentId);
                uniqueWaitlist.push(studentId);
            }
        }
        currentEditTask.waitlistStudents = uniqueWaitlist;
    }
    
    // Ensure primary student is not in waitlist
    if (currentEditTask.primaryStudent && currentEditTask.waitlistStudents) {
        currentEditTask.waitlistStudents = currentEditTask.waitlistStudents.filter(
            id => id !== currentEditTask.primaryStudent
        );
    }
}

function enableReorderControls() {
    const reorderControls = document.querySelectorAll('.reorder-btn');
    reorderControls.forEach(btn => {
        btn.addEventListener('click', () => {
            const index = btn.dataset.index;
            const studentId = btn.dataset.studentId;
            moveStudent(index, studentId);
        });
    });
}

function moveStudentUp(index) {
    const currentIndex = parseInt(index);
    if (currentIndex > 0) {
        const prevIndex = currentIndex - 1;
        swapStudents(currentIndex, prevIndex);
        updateEditStudentAssignments();
        }
    }

function moveStudentDown(index) {
    const currentIndex = parseInt(index);
    if (currentIndex < currentEditTask.waitlistStudents.length - 1) {
        const nextIndex = currentIndex + 1;
        swapStudents(currentIndex, nextIndex);
            updateEditStudentAssignments();
    }
}

function swapStudents(index1, index2) {
    const temp = currentEditTask.waitlistStudents[index1];
    currentEditTask.waitlistStudents[index1] = currentEditTask.waitlistStudents[index2];
    currentEditTask.waitlistStudents[index2] = temp;
}

function openPriorityChangeModal(type) {
    if (!currentEditTask) return;
    
    document.getElementById('priority-change-title').textContent = 
        type === 'primary' ? 'Manage Primary Student' : 'Manage Waitlist Students';
    
    // Display current assignments
    updatePriorityChangeDisplay();
    
    document.getElementById('priority-change-modal').classList.add('active');
}

function closePriorityChangeModal() {
    document.getElementById('priority-change-modal').classList.remove('active');
    pendingPriorityChanges = null;
}

function updatePriorityChangeDisplay() {
    if (!currentEditTask) return;
    
    // Display current primary student
    const primaryDisplay = document.getElementById('primary-student-display');
    if (currentEditTask.primaryStudent) {
        const student = allStudents.find(s => s.id === currentEditTask.primaryStudent);
        primaryDisplay.innerHTML = `
            <div class="draggable-student" data-student-id="${currentEditTask.primaryStudent}" data-type="primary">
                <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
                <div>
                    <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                    <div class="student-position">Primary Assignment</div>
                </div>
            </div>
        `;
    } else {
        primaryDisplay.innerHTML = '<p>No primary student assigned</p>';
    }
    
    // Display current waitlist students with up/down arrow controls
    const waitlistDisplay = document.getElementById('waitlist-students-display');
    if (currentEditTask.waitlistStudents && currentEditTask.waitlistStudents.length > 0) {
        waitlistDisplay.innerHTML = currentEditTask.waitlistStudents.map((studentId, index) => {
            const student = allStudents.find(s => s.id === studentId);
            const isFirst = index === 0;
            const isLast = index === currentEditTask.waitlistStudents.length - 1;
            return `
                <div class="draggable-student" data-student-id="${studentId}" data-type="waitlist" data-index="${index}">
                    <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
                    <div>
                        <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                        <div class="student-position">Waitlist #${index + 1}</div>
                    </div>
                    <div class="reorder-controls">
                        <button class="reorder-btn" onclick="movePriorityStudentUp(${index})" ${isFirst ? 'disabled' : ''} title="Move Up">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="reorder-btn" onclick="movePriorityStudentDown(${index})" ${isLast ? 'disabled' : ''} title="Move Down">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        waitlistDisplay.innerHTML = '<p>No waitlist students</p>';
    }
    
    // Initialize reorder controls
    initializeReorderControls();
}

function initializeReorderControls() {
    const reorderControls = document.querySelectorAll('.reorder-btn');
    reorderControls.forEach(btn => {
        btn.addEventListener('click', () => {
            const index = btn.dataset.index;
            const studentId = btn.dataset.studentId;
            movePriorityStudent(index, studentId);
        });
    });
}

function movePriorityStudentUp(index) {
    const currentIndex = parseInt(index);
    if (currentIndex > 0) {
        const prevIndex = currentIndex - 1;
        swapPriorityStudents(currentIndex, prevIndex);
        pendingPriorityChanges = true;
        updatePriorityChangeDisplay();
    }
}

function movePriorityStudentDown(index) {
    const currentIndex = parseInt(index);
    if (currentIndex < currentEditTask.waitlistStudents.length - 1) {
        const nextIndex = currentIndex + 1;
        swapPriorityStudents(currentIndex, nextIndex);
            pendingPriorityChanges = true;
    updatePriorityChangeDisplay();
}
}

function swapPriorityStudents(index1, index2) {
    const temp = currentEditTask.waitlistStudents[index1];
    currentEditTask.waitlistStudents[index1] = currentEditTask.waitlistStudents[index2];
    currentEditTask.waitlistStudents[index2] = temp;
}

function confirmPriorityChanges() {
    if (!pendingPriorityChanges) {
        alert('No changes to confirm');
        return;
    }
    
    // Update the edit form display
    updateEditStudentAssignments();
    
    // Close priority change modal
    closePriorityChangeModal();
    
    alert('Priority changes confirmed and applied to the edit form.');
}

async function saveTaskChanges() {
    if (!currentEditTask) {
        alert('No task selected for editing. Please try editing the task again.');
        return;
    }
    
    try {
        const taskId = currentEditTask.id;
        if (!taskId) {
            alert('Invalid task ID. Please try editing the task again.');
            return;
        }
        
        const taskRef = ref(db, `assignedTasks/${taskId}`);
        
        // Check if there's no primary student but there are waitlist students
        let wasPromoted = false;
        let promotedStudentName = '';
        
        if (!currentEditTask.primaryStudent && currentEditTask.waitlistStudents && currentEditTask.waitlistStudents.length > 0) {
            // Automatically promote the first waitlist student to primary
            const promotedStudentId = currentEditTask.waitlistStudents.shift();
            currentEditTask.primaryStudent = promotedStudentId;
            
            // Store promotion information for success message
            wasPromoted = true;
            const promotedStudent = allStudents.find(s => s.id === promotedStudentId);
            promotedStudentName = promotedStudent?.personal?.name || 'Unknown';
            
            // Update the display to reflect the change
            updateEditStudentAssignments();
            
            console.log(`Automatically promoted waitlist student ${promotedStudentId} to primary for task ${taskId}`);
        }
        
        // Update task data
        const updatedTaskData = {
            ...currentEditTask,
            title: document.getElementById('edit-task-title').value,
            description: document.getElementById('edit-task-description').value,
            deadline: document.getElementById('edit-task-deadline').value,
            updatedAt: new Date().toISOString()
        };
        
        // Update the main task
        await update(taskRef, updatedTaskData);
        
        // Update student assignments
        await updateStudentAssignments(taskId, updatedTaskData);
        
        // Refresh only the specific task card
        await refreshTaskCard(taskId, updatedTaskData);
        
        // Close the modal after successful save and refresh
        closeEditTaskModal();
        
        // Show success message
        document.getElementById('success-title').textContent = 'Task Updated Successfully!';
        let successMessage = `
            <div class="success-content">
                <i class="fas fa-check-circle"></i>
                <h4>Task has been updated!</h4>
                <p><strong>Task Title:</strong> ${updatedTaskData.title}</p>
        `;
        
        // Add specific message if a student was automatically promoted
        if (wasPromoted) {
            successMessage += `<p><strong>Note:</strong> ${promotedStudentName} has been automatically promoted from waitlist to primary student.</p>`;
        }
        
        successMessage += `<p>All changes have been applied and students have been notified.</p></div>`;
        document.getElementById('success-message').innerHTML = successMessage;
        document.getElementById('success-modal').classList.add('active');
        
    } catch (error) {
        console.error('Error updating task:', error);
        alert('Failed to update task: ' + error.message);
    }
}

async function updateStudentAssignments(taskId, updatedTaskData) {
    try {
        // Get current task data to compare
        const currentTaskRef = ref(db, `assignedTasks/${taskId}`);
        const currentSnapshot = await get(currentTaskRef);
        const currentTask = currentSnapshot.val();
        
        // Update primary student assignment
        if (updatedTaskData.primaryStudent !== currentTask.primaryStudent) {
            // Remove old primary student assignment
            if (currentTask.primaryStudent) {
                await remove(ref(db, `students/${currentTask.primaryStudent}/assignedTasks/${taskId}`));
            }
            
            // Add new primary student assignment
            if (updatedTaskData.primaryStudent) {
                const newPrimaryAssignment = {
                    taskId: taskId,
                    title: updatedTaskData.title,
                    description: updatedTaskData.description,
                    deadline: updatedTaskData.deadline,
                    professionalId: userId,
                    professionalName: currentUserProfile.name,
                    status: 'pending',
                    assignedAt: new Date().toISOString(),
                    files: updatedTaskData.files || {},
                    assignmentType: 'primary'
                };
                await set(ref(db, `students/${updatedTaskData.primaryStudent}/assignedTasks/${taskId}`), newPrimaryAssignment);
            }
        }
        
        // Update waitlist students
        const currentWaitlist = currentTask.waitlistStudents || [];
        const newWaitlist = updatedTaskData.waitlistStudents || [];
        
        // Remove students no longer in waitlist
        for (const studentId of currentWaitlist) {
            if (!newWaitlist.includes(studentId)) {
                await remove(ref(db, `students/${studentId}/assignedTasks/${taskId}`));
            }
        }
        
        // Add new waitlist students
        for (let i = 0; i < newWaitlist.length; i++) {
            const studentId = newWaitlist[i];
            if (!currentWaitlist.includes(studentId)) {
                const waitlistAssignment = {
                    taskId: taskId,
                    title: updatedTaskData.title,
                    description: updatedTaskData.description,
                    deadline: updatedTaskData.deadline,
                    professionalId: userId,
                    professionalName: currentUserProfile.name,
                    status: 'waitlisted',
                    assignedAt: new Date().toISOString(),
                    files: updatedTaskData.files || {},
                    assignmentType: 'waitlist',
                    waitlistPosition: i + 1
                };
                await set(ref(db, `students/${studentId}/assignedTasks/${taskId}`), waitlistAssignment);
            }
        }
        
        // Update waitlist positions for existing students
        for (let i = 0; i < newWaitlist.length; i++) {
            const studentId = newWaitlist[i];
            if (currentWaitlist.includes(studentId)) {
                await update(ref(db, `students/${studentId}/assignedTasks/${taskId}`), {
                    waitlistPosition: i + 1,
                    title: updatedTaskData.title,
                    description: updatedTaskData.description,
                    deadline: updatedTaskData.deadline
                });
            }
        }
        
    } catch (error) {
        console.error('Error updating student assignments:', error);
        throw error;
    }
}

// File handling
document.getElementById('task-files').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    uploadedTaskFiles.push(...files);
    updateTaskFilesList();
    e.target.value = '';
});

function updateTaskFilesList() {
    const filesList = document.getElementById('task-files-list');
    filesList.innerHTML = uploadedTaskFiles.map((file, index) => `
        <div class="task-file-item">
            <i class="fas fa-file"></i>
            <span>${file.name}</span>
            <i class="fas fa-times remove-file" onclick="removeTaskFile(${index})"></i>
        </div>
    `).join('');
}

function removeTaskFile(index) {
    uploadedTaskFiles.splice(index, 1);
    updateTaskFilesList();
}

async function showStudentProfile(studentId) {
    const student = allStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const profilePanel = document.getElementById('student-profile-panel');
    
    profilePanel.innerHTML = `
        <div class="profile-header">
            <img src="${student.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student.personal?.name || 'Unnamed'}" class="profile-avatar">
            <div class="profile-info">
                <h3>${student.personal?.name || 'Unnamed'}</h3>
                <p class="profile-title">${student.education?.branch || 'No education info'}</p>
            </div>
        </div>
        <div class="profile-content">
            <div class="profile-section">
                <h4>About</h4>
                <p>${student.personal?.bio || 'No bio available'}</p>
            </div>
            <div class="profile-section">
                <h4>Skills</h4>
                <div class="skills-list">
                    ${student.skills ? student.skills.split(',').map(skill => 
                        `<span class="skill-tag">${skill.trim()}</span>`
                    ).join('') : '<p>No skills listed</p>'}
                </div>
            </div>
            <div class="profile-section">
                <h4>Education</h4>
                <div class="education-info">
                    <p><strong>Branch:</strong> ${student.education?.branch || 'Not specified'}</p>
                    <p><strong>Year:</strong> ${student.education?.year || 'Not specified'}</p>
                    <p><strong>Institution:</strong> ${student.education?.institution || 'Not specified'}</p>
                </div>
            </div>
            ${student.personal?.interests ? `
                <div class="profile-section">
                    <h4>Interests</h4>
                    <p>${student.personal.interests}</p>
                </div>
            ` : ''}
            ${student.portfolio && student.portfolio.length > 0 ? `
                <div class="profile-section">
                    <h4>Portfolio</h4>
                    <div class="portfolio-items">
                        ${student.portfolio.slice(0, 3).map(item => `
                            <div class="portfolio-item">
                                <h5>${item.title || 'Untitled'}</h5>
                                <p>${item.description || 'No description'}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    // Show the profile panel
    profilePanel.style.display = 'block';
}

// Delete Task Functionality
async function deleteAssignedTask(taskId) {
    try {
        // Show confirmation dialog
        confirmAction('confirmDeleteAssignedTask', 'Delete Task', 'Are you sure you want to delete this assigned task? This will remove the task from all students and cannot be undone.', { taskId });
    } catch (error) {
        console.error('Error showing delete confirmation:', error);
        alert('Failed to show confirmation dialog.');
    }
}

async function confirmDeleteAssignedTask({ taskId }) {
    try {
        // Get the task details first
        const taskRef = ref(db, `assignedTasks/${taskId}`);
        const taskSnapshot = await get(taskRef);
        
        if (!taskSnapshot.exists()) {
            alert('Task not found.');
            return;
        }
        
        const task = taskSnapshot.val();
        
        // Remove task from assignedTasks collection
        await remove(ref(db, `assignedTasks/${taskId}`));
        
        // Remove task from all students' assigned tasks
        if (task.primaryStudent) {
            await remove(ref(db, `students/${task.primaryStudent}/assignedTasks/${taskId}`));
        }
        
        if (task.waitlistStudents && task.waitlistStudents.length > 0) {
            for (const studentId of task.waitlistStudents) {
                await remove(ref(db, `students/${studentId}/assignedTasks/${taskId}`));
            }
        }
        
        // Remove task from professional's tasks collection if it exists
        const professionalTaskRef = ref(db, `professionals/${userId}/tasks/${taskId}`);
        await remove(professionalTaskRef);
        
        // Remove task from main tasks collection if it exists
        const mainTaskRef = ref(db, `tasks/${taskId}`);
        await remove(mainTaskRef);
        
        // Show success message
        showSuccessModal('Task Deleted!', 'The assigned task has been successfully deleted and removed from all students.');
        
        // Reload assigned tasks
        loadAssignedTasks();
        
    } catch (error) {
        console.error('Error deleting assigned task:', error);
        alert('Failed to delete task. Please try again.');
    }
}

function confirmAction(action, title, message, actionParams = {}) {
    const dialogTitle = document.getElementById('dialog-title');
    const dialogMessage = document.getElementById('dialog-message');
    const confirmButton = document.getElementById('confirm-button');
    const confirmationDialog = document.getElementById('confirmation-dialog');
    
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    confirmationDialog.classList.add('active');
    confirmButton.textContent = title.includes('Delete') ? 'Delete' : 'Confirm';
    confirmButton.className = title.includes('Delete') ? 'delete' : 'confirm';
    confirmButton.onclick = () => {
        window[action](actionParams);
        closeConfirmation();
    };
}

function closeConfirmation() {
    document.getElementById('confirmation-dialog').classList.remove('active');
}

function showSuccessModal(title, message) {
    const successTitle = document.getElementById('success-title');
    const successMessage = document.getElementById('success-message');
    const successModal = document.getElementById('success-modal');
    
    successTitle.textContent = title;
    successMessage.innerHTML = `
        <div class="success-content">
            <i class="fas fa-check-circle"></i>
            <h4>${title}</h4>
            <p>${message}</p>
        </div>
    `;
    successModal.classList.add('active');
}

// Window functions
window.openCreateTaskModal = openCreateTaskModal;
window.closeCreateTaskModal = closeCreateTaskModal;
window.openStudentSearchModal = openStudentSearchModal;
window.closeStudentSearchModal = closeStudentSearchModal;
window.closeSuccessModal = closeSuccessModal;
window.createTask = createTask;
window.searchStudents = searchStudents;
window.filterStudents = filterStudents;
window.toggleStudentCheckbox = toggleStudentCheckbox;
window.removeSelectedStudent = removeSelectedStudent;
window.confirmStudentSelection = confirmStudentSelection;
window.viewTaskDetails = viewTaskDetails;
window.closeTaskDetailsModal = closeTaskDetailsModal;
window.editCurrentTask = editCurrentTask;
window.editTaskFromCard = editTaskFromCard;
window.closeEditTaskModal = closeEditTaskModal;
window.openPriorityChangeModal = openPriorityChangeModal;
window.closePriorityChangeModal = closePriorityChangeModal;
window.confirmPriorityChanges = confirmPriorityChanges;
window.saveTaskChanges = saveTaskChanges;
window.removeTaskFile = removeTaskFile;
window.showStudentProfile = showStudentProfile;
window.deleteAssignedTask = deleteAssignedTask;
window.confirmDeleteAssignedTask = confirmDeleteAssignedTask;
window.confirmAction = confirmAction;
window.closeConfirmation = closeConfirmation;
window.showSuccessModal = showSuccessModal;
window.toggleDropdown = toggleDropdown;
window.openProfilePopup = openProfilePopup;
window.closeProfilePopup = closeProfilePopup;

function toggleDropdown(taskId) {
    // Close all other dropdowns first
    const allDropdowns = document.querySelectorAll('.dropdown-menu');
    allDropdowns.forEach(dropdown => {
        if (dropdown.id !== `dropdown-${taskId}`) {
            dropdown.classList.remove('active');
        }
    });
    
    // Toggle the clicked dropdown
    const dropdown = document.getElementById(`dropdown-${taskId}`);
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.three-dot-menu')) {
        const allDropdowns = document.querySelectorAll('.dropdown-menu');
        allDropdowns.forEach(dropdown => {
            dropdown.classList.remove('active');
        });
    }
});

// Initialize
init();

// Remove functions
window.removePrimaryStudent = function() {
    if (!currentEditTask.primaryStudent) return;
    
    if (confirm('Are you sure you want to remove the primary student from this task?')) {
        currentEditTask.primaryStudent = null;
        updateEditStudentAssignments();
    }
};

window.removeWaitlistStudent = function(index) {
    const i = parseInt(index);
    if (i < 0 || i >= currentEditTask.waitlistStudents.length) return;
    
    const student = allStudents.find(s => s.id === currentEditTask.waitlistStudents[i]);
    const studentName = student?.personal?.name || 'Unknown';
    
    if (confirm(`Are you sure you want to remove ${studentName} from the waitlist?`)) {
        currentEditTask.waitlistStudents.splice(i, 1);
        updateEditStudentAssignments();
    }
};

// Assign waitlist modal functions
let selectedStudentsForWaitlist = [];
let maxWaitlistSlots = 5;

window.openAssignWaitlistModal = function() {
    if (!currentEditTask) return;
    
    const currentWaitlistCount = currentEditTask.waitlistStudents ? currentEditTask.waitlistStudents.length : 0;
    const maxStudents = 5;
    const availableSlots = maxStudents - currentWaitlistCount;
    
    if (availableSlots <= 0) {
        alert('Waitlist is already full (5 students maximum)');
        return;
    }
    
    // Show available students for assignment
    showAvailableStudentsForWaitlist(availableSlots);
};

function showAvailableStudentsForWaitlist(availableSlots) {
    if (!currentEditTask) return;
    
    maxWaitlistSlots = availableSlots;
    selectedStudentsForWaitlist = [];
    
    // Get current assigned students (primary + waitlist)
    const currentAssignedStudents = new Set();
    if (currentEditTask.primaryStudent) {
        currentAssignedStudents.add(currentEditTask.primaryStudent);
    }
    if (currentEditTask.waitlistStudents) {
        currentEditTask.waitlistStudents.forEach(id => currentAssignedStudents.add(id));
    }
    
    // Filter out already assigned students
    const availableStudents = allStudents.filter(student => 
        !currentAssignedStudents.has(student.id)
    );
    
    // Populate available students list
    const availableList = document.getElementById('available-students-list');
    availableList.innerHTML = availableStudents.map(student => `
        <div class="student-item" data-student-id="${student.id}" onclick="toggleStudentSelection('${student.id}')">
            <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
            <div class="student-info">
                <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                <div class="student-details">${student?.education?.branch || 'No branch'} • ${student?.skills || 'No skills'}</div>
            </div>
            <div class="selection-indicator">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    `).join('');
    
    // Update counters
    document.getElementById('selected-count').textContent = '0';
    document.getElementById('max-slots').textContent = availableSlots;
    
    // Show modal
    document.getElementById('assign-waitlist-modal').classList.add('active');
}

window.toggleStudentSelection = function(studentId) {
    const index = selectedStudentsForWaitlist.indexOf(studentId);
    
    if (index > -1) {
        // Remove from selection
        selectedStudentsForWaitlist.splice(index, 1);
    } else {
        // Add to selection if not at max
        if (selectedStudentsForWaitlist.length < maxWaitlistSlots) {
            selectedStudentsForWaitlist.push(studentId);
        } else {
            alert(`You can only select up to ${maxWaitlistSlots} students for the waitlist.`);
            return;
        }
    }
    
    updateStudentSelectionDisplay();
};

function updateStudentSelectionDisplay() {
    // Update available students display
    const availableItems = document.querySelectorAll('#available-students-list .student-item');
    availableItems.forEach(item => {
        const studentId = item.dataset.studentId;
        const isSelected = selectedStudentsForWaitlist.includes(studentId);
        const indicator = item.querySelector('.selection-indicator');
        
        if (isSelected) {
            indicator.innerHTML = '<i class="fas fa-check"></i>';
            item.classList.add('selected');
        } else {
            indicator.innerHTML = '<i class="fas fa-plus"></i>';
            item.classList.remove('selected');
        }
    });
    
    // Update selected students display
    const selectedList = document.getElementById('selected-students-list');
    selectedList.innerHTML = selectedStudentsForWaitlist.map(studentId => {
        const student = allStudents.find(s => s.id === studentId);
        return `
            <div class="student-item selected">
                <img src="${student?.personal?.profilePic || '../assets/avatar/1.png'}" alt="${student?.personal?.name || 'Unknown'}" class="student-avatar">
                <div class="student-info">
                    <div class="student-name">${student?.personal?.name || 'Unknown'}</div>
                    <div class="student-details">${student?.education?.branch || 'No branch'}</div>
                </div>
                <button class="remove-selection-btn" onclick="toggleStudentSelection('${studentId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');
    
    // Update counter
    document.getElementById('selected-count').textContent = selectedStudentsForWaitlist.length;
}

window.filterAvailableStudents = function() {
    const searchTerm = document.getElementById('student-search').value.toLowerCase();
    const availableItems = document.querySelectorAll('#available-students-list .student-item');
    
    availableItems.forEach(item => {
        const studentName = item.querySelector('.student-name').textContent.toLowerCase();
        const studentDetails = item.querySelector('.student-details').textContent.toLowerCase();
        
        if (studentName.includes(searchTerm) || studentDetails.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
};

window.closeAssignWaitlistModal = function() {
    document.getElementById('assign-waitlist-modal').classList.remove('active');
    selectedStudentsForWaitlist = [];
    document.getElementById('student-search').value = '';
};

window.confirmAssignWaitlist = function() {
    if (selectedStudentsForWaitlist.length === 0) {
        alert('Please select at least one student to add to the waitlist.');
        return;
    }
    
    // Add selected students to waitlist
    if (!currentEditTask.waitlistStudents) {
        currentEditTask.waitlistStudents = [];
    }
    
    currentEditTask.waitlistStudents.push(...selectedStudentsForWaitlist);
    
    // Close modal and update display
    closeAssignWaitlistModal();
    updateEditStudentAssignments();
    
    alert(`${selectedStudentsForWaitlist.length} student(s) added to waitlist successfully!`);
};

// Refresh only the specific task card
async function refreshTaskCard(taskId, updatedTaskData) {
    try {
        // Find the existing task card
        const existingCard = document.querySelector(`[data-task-id="${taskId}"]`);
        if (!existingCard) {
            console.warn(`Task card with ID ${taskId} not found, reloading all tasks`);
            loadAssignedTasks();
            return;
        }
        
        // Create new task card with updated data
        const newCard = await createTaskCard(updatedTaskData, taskId);
        
        // Replace the old card with the new one
        existingCard.parentNode.replaceChild(newCard, existingCard);
        
        console.log(`Task card ${taskId} refreshed successfully`);
        
    } catch (error) {
        console.error('Error refreshing task card:', error);
        // Fallback to reloading all tasks if refresh fails
        loadAssignedTasks();
    }
}

// Profile popup functions
function openProfilePopup(studentId) {
    const student = allStudents.find(s => s.id === studentId);
    const studentName = student?.personal?.name || 'Student';
    
    // Update modal title
    document.getElementById('profile-popup-title').textContent = `${studentName}'s Profile`;
    
    // Set iframe source
    const iframe = document.getElementById('profile-iframe');
    iframe.src = `../workplace/view-profile.html?studentId=${studentId}`;
    
    // Show modal
    document.getElementById('profile-popup-modal').classList.add('active');
}

function closeProfilePopup() {
    // Clear iframe source
    const iframe = document.getElementById('profile-iframe');
    iframe.src = '';
    
    // Hide modal
    document.getElementById('profile-popup-modal').classList.remove('active');
}
    </script>
</body>
</html> 