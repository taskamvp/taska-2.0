<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska Elite - Your Profile</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/classified-navbar.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        body { 
            background: #ffffff; 
            min-height: 100vh; 
            overflow-x: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0;
            padding: 0;
            color: #1d1d1f;
        }
        .dashboard-content { 
            padding: 1.5rem; 
            margin-top: 80px;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .profile-container { 
            background: #ffffff; 
            border: none;
            border-radius: 12px; 
            width: 100%; 
            max-width: none; 
            padding: 2rem; 
            display: grid; 
            gap: 1.5rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            grid-template-columns: 1fr 1fr;
            grid-template-areas: 
                "header header"
                "personal professional"
                "education education"
                "actions actions";
        }
        .profile-header { 
            text-align: center; 
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1.5rem;
            margin-bottom: 0;
            grid-area: header;
        }
        .profile-header h1 { 
            font-size: 1.75rem; 
            color: #1d1d1f; 
            margin: 0 0 1rem 0; 
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        .profile-avatar { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            border: 3px solid #007aff; 
            margin: 0 auto 1rem; 
            overflow: hidden; 
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        .profile-avatar:hover {
            border-color: #0056cc;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .profile-avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .details-grid { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef;
            border-radius: 8px; 
            padding: 1.5rem; 
            display: grid; 
            gap: 0.75rem; 
            position: relative;
            height: fit-content;
        }
        .details-grid.personal {
            grid-area: personal;
        }
        .details-grid.professional {
            grid-area: professional;
        }
        .details-grid.education {
            grid-area: education;
            grid-column: 1 / -1;
        }
        .details-grid h2 { 
            font-size: 1.25rem; 
            color: #1d1d1f; 
            margin-bottom: 1rem; 
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        .details-grid p { 
            margin: 0; 
            font-size: 0.95rem; 
            color: #86868b; 
            display: grid; 
            grid-template-columns: 140px 1fr; 
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
        }
        .details-grid p:last-child {
            border-bottom: none;
        }
        .details-grid strong { 
            color: #1d1d1f; 
            font-weight: 500; 
        }
        .profile-actions { 
            text-align: center; 
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px;
            grid-area: actions;
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .edit-btn { 
            display: inline-block; 
            padding: 0.75rem 1.5rem; 
            background: #007aff; 
            color: #ffffff; 
            text-decoration: none; 
            border-radius: 8px; 
            font-size: 0.95rem; 
            font-weight: 500;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
            transition: all 0.2s ease;
        }
        .edit-btn:hover {
            background: #0056cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        .logout-btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #ff3b30;
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            margin-left: 0;
            border: none;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.2);
            transition: all 0.2s ease;
        }
        .logout-btn:hover {
            background: #d70015;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        /* Profile Image Upload */
        .profile-image-section { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 1rem; 
            margin-bottom: 1rem; 
        }
        .profile-upload-btn { 
            padding: 0.5rem 1rem; 
            background: #007aff; 
            color: #ffffff; 
            border: none;
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
            transition: all 0.2s ease;
        }
        .profile-upload-btn:hover { 
            background: #0056cc; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* Cropper Modal - macOS Style */
        .cropper-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 10000; 
            align-items: center; 
            justify-content: center; 
            opacity: 1; 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .cropper-container { 
            background: #ffffff; 
            border: none;
            border-radius: 12px; 
            padding: 1.5rem; 
            width: 90%; 
            max-width: 500px; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }
        .cropper-image-wrapper { 
            width: 100%; 
            height: 400px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .cropper-image-wrapper img { 
            max-width: 100%; 
            max-height: 100%; 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block; 
        }
        .cropper-controls { 
            display: flex; 
            gap: 0.5rem; 
            justify-content: center; 
            flex-wrap: wrap; 
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        .cropper-btn { 
            padding: 0.5rem 1rem; 
            border: 1px solid #e9ecef;
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            background: #f8f9fa; 
            color: #1d1d1f; 
            transition: all 0.2s ease; 
            font-weight: 500;
        }
        .cropper-btn:hover { 
            background: #e9ecef; 
            border-color: #007aff;
        }
        .cropper-btn.save { 
            background: #007aff; 
            color: #ffffff; 
            border-color: #007aff;
        }
        .cropper-btn.save:hover { 
            background: #0056cc; 
            border-color: #0056cc;
        }
        .cropper-btn.cancel { 
            background: #f8f9fa; 
            color: #1d1d1f; 
            border-color: #e9ecef;
        }
        .cropper-btn.cancel:hover { 
            background: #e9ecef; 
            border-color: #86868b;
        }
        .cropper-btn.zoom-in, .cropper-btn.zoom-out, .cropper-btn.rotate { 
            padding: 0.5rem; 
            background: #f8f9fa; 
            color: #1d1d1f; 
            border-color: #e9ecef;
        }
        .cropper-btn.zoom-in:hover, .cropper-btn.zoom-out:hover, .cropper-btn.rotate:hover { 
            background: #e9ecef; 
            border-color: #007aff;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .dashboard-content {
                padding: 1rem;
            }
            .profile-container { 
                padding: 1.5rem; 
                margin: 0.5rem;
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "personal"
                    "professional"
                    "education"
                    "actions";
                gap: 1rem;
            }
            .profile-header h1 { 
                font-size: 1.5rem; 
            }
            .profile-avatar {
                width: 70px;
                height: 70px;
            }
            .details-grid {
                padding: 1.25rem;
            }
            .details-grid h2 {
                font-size: 1.2rem;
                margin-bottom: 0.75rem;
            }
            .details-grid p {
                grid-template-columns: 1fr;
                gap: 0.25rem;
                padding: 0.5rem 0;
            }
            .details-grid strong {
                display: block;
                margin-bottom: 0.25rem;
                color: #1d1d1f;
                font-weight: 500;
            }
            .profile-actions {
                flex-direction: column;
                gap: 0.75rem;
                padding: 1.25rem;
            }
            .edit-btn, .logout-btn {
                margin: 0;
                width: 100%;
                max-width: 200px;
            }
            .cropper-container { 
                padding: 1rem; 
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar_classified">
        <a href="../index.html">
            <div class="logo">Taska</div>
        </a>
        <ul class="nav-menu">
            <li><a href="explore.html">Explore</a></li>
            <li><a href="tasks.html">Workplace</a></li>
            <li><a href="gigs.html">Tasks</a></li>
            <li><a href="profile.html" class="active">Account</a></li>
        </ul>
        <div class="hamburger">☰</div>
    </nav>

    <main class="dashboard-content">
        <div class="profile-container">
            <div class="profile-header">
                <h1>Your Profile</h1>
                <div class="profile-image-section">
                    <div class="profile-avatar" onclick="document.getElementById('profile-image').click()">
                        <img id="profile-image-preview" src="../assets/avatar/1.png" alt="Profile Preview">
                    </div>
                    <input type="file" id="profile-image" accept="image/*" style="display: none;">
                </div>
            </div>

            <div class="details-grid personal">
                <h2>Personal Details</h2>
                <p><strong>Name:</strong> <span id="name">Loading...</span></p>
                <p><strong>Email:</strong> <span id="email">Loading...</span></p>
                <p><strong>Phone:</strong> <span id="phone">Loading...</span></p>
                <p><strong>Location:</strong> <span id="location">Loading...</span></p>
                <p><strong>Bio:</strong> <span id="bio">Loading...</span></p>
            </div>

            <div class="details-grid professional">
                <h2>Professional Details</h2>
                <p><strong>Job Role:</strong> <span id="jobRole">Loading...</span></p>
                <p><strong>Company:</strong> <span id="company">Loading...</span></p>
                <p><strong>Experience:</strong> <span id="experience">Loading...</span></p>
            </div>

            <div class="details-grid education">
                <h2>Educational Details</h2>
                <p><strong>College:</strong> <span id="college">Loading...</span></p>
                <p><strong>Degree:</strong> <span id="degree">Loading...</span></p>
                <p><strong>Area of Study:</strong> <span id="areaOfStudy">Loading...</span></p>
            </div>

            <div class="profile-actions">
                <a href="update-profile.html" class="edit-btn">Edit Profile</a>
                <a href="#" id="logout-btn" class="logout-btn">Logout</a>
            </div>
        </div>
    </main>

    <!-- Cropper Modal -->
    <div class="cropper-modal" id="cropper-modal">
        <div class="cropper-container">
            <div class="cropper-image-wrapper">
                <img id="cropper-image" src="" alt="Image to crop">
            </div>
            <div class="cropper-controls">
                <button type="button" class="cropper-btn zoom-in"><i class="fas fa-search-plus"></i></button>
                <button type="button" class="cropper-btn zoom-out"><i class="fas fa-search-minus"></i></button>
                <button type="button" class="cropper-btn rotate"><i class="fas fa-redo"></i></button>
                <button type="button" class="cropper-btn save">Save</button>
                <button type="button" class="cropper-btn cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get, set, push } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDZIDlEtaNRxODoFhRw0xF2yYFBqqBexqo",
            authDomain: "taska-45011.firebaseapp.com",
            databaseURL: "https://taska-45011-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taska-45011",
            storageBucket: "taska-45011.firebasestorage.app",
            messagingSenderId: "205487498813",
            appId: "1:205487498813:web:0de2c9eab567482781ec54"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const userId = localStorage.getItem('userId');

        if (!userId) {
            alert("Please log in or sign up first.");
            window.location.href = '../login.html';
        } else {
            loadProfileData();
        }

        let cropper;
        const profileImageInput = document.getElementById('profile-image');
        const profileImagePreview = document.getElementById('profile-image-preview');
        const cropperModal = document.getElementById('cropper-modal');
        const cropperImage = document.getElementById('cropper-image');
        const zoomInBtn = document.querySelector('.cropper-btn.zoom-in');
        const zoomOutBtn = document.querySelector('.cropper-btn.zoom-out');
        const rotateBtn = document.querySelector('.cropper-btn.rotate');
        const saveBtn = document.querySelector('.cropper-btn.save');
        const cancelBtn = document.querySelector('.cropper-btn.cancel');

        profileImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    cropperImage.src = event.target.result;
                    cropperModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropperImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true,
                        background: false,
                        modal: true,
                        zIndex: 5200
                    });
                    document.body.style.overflow = 'hidden';
                };
                reader.readAsDataURL(file);
            }
        });

        zoomInBtn.addEventListener('click', () => cropper.zoom(0.1));
        zoomOutBtn.addEventListener('click', () => cropper.zoom(-0.1));
        rotateBtn.addEventListener('click', () => cropper.rotate(90));
        cancelBtn.addEventListener('click', () => {
            cropperModal.style.display = 'none';
            if (cropper) cropper.destroy();
            profileImageInput.value = '';
            document.body.style.overflow = 'auto';
        });

        saveBtn.addEventListener('click', async () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200,
                imageSmoothingQuality: 'high'
            });
            canvas.toBlob(async (blob) => {
                try {
                    const webpBlob = await new Promise((resolve) => {
                        const img = new Image();
                        img.src = canvas.toDataURL('image/webp', 0.8);
                        img.onload = () => {
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = img.width;
                            tempCanvas.height = img.height;
                            tempCanvas.getContext('2d').drawImage(img, 0, 0);
                            tempCanvas.toBlob(resolve, 'image/webp', 0.8);
                        };
                    });

                    const storagePath = `profile/${userId}.webp`;
                    const imageRef = storageRef(storage, storagePath);
                    await uploadBytes(imageRef, webpBlob);
                    const downloadURL = await getDownloadURL(imageRef);

                    profileImagePreview.src = downloadURL;

                    const verificationRef = ref(database, `verification/${userId}`);
                    await push(verificationRef, {
                        field: 'personal.profilePic',
                        value: downloadURL,
                        timestamp: Date.now(),
                        status: 'pending'
                    });

                    const userRef = ref(database, `professionalslist/${userId}`);
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        await set(userRef, {
                            ...data,
                            personal: {
                                ...data.personal,
                                profilePic: downloadURL
                            }
                        });
                    }

                    cropperModal.style.display = 'none';
                    if (cropper) cropper.destroy();
                    profileImageInput.value = '';
                    document.body.style.overflow = 'auto';
                } catch (error) {
                    alert("Failed to upload image: " + error.message);
                }
            }, 'image/webp', 0.8);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const hamburger = document.querySelector('.navbar .hamburger');
            const navMenu = document.querySelector('.navbar .nav-menu');
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
        });

        async function loadProfileData() {
            try {
                const userRef = ref(database, `professionalslist/${userId}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('name').textContent = data.personal?.name || 'Not set';
                    document.getElementById('email').textContent = data.personal?.email || 'Not set';
                    document.getElementById('phone').textContent = data.personal?.phone || 'Not set';
                    document.getElementById('location').textContent = data.personal?.location || 'Not set';
                    document.getElementById('bio').textContent = data.personal?.bio || 'Not set';
                    document.getElementById('jobRole').textContent = data.professional?.jobRole || 'Not set';
                    document.getElementById('company').textContent = data.professional?.company || 'Not set';
                    document.getElementById('experience').textContent = data.professional?.experience || 'Not set';
                    document.getElementById('college').textContent = data.education?.college || 'Not set';
                    document.getElementById('degree').textContent = data.education?.degree || 'Not set';
                    document.getElementById('areaOfStudy').textContent = data.education?.areaOfStudy || 'Not set';
                    profileImagePreview.src = data.personal?.profilePic || '../assets/avatar/1.png';
                } else {
                    alert("No profile data found. Please update your profile.");
                }
            } catch (error) {
                alert(`Failed to load profile: ${error.message}`);
            }
        }

        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '../index.html';
        });
    </script>
</body>
</html>